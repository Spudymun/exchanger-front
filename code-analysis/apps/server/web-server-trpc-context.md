### –ü—É—Ç—å: apps/web/src/server/trpc/context.ts

**–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)**
–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ tRPC —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ª–æ–∫–∞–ª–∏, IP –∞–¥—Ä–µ—Å–∞ –∏ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–∞—Ö.

**–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (3‚Äì6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)**
–§—É–Ω–∫—Ü–∏—è createContext —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ tRPC –∑–∞–ø—Ä–æ—Å–∞, –≤–∫–ª—é—á–∞—è –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ –¥–ª—è rate limiting, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ sessionId –∏–∑ cookies –∏–ª–∏ Authorization header. –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ Accept-Language –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–µ—Ä–µ–∑ getLocaleFromAcceptLanguage –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–æ–π –ª–æ–∫–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π quality values –∏ fallback –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å userManager –∏–∑ @repo/exchange-core –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ sessionId –∏ —Å–æ–∑–¥–∞–µ—Ç –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ createErrorMessageFunction. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ IP –∞–¥—Ä–µ—Å–∞ –≤–∫–ª—é—á–∞—è x-forwarded-for –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–∞ –ø—Ä–æ–∫—Å–∏ –∏ load balancer. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è tRPC –ø—Ä–æ—Ü–µ–¥—É—Ä –≤–∫–ª—é—á–∞—è request/response –æ–±—ä–µ–∫—Ç—ã, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ª–æ–∫–∞–ª—å –∏ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏.

**–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ / API (–≤—Å–µ –Ω–∞ 100%)**

- `export const createContext` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è tRPC –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- `export type Context` ‚Äî —Ç–∏–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö
- `getLocaleFromAcceptLanguage(acceptLanguage)` ‚Äî –ø–∞—Ä—Å–µ—Ä Accept-Language –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è)

**–í—Ö–æ–¥—ã (expected inputs) / –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤—Å–µ –Ω–∞ 100%)**

- `opts: CreateNextContextOptions` ‚Äî –æ–±—ä–µ–∫—Ç —Å req –∏ res –æ—Ç Next.js
- –ß–∏—Ç–∞–µ—Ç cookies.sessionId –∏ headers.authorization –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç headers['accept-language'] –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª–∏
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç IP –∏–∑ headers['x-forwarded-for'] –∏–ª–∏ socket.remoteAddress

**–í—ã—Ö–æ–¥—ã / –ü–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–≤—Å–µ –Ω–∞ 100%)**

- `req, res` ‚Äî –æ–±—ä–µ–∫—Ç—ã –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞ Next.js
- `ip` ‚Äî IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è rate limiting
- `user` ‚Äî –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ null
- `sessionId` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–∏ –∏–∑ cookies –∏–ª–∏ header
- `locale` ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –ª–æ–∫–∞–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `getErrorMessage` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö

**–í–∑–∞–∏–º–æ—Å–≤—è–∑–∏ (–∫—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç / —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç) (–≤—Å–µ –Ω–∞ 100%)**

- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: tRPC —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- **–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç**: SupportedLocale, SUPPORTED_LOCALES –∏–∑ @repo/constants
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç**: User, userManager –∏–∑ @repo/exchange-core –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç**: createErrorMessageFunction –∏–∑ –ª–æ–∫–∞–ª—å–Ω—ã—Ö utils –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
- **–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è**: —Å tRPC middleware –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º–∏ —á–µ—Ä–µ–∑ Context —Ç–∏–ø

**–î–æ–º–µ–Ω –¥–∞–Ω–Ω—ã—Ö / —Ç–∏–ø—ã (–≤—Å–µ –Ω–∞ 100%)**

```typescript
// –ö–æ–Ω—Ç–µ–∫—Å—Ç tRPC
interface Context {
  req: NextApiRequest;
  res: NextApiResponse;
  ip: string;
  user: User | null;
  sessionId: string | undefined;
  locale: SupportedLocale;
  getErrorMessage: (key: string, values?: Record<string, any>) => string;
}

// –ü–∞—Ä—Å–∏–Ω–≥ Accept-Language
interface LanguagePreference {
  locale: string;
  quality: number;
}

// –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
type AuthSource = 'cookie' | 'header';
type IPSource = 'x-forwarded-for' | 'socket' | 'unknown';
```

**–†–∏—Å–∫–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

- **Authentication security**: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ sessionId
- **IP spoofing**: x-forwarded-for –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–¥–µ–ª–∞–Ω, –Ω—É–∂–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **Session management**: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç userManager –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Locale injection**: Accept-Language –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **Error message exposure**: –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

**–¢–µ—Å—Ç—ã / —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–∫—Ä—ã—Ç–∏—é**

- **Authentication —Ç–µ—Å—Ç—ã**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ sessionId
- **Locale parsing —Ç–µ—Å—Ç—ã**: –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞ Accept-Language –∑–∞–≥–æ–ª–æ–≤–∫–∞
- **IP extraction —Ç–µ—Å—Ç—ã**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∏—è IP –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- **Error localization —Ç–µ—Å—Ç—ã**: –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **Security —Ç–µ—Å—Ç—ã**: –∑–∞—â–∏—Ç–∞ –æ—Ç injection –∞—Ç–∞–∫ —á–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∏

**–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (low/medium/high)**
**MEDIUM** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é

**TODO / –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥**

- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å tRPC —á–µ—Ä–µ–∑ CreateNextContextOptions
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ Accept-Language —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π quality values
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ IP —Å —É—á–µ—Ç–æ–º proxy –∏ load balancer
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º userManager
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –æ—à–∏–±–æ–∫
- ‚úÖ Fallback –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø—Ä–∏ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–π –ª–æ–∫–∞–ª–∏
- üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é x-forwarded-for –∑–∞–≥–æ–ª–æ–≤–∫–∞
- üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞—É–¥–∏—Ç–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —É–ª—É—á—à–∏—Ç—å session management —Å TTL –∏ refresh tokens
