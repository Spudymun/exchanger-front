### Путь: apps/web/src/server/trpc/routers/fiat.ts

**Краткое назначение (1 предложение)**

tRPC роутер для работы с фиатными валютами, банками и расчетом обменов между криптовалютами и традиционными валютами.

**Подробное описание (3–6 предложений)**

Роутер обеспечивает полную функциональность работы с фиатными валютами включая получение списка поддерживаемых валют с лимитами, управление банками-партнерами и их резервами, а также расчет кросс-валютных обменов. Система поддерживает множественные фиатные валюты (UAH, USD, EUR) с индивидуальными минимальными и максимальными лимитами для каждой валюты. Каждый банк имеет свои резервы по валютам, что позволяет динамически проверять доступность средств для обмена. Все операции включают валидацию входных данных, проверку существования банков и криптовалют, а также имитацию API задержек для реалистичного UX. Расчеты учитывают текущие курсы криптовалют, комиссии и кросс-курсы фиатных валют.

**Экспортируемые сущности / API**

- `export const fiatRouter` — композитный роутер с процедурами:
  - `getSupportedFiatCurrencies` — получение списка поддерживаемых фиатных валют с лимитами
  - `getBanksForFiatCurrency` — получение списка банков для конкретной валюты с резервами
  - `getBankInfo` — детальная информация о банке и его возможностях
  - `calculateFiatExchange` — расчет обмена криптовалюты на фиатную через конкретный банк

**Входы (expected inputs) / Параметры**

- `getSupportedFiatCurrencies`: без параметров
- `getBanksForFiatCurrency`: `{ currency: 'UAH' | 'USD' | 'EUR' }` — фиатная валюта
- `getBankInfo`: `{ bankId: string, currency: FiatCurrency }` — ID банка и валюта
- `calculateFiatExchange`: `{ cryptoAmount: number, fromCurrency: CryptoCurrency, toCurrency: FiatCurrency, bankId: string }`

**Выходы / Побочные эффекты**

- Возврат статических данных о валютах с локализованными названиями
- Динамическая информация о банках с текущими резервами
- Детализированные расчеты обменов с комиссиями и валидацией
- Проверка достаточности резервов банков для операций
- API задержки для имитации реальных внешних запросов
- Локализованные ошибки при некорректных параметрах

**Взаимосвязи (кто вызывает / что вызывает)**

Файлы, которые импортируют этот файл:

- `./index.ts` — композиция в главный appRouter
- Клиентский код через `trpc.fiat.*` вызовы
- Компоненты выбора банков и валютных калькуляторов

Файлы, которые импортируются здесь:

- `@repo/constants` — все константы фиатных валют, лимиты, mock курсы, банки
- `@repo/exchange-core` — бизнес-логика расчетов, типы валют
- `@repo/utils` — фабрики ошибок для обработки исключений
- `zod` — валидация входных схем для enum значений
- `../context` — типизация контекста для локализации ошибок
- `../init` — базовые строительные блоки tRPC

**Домен данных / типы**

```typescript
// Фиатные валюты и их метаданные
interface FiatCurrencyInfo {
  symbol: FiatCurrency;
  name: string;
  minAmount: number;
  maxAmount: number;
  isActive: boolean;
}

// Информация о банке
interface BankInfo {
  id: string;
  name: string;
  shortName: string;
  logoUrl: string;
  isActive: boolean;
  priority: number;
  reserve: number;
  currency?: FiatCurrency;
  minAmount?: number;
  maxAmount?: number;
}

// Результат расчета фиатного обмена
interface FiatExchangeCalculation {
  cryptoAmount: number;
  fromCurrency: CryptoCurrency;
  toCurrency: FiatCurrency;
  bankId: string;
  fiatAmount: number;
  cryptoRate: number;
  fiatRate: number;
  commission: number;
  commissionAmount: number;
  bankReserve: number;
  hasEnoughReserve: boolean;
  isValid: boolean;
}
```

**Риски и безопасность**

- **Financial accuracy**: Критически важна точность расчетов кросс-курсов
- **Reserve validation**: Необходима актуальная информация о резервах банков
- **Mock data**: Использование mock курсов не подходит для production
- **Bank validation**: Проверка существования и активности банков
- **Currency limits**: Соблюдение минимальных и максимальных лимитов
- **Rate consistency**: Синхронизация курсов между различными источниками

**Тесты / рекомендации по покрытию**

- Unit тесты расчетов кросс-курсов с различными комбинациями валют
- Валидационные тесты для всех enum значений валют
- Edge case тесты: нулевые резервы, несуществующие банки, превышение лимитов
- Integration тесты с реальными bank ID и currency combinations
- Performance тесты для множественных параллельных расчетов
- Математические тесты точности вычислений с floating point числами

**Оценка сложности (low/medium/high)**

**medium** — множественные валютные расчеты с проверкой ограничений и резервов

**TODO / Рефакторинг**

- **PRIORITY 1**: Заменить mock курсы на реальные API (CoinGecko, CryptoCompare)
- **PRIORITY 2**: Интеграция с реальными банковскими API для резервов
- Добавить кеширование курсов валют с TTL
- Реализовать динамическое обновление резервов банков
- Добавить историю курсов для аналитики
- Реализовать более сложную логику комиссий банков
- Добавить геолокационные ограничения для банков
