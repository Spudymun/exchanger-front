### Путь: apps/web/src/server/trpc/routers/shared.ts

**Краткое назначение (1 предложение)**

tRPC роутер для общих функций доступных как операторам, так и службе поддержки включая поиск, статистику и административные действия.

**Подробное описание (3–6 предложений)**

Роутер предоставляет набор общих инструментов для персонала компании с ролями оператора и поддержки через middleware `operatorAndSupport`. Включает комплексную поисковую функциональность по заявкам с фильтрацией по датам, статусам и текстовым запросам, а также поиск пользователей с различными критериями. Система предоставляет централизованную статистику по заявкам, пользователям и криптовалютам для принятия бизнес-решений. Дополнительно реализованы быстрые административные действия как обновление курсов, очистка кеша и отправка массовых уведомлений. Все функции используют централизованные утилиты для обеспечения консистентности данных и безопасного доступа к информации.

**Экспортируемые сущности / API**

- `export const sharedRouter` — композитный роутер с процедурами:
  - `searchOrders` — поиск заявок по ID, email, суммам с фильтрацией по датам и статусам
  - `searchUsers` — поиск пользователей по email, ID с фильтром по верификации
  - `getGeneralStats` — общая статистика по заявкам, пользователям и валютам
  - `quickActions` — быстрые административные действия (обновление курсов, очистка кеша, уведомления)

**Входы (expected inputs) / Параметры**

- `searchOrders`: `{ query: string, dateFrom?: string, dateTo?: string, status?: OrderStatus, limit?: number }`
- `searchUsers`: `{ query: string, verified?: boolean, limit?: number }`
- `getGeneralStats`: без параметров
- `quickActions`: `{ action: 'REFRESH_RATES' | 'CLEAR_CACHE' | 'SEND_NOTIFICATION', params?: object }`

**Выходы / Побочные эффекты**

- Фильтрованные и отсортированные списки заявок и пользователей
- Агрегированная статистика в реальном времени
- Безопасные данные пользователей без sensitive информации (пароли, session IDs)
- Имитация административных действий с временными задержками
- Подсчет связанных данных (количество заявок у пользователя)

**Взаимосвязи (кто вызывает / что вызывает)**

Файлы, которые импортируют этот файл:

- `./index.ts` — композиция в главный appRouter
- Admin панели операторов и поддержки через `trpc.shared.*`
- Dashboard компоненты со статистикой

Файлы, которые импортируются здесь:

- `@repo/constants` — все системные константы, лимиты, форматы дат
- `@repo/exchange-core` — менеджеры данных (orderManager, userManager), типы
- `@repo/utils` — утилиты поиска, пагинации, статистики, валидационные схемы
- `../init` — createTRPCRouter для композиции
- `../middleware/auth` — operatorAndSupport middleware для защиты доступа

**Домен данных / типы**

```typescript
// Результат поиска заявок
interface OrderSearchResult {
  id: string;
  email: string;
  status: OrderStatus;
  cryptoAmount: number;
  uahAmount: number;
  currency: CryptoCurrency;
  createdAt: Date;
}

// Безопасная информация о пользователе
interface SafeUserInfo {
  id: string;
  email: string;
  isVerified: boolean;
  createdAt: Date;
  lastLoginAt?: Date;
  ordersCount: number;
}

// Общая статистика
interface GeneralStats {
  orders: {
    total: number;
    today: number;
    pending: number;
    processing: number;
    completed: number;
  };
  users: {
    total: number;
    verified: number;
    newToday: number;
  };
  currencies: Array<{
    currency: CryptoCurrency;
    orders: number;
    volume: number;
  }>;
}
```

**Риски и безопасность**

- **Data exposure**: Доступ к email и финансовым данным клиентов
- **Authorization critical**: Middleware должен корректно проверять роли
- **Search performance**: Неоптимизированный поиск по большим объемам данных
- **Information leakage**: Статистика может раскрыть бизнес-информацию
- **Admin actions**: Быстрые действия могут влиять на production систему
- **PII handling**: Обработка персональных данных требует соблюдения GDPR

**Тесты / рекомендации по покрытию**

- Unit тесты поиска с различными комбинациями фильтров
- Edge case тесты: пустые результаты, некорректные даты, длинные запросы
- Security тесты доступа с различными ролями
- Performance тесты поиска с большими объемами данных
- Integration тесты статистических расчетов
- Валидационные тесты всех входных схем

**Оценка сложности (low/medium/high)**

**medium** — комплексная поисковая логика с агрегацией данных и управлением доступом

**TODO / Рефакторинг**

- Оптимизировать поиск через индексы или поисковый движок (Elasticsearch)
- Добавить кеширование для статистических запросов
- Реализовать real-time обновления статистики через WebSocket
- Добавить экспорт данных в различных форматах (CSV, Excel)
- Реализовать более гранулярные права доступа к данным
- Добавить аудит логирование для всех поисковых запросов
- Внедрить rate limiting для предотвращения злоупотреблений поиском
