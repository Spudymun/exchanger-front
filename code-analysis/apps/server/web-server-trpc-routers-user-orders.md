### Путь: apps/web/src/server/trpc/routers/user/orders.ts

**Краткое назначение (1 предложение)**

tRPC роутер для пользовательских операций с заявками включая просмотр истории, детали и отмену заявок.

**Подробное описание (3–6 предложений)**

Роутер обеспечивает полный набор операций для аутентифицированных пользователей по управлению их заявками на обмен криптовалют. Все процедуры защищены middleware `protectedProcedure` и включают валидацию доступа к данным только текущего пользователя через функции `validateUserAccess` и `validateOrderAccess`. Система предоставляет пагинированную историю заявок с фильтрацией по статусам, детальную информацию о конкретных заявках включая recipient данные и историю статусов. Реализована функция отмены заявок с проверкой возможности отмены на основе текущего статуса. Все операции используют централизованные утилиты для консистентности данных и логируются для аудита пользовательских действий.

**Экспортируемые сущности / API**

- `export const ordersRouter` — композитный роутер с процедурами:
  - `getOrderHistory` — получение истории заявок пользователя с пагинацией и фильтрацией
  - `getOrderDetails` — детальная информация о конкретной заявке с историей статусов
  - `cancelOrder` — отмена заявки пользователем (если статус позволяет)

**Входы (expected inputs) / Параметры**

- `getOrderHistory`: `{ limit?: number, offset?: number, status?: OrderStatus }` — пагинация и фильтр
- `getOrderDetails`: `{ orderId: string }` — ID заявки для получения деталей
- `cancelOrder`: `{ orderId: string }` — ID заявки для отмены

**Выходы / Побочные эффекты**

- Возврат только заявок текущего пользователя с проверкой доступа
- Обновление статуса заявки на CANCELLED при отмене
- Console логирование операций отмены заявок для аудита
- Пагинированные результаты с метаданными (total, hasMore)
- Детализированная информация включая recipient данные и txHash
- Синтетическая история статусов (placeholder для будущего функционала)

**Взаимосвязи (кто вызывает / что вызывает)**

Файлы, которые импортируют этот файл:

- `./index.ts` — композиция в userRouter как `orders: ordersRouter`
- Клиентский код через `trpc.user.orders.*` вызовы
- Компоненты личного кабинета и истории заявок

Файлы, которые импортируются здесь:

- `@repo/constants` — конфигурация пользователей, статусы заявок, сообщения
- `@repo/exchange-core` — orderManager, функции валидации доступа
- `@repo/utils` — утилиты обработки данных, валидационные схемы, фабрики ошибок
- `zod` — дополнительная валидация входных параметров
- `../../init` — createTRPCRouter для композиции
- `../../middleware/auth` — protectedProcedure для защиты доступа

**Домен данных / типы**

```typescript
// Заявка пользователя (view model)
interface UserOrderView {
  id: string;
  status: OrderStatus;
  cryptoAmount: number;
  uahAmount: number;
  currency: CryptoCurrency;
  depositAddress: string;
  createdAt: Date;
  updatedAt: Date;
  processedAt?: Date;
  txHash?: string;
}

// Детальная информация о заявке
interface UserOrderDetails extends UserOrderView {
  recipientData?: {
    cardNumber?: string;
    bankDetails?: string;
  };
  statusHistory: Array<{
    status: OrderStatus;
    timestamp: Date;
  }>;
}

// Результат истории заявок
interface UserOrderHistory {
  orders: UserOrderView[];
  total: number;
  hasMore: boolean;
}
```

**Риски и безопасность**

- **Data isolation critical**: Неправильная валидация доступа может дать доступ к чужим заявкам
- **Authorization checks**: Каждая операция должна проверять принадлежность заявки пользователю
- **Business logic**: Проверка возможности отмены должна быть консистентна с бизнес-правилами
- **Sensitive data**: Recipient данные содержат банковские реквизиты
- **Audit trail**: Все операции пользователей должны логироваться

**Тесты / рекомендации по покрытию**

- Unit тесты каждой процедуры с различными пользователями и заявками
- Security тесты попыток доступа к чужим заявкам
- Edge case тесты: несуществующие заявки, неотменяемые статусы
- Integration тесты полного flow управления заявками
- Performance тесты пагинации с большими объемами данных
- Валидационные тесты для всех входных параметров

**Оценка сложности (low/medium/high)**

**medium** — бизнес-логика с проверками безопасности и управлением состоянием

**TODO / Рефакторинг**

- Реализовать полноценную историю статусов заявок
- Добавить push уведомления об изменении статусов
- Реализовать возможность повторной отправки средств
- Добавить экспорт истории заявок в PDF/Excel
- Внедрить real-time обновления статусов через WebSocket
- Добавить возможность добавления комментариев к заявкам
- Реализовать рейтинговую систему для завершенных заявок
