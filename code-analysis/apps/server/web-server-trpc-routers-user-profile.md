### Путь: apps/web/src/server/trpc/routers/user/profile.ts

**Краткое назначение (1 предложение)**

tRPC роутер для управления профилем пользователя включая просмотр данных, статистики и обновление настроек.

**Подробное описание (3–6 предложений)**

Роутер предоставляет базовую функциональность управления профилем для аутентифицированных пользователей через middleware `protectedProcedure`. Система возвращает безопасные данные профиля включая основную информацию о пользователе и агрегированную статистику по заявкам через централизованные утилиты. Функция обновления профиля в настоящее время является заглушкой из-за отсутствия полей notifications в модели User, но предоставляет основу для будущего расширения функциональности. Все операции включают валидацию доступа через `validateUserAccess` и логирование изменений для аудита. Роутер следует принципу минимального доступа к данным, возвращая только необходимую информацию без sensitive данных.

**Экспортируемые сущности / API**

- `export const profileRouter` — композитный роутер с процедурами:
  - `getProfile` — получение профиля текущего пользователя с статистикой заявок
  - `updateProfile` — обновление настроек профиля (текущая заглушка для notifications)

**Входы (expected inputs) / Параметры**

- `getProfile`: без параметров (использует аутентификацию из контекста)
- `updateProfile`: `UpdateNotificationsSchema` — схема обновления уведомлений (заглушка)

**Выходы / Побочные эффекты**

- Возврат базовой информации о пользователе без sensitive данных
- Агрегированная статистика заявок через orderManager
- Console логирование операций обновления профиля
- Успешные сообщения для UI feedback
- Валидация существования и доступа к пользователю

**Взаимосвязи (кто вызывает / что вызывает)**

Файлы, которые импортируют этот файл:

- `./index.ts` — композиция в userRouter как `profile: profileRouter`
- Клиентский код через `trpc.user.profile.*` вызовы
- Компоненты профиля пользователя и настроек аккаунта

Файлы, которые импортируются здесь:

- `@repo/constants` — сообщения успеха для UI
- `@repo/exchange-core` — orderManager, validateUserAccess для безопасности
- `@repo/utils` — утилиты статистики, валидационные схемы
- `../../init` — createTRPCRouter для композиции
- `../../middleware/auth` — protectedProcedure для защиты доступа

**Домен данных / типы**

```typescript
// Профиль пользователя (view model)
interface UserProfile {
  id: string;
  email: string;
  isVerified: boolean;
  createdAt: Date;
  lastLoginAt?: Date;
  stats: {
    totalOrders: number;
    completedOrders: number;
  };
}

// Результат обновления профиля
interface UpdateProfileResult {
  id: string;
  email: string;
  isVerified: boolean;
  message: string;
}

// Схема обновления уведомлений (placeholder)
interface UpdateNotificationsSchema {
  emailNotifications?: boolean;
  smsNotifications?: boolean;
  pushNotifications?: boolean;
}
```

**Риски и безопасность**

- **Data isolation**: Валидация доступа только к собственному профилю
- **Information disclosure**: Профиль не должен раскрывать sensitive данные
- **Incomplete functionality**: updateProfile является заглушкой и может быть misleading
- **Statistics accuracy**: Агрегированная статистика должна быть точной
- **Authorization consistency**: Проверки доступа должны быть консистентны

**Тесты / рекомендации по покрытию**

- Unit тесты получения профиля с различными пользователями
- Security тесты доступа к профилю без аутентификации
- Integration тесты статистических расчетов с реальными заявками
- Edge case тесты: пользователи без заявок, неверифицированные пользователи
- Валидационные тесты для updateProfile когда функциональность будет реализована

**Оценка сложности (low/medium/high)**

**low** — базовая функциональность с минимальной бизнес-логикой

**TODO / Рефакторинг**

- **PRIORITY 1**: Реализовать полноценную функциональность updateProfile
- Добавить поля notifications в модель User
- Расширить статистику профиля (объемы операций, средний чек)
- Добавить настройки приватности и персонализации
- Реализовать возможность изменения email с верификацией
- Добавить историю изменений профиля для аудита
- Внедрить возможность экспорта персональных данных (GDPR compliance)
