### Путь: apps/web/src/server/trpc/routers/operator.ts

**Краткое назначение (1 предложение)**

tRPC роутер для операторских функций управления заявками включая обработку, изменение статусов и мониторинг статистики.

**Подробное описание (3–6 предложений)**

Роутер предоставляет полный набор инструментов для операторов по управлению жизненным циклом заявок на обмен криптовалют. Все процедуры защищены middleware `operatorOnly`, что гарантирует доступ только пользователям с ролью OPERATOR. Система включает получение заявок с фильтрацией по статусам и пагинацией, функции принятия заявок в обработку, обновления статусов с валидацией корректных переходов, и аналитику производительности. Используются централизованные утилиты для фильтрации, сортировки и статистики, что обеспечивает консистентность с другими частями системы. Все операции логируются с деталями о выполнившем их операторе для аудита и мониторинга.

**Экспортируемые сущности / API**

- `export const operatorRouter` — композитный роутер с процедурами:
  - `getPendingOrders` — получение заявок для обработки с фильтрацией и пагинацией
  - `takeOrder` — принятие заявки в обработку (статус PENDING → PROCESSING)
  - `updateOrderStatus` — обновление статуса заявки с валидацией переходов
  - `getMyStats` — получение статистики работы оператора

**Входы (expected inputs) / Параметры**

- `getPendingOrders`: `{ limit?: number, cursor?: string, status: OrderStatus }` — пагинация и фильтр
- `takeOrder`: `{ orderId: string }` — ID заявки для обработки
- `updateOrderStatus`: `{ orderId: string, status: OrderStatus, comment?: string }` — новый статус и комментарий
- `getMyStats`: без параметров

**Выходы / Побочные эффекты**

- Обновление статусов заявок через orderManager
- Console логирование всех операций с деталями оператора
- Возврат обогащенных данных заявок с конфигурацией статусов
- Автоматическое проставление `processedAt` при завершении заявки
- Курсорная пагинация для эффективной работы с большими списками
- Статистические расчеты по всему объему заявок

**Взаимосвязи (кто вызывает / что вызывает)**

Файлы, которые импортируют этот файл:

- `./index.ts` — композиция в главный appRouter
- Admin panel компоненты через `trpc.operator.*` вызовы
- Operator dashboard и рабочие панели

Файлы, которые импортируются здесь:

- `@repo/constants` — конфигурация статусов, лимиты валидации, ORDER_STATUSES
- `@repo/exchange-core` — orderManager для управления заявками
- `@repo/utils` — утилиты пагинации, фильтрации, статистики, валидационные схемы
- `zod` — дополнительная валидация входных параметров
- `../init` — createTRPCRouter для композиции
- `../middleware/auth` — operatorOnly middleware для защиты доступа

**Домен данных / типы**

```typescript
// Расширенная информация о заявке для операторов
interface OperatorOrderView {
  id: string;
  email: string;
  status: OrderStatus;
  cryptoAmount: number;
  uahAmount: number;
  currency: CryptoCurrency;
  createdAt: Date;
  updatedAt: Date;
  config: OrderStatusConfig; // UI конфигурация статуса
}

// Статистика оператора
interface OperatorStats {
  total: number;
  today: number;
  completed: number;
  processing: number;
  pending: number;
  totalVolume: number;
  avgProcessingTime: string;
}

// Результат пагинации
interface PaginatedOrders {
  items: OperatorOrderView[];
  nextCursor?: string;
  hasMore: boolean;
}
```

**Риски и безопасность**

- **Authorization critical**: Неправильная настройка operatorOnly может дать доступ неавторизованным пользователям
- **Status transitions**: Некорректные переходы статусов могут нарушить бизнес-процессы
- **Data exposure**: Операторы видят email клиентов и суммы операций
- **Audit trail**: Все действия должны логироваться для соответствия требованиям
- **Concurrent access**: Несколько операторов могут пытаться обработать одну заявку
- **Performance**: Статистические запросы по всем заявкам могут быть медленными

**Тесты / рекомендации по покрытию**

- Unit тесты каждой процедуры с различными ролями пользователей
- Integration тесты валидации переходов статусов
- Edge case тесты: несуществующие заявки, некорректные статусы
- Security тесты попыток доступа без operator роли
- Performance тесты пагинации с большими объемами данных
- Audit тесты корректности логирования операций

**Оценка сложности (low/medium/high)**

**medium** — бизнес-критичная логика с множественными проверками и state management

**TODO / Рефакторинг**

- Добавить распределение заявок между операторами (load balancing)
- Реализовать систему уведомлений о новых заявках
- Добавить детальную аналитику производительности операторов
- Реализовать систему комментариев и внутренней переписки
- Добавить автоматические SLA проверки и алерты
- Внедрить систему блокировки заявок при обработке (prevent race conditions)
- Реализовать batch операции для массового обновления статусов
