### Путь: apps/web/src/server/trpc/routers/user/security.ts

**Краткое назначение (1 предложение)**

tRPC роутер для операций безопасности пользователя включая смену пароля, повторную верификацию email и удаление аккаунта.

**Подробное описание (3–6 предложений)**

Роутер реализует критически важные функции безопасности для аутентифицированных пользователей через middleware `protectedProcedure`. Включает полноценную смену пароля с валидацией текущего пароля и хешированием нового через bcrypt, повторную отправку кода верификации email для неподтвержденных пользователей. Особое внимание уделено функции удаления аккаунта с проверкой пароля, отсутствия активных заявок и требованием явного подтверждения через literal строку для предотвращения случайного удаления. Все операции включают строгую валидацию входных данных через Zod схемы, логирование для аудита и локализованные сообщения об ошибках. Система следует принципам GDPR compliance для операций с персональными данными.

**Экспортируемые сущности / API**

- `export const securityRouter` — композитный роутер с процедурами:
  - `changePassword` — смена пароля с валидацией текущего пароля
  - `resendVerificationEmail` — повторная отправка кода подтверждения email
  - `deleteAccount` — удаление аккаунта с проверками безопасности

**Входы (expected inputs) / Параметры**

- `changePassword`: `{ currentPassword: string, newPassword: string }` — старый и новый пароли
- `resendVerificationEmail`: без параметров (использует аутентификацию из контекста)
- `deleteAccount`: `{ password: string, confirmation: 'DELETE_MY_ACCOUNT' }` — пароль и явное подтверждение

**Выходы / Побочные эффекты**

- Обновление hashedPassword пользователя через userManager
- Console логирование всех операций безопасности для аудита
- Mock отправка verification email с генерацией кода
- Очистка session cookie при удалении аккаунта
- Проверка и предотвращение удаления при активных заявках
- Возврат локализованных сообщений успеха для UI

**Взаимосвязи (кто вызывает / что вызывает)**

Файлы, которые импортируют этот файл:

- `./index.ts` — композиция в userRouter как `security: securityRouter`
- Клиентский код через `trpc.user.security.*` вызовы
- Компоненты настроек безопасности и управления аккаунтом

Файлы, которые импортируются здесь:

- `@repo/constants` — сообщения пользователю, конфигурация, лимиты валидации
- `@repo/exchange-core` — менеджеры данных, валидация доступа, генерация кодов
- `@repo/utils` — валидационные схемы, фабрики ошибок
- `bcryptjs` — хеширование паролей
- `zod` — валидация входных данных
- `../../init` — createTRPCRouter для композиции
- `../../middleware/auth` — protectedProcedure для защиты доступа

**Домен данных / типы**

```typescript
// Схема смены пароля
interface ChangePasswordInput {
  currentPassword: string;
  newPassword: string;
}

// Схема удаления аккаунта
interface DeleteAccountInput {
  password: string;
  confirmation: 'DELETE_MY_ACCOUNT';
}

// Результаты операций безопасности
interface SecurityOperationResult {
  message: string;
}

// Внутренние проверки
interface AccountDeletionChecks {
  hasValidPassword: boolean;
  hasActiveOrders: boolean;
  hasExplicitConfirmation: boolean;
}
```

**Риски и безопасность**

- **CRITICAL**: Смена пароля без правильной валидации может скомпрометировать аккаунты
- **Password security**: Использование bcrypt с правильными salt rounds
- **Session management**: Очистка сессий при критических операциях
- **GDPR compliance**: Правильная обработка запросов на удаление данных
- **Business logic**: Предотвращение удаления аккаунтов с активными операциями
- **Mock functionality**: Email отправка не работает в production

**Тесты / рекомендации по покрытию**

- Unit тесты смены пароля с правильными и неправильными паролями
- Security тесты попыток смены пароля без аутентификации
- Edge case тесты: слабые пароли, SQL injection попытки
- Integration тесты полного flow удаления аккаунта
- Валидационные тесты для всех входных схем
- Business logic тесты предотвращения удаления с активными заявками

**Оценка сложности (low/medium/high)**

**high** — критически важные операции безопасности с множественными проверками

**TODO / Рефакторинг**

- **PRIORITY 1**: Реализовать реальную отправку verification email
- **PRIORITY 2**: Добавить реальное удаление пользователя в userManager
- Добавить двухфакторную аутентификацию (2FA setup/disable)
- Реализовать историю изменений безопасности для аудита
- Добавить rate limiting для операций смены пароля
- Внедрить уведомления о подозрительной активности
- Реализовать частичное удаление данных (soft delete) вместо полного удаления
