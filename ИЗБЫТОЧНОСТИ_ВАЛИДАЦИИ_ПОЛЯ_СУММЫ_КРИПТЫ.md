# üö® –ê–ù–ê–õ–ò–ó –ò–ó–ë–´–¢–û–ß–ù–û–°–¢–ï–ô –í–ê–õ–ò–î–ê–¶–ò–ò –ü–û–õ–Ø –°–£–ú–ú–´ –ö–†–ò–ü–¢–´

## üìä –û–ë–ó–û–† –ü–†–û–ë–õ–ï–ú–´

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 29 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–°—Ç–∞—Ç—É—Å:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–ó–ë–´–¢–û–ß–ù–û–°–¢–ò –û–ë–ù–ê–†–£–ñ–ï–ù–´  
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏:** 3 –≥—Ä—É–ø–ø—ã

---

## üîç –ù–ê–ô–î–ï–ù–ù–´–ï –ò–ó–ë–´–¢–û–ß–ù–û–°–¢–ò

### **1. –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï –õ–û–ì–ò–ö–ò –í–ê–õ–ò–î–ê–¶–ò–ò –ú–ï–ñ–î–£ –°–•–ï–ú–ê–ú–ò**

#### –ü—Ä–æ–±–ª–µ–º–Ω–∞—è –ø–∞—Ä–∞:

- **`cryptoAmountStringSchema`** (schemas-crypto.ts) - –ü–û–õ–ù–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **`validateExchangeAmountFormat()`** (security-enhanced-exchange-schemas.ts) - –£–†–ï–ó–ê–ù–ù–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è

#### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:

| –ü—Ä–æ–≤–µ—Ä–∫–∞              | `cryptoAmountStringSchema`    | `validateExchangeAmountFormat()` |
| --------------------- | ----------------------------- | -------------------------------- |
| ‚úÖ XSS –∑–∞—â–∏—Ç–∞         | `containsPotentialXSS(val)`   | `containsPotentialXSS(val)`      |
| ‚úÖ Allow empty string | `if (val === '') return true` | `if (val === '') return true`    |
| ‚úÖ Numeric validation | `Number.isNaN(num)`           | `Number.isNaN(num)`              |
| ‚úÖ Decimal places     | `val.split('.')` ‚â§ 2          | `val.split('.')` ‚â§ 2             |
| ‚úÖ Decimal precision  | –î–æ 8 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏       | ‚ùå **–ù–ï–¢**                       |
| ‚úÖ Positive check     | `Number(val) > 0`             | ‚ùå **–ù–ï–¢**                       |

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

- **`cryptoAmountStringSchema`:** useExchangeStoreWithTranslations.ts (3 –º–µ—Å—Ç–∞)
- **`validateExchangeAmountFormat()`:** 2 —Å—Ö–µ–º—ã exchange —Ñ–æ—Ä–º

---

### **2. –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï –ü–û–î–•–û–î–û–í –ö –í–ê–õ–ò–î–ê–¶–ò–ò –°–£–ú–ú–´**

#### String –ø–æ–¥—Ö–æ–¥—ã:

```typescript
// –ü–æ–¥—Ö–æ–¥ 1: –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–æ–∫–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
export const cryptoAmountStringSchema = z
  .string()
  .refine(val => !containsPotentialXSS(val), 'INVALID_CHARACTERS_DETECTED')
  .refine(/* full validation logic */);

// –ü–æ–¥—Ö–æ–¥ 2: –£—Ä–µ–∑–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
function validateExchangeAmountFormat(val: string): boolean {
  if (containsPotentialXSS(val)) return false;
  // simplified validation logic
}
```

#### Number –ø–æ–¥—Ö–æ–¥—ã:

```typescript
// –ü–æ–¥—Ö–æ–¥ 3: Number –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è calculate
export const securityEnhancedCalculateAmountSchema = z.object({
  amount: z.number().positive(),
});

// –ü–æ–¥—Ö–æ–¥ 4: Number –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è create order
export const securityEnhancedCreateExchangeOrderSchema = z.object({
  cryptoAmount: z
    .number()
    .positive('AMOUNT_POSITIVE_REQUIRED')
    .min(VALIDATION_LIMITS.MIN_ORDER_AMOUNT, 'AMOUNT_MIN_REQUIRED')
    .max(VALIDATION_LIMITS.MAX_ORDER_AMOUNT, 'AMOUNT_MAX_EXCEEDED')
    .finite('AMOUNT_MUST_BE_FINITE'),
});
```

---

### **3. –î–£–ë–õ–ò–†–û–í–ê–ù–ò–ï POSITIVE –í–ê–õ–ò–î–ê–¶–ò–ò**

#### –¢—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —Å–ø–æ—Å–æ–±–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```typescript
// –°–ø–æ—Å–æ–± 1: String-based –ø—Ä–æ–≤–µ—Ä–∫–∞
.refine(val => val === '' || Number(val) > 0, { message: 'AMOUNT_POSITIVE' })

// –°–ø–æ—Å–æ–± 2: Number-based –ø—Ä–æ–≤–µ—Ä–∫–∞ (–ø—Ä–æ—Å—Ç–∞—è)
z.number().positive()

// –°–ø–æ—Å–æ–± 3: Number-based –ø—Ä–æ–≤–µ—Ä–∫–∞ (—Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º)
z.number().positive('AMOUNT_POSITIVE_REQUIRED')
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

- **–°–ø–æ—Å–æ–± 1:** `cryptoAmountStringSchema`
- **–°–ø–æ—Å–æ–± 2:** `securityEnhancedCalculateAmountSchema.amount`
- **–°–ø–æ—Å–æ–± 3:** `securityEnhancedCreateExchangeOrderSchema.cryptoAmount`

---

## üìã –ü–û–õ–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê –ö–û–ú–ü–û–ù–ï–ù–¢–û–í

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                                                | –¢–∏–ø      | –§–∞–π–ª                                  | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ                               | –ü—Ä–æ–±–ª–µ–º–∞                               |
| -------------------------------------------------------- | -------- | ------------------------------------- | ------------------------------------------- | -------------------------------------- |
| `cryptoAmountStringSchema`                               | Schema   | schemas-crypto.ts                     | ‚úÖ useExchangeStoreWithTranslations.ts (3x) | **–≠—Ç–∞–ª–æ–Ω–Ω–∞—è —Å—Ö–µ–º–∞**                    |
| `validateExchangeAmountFormat()`                         | Function | security-enhanced-exchange-schemas.ts | ‚úÖ 2 —Å—Ö–µ–º—ã exchange —Ñ–æ—Ä–º                    | **–î—É–±–ª–∏—Ä—É–µ—Ç cryptoAmountStringSchema** |
| `securityEnhancedCalculateAmountSchema`                  | Schema   | security-enhanced-utils.ts            | ‚úÖ exchange.ts tRPC router (2x)             | **–†–∞–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (number vs string)**   |
| `securityEnhancedCreateExchangeOrderSchema.cryptoAmount` | Field    | security-enhanced-exchange-schemas.ts | ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è                             | **–î—É–±–ª–∏—Ä—É–µ—Ç positive –≤–∞–ª–∏–¥–∞—Ü–∏—é**       |
| `validateAmountFormat()`                                 | Function | security-enhanced-exchange-schemas.ts | ‚úÖ validateCryptoAmountLimits()             | **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**                       |
| `validateBusinessLimits()`                               | Function | security-enhanced-exchange-schemas.ts | ‚úÖ validateCryptoAmountLimits()             | **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**                       |
| `validateCryptoAmountLimits()`                           | Function | security-enhanced-exchange-schemas.ts | ‚úÖ 3 —Å—Ö–µ–º—ã exchange —Ñ–æ—Ä–º                    | **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**                       |
| `handleAmountValidation()`                               | Function | handlers.ts                           | ‚úÖ core.ts                                  | **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**                       |

---

## üéØ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–ï–õ–ö–ò–ï –ò–ó–ë–´–¢–û–ß–ù–û–°–¢–ò

### UAH Amount –≤–∞–ª–∏–¥–∞—Ü–∏—è:

```typescript
uahAmount: z.number()
  .positive('UAH_AMOUNT_POSITIVE_REQUIRED') // –î—É–±–ª–∏—Ä—É–µ—Ç –ø–æ–¥—Ö–æ–¥ positive –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  .finite('UAH_AMOUNT_MUST_BE_FINITE');
```

### –†–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–¥–Ω–æ–π –ª–æ–≥–∏–∫–∏:

- `'AMOUNT_POSITIVE'`
- `'AMOUNT_POSITIVE_REQUIRED'`
- `'UAH_AMOUNT_POSITIVE_REQUIRED'`

---

## üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–°–¢–†–ê–ù–ï–ù–ò–Æ

### 1. –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–æ–≤–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—É–º–º—ã:

- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** `cryptoAmountStringSchema` –∫–∞–∫ —ç—Ç–∞–ª–æ–Ω
- **–ó–∞–º–µ–Ω–∏—Ç—å:** `validateExchangeAmountFormat()` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ö–µ–º—ã
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏

### 2. –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è positive –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

- **–°–æ–∑–¥–∞—Ç—å:** –ï–¥–∏–Ω—ã–π helper –¥–ª—è positive –ø—Ä–æ–≤–µ—Ä–∫–∏
- **–ü—Ä–∏–º–µ–Ω–∏—Ç—å:** –ö–æ –≤—Å–µ–º amount –ø–æ–ª—è–º
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥—Ö–æ–¥–æ–≤

### 3. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö:

- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å:** –ö–ª—é—á–∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è amount –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ UX

---

## üí∞ –ú–ï–¢–†–ò–ö–ò –ò–ó–ë–´–¢–û–ß–ù–û–°–¢–ò

- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:** ~40 —Å—Ç—Ä–æ–∫
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ:** 4 –ø–æ–¥—Ö–æ–¥–∞
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–æ—Å–æ–±–æ–≤ positive –≤–∞–ª–∏–¥–∞—Ü–∏–∏:** 3 —Å–ø–æ—Å–æ–±–∞
- **–§–∞–π–ª–æ–≤ —Å –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å—é:** 3 —Ñ–∞–π–ª–∞

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û–°–¢–¨

**–í–´–°–û–ö–ê–Ø –ö–†–ò–¢–ò–ß–ù–û–°–¢–¨** - –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞—é—Ç:

- –ü—Ä–æ–±–ª–µ–º—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ–¥–∞
- –†–∞–∑–ª–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –æ–¥–Ω–∏—Ö –ø–æ–ª–µ–π
- –ü—É—Ç–∞–Ω–∏—Ü—É –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å—Ö–µ–º
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã  
**–¢—Ä–µ–±—É–µ—Ç:** –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç–µ–π
