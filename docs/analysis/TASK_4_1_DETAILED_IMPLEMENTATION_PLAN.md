# –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Task 4.1: Exchange Router Enhancement

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 20 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–ó–∞–¥–∞—á–∞:** 4.1 –î–æ–ø–æ–ª–Ω–∏—Ç—å `apps/web/src/server/trpc/routers/exchange.ts`  
**–û—Å–Ω–æ–≤–∞:** –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è TASK_5_2_CODE_REVIEW_REPORT.md  
**–ü–æ–¥—Ö–æ–¥:** –ê–≥–µ–Ω—Ç-–∫–æ–¥–µ—Ä (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–¥–æ–≤—É—é –±–∞–∑—É, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)

---

## üéØ –¶–ï–õ–¨ –ó–ê–î–ê–ß–ò

**–†–∞—Å—à–∏—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π createOrder procedure –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π:**

- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UserManagerFactory –∏ WalletPoolManager
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ security-enhanced schemas
- –í—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∫–∞–∫ –ø–∞–∑–ª –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

---

## üìä –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ê–ù–ê–õ–ò–ó –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ö–û–î–ê

### üîç –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ exchange.ts

**–ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ `exchange.ts` –£–ñ–ï –ò–ú–ï–ï–¢ —á–∞—Å—Ç–∏—á–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é:**

‚úÖ **–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

- `allocateWalletForOrder()` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `WalletPoolManagerFactory.create()`
- `processQueuedOrder()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–æ–∫ –≤ –æ—á–µ—Ä–µ–¥–∏ —Å `UserManagerFactory.createForWeb()`
- `processSuccessfulOrder()` - —É—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å `AutoRegistrationService`
- Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ `RateLimitedEmailService.sendCryptoAddress()`

‚ùå **–ü—Ä–æ–±–ª–µ–º—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ TASK_5_2):**

- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: WalletPoolManagerFactory –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `WALLET_POOL_CONFIG.DEFAULT_MODE`
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: EMAIL_CONSTANTS —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ `@repo/constants`
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: DRY –Ω–∞—Ä—É—à–µ–Ω–∏–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–æ

### üèóÔ∏è –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π workflow –≤ createOrder:

```typescript
1. prepareOrderRequest() - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
2. allocateWalletForOrder() - WalletPoolManagerFactory –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚úÖ
3. –ï—Å–ª–∏ –∫–æ—à–µ–ª–µ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí processSuccessfulOrder() ‚úÖ
4. –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ—à–µ–ª—å–∫–∞ ‚Üí processQueuedOrder() ‚úÖ
5. Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚úÖ
6. –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚úÖ
```

**–í–´–í–û–î:** –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WalletPoolManager –∏ UserManagerFactory –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢!

---

## üîß –¢–†–ï–ë–£–ï–ú–´–ï –î–û–†–ê–ë–û–¢–ö–ò –î–õ–Ø –ó–ê–î–ê–ß–ò 4.1

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–æ–≤ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**

```typescript
// –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
import { WalletPoolManagerFactory } from '@repo/exchange-core';
import { UserManagerFactory } from '@repo/session-management';
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤ workflow

**–í–Ω–µ–¥—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ `allocateWalletForOrder()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π Factory
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ email –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ DRY —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω–µ –Ω–∞—Ä—É—à–∏–ª —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### 3. –£–ª—É—á—à–µ–Ω–∏–µ error handling

**–†–∞—Å—à–∏—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –¥–ª—è –Ω–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:**

```typescript
// –î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –¥–ª—è wallet allocation failures
// –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è debugging
// –û–±–µ—Å–ø–µ—á–∏—Ç—å graceful degradation –ø—Ä–∏ failures
```

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–£—á–µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ allocation mode:**

- `DEFAULT_MODE` —Ç–µ–ø–µ—Ä—å `'immediate'` –≤–º–µ—Å—Ç–æ `'hybrid'`
- –í–æ–∑–º–æ–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ queue –º–µ—Ö–∞–Ω–∏–∑–º–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ timeout'–∞–º–∏

---

## üìã –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### Phase 1: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**1.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**

- [ ] –ê–Ω–∞–ª–∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ `allocateWalletForOrder()` —Å –Ω–æ–≤—ã–º Factory
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è `processQueuedOrder()` –∏ `processSuccessfulOrder()`
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ email workflow —Å –Ω–æ–≤—ã–º–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ createOrder end-to-end

**1.2 –í–∞–ª–∏–¥–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏**

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ constants
- [ ] –ê–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å security-enhanced schemas

### Phase 2: –î–æ—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

**2.1 –£–ª—É—á—à–µ–Ω–∏–µ wallet allocation –ª–æ–≥–∏–∫–∏**

```typescript
async function allocateWalletForOrder(currency: CryptoCurrency) {
  const { WalletPoolManagerFactory } = await import('@repo/exchange-core');

  try {
    const walletManager = await WalletPoolManagerFactory.create();
    return await walletManager.allocateWallet(currency);
  } catch (error) {
    // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    logger.error('Wallet allocation failed', { currency, error });
    throw createOrderError('wallet_allocation_failed', { currency });
  }
}
```

**2.2 –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è queue processing**

```typescript
// –£—á–µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ DEFAULT_MODE –Ω–∞ 'immediate'
// –í–æ–∑–º–æ–∂–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è queue –ª–æ–≥–∏–∫–∏
// –£–ª—É—á—à–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```

**2.3 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ logging –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
// –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è wallet allocation success/failure rates
// Tracking –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
```

### Phase 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**3.1 Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤**

- [ ] –¢–µ—Å—Ç—ã WalletPoolManagerFactory —Å –Ω–æ–≤—ã–º–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏
- [ ] –¢–µ—Å—Ç—ã email service —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è refactored Factory –º–µ—Ç–æ–¥–æ–≤

**3.2 Integration —Ç–µ—Å—Ç—ã –¥–ª—è exchange.ts**

- [ ] End-to-end —Ç–µ—Å—Ç—ã createOrder procedure
- [ ] –¢–µ—Å—Ç—ã —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (success, queue, failure)
- [ ] Performance —Ç–µ—Å—Ç—ã —Å –Ω–æ–≤—ã–º allocation mode

**3.3 –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API –Ω–µ —Å–ª–æ–º–∞–Ω
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö environment'–∞—Ö

---

## üîÑ WORKFLOW –ò–ù–¢–ï–ì–†–ê–¶–ò–ò

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π createOrder procedure (–°–û–•–†–ê–ù–ò–¢–¨)

```typescript
export const exchangeRouter = createTRPCRouter({
  createOrder: publicProcedure
    .use(rateLimitMiddleware) // –°–û–•–†–ê–ù–ò–¢–¨
    .input(securityEnhancedCreateExchangeOrderSchema) // –°–û–•–†–ê–ù–ò–¢–¨
    .mutation(async ({ input, ctx }) => {
      // –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –õ–û–ì–ò–ö–ê - —Ç–æ–ª—å–∫–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

      // 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–°–û–•–†–ê–ù–ò–¢–¨)
      const orderRequest = prepareOrderRequest(input);

      // 2. Wallet allocation (–£–õ–£–ß–®–ò–¢–¨)
      const depositAddress = await allocateWalletForOrder(orderRequest.currency);

      // 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–°–û–•–†–ê–ù–ò–¢–¨ + –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å)
      if (depositAddress) {
        return await processSuccessfulOrder(/* ... */);
      } else {
        return await processQueuedOrder(/* ... */);
      }
    });
```

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–ø—Ä–∏–Ω—Ü–∏–ø –ø–∞–∑–ª–∞)

**–ò–∑–º–µ–Ω–∏—Ç—å –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**

1. –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–æ–≤
2. –£–ª—É—á—à–∏—Ç—å error handling –≥–¥–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
3. –î–æ–±–∞–≤–∏—Ç—å logging –¥–ª—è observability
4. –ù–ï –¢–†–û–ì–ê–¢–¨ —Ä–∞–±–æ—á—É—é –ª–æ–≥–∏–∫—É –±–µ–∑ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## üéØ ACCEPTANCE CRITERIA

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- [ ] createOrder procedure —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- [ ] Wallet allocation –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π DEFAULT_MODE ('immediate')
- [ ] Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
- [ ] Queue processing —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Error handling –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- [ ] –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º patterns –≤ –ø—Ä–æ–µ–∫—Ç–µ
- [ ] –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏ (DRY principle)
- [ ] –í—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] TypeScript —Ç–∏–ø—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] ESLint –ø—Ä–∞–≤–∏–ª–∞ —Å–æ–±–ª—é–¥–µ–Ω—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è createOrder –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö
- [ ] Memory usage –Ω–µ —É–≤–µ–ª–∏—á–∏–ª—Å—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ

---

## üöß –†–ò–°–ö–ò –ò –ú–ò–¢–ò–ì–ê–¶–ò–Ø

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏:

**–†–∏—Å–∫ 1: –ò–∑–º–µ–Ω–µ–Ω–∏–µ DEFAULT_MODE –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**

- _–ú–∏—Ç–∏–≥–∞—Ü–∏—è:_ –¢—â–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 'immediate' mode
- _–ü–ª–∞–Ω B:_ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å rollback –∫ 'hybrid' –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

**–†–∏—Å–∫ 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Factory –Ω–∞—Ä—É—à–∏–ª —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

- _–ú–∏—Ç–∏–≥–∞—Ü–∏—è:_ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ integration —Ç–µ—Å—Ç—ã
- _–ü–ª–∞–Ω B:_ Temporary fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é

**–†–∏—Å–∫ 3: Email –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑–º–µ–Ω–∏–ª–∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**

- _–ú–∏—Ç–∏–≥–∞—Ü–∏—è:_ –í–∞–ª–∏–¥–∞—Ü–∏—è —á—Ç–æ WALLET_EXPIRY_HOURS = 24 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- _–ü–ª–∞–Ω B:_ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ environment variables

### –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏:

**–†–∏—Å–∫ 1: Breaking changes –≤ production**

- _–ú–∏—Ç–∏–≥–∞—Ü–∏—è:_ –¢—â–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ staging environment
- _–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:_ –ê–ª–µ—Ä—Ç—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

**–†–∏—Å–∫ 2: Performance degradation**

- _–ú–∏—Ç–∏–≥–∞—Ü–∏—è:_ Load testing —Å –Ω–æ–≤—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- _Fallback:_ Feature flags –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è

---

## üìà –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê

### Immediate (–ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è):

- createOrder success rate ‚â• 95%
- Average response time ‚â§ 2s
- Zero critical errors –≤ –ª–æ–≥–∞—Ö

### Short-term (1-2 –Ω–µ–¥–µ–ª–∏):

- Queue processing efficiency improved
- Email delivery rate ‚â• 98%
- Wallet allocation success rate ‚â• 99%

### Long-term (1 –º–µ—Å—è—Ü):

- Maintainability score improved (–º–µ–Ω—å—à–µ duplicated code)
- Developer velocity increased (easier to extend)
- Production stability maintained

---

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´

### –ü—Ä—è–º–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:

- `packages/exchange-core/src/services/wallet-pool-manager-factory.ts` ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
- `packages/exchange-core/src/services/queue-email-notifier.ts` ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û
- `packages/constants/src/wallet-pool-config.ts` ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û
- `apps/web/src/server/trpc/routers/exchange.ts` - –¶–ï–õ–¨ –ó–ê–î–ê–ß–ò

### –ö–æ—Å–≤–µ–Ω–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:

- `packages/session-management/` - UserManagerFactory
- `packages/email-service/` - RateLimitedEmailService
- `packages/utils/` - Security validation schemas

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ:

- `apps/web/src/server/trpc/routers/operator.ts` - –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ –∂–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- Tests –∏ integration —Ç–µ—Å—Ç—ã

---

## üìö –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø

### –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

- [ ] API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è createOrder changes
- [ ] Architecture documentation —Å –Ω–æ–≤—ã–º workflow
- [ ] Development guide —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [ ] Troubleshooting guide –¥–ª—è –Ω–æ–≤—ã—Ö error scenarios

### –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é:

- [ ] Integration guide –¥–ª—è WalletPoolManager + UserManager
- [ ] Performance optimization guide
- [ ] Monitoring and alerting runbook

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ó–∞–¥–∞—á–∞ 4.1 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —ç–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –∞ –Ω–µ —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ.**

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–∞–∫ –ø–∞–∑–ª –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π** - –æ–ø–æ—Ä–∞ –Ω–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ patterns** - —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –≤ –ø—Ä–æ–µ–∫—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–∞–º
4. **–¢—â–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–∞–¥–µ–∂–Ω–∞—è, maintainable –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è WalletPoolManager –∏ UserManagerFactory –≤ exchange router —Å –ø–æ–ª–Ω—ã–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.
