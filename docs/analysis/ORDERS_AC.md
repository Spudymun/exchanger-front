# Acceptance Criteria: Система обработки заявок на криптообмен (Production Ready)

## 1. Общие требования

- [ ] Система должна обрабатывать минимум 1000 одновременных заявок
- [ ] Время отклика API не должно превышать 200мс для 95% запросов
- [ ] Система должна быть отказоустойчивой к сбоям базы данных и внешних сервисов
- [ ] Все критические операции должны логироваться для аудита и отладки
- [ ] Реализовать мониторинг ключевых метрик: количество заявок, размер очередей, время обработки

## 2. Создание заявки (Эндпоинт `POST /api/orders`)

**AC2.1: Валидация входных данных**

- [ ] Проверка формата email (RFC 5322)
- [ ] Валидация номера карты (алгоритм Луна)
- [ ] Проверка суммы на соответствие минимальным/максимальным лимитам
- [ ] Проверка поддерживаемых валют и сетей
- [ ] При ошибке валидации возвращается HTTP 422 с детализацией ошибок

**AC2.2: Создание заявки с немедленным выделением адреса**

- [ ] При наличии свободного кошелька в очереди FIFO:
  - Заявка создается со статусом `pending`
  - Кошелек помечается как `occupied` и удаляется из очереди свободных
  - Возвращается HTTP 201 с полными данными заявки
  - Инициируется асинхронная отправка email с адресом

**AC2.3: Создание заявки с ожиданием адреса**

- [ ] При отсутствии свободных кошельков:
  - Заявка создается со статусом `pending` и пустым адресом
  - Заявка помещается в FIFO-очередь ожидания
  - Возвращается HTTP 201 с флагом `in_queue: true`
  - Email не отправляется до выделения адреса

**AC2.4: Обработка сбоев**

- [ ] При недоступности БД возвращается HTTP 503
- [ ] Реализован механизм повтора для транзиентных ошибок
- [ ] Гарантированная идемпотентность при повторных запросах с тем же ID

## 3. Управление пулом кошельков

**AC3.1: Алгоритм FIFO для кошельков**

- [ ] Свободные кошельки организованы в строгую FIFO-очередь
- [ ] При выделении всегда выбирается кошелек из головы очереди
- [ ] При освобождении кошелек помещается в хвост очереди

**AC3.2: Механизм освобождения кошельков**

- [ ] При переходе заявки в статусы `completed`/`cancelled`:
  - Кошелек освобождается и помещается в хвост очереди
  - Запускается обработчик очереди ожидающих заявок

**AC3.3: Обработка очереди ожидания**

- [ ] При освобождении кошелька проверяется очередь ожидания:
  - Выбирается самая старая заявка без адреса для соответствующей сети
  - Кошелек привязывается к заявке
  - Отправляется email с адресом
  - Заявка удаляется из очереди ожидания

**AC3.4: Мониторинг состояния пула**

- [ ] Реализованы метрики количества свободных/занятых кошельков
- [ ] Реализованы метрики размера очереди ожидания
- [ ] Реализованы алерты при критическом уменьшении свободных кошельков

## 4. Интеграция с Telegram-ботом

**AC4.1: Уведомление о новых заявках**

- [ ] При создании заявки в Telegram отправляется уведомление:
  - Для заявок с immediate адресом - с кнопкой "Взять в работу"
  - Для заявок в очереди - с указанием позиции в очереди

**AC4.2: Взаимодействие с оператором**

- [ ] При нажатии "Взять в работу":
  - Статус меняется на `processing`
  - Записывается ID оператора
  - Обновляется сообщение в чате
- [ ] При завершении/отмене:
  - Статус меняется на `completed`/`cancelled`
  - Запускается освобождение кошелька
  - Обновляется чат операторов

**AC4.3: Безопасность**

- [ ] Все эндпоинты для бота защищены API Key аутентификацией
- [ ] Валидация прав оператора на действия с заявкой

## 5. Эндпоинты для оператора

**AC5.1: Взятие заявки в работу**

- [ ] `POST /api/internal/orders/{orderId}/claim`
- [ ] Требует валидного API Key
- [ ] Возвращает 200 OK или соответствующую ошибку

**AC5.2: Завершение заявки**

- [ ] `POST /api/internal/orders/{orderId}/complete`
- [ ] Меняет статус на `completed`
- [ ] Запускает освобождение кошелька

**AC5.3: Отмена заявки**

- [ ] `POST /api/internal/orders/{orderId}/cancel`
- [ ] Принимает параметр `reason`
- [ ] Меняет статус на `cancelled`
- [ ] Запускает освобождение кошелька

## 6. Отправка email-уведомлений

**AC6.1: Отправка при создании заявки**

- [ ] Асинхронная отправка через очередь сообщений
- [ ] Шаблон письма включает все детали заявки
- [ ] Retry логика с экспоненциальным backoff

**AC6.2: Отправка для заявок из очереди**

- [ ] Отправка при выделении кошелька для заявки из очереди
- [ ] Отдельный шаблон с уведомлением о готовности адреса

**AC6.3: Мониторинг доставки**

- [ ] Трекинг статуса отправки email
- [ ] Логирование ошибок доставки
- [ ] Уведомление при критических сбоях email-сервиса

## 7. Производительность и надежность

**AC7.1: База данных**

- [ ] Индексы для часто запрашиваемых полей (статус, сеть, created_at)
- [ ] Репликация для отказоустойчивости
- [ ] Регулярные бэкапы

**AC7.2: Кеширование**

- [ ] Кеширование часто запрашиваемых данных (список кошельков, статусы заявок)
- [ ] Стратегия инвалидации кеша при изменениях

**AC7.3: Асинхронная обработка**

- [ ] Очередь задач для email-уведомлений
- [ ] Очередь для обработки освобождения кошельков
- [ ] Rate limiting для внешних API

## 8. Безопасность

**AC8.1: Защита данных**

- [ ] Шифрование чувствительных данных (номера карт) в БД
- [ ] Masking данных при отображении в UI

**AC8.2: API безопасность**

- [ ] Rate limiting на эндпоинты
- [ ] Защита от SQL-инъекций
- [ ] Валидация всех входных параметров

**AC8.3: Аутентификация**

- [ ] JWT токены для пользовательских запросов
- [ ] API Keys для сервис-сервисного взаимодействия
- [ ] Ролевая модель доступа для операторов

## 9. Мониторинг и логирование

**AC9.1: Метрики**

- [ ] Количество заявок по статусам
- [ ] Время обработки заявок
- [ ] Размеры очередей кошельков и заявок
- [ ] Rate ошибок API

**AC9.2: Логирование**

- [ ] Структурированные логи для всех операций
- [ ] Correlation ID для трассировки запросов
- [ ] Централизованное хранение логов

**AC9.3: Алертинг**

- [ ] Алерты при высокой частоте ошибок
- [ ] Алерты при достижении критических размеров очередей
- [ ] Алерты при недоступности внешних сервисов

Этот набор AC покрывает все аспекты production-системы, включая производительность, надежность, безопасность и мониторинг. Реализация этих критериев обеспечит стабильную работу системы обмена даже при высоких нагрузках.
