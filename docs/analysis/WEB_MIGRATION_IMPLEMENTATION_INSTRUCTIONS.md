# –ü–õ–ê–ù –ú–ò–ì–†–ê–¶–ò–ò –ö MULTI-APP –ê–†–•–ò–¢–ï–ö–¢–£–†–ï

> **–î–∞—Ç–∞**: 12 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
> **–°—Ç–∞—Ç—É—Å**: –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–õ–ê–ù –ù–ê –û–°–ù–û–í–ï –†–ï–ê–õ–¨–ù–û–ô –ê–†–•–ò–¢–ï–ö–¢–£–†–´  
> **–û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞**: –¢—â–∞—Ç–µ–ª—å–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã  
> **–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–∑–æ–ª—è—Ü–∏–∏ —Å–µ—Å—Å–∏–π –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º (web, admin-panel) –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

## üéØ –¶–ï–õ–¨ –ú–ò–ì–†–ê–¶–ò–ò: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π session –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–ª—è multi-app

### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–†–ê–ë–û–¢–ê–ï–¢):

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      PostgreSQL     ‚îÇ  ‚îÇ        Redis        ‚îÇ
‚îÇ   (–æ–¥–Ω–∞ –ë–î)         ‚îÇ  ‚îÇ   (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ       ‚îÇ
‚îÇ                     ‚îÇ  ‚îÇ    –∫–ª—é—á–∏)           ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ  ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ users           ‚îÇ ‚îÇ  ‚îÇ ‚îÇ session:abc123  ‚îÇ ‚îÇ
‚îÇ ‚îÇ sessions        ‚îÇ ‚îÇ  ‚îÇ ‚îÇ session:def456  ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¶–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–î–û–ë–ê–í–õ–Ø–ï–ú application context):

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      PostgreSQL     ‚îÇ  ‚îÇ        Redis        ‚îÇ
‚îÇ   (—Ç–∞ –∂–µ –ë–î +       ‚îÇ  ‚îÇ   (namespace –ø–æ     ‚îÇ
‚îÇ    app context)     ‚îÇ  ‚îÇ    –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º)     ‚îÇ
‚îÇ                     ‚îÇ  ‚îÇ                     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ  ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ users           ‚îÇ ‚îÇ  ‚îÇ ‚îÇ session:web:123 ‚îÇ ‚îÇ
‚îÇ ‚îÇ sessions +      ‚îÇ ‚îÇ  ‚îÇ ‚îÇ session:admin:45‚îÇ ‚îÇ
‚îÇ ‚îÇ appContext      ‚îÇ ‚îÇ  ‚îÇ ‚îÇ                 ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ –ü–†–ò–ù–¶–ò–ü–´ –ú–ò–ì–†–ê–¶–ò–ò: EXTEND, DON'T REPLACE

1. ‚úÖ **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –í–°–ï —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã** - UserManagerFactory, RedisSessionAdapter, ProductionUserManager
2. ‚úÖ **100% Backward compatibility** - —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç—Å—è
3. ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ–º application context support
4. ‚úÖ **–ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ë–î** - —Ä–∞—Å—à–∏—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é Prisma —Å—Ö–µ–º—É
5. ‚úÖ **–ù–ï –ª–æ–º–∞—Ç—å Redis** - –¥–æ–±–∞–≤–ª—è–µ–º namespace, —Å–æ—Ö—Ä–∞–Ω—è–µ–º fallback

---

## –≠–¢–ê–ü 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Application Context –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

### 1.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç –≤ `packages/constants/src/session.ts`

**‚úÖ –î–û–ë–ê–í–ò–¢–¨ –ö –°–£–©–ï–°–¢–í–£–Æ–©–ò–ú –ö–û–ù–°–¢–ê–ù–¢–ê–ú:**

```typescript
export const SESSION_CONSTANTS = {
  // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  ENVIRONMENTS: {
    MOCK: 'mock',
    DEVELOPMENT: 'development',
    PRODUCTION: 'production',
  } as const,

  MIGRATION_STRATEGIES: {
    MOCK_ONLY: 'mock-only',
    PRODUCTION_ONLY: 'production-only',
    GRADUAL: 'gradual',
    WRITE_THROUGH: 'mock-with-write-through',
  } as const,

  REDIS: {
    SESSION_PREFIX: 'session:', // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –¥–ª—è backward compatibility
    MAX_RETRIES: 3,
    // ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –Ω–æ–≤—ã–µ prefixes –¥–ª—è multi-app namespace
    APP_SESSION_PREFIX: 'session:', // Base prefix
    WEB_SESSION_PREFIX: 'session:web:',
    ADMIN_SESSION_PREFIX: 'session:admin:',
  } as const,

  DATABASE: {
    MAX_CONNECTIONS: 10,
    CONNECTION_TIMEOUT: 5000,
  } as const,

  // ‚úÖ –ù–û–í–´–ï –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è application context
  APPLICATION_CONTEXT: {
    WEB: 'web',
    ADMIN: 'admin',
  } as const,
} as const;

// ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã
export type SessionEnvironment =
  (typeof SESSION_CONSTANTS.ENVIRONMENTS)[keyof typeof SESSION_CONSTANTS.ENVIRONMENTS];

export type SessionMigrationStrategy =
  (typeof SESSION_CONSTANTS.MIGRATION_STRATEGIES)[keyof typeof SESSION_CONSTANTS.MIGRATION_STRATEGIES];

// ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –Ω–æ–≤—ã–π —Ç–∏–ø –¥–ª—è application context
export type ApplicationContext =
  (typeof SESSION_CONSTANTS.APPLICATION_CONTEXT)[keyof typeof SESSION_CONSTANTS.APPLICATION_CONTEXT];
```

### 1.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `packages/constants/src/user.ts`

**‚úÖ –î–û–ë–ê–í–ò–¢–¨ export –¥–ª—è ApplicationContext:**

```typescript
// ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ö–û–î –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
export const APP_SCOPE = {
  ADMIN_PANEL: 'admin-panel',
  WEB_APP: 'web',
} as const;

// ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú —Å–≤—è–∑—å –º–µ–∂–¥—É APP_SCOPE –∏ SESSION APPLICATION_CONTEXT
export const APP_SCOPE_TO_SESSION_CONTEXT = {
  [APP_SCOPE.WEB_APP]: 'web',
  [APP_SCOPE.ADMIN_PANEL]: 'admin',
} as const;

// ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú utility function –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
export function getSessionContextFromAppScope(appScope: AppScope): string {
  return APP_SCOPE_TO_SESSION_CONTEXT[appScope];
}

// ‚úÖ Re-export ApplicationContext –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
export type { ApplicationContext } from './session';
```

---

## –≠–¢–ê–ü 2: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Prisma —Å—Ö–µ–º—ã –¥–ª—è Application Context

### 2.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `packages/session-management/prisma/schema.prisma`

**‚úÖ –î–û–ë–ê–í–ò–¢–¨ –ø–æ–ª–µ applicationContext –≤ Session –º–æ–¥–µ–ª—å:**

```prisma
// ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–µ–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

model Session {
  id           String    @id @db.VarChar(255)
  userId       String    @map("user_id") @db.Uuid
  data         Json?     @db.JsonB
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  lastActivity DateTime  @default(now()) @map("last_activity") @db.Timestamptz(6)
  ipAddress    String?   @map("ip_address") @db.Inet
  userAgent    String?   @map("user_agent") @db.Text
  revoked      Boolean   @default(false)
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz(6)

  // ‚úÖ –ù–û–í–û–ï –ø–æ–ª–µ –¥–ª—è application context —Å default 'web' –¥–ª—è backward compatibility
  applicationContext ApplicationType @default(WEB) @map("application_context")

  // Relations –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ‚úÖ –û–ë–ù–û–í–õ–Ø–ï–ú indexes - –¥–æ–±–∞–≤–ª—è–µ–º applicationContext
  @@index([userId])
  @@index([applicationContext, userId]) // ‚úÖ –ù–û–í–´–ô –∏–Ω–¥–µ–∫—Å –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º
  @@index([expiresAt])
  @@index([createdAt])
  @@index([revoked])
  @@map("sessions")
}

// ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ enums, –î–û–ë–ê–í–õ–Ø–ï–ú ApplicationType
enum UserRole {
  USER     @map("user")
  ADMIN    @map("admin")
  OPERATOR @map("operator")
  SUPPORT  @map("support")
}

// ‚úÖ –ù–û–í–´–ô enum –¥–ª—è application context
enum ApplicationType {
  WEB      @map("web")
  ADMIN    @map("admin")
}
```

---

## –≠–¢–ê–ü 3: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ RedisSessionAdapter –¥–ª—è Context Support

### 3.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `packages/session-management/src/adapters/redis-session-adapter.ts`

**‚úÖ –î–û–ë–ê–í–ò–¢–¨ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π context –ø–∞—Ä–∞–º–µ—Ç—Ä:**

```typescript
import { SESSION_CONSTANTS, type ApplicationContext } from '@repo/constants';
import { Redis } from 'ioredis';

import type { SessionAdapter, SessionData } from '../types/index.js';

export class RedisSessionAdapter implements SessionAdapter {
  // ‚úÖ –†–ê–°–®–ò–†–Ø–ï–ú –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä - –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π context
  constructor(
    private redis: Redis,
    private context?: ApplicationContext // ‚úÖ –û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ô –¥–ª—è backward compatibility
  ) {}

  // ‚úÖ –ù–û–í–´–ô –º–µ—Ç–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ context-aware –∫–ª—é—á–µ–π
  private generateSessionKey(sessionId: string): string {
    if (this.context) {
      // –ù–æ–≤–∞—è —Å—Ö–µ–º–∞: session:web:abc123 –∏–ª–∏ session:admin:abc123
      return `${SESSION_CONSTANTS.REDIS.APP_SESSION_PREFIX}${this.context}:${sessionId}`;
    }
    // ‚úÖ FALLBACK –Ω–∞ —Å—Ç–∞—Ä—É—é —Å—Ö–µ–º—É –¥–ª—è backward compatibility
    return `${SESSION_CONSTANTS.REDIS.SESSION_PREFIX}${sessionId}`;
  }

  // ‚úÖ –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô - —Ç–æ–ª—å–∫–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—ã–π generateSessionKey

  async get(sessionId: string): Promise<SessionData | null> {
    try {
      const key = this.generateSessionKey(sessionId);
      const data = await this.redis.get(key);

      if (!data) return null;

      const parsed = JSON.parse(data) as SessionData;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ TTL –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      if (parsed.expires_at < Date.now()) {
        await this.delete(sessionId);
        return null;
      }

      return parsed;
    } catch {
      return null;
    }
  }

  async set(sessionId: string, data: SessionData, ttl: number): Promise<void> {
    try {
      const key = this.generateSessionKey(sessionId);
      await this.redis.set(key, JSON.stringify(data), 'EX', ttl);
    } catch (error) {
      throw new Error(
        `Failed to store session: ${error instanceof Error ? error.message : 'Unknown error'}`
      );
    }
  }

  async delete(sessionId: string): Promise<void> {
    try {
      const key = this.generateSessionKey(sessionId);
      await this.redis.del(key);
    } catch {
      // Delete errors are non-critical
    }
  }

  async extend(sessionId: string, ttl: number): Promise<void> {
    try {
      const key = this.generateSessionKey(sessionId);
      await this.redis.expire(key, ttl);
    } catch {
      // Extension errors are non-critical
    }
  }
}
```

---

## –≠–¢–ê–ü 4: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ UserManagerFactory –¥–ª—è Context Support

### 4.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `packages/session-management/src/factories/user-manager-factory.ts`

**‚úÖ –î–û–ë–ê–í–ò–¢–¨ –ø–æ–¥–¥–µ—Ä–∂–∫—É context –≤ Factory:**

```typescript
// ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–º–ø–æ—Ä—Ç—ã, –î–û–ë–ê–í–õ–Ø–ï–ú ApplicationContext
import { SESSION_CONSTANTS, type ApplicationContext } from '@repo/constants';
import { userManager as mockUserManager } from '@repo/exchange-core';

import { PostgreSQLUserAdapter } from '../adapters/postgres-user-adapter';
import { RedisSessionAdapter } from '../adapters/redis-session-adapter';
import { ProductionUserManager } from '../managers/production-user-manager';

// ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

// ‚úÖ –†–ê–°–®–ò–†–Ø–ï–ú —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ManagerConfiguration
export interface ManagerConfiguration {
  environment?: ManagerEnvironment;
  database?: {
    url: string;
    maxConnections?: number;
  };
  redis?: {
    url: string;
    maxRetries?: number;
  };
  // ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π context
  context?: ApplicationContext;
}

export class UserManagerFactory {
  // ‚úÖ –í–°–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –ú–ï–¢–û–î–´ –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
  private static cachedUserManager: UserManagerInterface | null = null;
  private static cachedConfig: string | null = null;

  // ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –º–µ—Ç–æ–¥ create –æ—Å—Ç–∞–µ—Ç—Å—è –ü–û–õ–ù–û–°–¢–¨–Æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  static async create(config: ManagerConfiguration = {}): Promise<UserManagerInterface> {
    // –í—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–π
    const configKey = JSON.stringify(config);
    if (this.cachedUserManager && this.cachedConfig === configKey) {
      return this.cachedUserManager;
    }

    const environment = config.environment || getEnvironment();
    this.logEnvironmentDebug(environment, config);
    const userManager = await this.createManagerByEnvironment(environment, config);

    this.cachedUserManager = userManager;
    this.cachedConfig = configKey;

    return userManager;
  }

  // ‚úÖ –†–ê–°–®–ò–†–Ø–ï–ú createForContext –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ application context
  static async createForContext(context?: ApplicationContext): Promise<UserManagerInterface> {
    // –ï—Å–ª–∏ context –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π create (backward compatibility)
    if (!context) {
      return await this.create();
    }

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º context
    return await this.create({
      context,
    });
  }

  // ‚úÖ –ù–û–í–´–ô convenience –º–µ—Ç–æ–¥ –¥–ª—è web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  static async createForWeb(): Promise<UserManagerInterface> {
    return await this.createForContext(SESSION_CONSTANTS.APPLICATION_CONTEXT.WEB);
  }

  // ‚úÖ –ù–û–í–´–ô convenience –º–µ—Ç–æ–¥ –¥–ª—è admin –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  static async createForAdmin(): Promise<UserManagerInterface> {
    return await this.createForContext(SESSION_CONSTANTS.APPLICATION_CONTEXT.ADMIN);
  }

  // ‚úÖ –û–ë–ù–û–í–õ–Ø–ï–ú createSessionAdapter –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ context
  private static async createSessionAdapter(
    redisConfig: NonNullable<ManagerConfiguration['redis']>,
    context?: ApplicationContext // ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú context –ø–∞—Ä–∞–º–µ—Ç—Ä
  ): Promise<SessionAdapter> {
    const { Redis } = await import('ioredis');
    const redis = new Redis(redisConfig.url, {
      maxRetriesPerRequest: redisConfig.maxRetries || SESSION_CONSTANTS.REDIS.MAX_RETRIES,
    });

    // ‚úÖ –ü–ï–†–ï–î–ê–ï–ú context –≤ RedisSessionAdapter
    return new RedisSessionAdapter(redis, context);
  }

  // ‚úÖ –û–ë–ù–û–í–õ–Ø–ï–ú createProductionManager –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ context
  private static async createProductionManager(
    config: ManagerConfiguration
  ): Promise<ProductionUserManager> {
    if (!config.database?.url || !config.redis?.url) {
      throw new Error('Production environment requires database and redis configuration');
    }

    const databaseAdapter = await this.createDatabaseAdapter(config.database);
    // ‚úÖ –ü–ï–†–ï–î–ê–ï–ú context –≤ createSessionAdapter
    const sessionAdapter = await this.createSessionAdapter(config.redis, config.context);

    return new ProductionUserManager(databaseAdapter, sessionAdapter);
  }

  // ‚úÖ –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
}
```

---

## –≠–¢–ê–ü 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ProductionUserManager –¥–ª—è Context Support

### 5.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `packages/session-management/src/managers/production-user-manager.ts`

**‚úÖ –î–û–ë–ê–í–ò–¢–¨ context –≤ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π:**

```typescript
// ‚úÖ –í–°–ï –∏–º–ø–æ—Ä—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
import { generateSessionId } from '@repo/exchange-core';
import { SESSION_CONSTANTS } from '@repo/constants';

import type {
  User,
  CreateUserData,
  UserManagerInterface,
  DatabaseAdapter,
  SessionAdapter,
  SessionMetadata,
  SessionData,
} from '../types/index.js';

export class ProductionUserManager implements UserManagerInterface {
  // ‚úÖ –ö–û–ù–°–¢–†–£–ö–¢–û–† –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  constructor(
    private db: DatabaseAdapter,
    private sessions: SessionAdapter
  ) {}

  // ‚úÖ –í–°–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –ú–ï–¢–û–î–´ –æ—Å—Ç–∞—é—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
  async findByEmail(email: string): Promise<User | undefined> {
    const user = await this.db.users.findByEmail(email);
    return user || undefined;
  }

  async findById(id: string): Promise<User | undefined> {
    const user = await this.db.users.findById(id);
    return user || undefined;
  }

  // ‚úÖ findBySessionId –æ—Å—Ç–∞–µ—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô - Redis adapter —Å–∞–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç context
  async findBySessionId(sessionId: string): Promise<User | undefined> {
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–π
    const sessionData = await this.sessions.get(sessionId);

    if (sessionData && sessionData.expires_at > Date.now()) {
      const user = await this.db.users.findById(sessionData.user_id);
      return user || undefined;
    }

    if (sessionData) {
      await this.sessions.delete(sessionId);
    }

    try {
      const user = await this.db.users.findBySessionId?.(sessionId);
      return user || undefined;
    } catch {
      return undefined;
    }
  }

  // ‚úÖ –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –æ—Å—Ç–∞—é—Ç—Å—è –ò–î–ï–ù–¢–ò–ß–ù–´–ú–ò
  async create(userData: CreateUserData): Promise<User> {
    return await this.db.users.create(userData);
  }

  async update(id: string, updateData: Partial<User>): Promise<User | null> {
    return await this.db.users.update(id, updateData);
  }

  // ‚úÖ createSession –æ—Å—Ç–∞–µ—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô - Redis adapter –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç context –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  async createSession(userId: string, metadata: SessionMetadata, ttl: number): Promise<string> {
    const sessionId = generateSessionId();
    const sessionData: SessionData = {
      user_id: userId,
      created_at: Date.now(),
      expires_at: Date.now() + ttl * 1000,
      ip: metadata.ip,
      user_agent: metadata.userAgent,
    };

    await this.sessions.set(sessionId, sessionData, ttl);
    return sessionId;
  }

  // ‚úÖ deleteSession –∏ extendSession –æ—Å—Ç–∞—é—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
  async deleteSession(sessionId: string): Promise<void> {
    await this.sessions.delete(sessionId);
  }

  async extendSession(sessionId: string, ttl: number): Promise<void> {
    await this.sessions.extend(sessionId, ttl);
  }

  // ‚úÖ –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –æ—Å—Ç–∞—é—Ç—Å—è –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–º–∏
  async getAll(): Promise<User[]> {
    // Mock compatibility method
    return [];
  }

  async count(): Promise<number> {
    return 0;
  }
}
```

```typescript
// ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –°–û–•–†–ê–ù–Ø–ï–ú —Å—Ç–∞—Ä—ã–π
export interface MultiDatabaseConfiguration {
  environment?: ManagerEnvironment;
  databases?: {
    identity?: string; // URL –¥–ª—è identity –ë–î
    web?: string; // URL –¥–ª—è web –ë–î
  };
  redis?: {
    url: string;
    maxRetries?: number;
  };
  context?: ApplicationContext;
}

// ‚úÖ –†–ê–°–®–ò–†–Ø–ï–ú —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ManagerConfiguration
export interface ManagerConfiguration {
  environment?: ManagerEnvironment;
  database?: {
    url: string;
    maxConnections?: number;
  };
  redis?: {
    url: string;
    maxRetries?: number;
  };
  // ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É multi-database
  multiDatabase?: MultiDatabaseConfiguration['databases'];
  context?: ApplicationContext;
}
```

**‚úÖ –î–û–ë–ê–í–ò–¢–¨ –ù–û–í–´–ô –ú–ï–¢–û–î createMultiDatabase (–Ω–µ –∑–∞–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ):**

```typescript
export class UserManagerFactory {
  // ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã

  // ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –¥–ª—è multi-database –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
  static async createMultiDatabase(
    config: MultiDatabaseConfiguration = {}
  ): Promise<UserManagerInterface> {
    const environment = config.environment || getEnvironment();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è multi-database
    if (config.databases?.identity) {
      return await this.createMultiDatabaseManager(config);
    }

    // Fallback –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º
    return await this.create(config as ManagerConfiguration);
  }

  // ‚úÖ –ù–û–í–´–ô –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è multi-database manager
  private static async createMultiDatabaseManager(
    config: MultiDatabaseConfiguration
  ): Promise<UserManagerInterface> {
    if (!config.databases?.identity) {
      throw new Error('Identity database URL is required for multi-database configuration');
    }

    const identityAdapter = await this.createDatabaseAdapterForUrl(config.databases.identity);
    const context = config.context || 'web';
    const sessionAdapter = await this.createSessionAdapterWithContext(config.redis!, context);

    return new ProductionUserManager(identityAdapter, sessionAdapter);
  }

  // ‚úÖ –ù–û–í–´–ô helper –º–µ—Ç–æ–¥
  private static async createDatabaseAdapterForUrl(url: string): Promise<DatabaseAdapter> {
    const prismaConfig: PrismaClientConfig = {
      url,
      maxConnections: SESSION_CONSTANTS.DATABASE.MAX_CONNECTIONS,
      connectionTimeout: SESSION_CONSTANTS.DATABASE.CONNECTION_TIMEOUT,
    };

    const prisma = getPrismaClient(prismaConfig);

    return {
      users: new PostgreSQLUserAdapter(prisma),
    };
  }

  // ‚úÖ –ù–û–í–´–ô –º–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è session adapter —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  private static async createSessionAdapterWithContext(
    redisConfig: NonNullable<MultiDatabaseConfiguration['redis']>,
    context: ApplicationContext
  ): Promise<SessionAdapter> {
    const { Redis } = await import('ioredis');
    const redis = new Redis(redisConfig.url, {
      maxRetriesPerRequest: redisConfig.maxRetries || SESSION_CONSTANTS.REDIS.MAX_RETRIES,
    });

    return new RedisSessionAdapter(redis, context);
  }

  // ‚úÖ –†–ê–°–®–ò–†–Ø–ï–ú createForContext –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ multi-database
  static async createForContext(context?: ApplicationContext): Promise<UserManagerInterface> {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è multi-database
    const identityUrl = process.env.DATABASE_IDENTITY_URL;

    if (identityUrl) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é multi-database –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
      return await this.createMultiDatabase({
        databases: {
          identity: identityUrl,
          web: process.env.DATABASE_WEB_URL,
        },
        redis: {
          url: process.env.REDIS_URL!,
        },
        context,
      });
    }

    // Fallback –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º
    return await this.create();
  }
}
```

---

## –≠–¢–ê–ü 4: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 4.1 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–°–û–•–†–ê–ù–Ø–ï–ú —Å—Ç–∞—Ä—ã–µ)

**‚úÖ –î–û–ë–ê–í–ò–¢–¨ –í `.env.local` (—Ä—è–¥–æ–º —Å–æ —Å—Ç–∞—Ä—ã–º–∏):**

```bash
# ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–°–û–•–†–ê–ù–Ø–ï–ú)
DATABASE_URL="postgresql://user:password@localhost:5432/exchanger_db"
REDIS_URL="redis://localhost:6379"
REDIS_MAX_RETRIES=3

# ‚úÖ –ù–û–í–´–ï –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è multi-database –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–î–û–ë–ê–í–õ–Ø–ï–ú)
DATABASE_IDENTITY_URL="postgresql://user:password@localhost:5432/exchanger_identity"
DATABASE_WEB_URL="postgresql://user:password@localhost:5432/exchanger_web"

# ‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key"
```

### 4.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `docker-compose.yml` (–¥–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)

**‚úÖ –†–ê–°–®–ò–†–ò–¢–¨ —Å–µ–∫—Ü–∏—é postgres:**

```yaml
postgres:
  image: postgres:15-alpine
  container_name: exchanger-postgres
  restart: unless-stopped
  environment:
    POSTGRES_DB: ${POSTGRES_DB:-exchanger_db} # ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú —Å—Ç–∞—Ä—É—é –ë–î
    POSTGRES_USER: ${POSTGRES_USER:-exchanger_user}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-exchanger_password}
    POSTGRES_HOST_AUTH_METHOD: trust
  ports:
    - '${POSTGRES_PORT:-5432}:5432'
  volumes:
    - postgres_data:/var/lib/postgresql/data
    - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro # ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú —Å—Ç–∞—Ä—ã–π
    - ./docker/postgres/init-multi-dbs.sql:/docker-entrypoint-initdb.d/02-multi-dbs.sql:ro # ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –Ω–æ–≤—ã–π
  networks:
    - exchanger-network
```

### 4.3 –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ë–î

**‚úÖ –°–û–ó–î–ê–¢–¨ –ù–û–í–´–ô –§–ê–ô–õ:** `docker/postgres/init-multi-dbs.sql`

```sql
-- ‚úÖ –°–û–ó–î–ê–ï–ú –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ë–î –¥–ª—è multi-database –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
-- –û—Å–Ω–æ–≤–Ω–∞—è –ë–î exchanger_db —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ –≤ init.sql

-- –°–æ–∑–¥–∞–µ–º Identity –ë–î (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
SELECT 'CREATE DATABASE exchanger_identity'
WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'exchanger_identity')\gexec

-- –°–æ–∑–¥–∞–µ–º Web –ë–î (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
SELECT 'CREATE DATABASE exchanger_web'
WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'exchanger_web')\gexec

-- –î–∞–µ–º –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ –Ω–æ–≤—ã–µ –ë–î
DO $$
BEGIN
  -- Identity –ë–î
  IF EXISTS (SELECT 1 FROM pg_database WHERE datname = 'exchanger_identity') THEN
    EXECUTE 'GRANT ALL PRIVILEGES ON DATABASE exchanger_identity TO ' || current_user;
  END IF;

  -- Web –ë–î
  IF EXISTS (SELECT 1 FROM pg_database WHERE datname = 'exchanger_web') THEN
    EXECUTE 'GRANT ALL PRIVILEGES ON DATABASE exchanger_web TO ' || current_user;
  END IF;
END $$;

\echo '‚úÖ Multi-database setup completed'
```

---

## –≠–¢–ê–ü 5: –°–æ–∑–¥–∞–Ω–∏–µ Prisma —Å—Ö–µ–º –¥–ª—è –Ω–æ–≤—ã—Ö –ë–î

### 5.1 –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –¥–ª—è Identity –ë–î

**‚úÖ –°–û–ó–î–ê–¢–¨ –ù–û–í–´–ô –§–ê–ô–õ:** `packages/session-management/prisma/identity.prisma`

```prisma
// ‚úÖ –°–•–ï–ú–ê –î–õ–Ø IDENTITY –ë–î (shared across all applications)
generator client {
  provider = "prisma-client-js"
  output   = "../generated/identity-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_IDENTITY_URL")
}

model User {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email          String    @unique @db.VarChar(255)
  hashedPassword String?   @map("hashed_password") @db.Text
  isVerified     Boolean   @default(false) @map("is_verified")
  role           UserRole  @default(USER)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  lastLoginAt    DateTime? @map("last_login_at") @db.Timestamptz(6)
  sessionId      String?   @map("session_id") @db.VarChar(255)

  // Relations
  sessions    Session[]
  permissions UserPermission[]

  // Indexes
  @@index([email])
  @@index([sessionId])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Session {
  id                String          @id @db.VarChar(255)
  userId            String          @map("user_id") @db.Uuid
  applicationContext ApplicationType @default(WEB) @map("application_context")
  data              Json?           @db.JsonB
  expiresAt         DateTime        @map("expires_at") @db.Timestamptz(6)
  createdAt         DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  lastActivity      DateTime        @default(now()) @map("last_activity") @db.Timestamptz(6)
  ipAddress         String?         @map("ip_address") @db.Inet
  userAgent         String?         @map("user_agent") @db.Text
  revoked           Boolean         @default(false)
  revokedAt         DateTime?       @map("revoked_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([applicationContext, userId])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([revoked])
  @@map("sessions")
}

model UserPermission {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String          @map("user_id") @db.Uuid
  permission        String          @db.VarChar(100)
  applicationContext ApplicationType @default(WEB) @map("application_context")
  grantedAt         DateTime        @default(now()) @map("granted_at") @db.Timestamptz(6)
  grantedBy         String?         @map("granted_by") @db.Uuid
  expiresAt         DateTime?       @map("expires_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission, applicationContext])
  @@index([applicationContext, userId])
  @@index([permission])
  @@map("user_permissions")
}

enum UserRole {
  USER     @map("user")
  ADMIN    @map("admin")
}

enum ApplicationType {
  WEB      @map("web")
}
```

### 5.2 –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –¥–ª—è Web –ë–î

**‚úÖ –°–û–ó–î–ê–¢–¨ –ù–û–í–´–ô –§–ê–ô–õ:** `packages/session-management/prisma/web.prisma`

```prisma
// ‚úÖ –°–•–ï–ú–ê –î–õ–Ø WEB –ë–î (–¢–û–õ–¨–ö–û –≤–µ–±-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–π)
generator client {
  provider = "prisma-client-js"
  output   = "../generated/web-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_WEB_URL")
}

// –¢–û–õ–¨–ö–û –≤–µ–±-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–π
model WebSession {
  id           String   @id @db.VarChar(255)
  userId       String   @map("user_id") @db.Uuid // Reference to identity.users
  data         Json?    @db.JsonB
  preferences  Json?    @db.JsonB // –í–µ–±-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  theme        String?  @db.VarChar(20)
  language     String?  @db.VarChar(10)
  expiresAt    DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  lastActivity DateTime @default(now()) @map("last_activity") @db.Timestamptz(6)

  @@index([userId])
  @@index([expiresAt])
  @@map("web_sessions")
}

// –í–µ–±-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∫—ç—à –¥–∞–Ω–Ω—ã—Ö
model WebUserCache {
  userId    String   @id @map("user_id") @db.Uuid
  data      Json     @db.JsonB
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("web_user_cache")
}
```

---

## –≠–¢–ê–ü 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Context

### 6.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `apps/web/src/server/trpc/context.ts`

**‚úÖ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï CONTEXT-AWARE UserManagerFactory:**

```typescript
// ‚úÖ –í–°–ï –∏–º–ø–æ—Ä—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
import { UserManagerFactory } from '@repo/session-management';
import { SESSION_CONSTANTS } from '@repo/constants';

export const createContext = async (opts: CreateNextContextOptions) => {
  // ‚úÖ –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const { req, res } = opts;
  const ip = req.ip || req.socket.remoteAddress || '0.0.0.0';
  let user: User | null = null;

  const sessionId = req.cookies.sessionId || req.headers.authorization?.replace('Bearer ', '');

  if (sessionId) {
    try {
      // ‚úÖ –ò–ó–ú–ï–ù–Ø–ï–ú –¢–û–õ–¨–ö–û —ç—Ç—É —Å—Ç—Ä–æ–∫—É - –¥–æ–±–∞–≤–ª—è–µ–º context –¥–ª—è web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      const userManager = await UserManagerFactory.createForContext(
        SESSION_CONSTANTS.APPLICATION_CONTEXT.WEB
      );
      const foundUser = await userManager.findBySessionId(sessionId);
      user = foundUser || null;
    } catch (error) {
      console.error('Session validation error:', error);
    }
  }

  // ‚úÖ –í–°–ï –æ—Å—Ç–∞–ª—å–Ω–æ–µ –æ—Å—Ç–∞–µ—Ç—Å—è –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–º
  const acceptLanguage = req.headers['accept-language'] || '';
  const locale = getLocaleFromAcceptLanguage(acceptLanguage);
  const getErrorMessage = createErrorMessageFunction(locale);

  return {
    req,
    res,
    ip,
    user,
    sessionId,
    locale,
    getErrorMessage,
  };
};
```

### 6.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `apps/web/src/server/trpc/routers/auth.ts`

**‚úÖ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï WEB CONTEXT:**

```typescript
// ‚úÖ –í–°–ï –∏–º–ø–æ—Ä—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
// –¢–æ–ª—å–∫–æ –∑–∞–º–µ–Ω—è–µ–º UserManagerFactory.create() –Ω–∞ UserManagerFactory.createForWeb()

// –í register mutation:
const webUserManager = await UserManagerFactory.createForWeb(); // ‚úÖ –ë–´–õ–û: .create()

// –í login mutation:
const webUserManager = await UserManagerFactory.createForWeb(); // ‚úÖ –ë–´–õ–û: .create()

// –í logout mutation:
const webUserManager = await UserManagerFactory.createForWeb(); // ‚úÖ –ë–´–õ–û: .create()

// ‚úÖ –í–°–ï –û–°–¢–ê–õ–¨–ù–û–ï –æ—Å—Ç–∞–µ—Ç—Å—è –ò–î–ï–ù–¢–ò–ß–ù–´–ú
```

### 6.3 –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è admin-panel (–±—É–¥—É—â–µ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

**‚úÖ –°–û–ó–î–ê–¢–¨ –§–ê–ô–õ:** `apps/admin-panel/src/server/trpc/context.ts` (–∫–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)

```typescript
// ‚úÖ –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ web context, –Ω–æ —Å ADMIN –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
export const createContext = async (opts: CreateNextContextOptions) => {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ ...

  if (sessionId) {
    try {
      // ‚úÖ ADMIN –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Å–µ—Å—Å–∏–π
      const userManager = await UserManagerFactory.createForContext(
        SESSION_CONSTANTS.APPLICATION_CONTEXT.ADMIN
      );
      const foundUser = await userManager.findBySessionId(sessionId);
      user = foundUser || null;
    } catch (error) {
      console.error('Session validation error:', error);
    }
  }

  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ web context ...
};
```

---

## –≠–¢–ê–ü 7: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 7.1 –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Prisma —Å—Ö–µ–º—ã (–±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏)

```powershell
# ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –≤ session-management –ø–∞–∫–µ—Ç
cd packages/session-management

# ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ Prisma –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è schema.prisma
npx prisma generate

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ TypeScript
npx tsc --noEmit

# ‚úÖ –°–±—Ä–æ—Å –ë–î –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ - –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç)
npx prisma db push --force-reset
```

### 7.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```powershell
# ‚úÖ –ó–∞–ø—É—Å–∫ web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cd ../../apps/web
npm run dev

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–æ–≤—ã–º–∏ session –∫–ª—é—á–∞–º–∏
# –û–∂–∏–¥–∞–µ–º—ã–µ Redis –∫–ª—é—á–∏: session:web:abc123...

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Redis –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–ª—é—á–µ–π
docker exec exchanger-redis redis-cli KEYS "*session:web:*"
```

---

## üîç –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê –ú–ò–ì–†–ê–¶–ò–ò

### ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **Session —Ç–∞–±–ª–∏—Ü–∞**: –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `application_context` —Å default 'web'
2. **Redis namespace**: –Ω–æ–≤—ã–µ –∫–ª—é—á–∏ `session:web:sessionId` –¥–ª—è web —Å–µ—Å—Å–∏–π
3. **Backward compatibility**: —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
4. **UserManagerFactory**: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç createForWeb() –∏ createForAdmin()
5. **Web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ web —Å–µ—Å—Å–∏–∏

### üîç –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:

```powershell
# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Sessions —Ç–∞–±–ª–∏—Ü—ã
docker exec exchanger-postgres psql -U exchanger_user -d exchanger_db -c "\d sessions"

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π –≤ Redis
docker exec exchanger-redis redis-cli KEYS "*session:*"

# ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã TypeScript
cd packages/session-management && npx tsc --noEmit
cd ../../apps/web && npx tsc --noEmit
```

### üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:

- **Sessions —Ç–∞–±–ª–∏—Ü–∞** —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ `application_context`
- **Redis** —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–∏ —Ñ–æ—Ä–º–∞—Ç–∞ `session:web:*`
- **Web –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- **TypeScript** –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- **Backward compatibility** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø –ü–û –ú–ò–ì–†–ê–¶–ò–ò

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:

1. **üì¶ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –±—ç–∫–∞–ø**: –°–¥–µ–ª–∞—Ç—å –¥–∞–º–ø –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
2. **üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–æ–ø–∏–∏**: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏
3. **ÔøΩ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ**: –ü–æ—ç—Ç–∞–ø–Ω–æ –≤ production

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

1. **‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. **üîê –°–µ—Å—Å–∏–∏**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è/–≤–∞–ª–∏–¥–∞—Ü–∏–∏
3. **üíæ Redis**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∏ –Ω–æ–≤—ã–µ patterns
4. **üóÑÔ∏è PostgreSQL**: –ù–∞–≥—Ä—É–∑–∫–∞ –∏ performance –Ω–æ–≤—ã—Ö indexes

### üîÑ Rollback –ø–ª–∞–Ω:

1. **‚è™ Prisma**: –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ `npx prisma migrate reset`
2. **ÔøΩ Code**: Revert –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ context.ts –∏ auth.ts
3. **ÔøΩ Data**: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## üìù –ò–¢–û–ì–û–í–´–ô –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

**‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: ~45 –º–∏–Ω—É—Ç

### üöÄ –≠—Ç–∞–ø 1 (15 –º–∏–Ω): –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏ –∞–¥–∞–ø—Ç–µ—Ä–æ–≤

- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ SESSION_CONSTANTS —Å APPLICATION_CONTEXT
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ RedisSessionAdapter –¥–ª—è context support

### üèóÔ∏è –≠—Ç–∞–ø 2 (15 –º–∏–Ω): –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UserManagerFactory –∏ Prisma

- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ context –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ Factory
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Prisma —Å—Ö–µ–º—ã —Å applicationContext –ø–æ–ª–µ

### ‚úÖ –≠—Ç–∞–ø 3 (15 –º–∏–Ω): –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- Prisma –º–∏–≥—Ä–∞—Ü–∏—è –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è context
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:

**–ì–æ—Ç–æ–≤–∞—è multi-app session –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å:**

- **Session –∏–∑–æ–ª—è—Ü–∏—è**: Web –∏ Admin —Å–µ—Å—Å–∏–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–æ context
- **Redis namespace**: `session:web:*` –∏ `session:admin:*` –∫–ª—é—á–∏
- **Database context**: application_context –ø–æ–ª–µ –≤ Sessions —Ç–∞–±–ª–∏—Ü–µ
- **Backward compatibility**: 100% —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é**: –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ telegram-bot –∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

---

## –≠–¢–ê–ü 8: CLEANUP - –£–¥–∞–ª–µ–Ω–∏–µ Backward Compatibility (–ü–æ—Å–ª–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏)

> ‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï**: –≠—Ç–æ—Ç —ç—Ç–∞–ø –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π –≤ production

### üéØ –¶–ï–õ–¨: –£–¥–∞–ª–µ–Ω–∏–µ –º—É—Å–æ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞ –∏ —É–ø—Ä–æ—â–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–∏–≥—Ä–∏—Ä–æ–≤–∞–ª–∏ –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ –∏—Å—Ç–µ–∫–ª–∏, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å backward compatibility –∫–æ–¥ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

### 8.1 –û—á–∏—Å—Ç–∫–∞ Redis –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ –≤ `packages/constants/src/session.ts`

**‚úÖ –£–î–ê–õ–ò–¢–¨ –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã:**

```typescript
export const SESSION_CONSTANTS = {
  // ... existing constants ...

  REDIS: {
    // ‚ùå –£–î–ê–õ–ò–¢–¨: SESSION_PREFIX: 'session:',  // –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
    // ‚ùå –£–î–ê–õ–ò–¢–¨: APP_SESSION_PREFIX: 'session:',  // –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
    MAX_RETRIES: 3,
    // ‚úÖ –û–°–¢–ê–í–õ–Ø–ï–ú —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ prefixes
    WEB_SESSION_PREFIX: 'session:web:',
    ADMIN_SESSION_PREFIX: 'session:admin:',
  } as const,

  // ... rest stays the same ...
} as const;
```

### 8.2 –£–ø—Ä–æ—â–µ–Ω–∏–µ RedisSessionAdapter

**‚úÖ –£–î–ê–õ–ò–¢–¨ fallback –ª–æ–≥–∏–∫—É:**

```typescript
export class RedisSessionAdapter implements SessionAdapter {
  // ‚úÖ –£–ü–†–û–©–ê–ï–ú: context —Ç–µ–ø–µ—Ä—å –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô –ø–∞—Ä–∞–º–µ—Ç—Ä
  constructor(
    private redis: Redis,
    private context: ApplicationContext // ‚ùå –£–î–ê–õ–Ø–ï–ú: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
  ) {}

  // ‚úÖ –£–ü–†–û–©–ê–ï–ú: —É–¥–∞–ª—è–µ–º fallback –ª–æ–≥–∏–∫—É
  private generateSessionKey(sessionId: string): string {
    // ‚ùå –£–î–ê–õ–Ø–ï–ú –≤–µ—Å—å fallback –∫–æ–¥:
    // if (this.context) {
    //   return `${SESSION_CONSTANTS.REDIS.APP_SESSION_PREFIX}${this.context}:${sessionId}`;
    // }
    // return `${SESSION_CONSTANTS.REDIS.SESSION_PREFIX}${sessionId}`;

    // ‚úÖ –¢–û–õ–¨–ö–û –Ω–æ–≤–∞—è —Å—Ö–µ–º–∞:
    return `${SESSION_CONSTANTS.REDIS.WEB_SESSION_PREFIX}${sessionId}`.replace('web', this.context);
  }

  // ‚úÖ –í–°–ï –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã —É–ø—Ä–æ—â–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
}
```

### 8.3 –£–ø—Ä–æ—â–µ–Ω–∏–µ UserManagerFactory

**‚úÖ –£–î–ê–õ–ò–¢–¨ —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã:**

```typescript
export class UserManagerFactory {
  // ‚ùå –£–î–ê–õ–ò–¢–¨: static async create(config: ManagerConfiguration = {})
  // ‚ùå –£–î–ê–õ–ò–¢–¨: static async createForContext(): Promise<UserManagerInterface>

  // ‚úÖ –û–°–¢–ê–í–õ–Ø–ï–ú —Ç–æ–ª—å–∫–æ context-aware –º–µ—Ç–æ–¥—ã:
  static async createForContext(context: ApplicationContext): Promise<UserManagerInterface> {
    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π create()
  }

  static async createForWeb(): Promise<UserManagerInterface> {
    return await this.createForContext(SESSION_CONSTANTS.APPLICATION_CONTEXT.WEB);
  }

  static async createForAdmin(): Promise<UserManagerInterface> {
    return await this.createForContext(SESSION_CONSTANTS.APPLICATION_CONTEXT.ADMIN);
  }

  // ‚ùå –£–î–ê–õ–ò–¢–¨: –≤—Å–µ –º–µ—Ç–æ–¥—ã createSessionAdapter –±–µ–∑ context –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  // ‚ùå –£–î–ê–õ–ò–¢–¨: createProductionManager –±–µ–∑ context –ø–æ–¥–¥–µ—Ä–∂–∫–∏
}
```

### 8.4 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ManagerConfiguration

**‚úÖ –°–î–ï–õ–ê–¢–¨ context –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ú:**

```typescript
export interface ManagerConfiguration {
  environment?: ManagerEnvironment;
  database?: {
    url: string;
    maxConnections?: number;
  };
  redis?: {
    url: string;
    maxRetries?: number;
  };
  // ‚úÖ –ò–ó–ú–ï–ù–Ø–ï–ú: context –±–æ–ª—å—à–µ –Ω–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π
  context: ApplicationContext; // ‚ùå –£–î–ê–õ–Ø–ï–ú: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
}
```

### 8.5 –£–¥–∞–ª–µ–Ω–∏–µ Prisma default –∑–Ω–∞—á–µ–Ω–∏—è

**‚úÖ –£–ë–†–ê–¢–¨ default –≤ schema.prisma:**

```prisma
model Session {
  // ... existing fields ...

  // ‚úÖ –ò–ó–ú–ï–ù–Ø–ï–ú: —É–±–∏—Ä–∞–µ–º default, context —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —è–≤–Ω–æ
  applicationContext ApplicationType @map("application_context")
  // ‚ùå –ë–´–õ–û: applicationContext ApplicationType @default(WEB) @map("application_context")

  // ... rest stays the same ...
}
```

### 8.6 –û—á–∏—Å—Ç–∫–∞ web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**‚úÖ –£–ü–†–û–°–¢–ò–¢–¨ context.ts:**

```typescript
export const createContext = async (opts: CreateNextContextOptions) => {
  // ... existing logic ...

  if (sessionId) {
    try {
      // ‚úÖ –£–ü–†–û–©–ê–ï–ú: –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–µ–º —è–≤–Ω—ã–π context
      const userManager = await UserManagerFactory.createForWeb();
      // ‚ùå –£–î–ê–õ–Ø–ï–ú: UserManagerFactory.createForContext() –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

      const foundUser = await userManager.findBySessionId(sessionId);
      user = foundUser || null;
    } catch (error) {
      console.error('Session validation error:', error);
    }
  }

  // ... rest stays the same ...
};
```

---

## üóëÔ∏è CLEANUP CHECKLIST

### –ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º cleanup:

- [ ] ‚úÖ –í—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- [ ] ‚úÖ –í—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏ –≤ Redis –∏—Å—Ç–µ–∫–ª–∏ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å: `KEYS session:*` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—ã—Ö –∫–ª—é—á–µ–π)
- [ ] ‚úÖ PostgreSQL Sessions —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ —Å applicationContext
- [ ] ‚úÖ Production –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –º–∏–Ω–∏–º—É–º 2 –Ω–µ–¥–µ–ª–∏
- [ ] ‚úÖ –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ cleanup

### –≠—Ç–∞–ø—ã cleanup:

1. **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã**: –£–¥–∞–ª–∏—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ SESSION_PREFIX –∏ APP_SESSION_PREFIX
2. **RedisSessionAdapter**: –£–±—Ä–∞—Ç—å fallback –ª–æ–≥–∏–∫—É –∏ —Å–¥–µ–ª–∞—Ç—å context –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º
3. **UserManagerFactory**: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–æ–¥—ã create() –∏ createForContext() –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
4. **ManagerConfiguration**: –°–¥–µ–ª–∞—Ç—å context –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–æ–ª–µ–º
5. **Prisma Schema**: –£–±—Ä–∞—Ç—å default –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è applicationContext
6. **Applications**: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π —É–±—Ä–∞–≤ fallback –ª–æ–≥–∏–∫—É

### –ü–æ—Å–ª–µ cleanup:

- [ ] ‚úÖ TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] ‚úÖ Production deployment –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- [ ] ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ deployment

---

## üéâ –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

**–ß–∏—Å—Ç–∞—è, –ø—Ä–æ—Å—Ç–∞—è, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è multi-app session –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

- **–°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è**: ApplicationContext –≤—Å–µ–≥–¥–∞ —è–≤–Ω–æ –∑–∞–¥–∞–Ω
- **–ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞**: –ù–µ—Ç fallback –∫–æ–¥–∞ –∏ legacy –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ Redis –∫–ª—é—á–µ–π
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —Å–µ—Å—Å–∏–π –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

```

```
