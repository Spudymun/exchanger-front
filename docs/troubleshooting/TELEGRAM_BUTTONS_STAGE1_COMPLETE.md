# Telegram Bot - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫ (–≠—Ç–∞–ø 1)

**–î–∞—Ç–∞:** 2025-10-11  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ P0 –ó–ê–í–ï–†–®–Å–ù - –¢–†–ï–ë–£–ï–¢–°–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Topics (`message_thread_id`)

**–§–∞–π–ª:** `apps/telegram-bot/pages/api/webhook.ts`

- ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `editTelegramMessage` –∏–∑ `telegram-api-helpers.ts`
- ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω `getPrismaClient` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ helper —Ñ—É–Ω–∫—Ü–∏—è `getTopicIdForOrder()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è topicId –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```typescript
async function getTopicIdForOrder(orderId: string, messageId: number): Promise<number | undefined> {
  // –ü–æ–ª—É—á–∞–µ—Ç topicId –∏–∑ —Ç–∞–±–ª–∏—Ü—ã telegram_order_messages
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç undefined –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –æ—à–∏–±–∫–∞
}
```

### 2. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ `cancel_order_` (–ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ1)

**–ë—ã–ª–æ:** –ü—Ä—è–º–æ–π `fetch()` –±–µ–∑ `message_thread_id` –∏ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫  
**–°—Ç–∞–ª–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `editTelegramMessage()` —Å:

- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ–º topicId –∏–∑ –ë–î
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–µ–π `message_thread_id` –≤ Telegram API
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å topicId

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–º–µ–Ω—ã –î–û–õ–ñ–ù–´ –ü–û–Ø–í–õ–Ø–¢–¨–°–Ø –≤ Telegram

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ `cancel_complete_` (–ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ2)

**–ë—ã–ª–æ:** –í–æ–∑–≤—Ä–∞—â–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å"  
**–°—Ç–∞–ª–æ:** –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –û–ë–ï –∫–Ω–æ–ø–∫–∏:

- ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É
- ‚úÖ –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É

**–ü–ª—é—Å:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `editTelegramMessage()` —Å topicId –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É –æ—Ç–º–µ–Ω—ã (–ö–†–ò–¢–ò–ß–ù–´–ô)

1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
2. –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
3. –ù–∞–∂–∞—Ç—å **"‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É"**
4. ‚úÖ –û–ñ–ò–î–ê–ï–ú–û: –ü–æ—è–≤–ª—è—é—Ç—Å—è 6 –ø—Ä–∏—á–∏–Ω –æ—Ç–º–µ–Ω—ã + –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
5. –í—ã–±—Ä–∞—Ç—å –ª—é–±—É—é –ø—Ä–∏—á–∏–Ω—É
6. ‚úÖ –û–ñ–ò–î–ê–ï–ú–û: –ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
7. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
8. ‚úÖ –û–ñ–ò–î–ê–ï–ú–û: –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞, —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û—Ç–º–µ–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–ö–†–ò–¢–ò–ß–ù–´–ô)

1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
2. –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É
3. –ù–∞–∂–∞—Ç—å **"‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É"**
4. ‚úÖ –û–ñ–ò–î–ê–ï–ú–û: –ü–æ—è–≤–ª—è—é—Ç—Å—è 2 –∫–Ω–æ–ø–∫–∏ (–û—Ç–º–µ–Ω–∞ + –î–∞, –∑–∞–≤–µ—Ä—à–∏—Ç—å)
5. –ù–∞–∂–∞—Ç—å **"–û—Ç–º–µ–Ω–∞"**
6. ‚úÖ –û–ñ–ò–î–ê–ï–ú–û: –ü–æ—è–≤–ª—è—é—Ç—Å—è **–î–í–ï** –∫–Ω–æ–ø–∫–∏:
   - ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞—è–≤–∫—É
   - ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É" –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

```
[INFO] Cancel order reasons shown { orderId: '...', topicId: 123 }
```

‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

```
[ERROR] Telegram API returned error
[WARN] Failed to edit message
```

---

## üìä –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∫–æ–¥–µ

### –ò–º–ø–æ—Ä—Ç—ã (—Å—Ç—Ä–æ–∫–∏ 1-11)

```typescript
// –î–û–ë–ê–í–õ–ï–ù–û:
import { getPrismaClient } from '@repo/session-management';
import { editTelegramMessage, type InlineKeyboard } from '../../src/lib/telegram-api-helpers';
```

### –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∏ 14-48)

```typescript
async function getTopicIdForOrder(orderId: string, messageId: number): Promise<number | undefined>;
```

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫ cancel*order* (—Å—Ç—Ä–æ–∫–∏ ~243-301)

- –ó–∞–º–µ–Ω—ë–Ω –ø—Ä—è–º–æ–π `fetch()` –Ω–∞ `editTelegramMessage()`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ topicId: `await getTopicIdForOrder(orderId, messageId)`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: `if (!success) { ... }`

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫ cancel*complete* (—Å—Ç—Ä–æ–∫–∏ ~190-255)

- –ò–∑–º–µ–Ω—ë–Ω keyboard: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É"
- –ó–∞–º–µ–Ω—ë–Ω –ø—Ä—è–º–æ–π `fetch()` –Ω–∞ `editTelegramMessage()`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ topicId
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

1. **topicId —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î**: –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è topicId —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `telegram_order_messages.topic_id`
2. **editTelegramMessage –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Topics**: –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç `message_thread_id` –≤ URL params
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ response.ok**: –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false` –µ—Å–ª–∏ Telegram API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
4. **–ì—Ä—É–ø–ø—ã —Å Topics**: –ë–µ–∑ `message_thread_id` Telegram API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 400

### –°–≤—è–∑—å —Å –ë–î

```sql
SELECT topic_id FROM telegram_order_messages
WHERE order_id = ? AND message_id = ?
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `topicId` –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

---

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏**: `handleCallbackQueryResponse()` –≤—Å—ë –µ—â—ë >400 —Å—Ç—Ä–æ–∫ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å >60
   - –≠—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è lint, –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É
   - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ helper —Ñ—É–Ω–∫—Ü–∏–∏ - –≠—Ç–∞–ø 5 (P2)

2. **–û—Å—Ç–∞–ª—å–Ω—ã–µ handlers**: `complete_order_`, `select_cancel_reason_`, `back_to_order_` –µ—â—ë –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä—è–º—ã–µ `fetch()`
   - –†–∞–±–æ—Ç–∞—é—Ç, –Ω–æ –Ω—É–∂–¥–∞—é—Ç—Å—è –≤ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ
   - –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –≠—Ç–∞–ø 4 (P1)

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ü–†–û–®–õ–ò ‚úÖ

1. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è: `git add .` + `git commit -m "fix: telegram bot buttons - add Topics support (P0)"`
2. –ü–µ—Ä–µ–π—Ç–∏ –∫ –≠—Ç–∞–ø—É 4 (P1): –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö handlers

### –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ù–ï –ü–†–û–®–õ–ò ‚ùå

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:

   ```bash
   # –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ telegram-bot
   # –ò—Å–∫–∞—Ç—å: "Failed to get topicId", "Telegram API returned error"
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

   ```bash
   # –í .env –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
   TELEGRAM_NEW_ORDERS_TOPIC_ID=123
   TELEGRAM_CANCELLED_ORDERS_TOPIC_ID=456
   TELEGRAM_PAID_ORDERS_TOPIC_ID=789
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î:
   ```sql
   SELECT * FROM telegram_order_messages
   WHERE order_id = '–ø—Ä–æ–±–ª–µ–º–Ω—ã–π_order_id';
   ```

---

## üìù –û—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

**–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –§–ª–æ—É –æ—Ç–º–µ–Ω—ã

- [ ] –ö–Ω–æ–ø–∫–∏ –ø—Ä–∏—á–∏–Ω –æ—Ç–º–µ–Ω—ã –ø–æ—è–≤–∏–ª–∏—Å—å
- [ ] –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- [ ] –õ–æ–≥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û—Ç–º–µ–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

- [ ] –ü–æ—Å–ª–µ "–û—Ç–º–µ–Ω–∞" –≤–∏–¥–Ω—ã –û–ë–ï –∫–Ω–æ–ø–∫–∏
- [ ] –ú–æ–∂–Ω–æ —Å–Ω–æ–≤–∞ –Ω–∞–∂–∞—Ç—å "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
- [ ] –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É"

### –ü—Ä–æ–±–ª–µ–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å):

```
–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É:
1. –ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏
2. –ß—Ç–æ –æ–∂–∏–¥–∞–ª–∏
3. –ß—Ç–æ –ø–æ–ª—É—á–∏–ª–∏
4. –õ–æ–≥–∏
```

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~1.5 —á–∞—Å–∞  
**–†–∏—Å–∫–∏:** –ù–∏–∑–∫–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
