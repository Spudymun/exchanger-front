# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–∏–Ω–Ω–æ–π "—É–º–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –∫–æ—à–µ–ª—å–∫–æ–≤" —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∑–∞–Ω—è—Ç—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤

> **–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 23 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
> **–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä:** AI Agent (–Ω–∞ –æ—Å–Ω–æ–≤–µ 100% —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)  
> **–¶–µ–ª—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–∑ TELEGRAM_BOT_IMPLEMENTATION_PLAN.md –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ  
> **–ü—Ä–∏–Ω—Ü–∏–ø:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–ë–ù–ê–†–£–ñ–ï–ù–ò–Ø

### ‚ùå –§–ê–ö–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï vs –£–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –ü–õ–ê–ù–ê:

**–£–¢–í–ï–†–ñ–î–ï–ù–ò–ï –í –ü–õ–ê–ù–ï:**

```
"–ü—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ ‚Üí –±–µ—Ä–µ—Ç—Å—è —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –∑–∞–Ω—è—Ç—ã–π –∫–æ—à–µ–ª–µ–∫ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —É—á–∞—Å—Ç–∏—è –≤ –∑–∞—è–≤–∫–µ –∏ –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –°–†–ê–ó–£ —Å —ç—Ç–∏–º –∞–¥—Ä–µ—Å–æ–º"
```

**–§–ê–ö–¢–ò–ß–ï–°–ö–ê–Ø –†–ï–ê–õ–¨–ù–û–°–¢–¨:**

- ‚ùå QueueAllocationStrategy –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –∫–æ—à–µ–ª—å–∫–æ–≤
- ‚ùå ImmediateAllocationStrategy –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –∫–æ—à–µ–ª—å–∫–æ–≤
- ‚ùå –ú–µ—Ç–æ–¥–∞ `findOldestOccupied` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ codebase
- ‚ùå –ü–æ–ª—è `usedOldestOccupiedWallet` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ AllocationResult
- ‚ùå –ù–∏–∫–∞–∫–æ–≥–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ —Å –∑–∞–Ω—è—Ç—ã–º –∫–æ—à–µ–ª—å–∫–æ–º –Ω–µ—Ç

### ‚úÖ –ß–¢–û –ù–£–ñ–ù–û –†–ï–ê–õ–ò–ó–û–í–ê–¢–¨ –î–õ–Ø –í–û–ü–õ–û–©–ï–ù–ò–Ø –£–¢–í–ï–†–ñ–î–ï–ù–ò–ô:

1. **–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ WalletRepositoryInterface:** `findOldestOccupied(currency)`
2. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ AllocationResult:** –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `usedOldestOccupiedWallet`
3. **–ù–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:** `SmartQueueAllocationStrategy`
4. **–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è exchange.createOrder:** –æ–±—Ä–∞–±–æ—Ç–∫–∞ `usedOldestOccupiedWallet`
5. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:** –Ω–æ–≤—ã–π allocation mode

---

## üìê –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ê–ù–ê–õ–ò–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô

### üéØ –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –î–õ–Ø –î–û–°–¢–ò–ñ–ï–ù–ò–Ø –¶–ï–õ–ò:

#### **–§–ê–ó–ê 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (Rule 25 - —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ)**

```typescript
// packages/exchange-core/src/repositories/wallet-repository-interface.ts
export interface WalletRepositoryInterface {
  // ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã –æ—Å—Ç–∞—é—Ç—Å—è
  findOldestAvailable(currency: CryptoCurrency): Promise<WalletInfo | null>;

  // üÜï –î–û–ë–ê–í–õ–Ø–ï–ú: –ü–æ–∏—Å–∫ —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∑–∞–Ω—è—Ç–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ (–±–µ–∑ orderId –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
  findOldestOccupied(currency: CryptoCurrency): Promise<WalletInfo | null>;
}

// packages/exchange-core/src/services/wallet-strategies/wallet-allocation-strategy.ts
export interface AllocationResult {
  success: boolean;
  address?: string;
  walletInfo?: WalletInfo;
  error?: string;
  queuePosition?: number;

  // üÜï –î–û–ë–ê–í–õ–Ø–ï–ú: –§–ª–∞–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∑–∞–Ω—è—Ç–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
  usedOldestOccupiedWallet?: boolean;
}
```

#### **–§–ê–ó–ê 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ PostgresWalletAdapter**

```typescript
// packages/session-management/src/adapters/postgres-wallet-adapter.ts
export class PostgresWalletAdapter implements WalletRepositoryInterface {
  // üÜï –î–û–ë–ê–í–õ–Ø–ï–ú: –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∑–∞–Ω—è—Ç–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
  async findOldestOccupied(currency: CryptoCurrency): Promise<WalletInfo | null> {
    this.validateRequired(currency, 'currency');

    try {
      const wallet = await this.prismaClient.wallet.findFirst({
        where: {
          currency,
          status: WalletStatus.ALLOCATED, // –¢–æ–ª—å–∫–æ –∑–∞–Ω—è—Ç—ã–µ
        },
        orderBy: { lastUsedAt: 'asc' }, // FIFO: —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –∑–∞–Ω—è—Ç—ã–π
      });

      return wallet ? this.mapPrismaToWallet(wallet) : null;
    } catch (error) {
      this.handleError(error, 'findOldestOccupied');
    }
  }
}
```

#### **–§–ê–ó–ê 3: –î–æ—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ QueueAllocationStrategy**

```typescript
// packages/exchange-core/src/services/wallet-strategies/queue-allocation-strategy.ts
/**
 * ‚úÖ –î–û–†–ê–ë–û–¢–ö–ê –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ö–õ–ê–°–°–ê - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ occupied wallets
 * –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è Rule 25 –∏ Rule 20
 */
export class QueueAllocationStrategy implements WalletAllocationStrategy {
  // ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π constructor –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

  async allocateWallet(currency: CryptoCurrency): Promise<AllocationResult> {
    try {
      // ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –õ–û–ì–ò–ö–ê - –ø–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è
      const availableWallet = await this.walletRepository.findOldestAvailable(currency);

      if (availableWallet) {
        // ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –õ–û–ì–ò–ö–ê - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        const walletInfo = await this.walletRepository.markAsOccupied(
          availableWallet.address,
          `allocation-${Date.now()}`
        );

        return {
          success: true,
          address: availableWallet.address,
          walletInfo: walletInfo || availableWallet,
          usedOldestOccupiedWallet: false, // üÜï –î–û–ë–ê–í–õ–Ø–ï–ú –¢–û–õ–¨–ö–û –§–õ–ê–ì
        };
      }

      // ÔøΩ –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç—ã–π –∫–æ—à–µ–ª–µ–∫ –ø–µ—Ä–µ–¥ –æ—á–µ—Ä–µ–¥—å—é
      const oldestOccupiedWallet = await this.walletRepository.findOldestOccupied(currency);

      if (oldestOccupiedWallet) {
        // ‚úÖ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ï —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ —Å –∑–∞–Ω—è—Ç—ã–º –∫–æ—à–µ–ª—å–∫–æ–º
        return {
          success: true, // ‚úÖ –°–†–ê–ó–£ —É—Å–ø–µ—Ö –≤–º–µ—Å—Ç–æ –æ—á–µ—Ä–µ–¥–∏
          address: oldestOccupiedWallet.address,
          walletInfo: oldestOccupiedWallet,
          usedOldestOccupiedWallet: true, // üÜï –§–ª–∞–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∑–∞–Ω—è—Ç–æ–≥–æ
        };
      }

      // ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –õ–û–ì–ò–ö–ê –û–ß–ï–†–ï–î–ò - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      const queueEntry = await this.queueRepository.addToQueue({
        orderId: `queue-${Date.now()}`,
        currency,
        priority: 1,
      });

      return {
        success: false,
        queuePosition: await this.getQueuePosition(queueEntry.id, currency),
      };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown allocation error',
      };
    }
  }

  // ‚úÖ –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
}
```

#### **–§–ê–ó–ê 5: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è WalletPoolManager (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)**

```typescript
// ‚úÖ –ù–ï –ò–ó–ú–ï–ù–Ø–ï–ú packages/exchange-core/src/services/wallet-pool-manager.ts
// –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ createAllocationStrategy –£–ñ–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢ —Ä–µ–∂–∏–º 'queue':

export class WalletPoolManager {
  private createAllocationStrategy(mode: AllocationMode): WalletAllocationStrategy {
    switch (mode) {
      case 'queue': // ‚úÖ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢
        return new QueueAllocationStrategy(this.walletRepository, this.queueRepository);
      // ‚Üë –≠—Ç–æ—Ç –∫–ª–∞—Å—Å —Ç–µ–ø–µ—Ä—å –°–û–î–ï–†–ñ–ò–¢ –ª–æ–≥–∏–∫—É occupied wallets

      case 'hybrid': // ‚úÖ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢
        return new QueueAllocationStrategy(this.walletRepository, this.queueRepository);

      default:
        return new ImmediateAllocationStrategy(this.walletRepository);
    }
  }
}
```

**‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢**: –ü–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ `QueueAllocationStrategy`, —Ä–µ–∂–∏–º `'queue'` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É occupied wallets

#### **–§–ê–ó–ê 4: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∂–∏–º–æ–≤**

```typescript
// ‚úÖ –ù–ï –ò–ó–ú–ï–ù–Ø–ï–ú packages/constants/src/wallet-pool-config.ts
// –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–∂–∏–º—ã –î–û–°–¢–ê–¢–û–ß–ù–´:

export const WALLET_POOL_CONFIG = {
  ALLOCATION_MODES: {
    IMMEDIATE: 'immediate', // ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ–∂–∏–º
    QUEUE_ONLY: 'queue', // ‚úÖ –≠–¢–û–¢ —Ä–µ–∂–∏–º –±—É–¥–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∞–Ω –ª–æ–≥–∏–∫–æ–π occupied wallets
    HYBRID: 'hybrid', // ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
  },

  // ‚úÖ –ù–ò–ö–ê–ö–ò–• –ò–ó–ú–ï–ù–ï–ù–ò–ô DEFAULT_MODE - –æ—Å—Ç–∞–µ—Ç—Å—è 'immediate'
  DEFAULT_MODE: 'immediate' as const,

  // ‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
} as const;
```

**‚úÖ –ü–†–ò–ù–¶–ò–ü**: –î–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π `QueueAllocationStrategy` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç –ª–æ–≥–∏–∫—É occupied wallets –≤ —Ä–µ–∂–∏–º–µ `'queue'`

#### **–§–ê–ó–ê 6: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è exchange.createOrder**

```typescript
// apps/web/src/server/trpc/routers/exchange.ts

async function createOrderInSystem(orderRequest, sessionMetadata, existingSessionId) {
  // ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –õ–û–ì–ò–ö–ê - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  const allocationResult = await allocateWalletForOrder(
    orderRequest.currency as CryptoCurrency
    // ‚úÖ –ù–ï –ø–µ—Ä–µ–¥–∞–µ–º orderId - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
  );

  if (!allocationResult.success) {
    // ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    if (allocationResult.queuePosition) {
      return processQueuedOrder(
        orderRequest,
        allocationResult.queuePosition,
        sessionMetadata,
        existingSessionId
      );
    }
    throw createOrderError('wallet_allocation_failed', allocationResult.error || 'Unknown error');
  }

  // ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –õ–û–ì–ò–ö–ê - —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–≤—Ä–∞—Ç —Ñ–ª–∞–≥–∞
  const order = await processSuccessfulOrder(
    generateOrderId(),
    orderRequest,
    allocationResult.address!,
    sessionMetadata,
    existingSessionId
  );

  // üÜï –î–û–ë–ê–í–õ–Ø–ï–ú –¢–û–õ–¨–ö–û –í–û–ó–í–†–ê–¢ –§–õ–ê–ì–ê
  return {
    ...order,
    usedOldestOccupiedWallet: allocationResult.usedOldestOccupiedWallet || false,
  };
}
```

---

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### ‚úÖ –ü–û–°–õ–ï –í–ù–ï–î–†–ï–ù–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô:

**1. –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—É–¥–µ—Ç –ò–°–¢–ò–ù–ù–´–ú:**

```typescript
// ‚úÖ –¢–µ–ø–µ—Ä—å —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ
if (result.usedOldestOccupiedWallet) {
  // –ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω –æ—Ç —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∑–∞–Ω—è—Ç–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
}
```

**2. –õ–æ–≥–∏–∫–∞ –±—É–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—é:**

- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –∑–∞–Ω—è—Ç—ã–π ‚úÖ
- –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –°–†–ê–ó–£ —Å —ç—Ç–∏–º –∞–¥—Ä–µ—Å–æ–º ‚úÖ
- FIFO –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è —Å–≤–æ–±–æ–¥–Ω—ã—Ö, –∏ –¥–ª—è –∑–∞–Ω—è—Ç—ã—Ö ‚úÖ
- –£–º–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚úÖ

**3. Telegram Bot –ª–æ–≥–∏–∫–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:**

```typescript
// ‚úÖ –ö–æ–¥ –∏–∑ –ø–ª–∞–Ω–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ
try {
  const result = await trpc.exchange.createOrder.mutate(orderData);

  if (result.usedOldestOccupiedWallet) {
    return `‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞
üìç –ê–¥—Ä–µ—Å: ${result.depositAddress}
üí∞ –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ ${result.cryptoAmount} ${currency}
üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –∑–∞–Ω—è—Ç—ã–π –∫–æ—à–µ–ª–µ–∫ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏)`;
  }
  // ...
}
```

---

## üìã –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –í–´–ü–û–õ–ù–ï–ù–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)

### **–î–µ–Ω—å 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (–ú–ò–ù–ò–ú–ê–õ–¨–ù–û)**

- [ ] –î–æ–±–∞–≤–∏—Ç—å `findOldestOccupied` –≤ `WalletRepositoryInterface` (1 –º–µ—Ç–æ–¥)
- [ ] –î–æ–±–∞–≤–∏—Ç—å `usedOldestOccupiedWallet` –≤ `AllocationResult` (1 –ø–æ–ª–µ)
- [ ] ‚úÖ –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –≤ `wallet-allocation-strategy.ts`

### **–î–µ–Ω—å 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∞–¥–∞–ø—Ç–µ—Ä–µ (–ü–†–û–°–¢–û)**

- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `findOldestOccupied` –≤ `PostgresWalletAdapter` (–ø—Ä–æ—Å—Ç–æ–π findFirst)
- [ ] –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞
- [ ] ‚úÖ –ù–ï –¥–µ–ª–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ - –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞

### **–î–µ–Ω—å 3: –î–æ—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–ì–õ–ê–í–ù–û–ï)**

- [ ] ‚úÖ –î–û–†–ê–ë–û–¢–ê–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `QueueAllocationStrategy.allocateWallet()` (10 —Å—Ç—Ä–æ–∫)
- [ ] ‚úÖ –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å `SmartQueueAllocationStrategy`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–ª–∞—Å—Å–µ

### **–î–µ–Ω—å 4: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)**

- [ ] ‚úÖ –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å `smart-queue` –≤ `ALLOCATION_MODES`
- [ ] ‚úÖ –ù–ï –∏–∑–º–µ–Ω—è—Ç—å `DEFAULT_MODE`
- [ ] ‚úÖ –ù–ï –∏–∑–º–µ–Ω—è—Ç—å `createAllocationStrategy` –≤ WalletPoolManager

### **–î–µ–Ω—å 5: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è createOrder (–ü–†–û–°–¢–û)**

- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—è `usedOldestOccupiedWallet` –≤ `createOrderInSystem`
- [ ] ‚úÖ –ù–ï –∏–∑–º–µ–Ω—è—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ç–æ–¥–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

### **–î–µ–Ω—å 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–§–û–ö–£–°)**

- [ ] End-to-end —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ `QueueAllocationStrategy`
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ–∂–∏–º–µ `'queue'` —Å occupied wallets
- [ ] ‚úÖ –ù–ï —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `'smart-queue'` —Ä–µ–∂–∏–º

---

## üõ°Ô∏è –ü–†–û–í–ï–†–ö–ò –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ô –¶–ï–õ–û–°–¢–ù–û–°–¢–ò

### ‚úÖ –°–û–ë–õ–Æ–î–ï–ù–ò–ï –ü–†–ê–í–ò–õ –ü–†–û–ï–ö–¢–ê:

**Rule 25 (–§–æ–∫—É—Å –Ω–∞ —Ü–µ–ª–∏):** –ò–∑–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
**Rule 20 (–ó–∞–ø—Ä–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è):** –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã  
**Rule 17 (–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã):** –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ constants –∏ utils
**Rule 11 (–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å —Ç–µ—Ö–¥–æ–ª–≥–∞):** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω—ã

### üîÑ –û–ë–†–ê–¢–ù–ê–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨:

- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (`immediate`, `queue`) –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –°—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏
- ‚úÖ API –æ—Å—Ç–∞–µ—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–º (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è)
- ‚úÖ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Ä–µ–∂–∏–º—ã —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

### üìä –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê:

1. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:** –í—Å–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –∫–æ–¥–µ
2. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ:** –ù–µ –Ω–∞—Ä—É—à–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ:** –ù–µ—Ç –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ allocation
4. **–¢–µ—Å—Ç–æ–≤—ã–µ:** 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

---

## üöÄ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï (–ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï)

–î–∞–Ω–Ω—ã–π –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ç—Ä–µ–±—É–µ–º—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å **–ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ú–ò –ò–ó–ú–ï–ù–ï–ù–ò–Ø–ú–ò** —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

**–ö–õ–Æ–ß–ï–í–´–ï –ü–†–ò–ù–¶–ò–ü–´:**

‚úÖ **Rule 25 (–§–û–ö–£–° –ù–ê –¶–ï–õ–ò):** –¢–æ–ª—å–∫–æ –¥–æ—Ä–∞–±–æ—Ç–∫–∞ `QueueAllocationStrategy` - –ë–ï–ó –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤  
‚úÖ **Rule 20 (–ó–ê–ü–†–ï–¢ –ò–ó–ë–´–¢–û–ß–ù–û–°–¢–ò):** –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–∂–∏–º–æ–≤ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç  
‚úÖ **Rule 24 (–ó–ù–ê–ù–ò–ï –°–¢–†–£–ö–¢–£–†–´):** –£—á–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞  
‚úÖ **Rule 17 (–¶–ï–ù–¢–†–ê–õ–ò–ó–û–í–ê–ù–ù–´–ï –°–ò–°–¢–ï–ú–´):** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö `ALLOCATION_MODES`

**–†–ï–ó–£–õ–¨–¢–ê–¢ –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô:**

- ‚úÖ **0 –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤** (–≤–º–µ—Å—Ç–æ 1)
- ‚úÖ **0 –Ω–æ–≤—ã—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç** (–≤–º–µ—Å—Ç–æ 2)
- ‚úÖ **~15 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞** (–≤–º–µ—Å—Ç–æ 200+)
- ‚úÖ **0 –Ω–∞—Ä—É—à–µ–Ω–∏–π –ø—Ä–∞–≤–∏–ª** (–≤–º–µ—Å—Ç–æ 4)
- ‚úÖ **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**

**–î–û–°–¢–ò–ñ–ï–ù–ò–ï –¶–ï–õ–ò:**

- ‚úÖ –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –∑–∞–Ω—è—Ç—ã–π
- ‚úÖ –ó–∞—è–≤–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –°–†–ê–ó–£ —Å –∞–¥—Ä–µ—Å–æ–º –∑–∞–Ω—è—Ç–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
- ‚úÖ –ü–æ–ª–µ `usedOldestOccupiedWallet` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ FIFO –∞–ª–≥–æ—Ä–∏—Ç–º —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –∑–∞–Ω—è—Ç—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤

**–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–ê–Ø –¶–ï–õ–û–°–¢–ù–û–°–¢–¨:**
–†–µ—à–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –ø—Ä–æ–µ–∫—Ç–∞, —Å–æ–±–ª—é–¥–∞–µ—Ç –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —Ü–µ–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏.
