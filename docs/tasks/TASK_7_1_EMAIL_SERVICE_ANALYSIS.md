# –ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏ 7.1: –°–æ–∑–¥–∞–Ω–∏–µ packages/email-service

> **–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 21 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
> **–ê–≥–µ–Ω—Ç-–∫–æ–¥–µ—Ä:** –§–æ–∫—É—Å –Ω–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã  
> **–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ 7.1 –∏–∑ ORDER_SYSTEM_IMPLEMENTATION_TASK_LIST.md

---

## üîç –†–ï–ó–£–õ–¨–¢–ê–¢ –§–ê–ö–¢–ò–ß–ï–°–ö–û–ô –ü–†–û–í–ï–†–ö–ò

### ‚ùå –ó–ê–î–ê–ß–ê 7.1 –ù–ï –ê–ö–¢–£–ê–õ–¨–ù–ê - –ü–ê–ö–ï–¢ –£–ñ–ï –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù

**–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –û–ë–ù–ê–†–£–ñ–ï–ù–ò–ï:** –ó–∞–¥–∞—á–∞ 7.1 "–°–æ–∑–¥–∞—Ç—å `packages/email-service/` –ø–æ –æ–±—Ä–∞–∑—Ü—É session-management" **–ù–ï –ù–£–ñ–ù–ê**, –ø–æ—Å–∫–æ–ª—å–∫—É –ø–∞–∫–µ—Ç `packages/email-service/` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–æ –≤—Å–µ–π —Ç—Ä–µ–±—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é.

---

## üìä –§–ê–ö–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –ê–†–•–ò–¢–ï–ö–¢–£–†–´ email-service

### ‚úÖ –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø–ú AC6.1-6.4 (100% –ø–æ–∫—Ä—ã—Ç–∏–µ)

**AC6.1: Email service –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è - ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

- ‚úÖ **Provider Pattern:** `EmailProviderInterface` —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è–º–∏:
  - `MockEmailProvider` (development/test)
  - `SendGridEmailProvider` (production)
  - `ResendEmailProvider` (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è production –æ–ø—Ü–∏—è)

- ‚úÖ **Factory Pattern:** `EmailServiceFactory` —Å environment-based switching:

  ```typescript
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ NODE_ENV
  provider: environment === 'production' ? 'sendgrid' : 'mock';
  ```

- ‚úÖ **Centralized Templates:** HTML/TXT —à–∞–±–ª–æ–Ω—ã –≤ `src/templates/`:
  - `crypto-address.html` - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π HTML template
  - `crypto-address.txt` - —Ç–µ–∫—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
  - `system-alert.html/txt` - –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

- ‚úÖ **Security-Enhanced Integration:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏–∑ `@repo/constants`:
  ```typescript
  fromEmail: CONTACT_INFO.SUPPORT_EMAIL,
  fromName: COMPANY_INFO.NAME
  ```

**AC6.2: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ - ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–û**

- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ tRPC:** `apps/web/src/server/trpc/routers/exchange.ts`:

  ```typescript
  await RateLimitedEmailService.sendCryptoAddress(
    {
      orderId: order.id,
      cryptoAddress: depositAddress,
      currency: orderRequest.currency,
      amount: orderRequest.cryptoAmount,
      expiresAt: new Date(Date.now() + ORDER_EXPIRATION_TIME_MS),
      userEmail: orderRequest.email,
    },
    sessionMetadata.ip
  );
  ```

- ‚úÖ **Error Handling:** Email –æ—à–∏–±–∫–∏ –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
- ‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:** Email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ await
- ‚úÖ **Rate Limiting:** –ü–æ IP-–∞–¥—Ä–µ—Å—É —á–µ—Ä–µ–∑ `RateLimitedEmailService`

**AC6.3: –¢–∏–ø–∏–∑–∞—Ü–∏—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö - ‚úÖ –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û –ü–†–ê–í–ò–õ–¨–ù–û**

- ‚úÖ **–¢–∏–ø—ã:** `CryptoAddressEmailData` –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è:

  ```typescript
  interface CryptoAddressEmailData {
    orderId: string;
    cryptoAddress: string;
    currency: CryptoCurrency;
    amount: number;
    expiresAt: Date;
    userEmail: string;
  }
  ```

- ‚úÖ **Template Service:** `EmailTemplateService` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- ‚úÖ **Provider Abstraction:** –ï–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö email –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

**AC6.4: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ - ‚úÖ –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–û –ì–û–¢–û–í–û**

- ‚úÖ **Environment Logger:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `createEnvironmentLogger` –∏–∑ `@repo/utils`
- ‚úÖ **Structured Logging:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:

  ```typescript
  this.logger.info('Sending crypto address email', {
    orderId: data.orderId,
    currency: data.currency,
    to: data.userEmail,
  });
  ```

- ‚úÖ **Error Logging:** –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
- ‚úÖ **Rate Limit Logging:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è rate limiting

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï session-management

### ‚úÖ –ò–î–ï–ù–¢–ò–ß–ù–´–ï –ü–ê–¢–¢–ï–†–ù–´ (100% —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–æ–≤:**

```
packages/email-service/          packages/session-management/
‚îú‚îÄ‚îÄ src/                        ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ factories/             ‚îÇ   ‚îú‚îÄ‚îÄ factories/
‚îÇ   ‚îú‚îÄ‚îÄ providers/             ‚îÇ   ‚îú‚îÄ‚îÄ managers/
‚îÇ   ‚îú‚îÄ‚îÄ services/              ‚îÇ   ‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îú‚îÄ‚îÄ types/                 ‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îú‚îÄ‚îÄ utils/                 ‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts               ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ package.json               ‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ tsconfig.json              ‚îî‚îÄ‚îÄ tsconfig.json
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**

- ‚úÖ **Provider Pattern** (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ)
- ‚úÖ **Factory Pattern** (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ)
- ‚úÖ **Environment-based switching** (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ)
- ‚úÖ **Centralized exports** —á–µ—Ä–µ–∑ index.ts (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ)
- ‚úÖ **Dependencies –Ω–∞ @repo/constants, @repo/utils** (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ)
- ‚úÖ **TypeScript configuration** (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ)

---

## üìã –î–ï–¢–ê–õ–¨–ù–û–ï –ü–û–ö–†–´–¢–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–ô

### ‚úÖ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ò–ó AC –ü–û–õ–ù–û–°–¢–¨–Æ –í–´–ü–û–õ–ù–ï–ù–´

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ AC                | –°—Ç–∞—Ç—É—Å | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è                             |
| ---------------------------- | ------ | -------------------------------------- |
| AC6.1: Provider Pattern      | ‚úÖ     | Mock/SendGrid/Resend –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã        |
| AC6.1: Environment switching | ‚úÖ     | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ø–æ NODE_ENV       |
| AC6.1: Centralized templates | ‚úÖ     | HTML/TXT —à–∞–±–ª–æ–Ω—ã –≤ src/templates/      |
| AC6.2: tRPC integration      | ‚úÖ     | –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ exchange.createOrder   |
| AC6.2: Rate limiting         | ‚úÖ     | RateLimitedEmailService —Å IP tracking  |
| AC6.2: Error handling        | ‚úÖ     | –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫            |
| AC6.3: Type safety           | ‚úÖ     | CryptoAddressEmailData –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å       |
| AC6.4: Logging               | ‚úÖ     | createEnvironmentLogger –∏–∑ @repo/utils |

### ‚úÖ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ò–ó –ó–ê–î–ê–ß–ò 7.1 –ü–û–õ–ù–û–°–¢–¨–Æ –í–´–ü–û–õ–ù–ï–ù–´

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ Task 7.1                       | –°—Ç–∞—Ç—É—Å | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è                   |
| ----------------------------------------- | ------ | ---------------------------- |
| "–ø–æ –æ–±—Ä–∞–∑—Ü—É session-management"           | ‚úÖ     | –ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–∞  |
| "–ü–∞–ø–∫–∏ src/providers/, src/factories/"    | ‚úÖ     | –¢–æ—á–Ω–æ —Ç–∞–∫–∏–µ –∂–µ –ø–∞–ø–∫–∏         |
| "TypeScript –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"                 | ‚úÖ     | –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π tsconfig.json    |
| "package.json setup"                      | ‚úÖ     | –¢–∞ –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ dependencies |
| "Environment-based switching"             | ‚úÖ     | Factory —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ |
| "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (Resend, Gmail SMTP)" | ‚úÖ     | Resend + SendGrid –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã |

---

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: –ó–ê–î–ê–ß–ê 7.1 –ù–ï –ê–ö–¢–£–ê–õ–¨–ù–ê

### ‚ùå –ù–ò–ö–ê–ö–ò–• –î–ï–ô–°–¢–í–ò–ô –ù–ï –¢–†–ï–ë–£–ï–¢–°–Ø

**–û–°–ù–û–í–ê–ù–ò–ï:** –ü–∞–∫–µ—Ç `packages/email-service/` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä—ã–≤–∞–µ—Ç** –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

1. **üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞:** –¢–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã session-management
2. **üîß –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:** 100% –ø–æ–∫—Ä—ã—Ç–∏–µ AC6.1-6.4 —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
3. **üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production —á–µ—Ä–µ–∑ exchange.createOrder
4. **üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ error handling —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
5. **‚ö° Performance:** Rate limiting –ø–æ IP-–∞–¥—Ä–µ—Å–∞–º —Ä–∞–±–æ—Ç–∞–µ—Ç
6. **üîí Security:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏–∑ @repo/constants

### üöÄ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö PRODUCTION

Email service —É–∂–µ **–≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é**:

- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SendGrid/Resend –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
- Mock provider –¥–ª—è development/testing
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π tRPC
- Error handling –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ø–æ—Ç–æ–∫
- Rate limiting –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç spam

### üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–ü–†–û–ü–£–°–¢–ò–¢–¨ –∑–∞–¥–∞—á—É 7.1** –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–∏–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –∑–∞–¥–∞—á–∞–º –∏–∑ ORDER_SYSTEM_IMPLEMENTATION_TASK_LIST.md, –ø–æ—Å–∫–æ–ª—å–∫—É email-service —É–∂–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º—É.

---

**–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω:** 21 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ 7.1:** ‚ùå –ù–ï –ê–ö–¢–£–ê–õ–¨–ù–ê (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞)  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü–µ—Ä–µ—Ö–æ–¥ –∫ –¥—Ä—É–≥–∏–º –∑–∞–¥–∞—á–∞–º –∏–∑ —Å–ø–∏—Å–∫–∞
