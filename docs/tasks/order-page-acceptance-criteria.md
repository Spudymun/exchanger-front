# Acceptance Criteria: Страница статуса заявки (Order Page)

**Связанная User Story:** Как пользователь, я хочу видеть детальную информацию о статусе моей заявки на обмен криптовалюты после отправки формы, чтобы отслеживать процесс обмена и получать инструкции по дальнейшим действиям.

**Область применения:** Страница детального отображения статуса заявки, доступная по URL `/[locale]/order/[orderId]`.

**Ключевые особенности:**

- **Автоматический переход:** Пользователь попадает на страницу автоматически после успешной отправки формы обмена.
- **Статус в реальном времени:** Отображение актуального статуса заявки с автообновлением.
- **Детальная информация:** Полная информация о заявке включая суммы, адреса, временные метки.
- **Мультиязычность:** Поддержка локализации (ru/uk).
- **Безопасность:** Валидация orderId с защитой от XSS атак.

---

## 1. Навигация и Доступ к Странице

**AC 1.1:** После успешной отправки формы обмена в `ExchangeContainer`, пользователь автоматически перенаправляется на страницу статуса заявки.

- **AC 1.1.1:** URL имеет формат: `/{locale}/order/{orderId}`, где `locale` - текущая локаль пользователя (ru/uk), `orderId` - уникальный идентификатор заявки.
- **AC 1.1.2:** Переход происходит через `router.push(\`/order/\${result.orderId}\`)`с использованием`useRouter`из`../i18n/navigation` для автоматической локализации URL.

**AC 1.2:** Пользователь может попасть на страницу по прямой ссылке, введя корректный URL в адресную строку.

**AC 1.3:** При вводе некорректного `orderId` (короче 10 символов или невалидного формата) пользователь попадает на страницу 404 (not-found).

## 2. Отображение Информации о Заявке

**AC 2.1:** На странице отображается компонент `OrderStatus` с параметром `showDetails={true}`.

**AC 2.2:** Компонент `OrderStatus` отображает полную детальную информацию о заявке:

- **AC 2.2.1:** Заголовок с номером заявки: "Заявка #{orderId}".
- **AC 2.2.2:** Текущий статус заявки с цветовой индикацией согласно `ORDER_STATUS_CONFIG`.
- **AC 2.2.3:** Сумма отправки в криптовалюте (например, "100 USDT").
- **AC 2.2.4:** Сумма получения в фиатной валюте (например, "4,050 UAH").
- **AC 2.2.5:** Адрес депозита для отправки криптовалюты.
- **AC 2.2.6:** Время создания заявки (`createdAt`).
- **AC 2.2.7:** Время последнего обновления (`updatedAt`).
- **AC 2.2.8:** Хеш транзакции (`txHash`), если доступен.
- **AC 2.2.9:** Данные получателя (номер карты), если указаны.

**AC 2.3:** Статус заявки отображается с соответствующими иконками:

- **AC 2.3.1:** "Ожидает оплаты" - иконка `Clock` (желтый).
- **AC 2.3.2:** "Обрабатывается" - иконка `Loader2` с анимацией (синий).
- **AC 2.3.3:** "Завершена" - иконка `CheckCircle` (зеленый).
- **AC 2.3.4:** "Отменена" - иконка `XCircle` (красный).

## 3. Автообновление и Состояния Загрузки

**AC 3.1:** Статус заявки автоматически обновляется каждые 30 секунд через `useOrderStatus` hook.

**AC 3.2:** При загрузке данных о заявке отображается состояние загрузки:

- **AC 3.2.1:** Показывается spinner или skeleton loader.
- **AC 3.2.2:** Текст "Загрузка информации о заявке...".

**AC 3.3:** При ошибке загрузки данных отображается состояние ошибки:

- **AC 3.3.1:** Сообщение об ошибке с возможностью повторной попытки.
- **AC 3.3.2:** Если заявка не найдена (404), отображается специальное сообщение "Заявка не найдена".

## 4. Безопасность и Валидация

**AC 4.1:** `orderId` валидируется с использованием `securityEnhancedOrderByIdSchema`:

- **AC 4.1.1:** Проверка на минимальную длину (10+ символов).
- **AC 4.1.2:** Защита от XSS атак через `securityEnhancedIdSchema`.
- **AC 4.1.3:** Санитизация входных данных.

**AC 4.2:** При обнаружении попыток XSS или инъекций, пользователь перенаправляется на страницу 404.

**AC 4.3:** Все данные заявки фильтруются через существующие security schemas перед отображением.

## 5. Интернационализация (i18n)

**AC 5.1:** Мета-данные страницы локализованы:

- **AC 5.1.1:** Заголовок (title): "Заявка #{orderId} | Обменник" (ru), "Заявка #{orderId} | Обмінник" (uk).
- **AC 5.1.2:** Описание (description): "Статус заявки на обмен криптовалюты" (ru), "Статус заявки на обмін криптовалюти" (uk).

**AC 5.2:** Все элементы интерфейса используют переводы из `OrderPage` секции в файлах переводов.

**AC 5.3:** Компонент `OrderStatus` отображает локализованные тексты статусов и сообщений.

## 6. Отзывчивость и Доступность

**AC 6.1:** Страница корректно отображается на всех устройствах:

- **AC 6.1.1:** Десктоп (1200px+).
- **AC 6.1.2:** Планшет (768px-1199px).
- **AC 6.1.3:** Мобильные устройства (320px-767px).

**AC 6.2:** Компонент `OrderStatus` использует существующие responsive стили из `@repo/ui`.

**AC 6.3:** Страница соответствует стандартам доступности:

- **AC 6.3.1:** Семантическая разметка HTML.
- **AC 6.3.2:** Поддержка навигации с клавиатуры.
- **AC 6.3.3:** Корректные ARIA атрибуты для статусов.

## 7. Производительность

**AC 7.1:** Страница загружается в течение 2 секунд при хорошем интернет-соединении.

**AC 7.2:** Используется Server-Side Rendering (SSR) для быстрой первоначальной загрузки.

**AC 7.3:** Автообновление статуса не влияет на производительность:

- **AC 7.3.1:** Используется React Query для кеширования данных.
- **AC 7.3.2:** Запросы дебаунсятся для предотвращения спама.

## 8. Интеграция с Существующими Компонентами

**AC 8.1:** Используется существующий компонент `OrderStatus` без модификаций:

- **AC 8.1.1:** Импорт: `import { OrderStatus } from '../../../../src/components/OrderStatus'`.
- **AC 8.1.2:** Передача пропсов: `<OrderStatus orderId={params.orderId} showDetails={true} />`.

**AC 8.2:** Используется существующий `useOrderStatus` hook из `../hooks/useExchangeMutation`.

**AC 8.3:** Все API вызовы идут через существующие tRPC endpoints:

- **AC 8.3.1:** `exchange.getOrderStatus` для получения данных заявки.
- **AC 8.3.2:** Возвращаемые данные соответствуют типу `Order` из `@repo/exchange-core`.

## 9. Обработка Ошибок

**AC 9.1:** При ошибке сети отображается сообщение с возможностью повторной попытки.

**AC 9.2:** При ошибке валидации `orderId` пользователь перенаправляется на 404.

**AC 9.3:** При серверной ошибке (5xx) отображается общее сообщение об ошибке.

**AC 9.4:** Все ошибки логируются для последующего анализа.

## 10. SEO и Мета-данные

**AC 10.1:** Страница имеет корректные мета-теги:

- **AC 10.1.1:** Уникальный title с номером заявки.
- **AC 10.1.2:** Описательный description.
- **AC 10.1.3:** Языковые атрибуты (hreflang).

**AC 10.2:** URL структура соответствует SEO best practices: `/locale/order/orderId`.

**AC 10.3:** Страницы заявок не индексируются поисковиками (noindex) для защиты приватности.

## 11. Тестирование

**AC 11.1:** E2E тесты покрывают основные сценарии:

- **AC 11.1.1:** Успешное отображение заявки с валидным `orderId`.
- **AC 11.1.2:** Перенаправление на 404 при невалидном `orderId`.
- **AC 11.1.3:** Корректное отображение разных статусов заявки.
- **AC 11.1.4:** Автообновление статуса.

**AC 11.2:** Unit тесты покрывают:

- **AC 11.2.1:** Валидацию `orderId`.
- **AC 11.2.2:** Генерацию мета-данных.
- **AC 11.2.3:** Обработку ошибок.

**AC 11.3:** Тестирование совместимости с существующими компонентами:

- **AC 11.3.1:** `OrderStatus` корректно получает и отображает данные.
- **AC 11.3.2:** `useOrderStatus` hook работает без изменений.

## 12. Модификация ExchangeContainer

**AC 12.1:** В компоненте `ExchangeContainer` заменена реализация `onSubmit`:

- **AC 12.1.1:** Удален `throw new Error('Form submission not yet implemented')`.
- **AC 12.1.2:** Добавлен вызов `createOrder` mutation с передачей данных формы.
- **AC 12.1.3:** При успешном создании заявки выполняется навигация на страницу заказа.

**AC 12.2:** Добавлены необходимые импорты:

- **AC 12.2.1:** `import { useExchangeMutation } from '../../hooks/useExchangeMutation'`.
- **AC 12.2.2:** `import { calculateUahAmount, type CryptoCurrency } from '@repo/exchange-core'`.
- **AC 12.2.3:** `import { useRouter } from '../i18n/navigation'`.

**AC 12.3:** Обработка ошибок остается в рамках существующей системы формы.

## 13. Файловая Структура

**AC 13.1:** Создан новый файл страницы: `apps/web/app/[locale]/order/[orderId]/page.tsx`.

**AC 13.2:** Добавлены переводы в:

- **AC 13.2.1:** `apps/web/messages/ru.json` - секция `OrderPage`.
- **AC 13.2.2:** `apps/web/messages/uk.json` - секция `OrderPage`.

**AC 13.3:** Создан файл тестов: `tests/order-page.spec.ts`.

**AC 13.4:** Существующие файлы НЕ модифицированы, кроме:

- **AC 13.4.1:** `ExchangeContainer.tsx` - только замена `onSubmit` логики.
- **AC 13.4.2:** Файлы переводов - только добавление новых секций.

## 14. Техническая Реализация

**AC 14.1:** Используется App Router архитектура Next.js 15.

**AC 14.2:** Страница реализована как Server Component с получением параметров через `params`.

**AC 14.3:** Компонент `OrderStatus` рендерится на клиенте ('use client') для интерактивности.

**AC 14.4:** TypeScript типизация соблюдена для всех компонентов и данных.

**AC 14.5:** Следование существующим code style и паттернам проекта.

---

## ✅ Критерии Готовности (Definition of Done)

1. **Функциональность:** Все AC выполнены и протестированы.
2. **Интеграция:** Компонент интегрирован с существующими системами без breaking changes.
3. **Тестирование:** Покрытие E2E и unit тестами не менее 80%.
4. **Производительность:** Страница загружается менее чем за 2 секунды.
5. **Доступность:** Соответствие WCAG 2.1 AA.
6. **Безопасность:** Прохождение security review и отсутствие уязвимостей.
7. **Локализация:** Полная поддержка ru/uk локалей.
8. **Документация:** Обновлена техническая документация.
9. **Code Review:** Код прошел review и соответствует стандартам проекта.
10. **Deployment:** Успешный deploy на staging и production окружения.
