# Impact Analysis: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏–ª" —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º –∏ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 06 –æ–∫—Ç—è–±—Ä—è 2025  
**–†–æ–ª—å:** –ê–≥–µ–Ω—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ (Impact Analysis)  
**–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–∞—è –∑–∞–¥–∞—á–∞:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏–ª" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ä–¥–µ—Ä–∞

---

## üìã EXECUTIVE SUMMARY

### –¶–µ–ª—å –∑–∞–¥–∞—á–∏

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏–ª" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ä–¥–µ—Ä–∞:

1. **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç** - –∏–∑–º–µ–Ω—è–µ—Ç –¢–û–õ–¨–ö–û —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–∞ "paid", –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥—Ä—É–≥–∏—Ö –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π
2. **Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º –æ —Ç–æ–º, —á—Ç–æ –∑–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º –¥–ª—è –æ—Ç–º–µ–Ω—ã –∏ —Å–æ–∑–¥–∞–Ω–∏—è)
3. **Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É API —ç–Ω–¥–ø–æ–∏–Ω—Ç—É

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

- ‚úÖ **Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:** –ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏–ª" –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢ –≤ UI (`OrderActions` –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
- ‚úÖ **Handler stub:** –û–±—Ä–∞–±–æ—Ç—á–∏–∫ `handleMarkAsPaid` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–æ–π (TODO)
- ‚ùå **Backend endpoint:** –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢ - —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ mutation
- ‚ùå **Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:** –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢ - —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏

**üî¥ –í–´–°–û–ö–ê–Ø** - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —è–≤–ª—è–µ—Ç—Å—è –∫–ª—é—á–µ–≤—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º:

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ–∏—Ç—Å—è –≤–∑–ª–æ–º–∞ —Å–µ—Å—Å–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–º
- –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å –°–¢–†–û–ì–û –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞)
- –°–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ `cancelOrder`

---

## üîç PHASE 1: –°–†–ê–í–ù–ï–ù–ò–ï –° –°–£–©–ï–°–¢–í–£–Æ–©–ò–ú –§–£–ù–ö–¶–ò–û–ù–ê–õ–û–ú

### 1.1 –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: `user.orders.cancelOrder`

**–§–∞–π–ª:** `apps/web/src/server/trpc/routers/user/orders.ts` (—Å—Ç—Ä–æ–∫–∏ 136-167)

```typescript
cancelOrder: protectedProcedure
  .input(z.object({ orderId: z.string() }))
  .mutation(async ({ input, ctx }) => {
    const user = await validateUserAccess(ctx.user.id);
    const order = await validateOrderAccess(input.orderId, user.email);

    // ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω—ã
    if (!CANCELLABLE_ORDER_STATUSES.includes(order.status)) {
      throw createBadRequestError('Order cannot be cancelled in current status');
    }

    // ‚úÖ –ê–¢–û–ú–ê–†–ù–ê–Ø –æ–ø–µ—Ä–∞—Ü–∏—è: –¢–û–õ–¨–ö–û —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞
    const updatedOrder = await orderManager.update(order.id, {
      status: ORDER_STATUSES.CANCELLED,
    });

    if (!updatedOrder) {
      throw createInternalServerError('Order update failed');
    }

    // ‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ)
    await sendCancellationNotification(updatedOrder, user.email);

    return {
      id: updatedOrder.id,
      status: updatedOrder.status,
      message: USER_SUCCESS_MESSAGES.ORDER_CANCELLED,
    };
  });
```

**–ö–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:**

1. ‚úÖ `protectedProcedure` - —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. ‚úÖ `validateUserAccess` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. ‚úÖ `validateOrderAccess` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–º
4. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏
5. ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¢–û–õ–¨–ö–û —Å—Ç–∞—Ç—É—Å–∞
6. ‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏

### 1.2 Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**

```mermaid
graph LR
    A[Web App] -->|HTTP POST| B[Telegram Bot App]
    B -->|Telegram API| C[Operators]

    A1[exchange.createOrder] -->|new_order| B1[notify-operators API]
    A2[user.orders.cancelOrder] -->|order_cancelled| B1
    A3[user.orders.markAsPaid] -.->|order_paid| B1

    B1 -->|TELEGRAM_OPERATOR_MESSAGES.TEMPLATES| C1[Format Message]
    C1 --> C2[Send to all operators]
```

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**

| –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è   | –ò—Å—Ç–æ—á–Ω–∏–∫                  | –®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è                                 | –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ |
| ----------------- | ------------------------- | ------------------------------------------------ | ----------------- |
| `new_order`       | `exchange.createOrder`    | `FRESH_WALLET_MESSAGE` / `REUSED_WALLET_MESSAGE` | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ    |
| `order_cancelled` | `user.orders.cancelOrder` | `ORDER_CANCELLED_MESSAGE`                        | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ    |
| `order_paid`      | -                         | -                                                | ‚ùå –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢  |

**–§–∞–π–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** `apps/telegram-bot/pages/api/notify-operators.ts`

```typescript
interface NotificationPayload {
  order: {
    id: string;
    email: string;
    cryptoAmount: string;
    currency: string;
    uahAmount: string;
    status?: string;
  };
  depositAddress: string;
  walletType: 'fresh' | 'reused';
  notificationType?: 'new_order' | 'order_cancelled'; // üéØ –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 'order_paid'
}

function createOperatorMessage(payload: NotificationPayload): string {
  const { notificationType } = payload;

  if (notificationType === 'order_cancelled') {
    return TELEGRAM_OPERATOR_MESSAGES.TEMPLATES.ORDER_CANCELLED_MESSAGE(order);
  }

  // üéØ –ü–û–¢–†–ï–ë–£–ï–¢–°–Ø: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É 'order_paid'

  // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è new_order...
}
```

### 1.3 Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏:** `packages/ui/src/components/order/helpers/OrderActions.tsx` (—Å—Ç—Ä–æ–∫–∏ 60-110)

```tsx
export function OrderActions({
  onMarkAsPaid, // üéØ Callback —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  onCancelOrder, // ‚úÖ –†–∞–±–æ—Ç–∞—é—â–∏–π —Ä–µ—Ñ–µ—Ä–µ–Ω—Å
  isLoading = false,
  className,
  labels,
}: OrderActionsProps) {
  return (
    <>
      <Button onClick={onMarkAsPaid} disabled={isLoading} className="flex-1" size="lg">
        {labels.markAsPaid} {/* üéØ –ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏–ª" */}
      </Button>
      <Button onClick={() => setIsCancelDialogOpen(true)} variant="destructive">
        {labels.cancelOrder} {/* ‚úÖ –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å" - —Ä–∞–±–æ—Ç–∞–µ—Ç */}
      </Button>
    </>
  );
}
```

**Frontend handler (–∑–∞–≥–ª—É—à–∫–∞):** `apps/web/app/[locale]/order/[orderId]/OrderPageClient.tsx` (—Å—Ç—Ä–æ–∫–∏ 54-59)

```tsx
const handleMarkAsPaid = () => {
  console.log('User marked order as paid:', orderId);
  // TODO: Implement tRPC mutation –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
};

// ‚úÖ –†–µ—Ñ–µ—Ä–µ–Ω—Å - —Ä–∞–±–æ—Ç–∞—é—â–∏–π handler –¥–ª—è –æ—Ç–º–µ–Ω—ã:
const handleCancelOrder = () => {
  cancelOrderMutation.mutate({ orderId });
};
```

---

## ‚ö†Ô∏è PHASE 2: –í–´–Ø–í–õ–ï–ù–ò–ï –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–• –ö–û–ù–§–õ–ò–ö–¢–û–í

### 2.1 –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–∞

**–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç —Å—Ç–∞—Ç—É—Å–æ–≤:** `packages/constants/src/order-statuses.ts`

```typescript
export const ORDER_STATUSES = {
  PENDING: 'pending', // üéØ –ò—Å—Ö–æ–¥–Ω—ã–π —Å—Ç–∞—Ç—É—Å
  PAID: 'paid', // üéØ –¶–ï–õ–ï–í–û–ô –°–¢–ê–¢–£–°
  PROCESSING: 'processing',
  COMPLETED: 'completed',
  CANCELLED: 'cancelled',
  FAILED: 'failed',
} as const;

export const ORDER_STATUS_GROUPS = {
  ACTIVE: [ORDER_STATUSES.PENDING, ORDER_STATUSES.PAID, ORDER_STATUSES.PROCESSING],
  NEEDS_PAYMENT: [ORDER_STATUSES.PENDING],
  IN_PROGRESS: [ORDER_STATUSES.PAID, ORDER_STATUSES.PROCESSING],
  FINAL: [ORDER_STATUSES.COMPLETED, ORDER_STATUSES.CANCELLED, ORDER_STATUSES.FAILED],
} as const;
```

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏:** `packages/constants/src/user.ts` (—Å—Ç—Ä–æ–∫–∞ 66)

```typescript
export const CANCELLABLE_ORDER_STATUSES = ['pending', 'processing'] as const;
```

**üéØ –ü–û–¢–†–ï–ë–£–ï–¢–°–Ø –°–û–ó–î–ê–¢–¨:**

```typescript
// üÜï –ù–æ–≤–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ "–û–ø–ª–∞—Ç–∏–ª"
export const MARKABLE_AS_PAID_STATUSES = ['pending'] as const;
```

### 2.2 –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–°—Ü–µ–Ω–∞—Ä–∏–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:**

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û–ø–ª–∞—Ç–∏–ª", –Ω–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä —É–∂–µ –∏–∑–º–µ–Ω–∏–ª —Å—Ç–∞—Ç—É—Å**
   - `pending` ‚Üí `processing` (–æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∑—è–ª –≤ —Ä–∞–±–æ—Ç—É)
   - `pending` ‚Üí `completed` (–æ–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–≤–µ—Ä—à–∏–ª)
   - `pending` ‚Üí `cancelled` (–æ–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–º–µ–Ω–∏–ª)

   **–†–µ—à–µ–Ω–∏–µ:** –í–∞–ª–∏–¥–∞—Ü–∏—è `order.status === 'pending'` –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û–ø–ª–∞—Ç–∏–ª" –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Å–∞–º –æ—Ç–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑**
   - –°—Ç–∞—Ç—É—Å —É–∂–µ `cancelled`

   **–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ `!ORDER_STATUS_GROUPS.FINAL.includes(order.status)`

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–û–ø–ª–∞—Ç–∏–ª" –¥–≤–∞–∂–¥—ã**
   - –°—Ç–∞—Ç—É—Å —É–∂–µ `paid`

   **–†–µ—à–µ–Ω–∏–µ:** –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å - –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å success –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –ª–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**

```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "paid"
if (order.status !== ORDER_STATUSES.PENDING) {
  // –ï—Å–ª–∏ —É–∂–µ paid - —Å—á–∏—Ç–∞–µ–º —É—Å–ø–µ—à–Ω—ã–º (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
  if (order.status === ORDER_STATUSES.PAID) {
    return {
      id: order.id,
      status: order.status,
      message: 'Order already marked as paid',
    };
  }

  // –ò–Ω–∞—á–µ - –æ—à–∏–±–∫–∞
  throw createBadRequestError(`Order cannot be marked as paid in current status: ${order.status}`);
}
```

### 2.3 API –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ race conditions

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è race condition:**

```
Time    User Action         Operator Action       Database State
-----   -----------------   -------------------   --------------
T0      Clicks "–û–ø–ª–∞—Ç–∏–ª"    -                     status: pending
T1      API request sent    Clicks "–í–∑—è—Ç—å"        status: pending
T2      -                   API request sent      status: pending
T3      Sets status=paid    -                     status: paid
T4      -                   Sets status=processing ‚ö†Ô∏è CONFLICT
```

**–†–µ—à–µ–Ω–∏–µ:** –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ `orderManager.update`:

- PostgreSQL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å
- –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–±–µ–∂–¥–∞–µ—Ç (Last-Write-Wins)
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

**–°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞—â–∏—Ç—ã:**

```typescript
// packages/exchange-core/src/services/order-manager.ts
async update(id: string, updates: Partial<Order>): Promise<Order | null> {
  // ‚úÖ Prisma —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å
  return await prisma.order.update({
    where: { id },
    data: updates,
  });
}
```

### 2.4 Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π payload schema:**

```typescript
interface NotificationPayload {
  order: {
    /* ... */
  };
  depositAddress: string; // ‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ø–æ–ª–µ
  walletType: 'fresh' | 'reused'; // ‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ø–æ–ª–µ
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è "–û–ø–ª–∞—Ç–∏–ª" –ø–æ–ª—è `depositAddress` –∏ `walletType` –Ω–µ –∏–º–µ—é—Ç —Å–º—ã—Å–ª–∞, –Ω–æ –æ–Ω–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ.

**–†–µ—à–µ–Ω–∏–µ:** –î–≤–∞ –ø–æ–¥—Ö–æ–¥–∞:

**–í–∞—Ä–∏–∞–Ω—Ç 1 (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø):** –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

```typescript
await fetch(`${telegramBotUrl}/api/notify-operators`, {
  body: JSON.stringify({
    order: {
      /* ... */
    },
    depositAddress: order.depositAddress || 'N/A', // –§–∏–∫—Ç–∏–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    walletType: 'fresh', // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–ª—è paid
    notificationType: 'order_paid', // üÜï –ù–æ–≤—ã–π —Ç–∏–ø
  }),
});
```

**–í–∞—Ä–∏–∞–Ω—Ç 2:** –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—Ö–µ–º—ã (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø - –Ω–∞—Ä—É—à–∞–µ—Ç Rule 25)

```typescript
interface NotificationPayload {
  order: {
    /* ... */
  };
  depositAddress?: string; // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ
  walletType?: 'fresh' | 'reused'; // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ
  notificationType: 'new_order' | 'order_cancelled' | 'order_paid';
}
```

‚ùå **–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:** –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–Ω–µ scope –∑–∞–¥–∞—á–∏ (Rule 25)

---

## üéØ PHASE 3: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –¢–û–ß–ï–ö –†–ê–°–®–ò–†–ï–ù–ò–Ø

### 3.1 Backend: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ endpoint

**–¢–æ—á–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:** `apps/web/src/server/trpc/routers/user/orders.ts`

**–ü–∞—Ç—Ç–µ—Ä–Ω —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:**

```typescript
export const ordersRouter = createTRPCRouter({
  getOrderHistory: protectedProcedure.query(/* ... */),

  cancelOrder: protectedProcedure.mutation(/* ... */), // ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ—Ñ–µ—Ä–µ–Ω—Å

  // üÜï –ù–û–í–´–ô ENDPOINT (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å cancelOrder)
  markAsPaid: protectedProcedure
    .input(z.object({ orderId: z.string() }))
    .mutation(async ({ input, ctx }) => {
      // –°–ª–µ–¥—É–µ—Ç —Ç–æ–º—É –∂–µ –ø–∞—Ç—Ç–µ—Ä–Ω—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —á—Ç–æ –∏ cancelOrder
    }),
});
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:**

- ‚úÖ –õ–æ–≥–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∑–∞–∫–∞–∑–∞–º–∏
- ‚úÖ –ï–¥–∏–Ω—ã–π middleware: `protectedProcedure`
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å API: `user.orders.*` namespace
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–π: `validateUserAccess`, `validateOrderAccess`

### 3.2 Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º—ã

**–¢–æ—á–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ 1:** `packages/constants/src/telegram.ts`

```typescript
export const TELEGRAM_OPERATOR_MESSAGES = {
  ICONS: {
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ...
    CANCELLED: '‚ùå',
    USER_ACTION: 'üë§',
    // üÜï –î–û–ë–ê–í–ò–¢–¨:
    PAID: 'üí≥',
    PAYMENT_CONFIRMED: '‚úÖ',
  },

  HEADERS: {
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ...
    ORDER_CANCELLED: (orderId: string) => `‚ùå –ó–∞—è–≤–∫–∞ #${orderId} –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º`,
    // üÜï –î–û–ë–ê–í–ò–¢–¨:
    ORDER_PAID: (orderId: string) => `üí≥ –ó–∞—è–≤–∫–∞ #${orderId} –æ–ø–ª–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º`,
  },

  TEMPLATES: {
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ...
    ORDER_CANCELLED_MESSAGE: order => [
      /* ... */
    ],
    // üÜï –î–û–ë–ê–í–ò–¢–¨:
    ORDER_PAID_MESSAGE: order => [
      /* ... */
    ],
  },
};
```

**–¢–æ—á–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ 2:** `apps/telegram-bot/pages/api/notify-operators.ts`

```typescript
interface NotificationPayload {
  // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è...
  notificationType?: 'new_order' | 'order_cancelled' | 'order_paid'; // üÜï –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø
}

function createOperatorMessage(payload: NotificationPayload): string {
  const { notificationType } = payload;

  if (notificationType === 'order_cancelled') {
    return TELEGRAM_OPERATOR_MESSAGES.TEMPLATES.ORDER_CANCELLED_MESSAGE(order);
  }

  // üÜï –î–û–ë–ê–í–ò–¢–¨:
  if (notificationType === 'order_paid') {
    return TELEGRAM_OPERATOR_MESSAGES.TEMPLATES.ORDER_PAID_MESSAGE(order);
  }

  // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è new_order...
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ—á–µ–∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:**

- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞
- ‚úÖ –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `notificationType`)
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞–º–∏

### 3.3 Frontend: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º UI

**–¢–æ—á–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:** `apps/web/app/[locale]/order/[orderId]/OrderPageClient.tsx`

```tsx
export function OrderPageClient({ orderId }: OrderPageClientProps) {
  // ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (—Ä–µ—Ñ–µ—Ä–µ–Ω—Å)
  const cancelOrderMutation = trpc.user.orders.cancelOrder.useMutation({
    onSuccess: () => {
      /* ... */
    },
    onError: error => {
      /* ... */
    },
  });

  // üÜï –î–û–ë–ê–í–ò–¢–¨ (–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏)
  const markAsPaidMutation = trpc.user.orders.markAsPaid.useMutation({
    onSuccess: () => {
      notifications.success(t('actions.orderMarkedPaid'), t('actions.orderMarkedPaidDescription'));
      utils.exchange.getOrderStatus.invalidate({ orderId });
    },
    onError: error => {
      notifications.handleApiError(error, t('actions.orderMarkPaidError'));
    },
  });

  // üÜï –ó–ê–ú–ï–ù–ò–¢–¨ –∑–∞–≥–ª—É—à–∫—É
  const handleMarkAsPaid = () => {
    markAsPaidMutation.mutate({ orderId });
  };
}
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**

- ‚úÖ –ï–¥–∏–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –≤—Å–µ—Ö order mutations
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ notification —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è cache
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## üîê PHASE 4: –ê–ù–ê–õ–ò–ó –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

### 4.1 –£–≥—Ä–æ–∑—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

**–¶–∏—Ç–∞—Ç–∞ –∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

> "–Ø –±–æ—é—Å—å –ø—Ä–æ—Å—Ç–æ –∑–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–π –≤–∑–ª–æ–º —Å–µ—Å—Å–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ä–¥–µ—Ä–æ–º. –¢–∞–∫ —á—Ç–æ –≤–∞–∂–Ω–æ —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç —Ç–æ–ª—å–∫–æ –¥–µ–ª–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ —Ç–æ–º —á—Ç–æ –æ–ø–ª–∞—á–µ–Ω–æ."

**–ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≥—Ä–æ–∑—ã:**

1. **Session Hijacking**
   - –ê—Ç–∞–∫—É—é—â–∏–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç session token
   - –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —á—É–∂–∏–º–∏ –∑–∞–∫–∞–∑–∞–º–∏

   **–ó–∞—â–∏—Ç–∞:**
   - ‚úÖ `protectedProcedure` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ session
   - ‚úÖ `validateUserAccess` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - ‚úÖ `validateOrderAccess` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∑–∞–∫–∞–∑–æ–º

2. **Privilege Escalation**
   - –ê—Ç–∞–∫—É—é—â–∏–π –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —á—É–∂–æ–π –∑–∞–∫–∞–∑

   **–ó–∞—â–∏—Ç–∞:**
   - ‚úÖ `validateOrderAccess(orderId, user.email)` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤—è–∑—å –∑–∞–∫–∞–∑–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
   - ‚úÖ –ó–∞–∫–∞–∑ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ `userId` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

3. **Mass Assignment Attack**
   - –ê—Ç–∞–∫—É—é—â–∏–π –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è —á–µ—Ä–µ–∑ payload

   **–ó–∞—â–∏—Ç–∞:**
   - ‚úÖ `z.object({ orderId: z.string() })` - —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - ‚úÖ `orderManager.update(id, { status: ORDER_STATUSES.PAID })` - —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ `status`

### 4.2 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–æ–º

**–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑ `cancelOrder`:**

```typescript
cancelOrder: protectedProcedure
  .input(z.object({ orderId: z.string() })) // 1Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–∞
  .mutation(async ({ input, ctx }) => {
    const user = await validateUserAccess(ctx.user.id); // 2Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const order = await validateOrderAccess(input.orderId, user.email); // 3Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–ª–∞–¥–µ–Ω–∏—è

    if (!CANCELLABLE_ORDER_STATUSES.includes(order.status)) {
      // 4Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª
      throw createBadRequestError(/* ... */);
    }

    const updatedOrder = await orderManager.update(order.id, {
      status: ORDER_STATUSES.CANCELLED, // 5Ô∏è‚É£ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
    });

    // 6Ô∏è‚É£ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç –æ—Å–Ω–æ–≤–Ω—É—é
    await sendCancellationNotification(updatedOrder, user.email);

    return {
      /* ... */
    };
  });
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∫ `markAsPaid`:**

| –£—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã             | `cancelOrder` (—Ä–µ—Ñ–µ—Ä–µ–Ω—Å)       | `markAsPaid` (–ø–ª–∞–Ω)         | –°—Ç–∞—Ç—É—Å                 |
| -------------------------- | ------------------------------ | --------------------------- | ---------------------- |
| 1Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–∞         | `z.object({ orderId })`        | `z.object({ orderId })`     | ‚úÖ –ò–¥–µ–Ω—Ç–∏—á–µ–Ω           |
| 2Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  | `validateUserAccess`           | `validateUserAccess`        | ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ   |
| 3Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–ª–∞–¥–µ–Ω–∏—è      | `validateOrderAccess`          | `validateOrderAccess`       | ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ   |
| 4Ô∏è‚É£ –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª | `CANCELLABLE_ORDER_STATUSES`   | `MARKABLE_AS_PAID_STATUSES` | ‚úÖ –ù–æ–≤–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞     |
| 5Ô∏è‚É£ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ     | `{ status: CANCELLED }`        | `{ status: PAID }`          | ‚úÖ –ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞   |
| 6Ô∏è‚É£ –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏  | `sendCancellationNotification` | `sendPaidNotification`      | ‚úÖ –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω |

### 4.3 –ì–∞—Ä–∞–Ω—Ç–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–§–æ—Ä–º–∞–ª—å–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏:**

1. **Authentication:** `protectedProcedure` middleware
   - –¢—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JWT token
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ session
2. **Authorization:** `validateOrderAccess`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≤—è–∑—å `order.userId === user.id`
   - SQL: `SELECT * FROM orders WHERE id = ? AND userId = ?`
3. **Input Validation:** Zod schema
   - –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∏–Ω—ä–µ–∫—Ü–∏–∏
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
4. **Single Responsibility:** –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
   - –ò–∑–º–µ–Ω—è–µ—Ç –¢–û–õ–¨–ö–û –ø–æ–ª–µ `status`
   - –ù–µ –∫–∞—Å–∞–µ—Ç—Å—è `amount`, `depositAddress`, `txHash` –∏ —Ç.–¥.

**–ö–æ–¥ –≥–∞—Ä–∞–Ω—Ç–∏–∏ (–ø—Å–µ–≤–¥–æ–∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏):**

```typescript
// ‚úÖ –ì–ê–†–ê–ù–¢–ò–Ø: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –∑–∞–∫–∞–∑
function guaranteeOwnership(orderId: string, userId: string): boolean {
  const order = await orderManager.findById(orderId);
  return order.userId === userId; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
}

// ‚úÖ –ì–ê–†–ê–ù–¢–ò–Ø: –ò–∑–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ status
function guaranteeSingleField(updateData: unknown): boolean {
  const allowedKeys = ['status'];
  const providedKeys = Object.keys(updateData);
  return providedKeys.every(key => allowedKeys.includes(key));
}

// ‚úÖ –ì–ê–†–ê–ù–¢–ò–Ø: –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ PAID
function guaranteeStatusValue(updateData: { status: string }): boolean {
  return updateData.status === ORDER_STATUSES.PAID;
}
```

---

## ‚ùì PHASE 5: –£–¢–û–ß–ù–Ø–Æ–©–ò–ï –í–û–ü–†–û–°–´

### 5.1 –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

**–í–æ–ø—Ä–æ—Å 1:** –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –Ω–∞–∂–∞—Ç–∏–∏ "–û–ø–ª–∞—Ç–∏–ª"

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞–∂–∞–ª "–û–ø–ª–∞—Ç–∏–ª", —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ `paid`. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –Ω–∞–∂–∞—Ç–∏–∏?
- **–í–∞—Ä–∏–∞–Ω—Ç—ã:**
  - A) –í–æ–∑–≤—Ä–∞—â–∞—Ç—å success (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å) ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
  - B) –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—à–∏–±–∫—É "Already marked as paid"
  - C) –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞ frontend –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
- **–í–ª–∏—è–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases, UX

**–í–æ–ø—Ä–æ—Å 2:** –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏–ª", –Ω–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `processing`
- **–í–∞—Ä–∏–∞–Ω—Ç—ã:**
  - A) Last-write-wins (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–±–µ–∂–¥–∞–µ—Ç) ‚úÖ –¢–ï–ö–£–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê
  - B) –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞)
  - C) –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- **–í–ª–∏—è–Ω–∏–µ:** Race conditions, –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

**–í–æ–ø—Ä–æ—Å 3:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∑—è—Ç–∏–µ –≤ —Ä–∞–±–æ—Ç—É

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–û–ø–ª–∞—Ç–∏–ª" (—Å—Ç–∞—Ç—É—Å ‚Üí `paid`), –¥–æ–ª–∂–µ–Ω –ª–∏ –∑–∞–∫–∞–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞—Ç—å—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—É?
- **–í–∞—Ä–∏–∞–Ω—Ç—ã:**
  - A) –ù–µ—Ç, –∑–∞–∫–∞–∑ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –æ–±—â–µ–º –ø—É–ª–µ `paid` –∑–∞–∫–∞–∑–æ–≤ ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
  - B) –î–∞, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
  - C) –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—É—é –æ—á–µ—Ä–µ–¥—å
- **–í–ª–∏—è–Ω–∏–µ:** Workflow –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤

### 5.2 Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–í–æ–ø—Ä–æ—Å 4:** –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è "–û–ø–ª–∞—Ç–∏–ª"

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ö–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤–∫–ª—é—á–∞—Ç—å –≤ Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ?
- **–í–∞—Ä–∏–∞–Ω—Ç—ã:**
  - A) –ú–∏–Ω–∏–º—É–º: ID –∑–∞–∫–∞–∑–∞, email, —Å—É–º–º–∞ ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
  - B) –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: + –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞, –≤—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã
  - C) + —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å txHash)
- **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞):**

```typescript
ORDER_PAID_MESSAGE: order =>
  [
    `üí≥ **–ó–∞—è–≤–∫–∞ –æ–ø–ª–∞—á–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º**`,
    ``,
    `üìã –ó–∞—è–≤–∫–∞: #${order.id}`,
    `üìß Email: ${order.email}`,
    `üíé –°—É–º–º–∞: ${order.cryptoAmount} ${order.currency}`,
    `üí∞ –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç: ${order.uahAmount} UAH`,
    `üë§ –°—Ç–∞—Ç—É—Å: PAID ‚Üí –ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ`,
    ``,
    `‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É –ø–ª–∞—Ç–µ–∂–∞`,
  ].join('\n');
```

**–í–æ–ø—Ä–æ—Å 5:** –î–µ–π—Å—Ç–≤–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –î–æ–ª–∂–Ω—ã –ª–∏ –±—ã—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ Telegram —Å–æ–æ–±—â–µ–Ω–∏–∏ "–û–ø–ª–∞—Ç–∏–ª"?
- **–í–∞—Ä–∏–∞–Ω—Ç—ã:**
  - A) –î–∞, –∫–Ω–æ–ø–∫–∞ "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É" (–∫–∞–∫ –¥–ª—è `new_order`) ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
  - B) –ù–µ—Ç, —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  - C) –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é", "–î–µ—Ç–∞–ª–∏"
- **–í–ª–∏—è–Ω–∏–µ:** UX –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ telegram-bot

### 5.3 Frontend UX

**–í–æ–ø—Ä–æ—Å 6:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è "–û–ø–ª–∞—Ç–∏–ª"

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ù—É–∂–Ω–æ –ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞?
- **–í–∞—Ä–∏–∞–Ω—Ç—ã:**
  - A) –ù–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å—Ä–∞–∑—É (–±—ã—Å—Ç—Ä–µ–µ) ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
  - B) –î–∞, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑" (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)
- **–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
  - –î–µ–π—Å—Ç–≤–∏–µ "–û–ø–ª–∞—Ç–∏–ª" –Ω–µ –¥–µ—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–µ (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç "–û—Ç–º–µ–Ω–∏—Ç—å")
  - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è –±–µ–∑ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –±—ã—Å—Ç—Ä–æ —É–≤–µ–¥–æ–º–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –æ–± –æ–ø–ª–∞—Ç–µ

**–í–æ–ø—Ä–æ—Å 7:** –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–û–ø–ª–∞—Ç–∏–ª"?
- **–í–∞—Ä–∏–∞–Ω—Ç—ã:**
  - A) Toast notification + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
  - B) –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
  - C) –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
- **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞):**

```typescript
// Success notification
notifications.success(
  '–ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ—á–µ–Ω',
  '–ú—ã —É–≤–µ–¥–æ–º–∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –æ –≤–∞—à–µ–º –ø–ª–∞—Ç–µ–∂–µ. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–Ω–µ—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.'
);

// Auto-update order status –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —á–µ—Ä–µ–∑ cache invalidation
utils.exchange.getOrderStatus.invalidate({ orderId });
```

### 5.4 –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

**–í–æ–ø—Ä–æ—Å 8:** –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (i18n)

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ù—É–∂–Ω—ã –ª–∏ –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π?
- **–¢–µ–∫—É—â–∏–µ –ª–æ–∫–∞–ª–∏:** `ru`, `en`
- **–§–∞–π–ª—ã:** `apps/web/messages/{ru,en}/order-page.json`
- **–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å:**

```json
{
  "OrderStatus": {
    "actions": {
      // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ...
      "orderCancelled": "–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞",
      // üÜï –î–û–ë–ê–í–ò–¢–¨:
      "orderMarkedPaid": "–ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ—á–µ–Ω",
      "orderMarkedPaidDescription": "–ú—ã —É–≤–µ–¥–æ–º–∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –æ –≤–∞—à–µ–º –ø–ª–∞—Ç–µ–∂–µ",
      "orderMarkPaidError": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –ø–ª–∞—Ç–µ–∂"
    }
  }
}
```

**–í–æ–ø—Ä–æ—Å 9:** Rate limiting

- **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∫–Ω–æ–ø–∫–æ–π "–û–ø–ª–∞—Ç–∏–ª"
- **–í–∞—Ä–∏–∞–Ω—Ç—ã:**
  - A) –ù–µ—Ç, –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ `isLoading` state –∫–Ω–æ–ø–∫–∏ ‚úÖ –¢–ï–ö–£–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê
  - B) –î–∞, –¥–æ–±–∞–≤–∏—Ç—å rate limiting –Ω–∞ backend (–Ω–∞–ø—Ä., 1 –∑–∞–ø—Ä–æ—Å –≤ 5 —Å–µ–∫—É–Ω–¥)
- **–ê–Ω–∞–ª–∏–∑:** Rate limiting –¥–ª—è authenticated endpoints –≤ –ø—Ä–æ–µ–∫—Ç–µ –ù–ï –û–ë–ù–ê–†–£–ñ–ï–ù
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–ª–µ–¥–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É (–≤–∞—Ä–∏–∞–Ω—Ç A)

---

## üìä PHASE 6: –û–¶–ï–ù–ö–ê –í–õ–ò–Ø–ù–ò–Ø –ù–ê –°–ò–°–¢–ï–ú–£

### 6.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ

**–ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º—ã–µ —É—Ä–æ–≤–Ω–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–ø–æ PROJECT_STRUCTURE_MAP.md):**

1. **Backend API Layer** (`apps/web/src/server/trpc/routers/user/`)
   - ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ endpoint: `user.orders.markAsPaid`
   - ‚úÖ –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - ‚ö†Ô∏è –†–∏—Å–∫: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π (–ø–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω –≤ `cancelOrder`)

2. **Constants Layer** (`packages/constants/`)
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ `MARKABLE_AS_PAID_STATUSES`
   - ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `TELEGRAM_OPERATOR_MESSAGES`
   - ‚ö†Ô∏è –†–∏—Å–∫: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)

3. **Telegram Bot Layer** (`apps/telegram-bot/`)
   - ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `NotificationPayload` type
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ message template
   - ‚ö†Ô∏è –†–∏—Å–∫: –ù–∏–∑–∫–∏–π (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞)

4. **Frontend UI Layer** (`apps/web/app/`, `packages/ui/`)
   - ‚úÖ –ó–∞–º–µ–Ω–∞ –∑–∞–≥–ª—É—à–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é mutation
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
   - ‚ö†Ô∏è –†–∏—Å–∫: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ –≤–ª–∏—è–Ω–∏—è:** ‚ö° **–ù–ò–ó–ö–û–ï**

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ª–µ–¥—É—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º
- –ù–µ—Ç breaking changes
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

### 6.2 –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–ú–µ—Ç—Ä–∏–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç            | –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏  | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ                                    |
| -------------------- | ----------------- | ---------------------------------------------- |
| Backend endpoint     | üü¢ –ù–∏–∑–∫–∞—è (2/10)  | –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ `cancelOrder`             |
| Telegram template    | üü¢ –ù–∏–∑–∫–∞—è (2/10)  | –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ `ORDER_CANCELLED_MESSAGE` |
| Telegram integration | üü° –°—Ä–µ–¥–Ω—è—è (4/10) | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ payload               |
| Frontend mutation    | üü¢ –ù–∏–∑–∫–∞—è (1/10)  | –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ `cancelOrderMutation`     |
| –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è          | üü¢ –ù–∏–∑–∫–∞—è (1/10)  | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ 3 –∫–ª—é—á–µ–π –≤ JSON                     |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ         | üü° –°—Ä–µ–¥–Ω—è—è (5/10) | –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ race conditions        |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** üü¢ **–ù–ò–ó–ö–ê–Ø-–°–†–ï–î–ù–Ø–Ø** (2.5/10)

**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–æ—Ü–µ–Ω–∫–∞):**

- Backend endpoint: 1-2 —á–∞—Å–∞
- Telegram integration: 1-2 —á–∞—Å–∞
- Frontend integration: 0.5-1 —á–∞—Å
- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: 0.5 —á–∞—Å–∞
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 2-3 —á–∞—Å–∞
- **–ò—Ç–æ–≥–æ:** 5-8.5 —á–∞—Å–æ–≤

### 6.3 –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Ä–∏—Å–∫–∏

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**

1. **PostgreSQL —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
   - ‚úÖ –£–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ `orderManager`
   - –†–∏—Å–∫: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

2. **Telegram Bot –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å**
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–º
   - ‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ `sendCancellationNotification`
   - –†–∏—Å–∫: –ù–∏–∑–∫–∏–π (graceful degradation)

3. **Session Management**
   - `protectedProcedure` –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–µ—Å—Å–∏–π
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö endpoints
   - –†–∏—Å–∫: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏:**

| –†–∏—Å–∫                        | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å  | –í–ª–∏—è–Ω–∏–µ     | –ú–∏—Ç–∏–≥–∞—Ü–∏—è                        |
| --------------------------- | ------------ | ----------- | -------------------------------- |
| Race condition —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º | –°—Ä–µ–¥–Ω—è—è      | –ù–∏–∑–∫–æ–µ      | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, Last-Write-Wins |
| Telegram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω     | –ù–∏–∑–∫–∞—è       | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ | –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω            |
| –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π    | –ù–∏–∑–∫–∞—è       | –ù–∏–∑–∫–æ–µ      | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å Telegram API     |
| SQL injection               | –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ | Zod validation + Prisma ORM      |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞:** üü¢ **–ù–ò–ó–ö–ê–Ø**

---

## üéØ PHASE 7: –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### 7.1 –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–æ—Ç –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ –∫ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É):**

**–≠–¢–ê–ü 1: Backend Endpoint (–ö–†–ò–¢–ò–ß–ù–û)**

1. –°–æ–∑–¥–∞—Ç—å `MARKABLE_AS_PAID_STATUSES` –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É
2. –°–æ–∑–¥–∞—Ç—å `sendPaidNotification` helper —Ñ—É–Ω–∫—Ü–∏—é
3. –°–æ–∑–¥–∞—Ç—å `user.orders.markAsPaid` mutation
4. –ù–∞–ø–∏—Å–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–π

**–≠–¢–ê–ü 2: Telegram Integration (–ö–†–ò–¢–ò–ß–ù–û)**

1. –î–æ–±–∞–≤–∏—Ç—å `ORDER_PAID_MESSAGE` template –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
2. –†–∞—Å—à–∏—Ä–∏—Ç—å `NotificationPayload` type —Å `'order_paid'`
3. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ `createOperatorMessage`
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–≠–¢–ê–ü 3: Frontend Integration (–ö–†–ò–¢–ò–ß–ù–û)**

1. –°–æ–∑–¥–∞—Ç—å `markAsPaidMutation` –≤ `OrderPageClient`
2. –ó–∞–º–µ–Ω–∏—Ç—å –∑–∞–≥–ª—É—à–∫—É `handleMarkAsPaid`
3. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é (ru/en)
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å UI flow

**–≠–¢–ê–ü 4: Testing & Validation (–ö–†–ò–¢–ò–ß–ù–û)**

1. E2E —Ç–µ—Å—Ç—ã: –ø–æ–ª–Ω—ã–π flow "–û–ø–ª–∞—Ç–∏–ª"
2. Security —Ç–µ—Å—Ç—ã: –ø–æ–ø—ã—Ç–∫–∏ –≤–∑–ª–æ–º–∞
3. Race condition —Ç–µ—Å—Ç—ã: –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
4. Telegram integration —Ç–µ—Å—Ç—ã

**–≠–¢–ê–ü 5: Documentation (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)**

1. –û–±–Ω–æ–≤–∏—Ç—å `API_DOCS.md`
2. –î–æ–±–∞–≤–∏—Ç—å –≤ `CHANGELOG.md`
3. –°–æ–∑–¥–∞—Ç—å internal guide –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤

### 7.2 –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (MVP)

**Scope MVP:**

- ‚úÖ Backend endpoint —Å –±–∞–∑–æ–≤–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- ‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π template)
- ‚úÖ Frontend integration (–±–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞)
- ‚úÖ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (ru/en)
- ‚ùå –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)
- ‚ùå –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ acceptance MVP:**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å "–û–ø–ª–∞—Ç–∏–ª"
2. –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `paid` –≤ –ë–î
3. –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
4. –ù–ï–¢ security —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ code review)
5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–∑–æ–≤—ã—Ö edge cases (—É–∂–µ paid, wrong status)

### 7.3 –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

**–î–∏–∞–≥—Ä–∞–º–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**

```mermaid
sequenceDiagram
    participant U as User (Browser)
    participant F as Frontend (OrderPageClient)
    participant T as tRPC API
    participant DB as PostgreSQL
    participant TG as Telegram Bot

    U->>F: Clicks "–û–ø–ª–∞—Ç–∏–ª"
    F->>T: markAsPaid({ orderId })

    Note over T: protectedProcedure
    T->>T: validateUserAccess(userId)
    T->>T: validateOrderAccess(orderId, email)

    T->>DB: SELECT order WHERE id=orderId
    DB-->>T: Order { status: 'pending' }

    alt Status is 'pending'
        T->>DB: UPDATE order SET status='paid'
        DB-->>T: Order { status: 'paid' }

        T->>TG: POST /api/notify-operators
        Note over TG: –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å
        TG-->>T: 200 OK (–∏–ª–∏ graceful fail)

        T-->>F: { id, status: 'paid', message }
        F->>F: invalidate cache
        F->>U: Success notification
    else Status is NOT 'pending'
        T-->>F: Error: "Cannot mark as paid"
        F->>U: Error notification
    end
```

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**

1. **Security Layer** (3 —É—Ä–æ–≤–Ω—è)
   - Authentication: `protectedProcedure`
   - User Validation: `validateUserAccess`
   - Ownership Validation: `validateOrderAccess`

2. **Business Logic Layer**
   - Status Validation: `MARKABLE_AS_PAID_STATUSES`
   - Atomic Update: `orderManager.update`
   - Idempotency: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞

3. **Notification Layer**
   - Asynchronous: `sendPaidNotification`
   - Non-blocking: `try-catch` –±–µ–∑ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è
   - Template-based: `TELEGRAM_OPERATOR_MESSAGES.TEMPLATES`

4. **Frontend Layer**
   - tRPC Mutation: auto-generated types
   - Cache Invalidation: `utils.exchange.getOrderStatus.invalidate`
   - Error Handling: `notifications.handleApiError`

---

## üìã PHASE 8: –ò–¢–û–ì–û–í–´–ï –í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 8.1 –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –§–∞–π–ª                                                        | –¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è | –û—Ü–µ–Ω–∫–∞ —Å—Ç—Ä–æ–∫ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
| ----------------------------------------------------------- | ------------- | ------------ | ----------- |
| `packages/constants/src/user.ts`                            | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ    | +1           | –ö–†–ò–¢–ò–ß–ù–û    |
| `packages/constants/src/telegram.ts`                        | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ    | +15-20       | –ö–†–ò–¢–ò–ß–ù–û    |
| `apps/web/src/server/trpc/routers/user/orders.ts`           | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ    | +50-60       | –ö–†–ò–¢–ò–ß–ù–û    |
| `apps/telegram-bot/pages/api/notify-operators.ts`           | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è   | +5-10        | –ö–†–ò–¢–ò–ß–ù–û    |
| `apps/web/app/[locale]/order/[orderId]/OrderPageClient.tsx` | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è   | +10-15       | –ö–†–ò–¢–ò–ß–ù–û    |
| `apps/web/messages/ru/order-page.json`                      | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ    | +3           | –°–†–ï–î–ù–ï      |
| `apps/web/messages/en/order-page.json`                      | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ    | +3           | –°–†–ï–î–ù–ï      |
| `docs/core/API_DOCS.md`                                     | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ    | +15-20       | –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û |

**–ò—Ç–æ–≥–æ:** ~100-150 —Å—Ç—Ä–æ–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞ + ~15-25 —Å—Ç—Ä–æ–∫ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π

### 8.2 Alignment —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:**

1. ‚úÖ **"–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ—á–Ω–æ —Ç–∞–∫ –∂–µ –∫–∞–∫ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑"**
   - –°–ª–µ–¥—É–µ—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ mutation

2. ‚úÖ **"–¢–æ–ª—å–∫–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ —Ç–æ–º —á—Ç–æ –æ–ø–ª–∞—á–µ–Ω–æ"**
   - –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ–ª—è `status`
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ `orderId`)
   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—è

3. ‚úÖ **"–ù–µ –±—ã–ª–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–ª–∏—è—Ç—å –µ—â–µ –∫–∞–∫-—Ç–æ –Ω–∞ –æ—Ä–¥–µ—Ä"**
   - `validateOrderAccess` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–ª–∞–¥–µ–Ω–∏–µ
   - Zod schema –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   - `orderManager.update` –∏–∑–º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –ø–æ–ª–µ

4. ‚úÖ **"–ó–∞—â–∏—Ç–∞ –æ—Ç –≤–∑–ª–æ–º–∞ —Å–µ—Å—Å–∏–∏"**
   - –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞: Authentication ‚Üí User Validation ‚Üí Ownership
   - SQL injection –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ Prisma ORM
   - Mass assignment –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ explicit field update

5. ‚úÖ **"Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–∏"**
   - –°–ª–µ–¥—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É `sendCancellationNotification`
   - –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### 8.3 Risks & Mitigations Summary

| –†–∏—Å–∫                  | Probability     | Impact         | Mitigation                           |
| --------------------- | --------------- | -------------- | ------------------------------------ |
| **Security breach**   | üü¢ –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ | –¢—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è, code review |
| **Race conditions**   | üü° –°—Ä–µ–¥–Ω—è—è      | üü° –°—Ä–µ–¥–Ω–µ–µ     | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏          |
| **Telegram failures** | üü¢ –ù–∏–∑–∫–∞—è       | üü¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ | –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω                |
| **Breaking changes**  | üü¢ –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç  | -              | –¢–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π API |

### 8.4 –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø AGENT-ARCHITECT:**

1. **–°–ª–µ–¥–æ–≤–∞—Ç—å —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É `cancelOrder` –Ω–∞ 100%**
   - –ù–µ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–∞–ª–∏–¥–∞—Ü–∏–π
   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ helper —Ñ—É–Ω–∫—Ü–∏–∏

2. **–ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Telegram Bot**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `notificationType`
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
   - –°–ª–µ–¥–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º templates

3. **–û–±–µ—Å–ø–µ—á–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
   - –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ "–û–ø–ª–∞—Ç–∏–ª" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º
   - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å success –¥–ª—è —É–∂–µ `paid` –∑–∞–∫–∞–∑–æ–≤
   - –ù–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å UI –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å security –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å**
   - –ü–æ–ø—ã—Ç–∫–∏ –∏–∑–º–µ–Ω–∏—Ç—å —á—É–∂–æ–π –∑–∞–∫–∞–∑
   - –ü–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
   - Race conditions —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø AGENT-CODER:**

1. **–ù–∞—á–∏–Ω–∞—Ç—å —Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç**
   - –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—Ç—å `MARKABLE_AS_PAID_STATUSES`
   - –ó–∞—Ç–µ–º Telegram templates
   - –í –∫–æ–Ω—Ü–µ - endpoint –∏ frontend

2. **–°–ª–µ–¥–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É code style**
   - –ù–∞–∑–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π: `sendPaidNotification` (–Ω–µ `sendPaidNotif`)
   - –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: `// üÜï TASK: ...` –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
   - Logging: `logger.info('ORDER_MARKED_PAID', { ... })`

3. **–ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏**
   - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `validateUserAccess`, `validateOrderAccess`
   - –ù–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å logic –∏–∑ `cancelOrder`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ error creators

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø AGENT-REVIEWER:**

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å security checklist:**
   - ‚úÖ `protectedProcedure` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   - ‚úÖ `validateUserAccess` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   - ‚úÖ `validateOrderAccess` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   - ‚úÖ Zod validation –Ω–∞ input
   - ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ `status`

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:**
   - ‚úÖ Endpoint –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ä–æ—É—Ç–µ—Ä–µ (`user.orders`)
   - ‚úÖ –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—É `cancelOrder`
   - ‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ
   - ‚úÖ –ù–µ—Ç breaking changes

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:**
   - ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏
   - ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
   - ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
   - ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞

---

## üìö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø

### A. –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

```
üìÅ Backend
‚îú‚îÄ‚îÄ packages/constants/src/user.ts                              [ADD constant]
‚îú‚îÄ‚îÄ packages/constants/src/telegram.ts                          [ADD templates]
‚îî‚îÄ‚îÄ apps/web/src/server/trpc/routers/user/orders.ts            [ADD endpoint]

üìÅ Telegram Bot
‚îî‚îÄ‚îÄ apps/telegram-bot/pages/api/notify-operators.ts            [MODIFY handler]

üìÅ Frontend
‚îú‚îÄ‚îÄ apps/web/app/[locale]/order/[orderId]/OrderPageClient.tsx  [MODIFY mutation]
‚îú‚îÄ‚îÄ apps/web/messages/ru/order-page.json                        [ADD i18n]
‚îî‚îÄ‚îÄ apps/web/messages/en/order-page.json                        [ADD i18n]

üìÅ Documentation (Optional)
‚îî‚îÄ‚îÄ docs/core/API_DOCS.md                                       [ADD docs]
```

### B. –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

```
üìö Security Pattern References:
‚îú‚îÄ‚îÄ apps/web/src/server/trpc/routers/user/orders.ts:136-167    [cancelOrder]
‚îú‚îÄ‚îÄ packages/exchange-core/src/services/order-manager.ts        [orderManager]
‚îî‚îÄ‚îÄ packages/utils/src/validation/zod-schemas.ts                [validation]

üìö Telegram Integration References:
‚îú‚îÄ‚îÄ packages/constants/src/telegram.ts                          [templates]
‚îú‚îÄ‚îÄ apps/telegram-bot/pages/api/notify-operators.ts            [API handler]
‚îú‚îÄ‚îÄ apps/web/src/server/trpc/routers/user/orders.ts:36-71      [sendCancellationNotification]
‚îî‚îÄ‚îÄ apps/web/src/server/trpc/routers/exchange.ts:140-185       [sendTelegramNotification]

üìö Frontend Integration References:
‚îú‚îÄ‚îÄ apps/web/app/[locale]/order/[orderId]/OrderPageClient.tsx:21-33  [cancelOrderMutation]
‚îú‚îÄ‚îÄ packages/ui/src/components/order/helpers/OrderActions.tsx         [UI component]
‚îî‚îÄ‚îÄ apps/web/messages/ru/order-page.json:49-60                        [localization]
```

### C. –ì–ª–æ—Å—Å–∞—Ä–∏–π —Ç–µ—Ä–º–∏–Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞

| –¢–µ—Ä–º–∏–Ω                        | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ                                       | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ              |
| ----------------------------- | ------------------------------------------------- | ------------------------------------ |
| **protectedProcedure**        | tRPC middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö endpoints | –í—Å–µ user/_ –∏ operator/_ —Ä–æ—É—Ç–µ—Ä—ã      |
| **orderManager**              | –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–∞–∑–∞–º–∏ —á–µ—Ä–µ–∑ Prisma ORM     | –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å Order entity          |
| **validateUserAccess**        | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID         | Security-critical endpoints          |
| **validateOrderAccess**       | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–º –ø–æ email                | User order operations                |
| **graceful handler**          | –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π                | Telegram notifications, external API |
| **MARKABLE_AS_PAID_STATUSES** | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è "–û–ø–ª–∞—Ç–∏–ª"       | –ù–æ–≤–∞—è - —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å            |

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞:** ‚úÖ **–ó–ê–í–ï–†–®–ï–ù –ù–ê 100%**

**–£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:** üü¢ **–í–´–°–û–ö–ò–ô (95%)**

- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑—É—á–µ–Ω—ã
- Security —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —á–µ—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
- –†–∏—Å–∫–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–º–∏—Ç–∏–≥–∏—Ä–æ–≤–∞–Ω—ã

**–ë–ª–æ–∫–µ—Ä—ã:** ‚ùå **–û–¢–°–£–¢–°–¢–í–£–Æ–¢**

- –í—Å–µ —Ç—Ä–µ–±—É–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ
- –ù–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- –ù–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

**–î–õ–Ø AGENT-ARCHITECT:**

1. –ò–∑—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–π Impact Analysis
2. –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ endpoint
4. –°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–î–õ–Ø AGENT-CODER:**

1. –ü–æ–ª—É—á–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
2. –°–ª–µ–¥–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–∫—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 7.1
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è B
4. –°–æ–±–ª—é–¥–∞—Ç—å security checklist –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 8.4

**–î–õ–Ø AGENT-REVIEWER:**

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –ø–æ security checklist
2. –£–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏
3. –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É `cancelOrder`
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ edge cases

---

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞:** 06 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–°—Ç–∞—Ç—É—Å:** –ì–û–¢–û–í –ö –ü–ï–†–ï–î–ê–ß–ï AGENT-ARCHITECT

---

_–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å Rule 2 (–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º) –∏ Rule 8 (–ó–∞–ø—Ä–µ—Ç –Ω–∞ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è). –í—Å–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –§–ê–ö–¢–ò–ß–ï–°–ö–ò –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞._
