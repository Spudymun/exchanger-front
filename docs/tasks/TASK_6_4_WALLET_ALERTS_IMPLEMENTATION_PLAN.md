# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ 6.4: Alerting System –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–æ–≤

> **–°–æ–∑–¥–∞–Ω–æ:** 20 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
> **–†–æ–ª—å:** –ê–≥–µ–Ω—Ç-–∫–æ–¥–µ—Ä (—Ñ–æ–∫—É—Å –Ω–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)  
> **–¶–µ–ª—å:** –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ alerting —Å–∏—Å—Ç–µ–º—ã –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É  
> **–ò—Å—Ç–æ—á–Ω–∏–∫:** –ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏ 6.4 –∏–∑ ORDER_SYSTEM_IMPLEMENTATION_TASK_LIST.md

---

## üéØ –ê–ù–ê–õ–ò–ó –ó–ê–î–ê–ß–ò –ò –û–ë–û–°–ù–û–í–ê–ù–ò–ï –ù–ï–û–ë–•–û–î–ò–ú–û–°–¢–ò

### üìã **–¢–û–ß–ù–û–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ó–ê–î–ê–ß–ò 6.4:**

**–ò–∑ ORDER_SYSTEM_IMPLEMENTATION_TASK_LIST.md:**

- –°–æ–∑–¥–∞—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —É–º–µ–Ω—å—à–µ–Ω–∏–∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–≥–¥–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ < 10%
- –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram/email –∞–¥–º–∏–Ω–∞–º/–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –ø—É–ª –∫–æ—à–µ–ª—å–∫–æ–≤

### üö® **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –í–ê–ñ–ù–û–°–¢–¨:**

1. **–ë–∏–∑–Ω–µ—Å-—Ä–∏—Å–∫–∏ –±–µ–∑ –∞–ª–µ—Ä—Ç–æ–≤:**
   - –ö–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –±–µ–∑ –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –æ–ø–ª–∞—Ç—ã
   - –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ —É–∑–Ω–∞—é—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –≤–æ–≤—Ä–µ–º—è
   - –ü—Ä–æ—Å—Ç–æ–∏ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞—è–≤–æ–∫

2. **–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å:**
   - Proactive –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–º–µ—Å—Ç–æ reactive
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ emergency —Å–∏—Ç—É–∞—Ü–∏–π
   - –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø—É–ª–∞ –∫–æ—à–µ–ª—å–∫–æ–≤

---

## üìä –§–ê–ö–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–´

### ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ (70%):**

#### **1. WalletPoolManager** ‚úÖ

```typescript
// packages/exchange-core/src/services/wallet-pool-manager.ts
export class WalletPoolManager {
  async getPoolStats(currency: CryptoCurrency): Promise<PoolStats>;
  // PoolStats: { currency, totalWallets, availableWallets, occupiedWallets, queueSize }
}
```

#### **2. –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è** ‚úÖ

```typescript
// packages/constants/src/wallet-pool-config.ts
export const WALLET_POOL_CONFIG = {
  MIN_AVAILABLE_THRESHOLDS: {
    BTC: 3, // –ú–∏–Ω–∏–º—É–º —Å–≤–æ–±–æ–¥–Ω—ã—Ö BTC –∫–æ—à–µ–ª—å–∫–æ–≤
    ETH: 2, // –ú–∏–Ω–∏–º—É–º —Å–≤–æ–±–æ–¥–Ω—ã—Ö ETH –∫–æ—à–µ–ª—å–∫–æ–≤
    USDT: 5, // –ú–∏–Ω–∏–º—É–º —Å–≤–æ–±–æ–¥–Ω—ã—Ö USDT –∫–æ—à–µ–ª—å–∫–æ–≤
    LTC: 2, // –ú–∏–Ω–∏–º—É–º —Å–≤–æ–±–æ–¥–Ω—ã—Ö LTC –∫–æ—à–µ–ª—å–∫–æ–≤
  },
};
```

#### **3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ API** ‚úÖ

```typescript
// apps/web/src/server/trpc/routers/shared.ts
getWalletPoolStats: operatorAndSupport
  .input(securityEnhancedSearchOrdersSchema.pick({ currency: true }))
  .query(async ({ input }) => {
    const walletPoolManager = await WalletPoolManagerFactory.create();
    return await walletPoolManager.getPoolStats(input.currency);
  });
```

#### **4. Logger —Å–∏—Å—Ç–µ–º–∞** ‚úÖ

```typescript
// packages/utils/src/logger.ts - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```

#### **5. Email —Å–∏—Å—Ç–µ–º–∞** ‚úÖ

```typescript
// packages/email-service/ - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è email –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
// packages/exchange-core/src/services/queue-email-notifier.ts
```

### ‚ùå **–û–¢–°–£–¢–°–¢–í–£–Æ–©–ò–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ (30%):**

1. **Alerting Logic** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ thresholds
2. **Background Process** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
3. **Notification Dispatcher** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –∞–¥–º–∏–Ω–∞–º/–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–ò

### üéØ **–ü–†–ò–ù–¶–ò–ü: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**

#### **1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤** ‚úÖ

- **–ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å** –Ω–æ–≤—ã–µ packages
- **–†–∞—Å—à–∏—Ä–∏—Ç—å** WalletPoolManager –Ω–æ–≤—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** existing Logger –∏ Email systems

#### **2. Integration Points:**

- **WalletPoolManager** ‚Üí –¥–æ–±–∞–≤–∏—Ç—å `checkAlerts()` –º–µ—Ç–æ–¥
- **Background Service** ‚Üí –Ω–æ–≤—ã–π —Ñ–∞–π–ª –≤ `exchange-core/services/`
- **Notification System** ‚Üí –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å existing email infrastructure

#### **3. –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º:**

- **Factory Pattern** (–∫–∞–∫ –≤ WalletPoolManagerFactory)
- **Strategy Pattern** (–∫–∞–∫ –≤ allocation strategies)
- **Environment-based switching** (–∫–∞–∫ –≤ session-management)

---

## üì¶ –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### **üîß –≠–¢–ê–ü 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ WalletPoolManager**

#### **1.1 –î–æ–±–∞–≤–∏—Ç—å alerting –º–µ—Ç–æ–¥—ã**

**–§–ê–ô–õ:** `packages/exchange-core/src/services/wallet-pool-manager.ts`

**–ú–ï–¢–û–î 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ—Ä–æ–≥–æ–≤**

```typescript
/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ—Ä–æ–≥–∏ –∫–æ—à–µ–ª—å–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö –≤–∞–ª—é—Ç
 * @implements Task 6.4 - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤
 */
async checkCriticalThresholds(): Promise<CriticalAlert[]> {
  const alerts: CriticalAlert[] = [];

  for (const currency of CRYPTOCURRENCIES) {
    const stats = await this.getPoolStats(currency);
    const threshold = WALLET_POOL_CONFIG.MIN_AVAILABLE_THRESHOLDS[currency];

    if (stats.availableWallets <= threshold) {
      alerts.push({
        currency,
        currentAvailable: stats.availableWallets,
        threshold,
        severity: this.calculateSeverity(stats.availableWallets, threshold),
        timestamp: new Date(),
      });
    }
  }

  return alerts;
}

/**
 * –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
 */
private calculateSeverity(available: number, threshold: number): 'warning' | 'critical' | 'emergency' {
  if (available === 0) return 'emergency';
  if (available === 1) return 'critical';
  if (available <= threshold) return 'warning';
  return 'warning'; // fallback
}
```

**–ú–ï–¢–û–î 2: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤**

```typescript
// packages/exchange-core/src/types/alert-types.ts
export interface CriticalAlert {
  currency: CryptoCurrency;
  currentAvailable: number;
  threshold: number;
  severity: 'warning' | 'critical' | 'emergency';
  timestamp: Date;
}
```

### **üîß –≠–¢–ê–ü 2: –°–æ–∑–¥–∞–Ω–∏–µ Alert Monitoring Service**

#### **2.1 –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

**–§–ê–ô–õ:** `packages/exchange-core/src/services/wallet-alert-monitor.ts`

```typescript
import { createEnvironmentLogger } from '@repo/utils';
import { WALLET_POOL_CONFIG } from '@repo/constants';
import { WalletPoolManagerFactory } from './wallet-pool-manager-factory';
import type { CriticalAlert } from '../types/alert-types';

const logger = createEnvironmentLogger('WalletAlertMonitor');

/**
 * –°–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—Ä–æ–≤–Ω–µ–π –∫–æ—à–µ–ª—å–∫–æ–≤
 * –†–µ–∞–ª–∏–∑—É–µ—Ç Task 6.4: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —É–º–µ–Ω—å—à–µ–Ω–∏–∏
 */
export class WalletAlertMonitor {
  private isRunning = false;
  private intervalId: NodeJS.Timeout | null = null;

  /**
   * –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   */
  async startMonitoring(intervalMinutes: number = 5): Promise<void> {
    if (this.isRunning) {
      logger.warn('Alert monitoring already running');
      return;
    }

    this.isRunning = true;
    const intervalMs = intervalMinutes * 60 * 1000;

    // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
    await this.performCheck();

    // –ó–∞—Ç–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
    this.intervalId = setInterval(async () => {
      await this.performCheck();
    }, intervalMs);

    logger.info('Wallet alert monitoring started', { intervalMinutes });
  }

  /**
   * –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
   */
  stopMonitoring(): void {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.isRunning = false;
    logger.info('Wallet alert monitoring stopped');
  }

  /**
   * –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∞–ª–µ—Ä—Ç–æ–≤
   */
  private async performCheck(): Promise<void> {
    try {
      const walletPoolManager = await WalletPoolManagerFactory.create();
      const alerts = await walletPoolManager.checkCriticalThresholds();

      if (alerts.length > 0) {
        await this.handleAlerts(alerts);
      } else {
        logger.debug('No critical wallet alerts detected');
      }
    } catch (error) {
      logger.error('Failed to perform wallet alert check', {
        error: error instanceof Error ? error.message : 'Unknown error',
      });
    }
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
   */
  private async handleAlerts(alerts: CriticalAlert[]): Promise<void> {
    logger.warn('Critical wallet alerts detected', { alertCount: alerts.length });

    for (const alert of alerts) {
      await this.sendAlert(alert);
    }
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–ª–µ—Ä—Ç
   */
  private async sendAlert(alert: CriticalAlert): Promise<void> {
    try {
      // Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º/–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
      await this.sendEmailAlert(alert);

      // TODO: Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏/–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)
      // await this.sendTelegramAlert(alert);

      logger.info('Alert sent successfully', {
        currency: alert.currency,
        severity: alert.severity,
      });
    } catch (error) {
      logger.error('Failed to send alert', {
        alert,
        error: error instanceof Error ? error.message : 'Unknown error',
      });
    }
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å email –∞–ª–µ—Ä—Ç
   */
  private async sendEmailAlert(alert: CriticalAlert): Promise<void> {
    // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º existing email infrastructure
    try {
      const emailService = await import('@repo/email-service');

      const subject = `üö® Critical Wallet Alert - ${alert.currency}`;
      const message = this.formatAlertMessage(alert);

      // TODO: –ü–æ–ª—É—á–∏—Ç—å email –∞–¥—Ä–µ—Å–∞ –∞–¥–º–∏–Ω–æ–≤/–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
      const adminEmails = this.getAdminEmails();

      for (const email of adminEmails) {
        await emailService.EmailService.sendCriticalAlert({
          to: email,
          subject,
          message,
          alert,
        });
      }
    } catch (error) {
      logger.error('Failed to send email alert', {
        alert,
        error: error instanceof Error ? error.message : 'Unknown error',
      });
    }
  }

  /**
   * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞
   */
  private formatAlertMessage(alert: CriticalAlert): string {
    const emoji = {
      emergency: 'üî¥',
      critical: 'üü†',
      warning: 'üü°',
    }[alert.severity];

    return `
${emoji} WALLET POOL ALERT

Currency: ${alert.currency}
Available Wallets: ${alert.currentAvailable}
Threshold: ${alert.threshold}
Severity: ${alert.severity.toUpperCase()}
Time: ${alert.timestamp.toISOString()}

Action Required: Please add more ${alert.currency} wallets to the pool.

This is an automated alert from ExchangeGO wallet monitoring system.
    `.trim();
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å email –∞–¥—Ä–µ—Å–∞ –∞–¥–º–∏–Ω–æ–≤ (–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞)
   */
  private getAdminEmails(): string[] {
    // TODO: –ü–æ–ª—É—á–∞—Ç—å –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    return process.env.ALERT_EMAILS?.split(',') || [];
  }
}
```

### **üîß –≠–¢–ê–ü 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å tRPC API**

#### **3.1 –î–æ–±–∞–≤–∏—Ç—å procedures –≤ shared.ts**

**–§–ê–ô–õ:** `apps/web/src/server/trpc/routers/shared.ts`

```typescript
// –í imports —Å–µ–∫—Ü–∏—é
import { WalletAlertMonitor } from '@repo/exchange-core';

// –í sharedRouter –ø–æ—Å–ª–µ getWalletPoolStats
/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –∫–æ—à–µ–ª—å–∫–æ–≤ (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
 */
checkWalletAlerts: operatorAndSupport
  .query(async () => {
    try {
      const walletPoolManager = await WalletPoolManagerFactory.create();
      const alerts = await walletPoolManager.checkCriticalThresholds();

      return {
        hasAlerts: alerts.length > 0,
        alerts,
        checkedAt: new Date(),
      };
    } catch (error) {
      logger.error('[checkWalletAlerts] Error:', error);
      throw createInternalServerError('Failed to check wallet alerts');
    }
  }),

/**
 * –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–ª–µ—Ä—Ç–æ–≤
 */
getAlertMonitorStatus: operatorOnly // –¢–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  .query(async () => {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    return {
      isMonitoringActive: true, // TODO: —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∏–∑ WalletAlertMonitor
      lastCheck: new Date(),
      monitoringInterval: '5 minutes',
      configuredThresholds: WALLET_POOL_CONFIG.MIN_AVAILABLE_THRESHOLDS,
    };
  }),
```

### **üîß –≠–¢–ê–ü 4: Background Process Setup**

#### **4.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

**–§–ê–ô–õ:** `apps/web/src/server/startup/wallet-monitoring.ts` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

```typescript
import { WalletAlertMonitor } from '@repo/exchange-core';
import { createEnvironmentLogger } from '@repo/utils';

const logger = createEnvironmentLogger('WalletMonitoringStartup');

/**
 * –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –º–æ–Ω–∏—Ç–æ—Ä–∞ –∞–ª–µ—Ä—Ç–æ–≤
 */
let alertMonitor: WalletAlertMonitor | null = null;

/**
 * –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ—à–µ–ª—å–∫–æ–≤
 */
export async function initializeWalletMonitoring(): Promise<void> {
  try {
    if (alertMonitor) {
      logger.warn('Wallet monitoring already initialized');
      return;
    }

    alertMonitor = new WalletAlertMonitor();

    // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
    const intervalMinutes = parseInt(process.env.WALLET_ALERT_INTERVAL || '5');
    await alertMonitor.startMonitoring(intervalMinutes);

    logger.info('Wallet alert monitoring initialized successfully', { intervalMinutes });
  } catch (error) {
    logger.error('Failed to initialize wallet monitoring', {
      error: error instanceof Error ? error.message : 'Unknown error',
    });
  }
}

/**
 * –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (graceful shutdown)
 */
export async function shutdownWalletMonitoring(): Promise<void> {
  if (alertMonitor) {
    alertMonitor.stopMonitoring();
    alertMonitor = null;
    logger.info('Wallet monitoring shutdown completed');
  }
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –º–æ–Ω–∏—Ç–æ—Ä–∞
 */
export function getAlertMonitor(): WalletAlertMonitor | null {
  return alertMonitor;
}
```

#### **4.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ app startup**

**–§–ê–ô–õ:** `apps/web/src/server/startup/index.ts` (–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ)

```typescript
import { initializeWalletMonitoring, shutdownWalletMonitoring } from './wallet-monitoring';

// –í —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π startup process
export async function initializeServer(): Promise<void> {
  // ... existing initialization code ...

  // –ù–æ–≤–æ–µ: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ—à–µ–ª—å–∫–æ–≤
  await initializeWalletMonitoring();
}

// –í graceful shutdown process
export async function shutdownServer(): Promise<void> {
  // ... existing shutdown code ...

  // –ù–æ–≤–æ–µ: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  await shutdownWalletMonitoring();
}
```

### **üîß –≠–¢–ê–ü 5: Email Templates –∏ Configuration**

#### **5.1 Email template –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤**

**–§–ê–ô–õ:** `packages/constants/src/email-templates.ts` (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ)

```typescript
export const EMAIL_TEMPLATES = {
  // ... existing templates ...

  WALLET_CRITICAL_ALERT: {
    subject: 'üö® Critical Wallet Alert - {currency}',
    body: `
<h2>üö® Wallet Pool Critical Alert</h2>

<div style="background-color: {severityColor}; padding: 15px; border-radius: 5px; margin: 10px 0;">
  <h3>{severityEmoji} {severity} Alert</h3>
  <p><strong>Currency:</strong> {currency}</p>
  <p><strong>Available Wallets:</strong> {availableWallets}</p>
  <p><strong>Minimum Threshold:</strong> {threshold}</p>
  <p><strong>Time:</strong> {timestamp}</p>
</div>

<h4>Action Required:</h4>
<p>Please add more {currency} wallets to the pool immediately.</p>

<p><em>This is an automated alert from ExchangeGO wallet monitoring system.</em></p>
    `,
  },
} as const;
```

#### **5.2 Environment configuration**

**–§–ê–ô–õ:** `.env.local` (–ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)

```bash
# Wallet Alert Monitoring
WALLET_ALERT_INTERVAL=5  # Minutes between checks
ALERT_EMAILS=admin@exchangego.com,operator@exchangego.com
ENABLE_WALLET_ALERTS=true

# Override thresholds (optional)
WALLET_THRESHOLD_BTC=3
WALLET_THRESHOLD_ETH=2
WALLET_THRESHOLD_USDT=5
WALLET_THRESHOLD_LTC=2
```

---

## üîÑ –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –ê–†–•–ò–¢–ï–ö–¢–£–†–û–ô

### **üìç –¢–û–ß–ö–ò –ò–ù–¢–ï–ì–†–ê–¶–ò–ò:**

#### **1. WalletPoolManager** (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

- –î–æ–±–∞–≤–∏—Ç—å `checkCriticalThresholds()` –º–µ—Ç–æ–¥
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ existing —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- –°–ª–µ–¥–æ–≤–∞—Ç—å existing patterns

#### **2. shared.ts Router** (–Ω–æ–≤—ã–µ procedures)

- `checkWalletAlerts` - —Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- `getAlertMonitorStatus` - —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#### **3. Email Service** (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å existing `@repo/email-service`
- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π template –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å existing rate limiting

#### **4. Logger System** (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å existing `createEnvironmentLogger`
- Structured logging –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
- Environment-based log levels

### **üéØ –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:**

1. **Single Responsibility**: –ö–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –∏–º–µ–µ—Ç –æ–¥–Ω—É –∑–∞–¥–∞—á—É
2. **Open/Closed**: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ existing –∫–æ–¥–∞
3. **Dependency Inversion**: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π
4. **Factory Pattern**: Consistent —Å existing WalletPoolManagerFactory

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –ì–û–¢–û–í–ù–û–°–¢–ò

### **üéØ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:**

- [ ] ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä–æ–≥–æ–≤ –∫–æ—à–µ–ª—å–∫–æ–≤
- [ ] ‚úÖ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º/–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
- [ ] ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] ‚úÖ Manual –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ tRPC API
- [ ] ‚úÖ Structured logging –≤—Å–µ—Ö –∞–ª–µ—Ä—Ç–æ–≤
- [ ] ‚úÖ Graceful startup/shutdown –ø—Ä–æ—Ü–µ—Å—Å—ã
- [ ] ‚úÖ Environment-based –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### **üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:**

- [ ] ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è existing –∫–æ–¥–∞
- [ ] ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ existing –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- [ ] ‚úÖ –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ existing patterns –∏ conventions
- [ ] ‚úÖ Backward compatibility
- [ ] ‚úÖ Error handling –∏ resilience

### **üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:**

- [ ] ‚úÖ TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- [ ] ‚úÖ ESLint compliance
- [ ] ‚úÖ Environment variables –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- [ ] ‚úÖ Proper cleanup –∏ resource management

---

## üöÄ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### **Phase 1: Core Alert Logic** (1-2 —á–∞—Å–∞)

1. –î–æ–±–∞–≤–∏—Ç—å `CriticalAlert` —Ç–∏–ø—ã
2. –†–∞—Å—à–∏—Ä–∏—Ç—å `WalletPoolManager` alerting –º–µ—Ç–æ–¥–∞–º–∏
3. –°–æ–∑–¥–∞—Ç—å `WalletAlertMonitor` —Å–µ—Ä–≤–∏—Å

### **Phase 2: Integration** (1 —á–∞—Å)

4. –î–æ–±–∞–≤–∏—Ç—å tRPC procedures –≤ `shared.ts`
5. –°–æ–∑–¥–∞—Ç—å startup/shutdown –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

### **Phase 3: Configuration** (30 –º–∏–Ω—É—Ç)

6. –î–æ–±–∞–≤–∏—Ç—å email templates
7. Environment variables setup

### **Phase 4: Testing** (30 –º–∏–Ω—É—Ç)

8. Manual —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ tRPC
9. –ü—Ä–æ–≤–µ—Ä–∫–∞ email –æ—Ç–ø—Ä–∞–≤–∫–∏
10. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### **‚úÖ –ü–û–°–õ–ï –†–ï–ê–õ–ò–ó–ê–¶–ò–ò:**

1. **Proactive Monitoring**: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —É—Ä–æ–≤–Ω–∏ –∫–æ—à–µ–ª—å–∫–æ–≤
2. **Instant Alerts**: –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö
3. **Prevention Focus**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ emergency —Å–∏—Ç—É–∞—Ü–∏–π
4. **Operational Visibility**: –ü–æ–ª–Ω–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—É–ª–∞ –∫–æ—à–µ–ª—å–∫–æ–≤
5. **Scalable Architecture**: –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –∞–ª–µ—Ä—Ç–æ–≤

### **üìà BUSINESS VALUE:**

- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–µ–≤ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞—è–≤–æ–∫
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø—É–ª–∞ –∫–æ—à–µ–ª—å–∫–æ–≤
- –ü–æ–≤—ã—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- –°–Ω–∏–∂–µ–Ω–∏–µ operational overhead

---

**–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:** –ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ 6.4 –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç existing –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (70% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏) –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é alerting –ª–æ–≥–∏–∫—É. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
