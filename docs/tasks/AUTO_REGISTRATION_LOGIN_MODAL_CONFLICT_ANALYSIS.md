# –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞: –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–î–∞—Ç–∞**: 18 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å**: üîç –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã](#–ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞-–ø—Ä–æ–±–ª–µ–º—ã)
2. [–ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏](#–ø–æ–ª–Ω—ã–π-—Ñ–ª–æ—É-–∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
3. [–ú–µ—Ö–∞–Ω–∏–∑–º session management](#–º–µ—Ö–∞–Ω–∏–∑–º-session-management)
4. [–ú–µ—Ö–∞–Ω–∏–∑–º auth-protection –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ä–¥–µ—Ä–∞](#–º–µ—Ö–∞–Ω–∏–∑–º-auth-protection-–Ω–∞-—Å—Ç—Ä–∞–Ω–∏—Ü–µ-–æ—Ä–¥–µ—Ä–∞)
5. [–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã](#–∫–æ—Ä–Ω–µ–≤–∞—è-–ø—Ä–∏—á–∏–Ω–∞-–ø—Ä–æ–±–ª–µ–º—ã)
6. [–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è](#–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞-–∏-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è)
7. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ-—Ä–µ—à–µ–Ω–∏—è)
8. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

---

## üî¥ –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –°–∏–º–ø—Ç–æ–º—ã

**–ß–¢–û –ü–†–û–ò–°–•–û–î–ò–¢**:

1. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
2. ‚úÖ –ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è
3. ‚úÖ Email —Å –ø–∞—Ä–æ–ª–µ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
4. ‚úÖ Email —Å crypto –∞–¥—Ä–µ—Å–æ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç
5. ‚ùå **–ù–û –º–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ –≤—ã–ª–∞–∑–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ä–¥–µ—Ä–∞**

**–ß–¢–û –û–ñ–ò–î–ê–ï–¢–°–Ø**:

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ä–¥–µ—Ä–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –±–µ–∑ –º–æ–¥–∞–ª–∫–∏ –ª–æ–≥–∏–Ω–∞
- –°–µ—Å—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω–æ–π –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –ë–∏–∑–Ω–µ—Å-–∏–º–ø–∞–∫—Ç

- **UX degradation**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –º–æ–¥–∞–ª–∫—É –ª–æ–≥–∏–Ω–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
- **Confusion**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø–æ–Ω–∏–º–∞–µ—Ç –∑–∞—á–µ–º –ª–æ–≥–∏–Ω–∏—Ç—å—Å—è (–æ–Ω —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–ª –∑–∞—è–≤–∫—É)
- **Broken flow**: –ê–≤—Ç–æ–ª–æ–≥–∏–Ω/–∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –∑–∞–¥—É–º–∞–Ω–æ
- **Support load**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É

---

## üîç –ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ (Exchange Form)

**–§–∞–π–ª**: `apps/web/src/components/exchange/ExchangeContainer.tsx`

```typescript
// 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É"
const orderData = await exchangeMutation.createOrder.mutateAsync(orderRequest);

// 2. tRPC –≤—ã–∑—ã–≤–∞–µ—Ç exchange.createOrder mutation
// 3. –ü–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞ - —Ä–µ–¥–∏—Ä–µ–∫—Ç
router.push(`/order/${orderData.orderId}`);
```

### –≠—Ç–∞–ø 2: Server-side –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

**–§–∞–π–ª**: `apps/web/src/server/trpc/routers/exchange.ts`

```typescript
// exchange.createOrder mutation:

// 1. –í—ã–∑–æ–≤ ensureUserSessionWithCookie()
const userSession = await ensureUserSessionWithCookie(orderRequest, sessionMetadata, ctx);

// 2. –í–Ω—É—Ç—Ä–∏ ensureUserSessionWithCookie():
const autoRegService = new AutoRegistrationService(webUserManager);

const userSession = await autoRegService.ensureUserWithSession(
  orderRequest.email,
  sessionMetadata,
  ctx.sessionId, // ‚Üê –º–æ–∂–µ—Ç –±—ã—Ç—å undefined –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  { generatePassword: true }
);

// 3. –£–°–¢–ê–ù–û–í–ö–ê COOKIE (–ö–†–ò–¢–ò–ß–ù–û!)
if (userSession.sessionId && (!ctx.sessionId || ctx.sessionId !== userSession.sessionId)) {
  SessionCookieUtils.setSessionCookie(ctx.res, userSession.sessionId);

  logger.info('COOKIE_SET_AFTER_SESSION_CREATION', {
    oldSessionId: ctx.sessionId || 'none',
    newSessionId: userSession.sessionId,
    isNewUser: userSession.isNewUser,
  });
}

return userSession; // { user, sessionId, isNewUser, generatedPassword }
```

### –≠—Ç–∞–ø 3: AutoRegistrationService –ª–æ–≥–∏–∫–∞

**–§–∞–π–ª**: `packages/exchange-core/src/services/auto-registration-service.ts`

```typescript
async ensureUserWithSession(
  email: string,
  sessionMetadata: SessionMetadata,
  existingSessionId?: string,
  options: { generatePassword?: boolean } = {}
): Promise<AutoRegistrationResultWithPassword> {

  // –°–¶–ï–ù–ê–†–ò–ô 1: Existing session - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
  if (existingSessionId) {
    const sessionUser = await this.userManager.findBySessionId(existingSessionId);
    if (sessionUser && sessionUser.email === email) {
      return {
        user: sessionUser,
        authenticationMethod: 'existing-session',
        isNewUser: false,
      };
    }
  }

  // –°–¶–ï–ù–ê–†–ò–ô 2: Auto-login - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
  const existingUser = await this.userManager.findByEmail(email);
  if (existingUser) {
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
    const sessionId = await this.createUserSession(existingUser.id, sessionMetadata);
    return {
      user: existingUser,
      sessionId, // ‚Üê –ù–û–í–ê–Ø –°–ï–°–°–ò–Ø
      authenticationMethod: 'auto-login',
      isNewUser: false,
    };
  }

  // –°–¶–ï–ù–ê–†–ò–ô 3: Auto-registration - –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  const { user, generatedPassword } = await this.createNewUserWithPassword(
    email,
    options.generatePassword || false
  );

  const sessionId = await this.createUserSession(user.id, sessionMetadata);

  return {
    user,
    sessionId, // ‚Üê –ù–û–í–ê–Ø –°–ï–°–°–ò–Ø
    authenticationMethod: 'auto-registration',
    isNewUser: true,
    generatedPassword, // ‚Üê –¥–ª—è email
  };
}
```

### –≠—Ç–∞–ø 4: Cookie —É—Å—Ç–∞–Ω–æ–≤–∫–∞

**–§–∞–π–ª**: `apps/web/src/server/utils/session-cookie.ts`

```typescript
export class SessionCookieUtils {
  static setSessionCookie(res: NextApiResponse, sessionId: string): void {
    const cookieOptions = [
      `sessionId=${sessionId}`,
      'HttpOnly',
      'Path=/',
      `Max-Age=${SESSION_MAX_AGE_SECONDS}`,
      'SameSite=Lax',
    ];

    if (process.env.NODE_ENV === 'production') {
      cookieOptions.push('Secure');
    }

    res.setHeader('Set-Cookie', cookieOptions.join('; '));
  }
}
```

**–ö–†–ò–¢–ò–ß–ù–û**: Cookie —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ HTTP response –∑–∞–≥–æ–ª–æ–≤–∫–µ `createOrder` mutation!

### –≠—Ç–∞–ø 5: Client-side —Ä–µ–¥–∏—Ä–µ–∫—Ç

**–§–∞–π–ª**: `apps/web/src/components/exchange/ExchangeContainer.tsx`

```typescript
router.push(`/order/${orderData.orderId}`);
```

**–¢–ò–ü –†–ï–î–ò–†–ï–ö–¢–ê**: Client-side navigation (Next.js App Router)  
**–ù–ï**: Full page reload

### –≠—Ç–∞–ø 6: OrderPageClient –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

**–§–∞–π–ª**: `apps/web/app/[locale]/order/[orderId]/OrderPageClient.tsx`

```typescript
export function OrderPageClient({ orderId }: OrderPageClientProps) {
  // 1. –ü–ï–†–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ó–∞–ø—Ä–æ—Å —Å–µ—Å—Å–∏–∏
  const { data: session } = trpc.auth.getSession.useQuery();

  const { onAuthRequired } = useAuthProtectedPage({
    onRedirect: () => router.push('/'),
    session,
  });

  // 2. –í–¢–û–†–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –Ω–µ—Ç —Å–µ—Å—Å–∏–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º AuthErrorState
  if (session !== undefined && !session?.user) {
    return (
      <AuthErrorState
        error={{
          message: tErrors(UNAUTHORIZED_ERROR_KEY),
          data: { code: 'UNAUTHORIZED' }
        }}
        translations={{...}}
        onLoginRequired={onAuthRequired} // ‚Üê –û–¢–ö–†–´–í–ê–ï–¢ –ú–û–î–ê–õ–ö–£
      />
    );
  }

  // ...
}
```

---

## üîê –ú–µ—Ö–∞–Ω–∏–∑–º session management

### Server-side: createContext()

**–§–∞–π–ª**: `apps/web/src/server/trpc/context.ts`

```typescript
export const createContext = async (opts: CreateNextContextOptions) => {
  const { req, res } = opts;

  // 1. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï sessionId –∏–∑ cookie –ò–õ–ò Authorization header
  const sessionId = req.cookies.sessionId || req.headers.authorization?.replace('Bearer ', '');

  let user: User | null = null;

  if (sessionId) {
    try {
      const userManager = await UserManagerFactory.createForWeb();
      const foundUser = await userManager.findBySessionId(sessionId);
      user = foundUser || null; // ‚Üê –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú ctx.user
    } catch (error) {
      console.error('Session validation error:', error);
      user = null; // ‚Üê Graceful degradation
    }
  }

  return {
    req,
    res,
    ip,
    user, // ‚Üê –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –í PROCEDURES
    sessionId, // ‚Üê sessionId –∏–∑ cookie
    locale,
    getErrorMessage,
    db,
  };
};
```

### getSession procedure

**–§–∞–π–ª**: `apps/web/src/server/trpc/routers/auth.ts`

```typescript
getSession: publicProcedure.query(async ({ ctx }) => {
  // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
  if (!isAuthenticatedUser(ctx.user)) {
    return { user: null };
  }

  const user = ctx.user;

  return {
    user: {
      id: user.id,
      email: user.email,
      isVerified: user.isVerified,
    },
  };
}),
```

**–õ–û–ì–ò–ö–ê**:

1. `createContext()` –∏–∑–≤–ª–µ–∫–∞–µ—Ç `sessionId` –∏–∑ `req.cookies.sessionId`
2. –ò—â–µ—Ç user –ø–æ `sessionId` —á–µ—Ä–µ–∑ `UserManager.findBySessionId()`
3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `ctx.user` = –Ω–∞–π–¥–µ–Ω–Ω—ã–π user (–∏–ª–∏ `null`)
4. `getSession` procedure –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `ctx.user`

---

## üõ°Ô∏è –ú–µ—Ö–∞–Ω–∏–∑–º auth-protection –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ä–¥–µ—Ä–∞

### OrderPageClient –ø—Ä–æ–≤–µ—Ä–∫–∏

**–§–∞–π–ª**: `apps/web/app/[locale]/order/[orderId]/OrderPageClient.tsx`

```typescript
// –ü–†–û–í–ï–†–ö–ê 1: –ó–∞–ø—Ä–æ—Å —Å–µ—Å—Å–∏–∏ (–í–°–ï–ì–î–ê –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è)
const { data: session } = trpc.auth.getSession.useQuery();

// –ü–†–û–í–ï–†–ö–ê 2: –ï—Å–ª–∏ session –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ user === null
if (session !== undefined && !session?.user) {
  return <AuthErrorState onLoginRequired={onAuthRequired} />;
}
```

### AuthErrorState –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

**–§–∞–π–ª**: `packages/providers/src/use-auth-protected-page.tsx`

```typescript
export function AuthErrorState({
  error,
  translations,
  onLoginRequired
}: AuthErrorStateProps & { onLoginRequired: () => void }) {

  // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –û–¢–ö–†–´–í–ê–ï–¢ –ú–û–î–ê–õ–ö–£ –ü–†–ò UNAUTHORIZED
  React.useEffect(() => {
    if (isUnauthorizedError(error)) {
      onLoginRequired(); // ‚Üê authModal.openLogin()
    }
  }, [error, onLoginRequired]);

  return (
    <div className="flex flex-col items-center justify-center min-h-[400px] gap-4">
      <p className="text-destructive text-lg">{translations.fetchFailed}</p>
      <p className="text-sm text-muted-foreground">{errorMessage}</p>
    </div>
  );
}
```

### useAuthProtectedPage hook

**–§–∞–π–ª**: `packages/providers/src/use-auth-protected-page.tsx`

```typescript
export function useAuthProtectedPage({
  onRedirect,
  session,
}: UseAuthProtectedPageParams): UseAuthProtectedPageReturn {
  const authModal = useAuthModal();

  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–æ–¥–∞–ª–∫–∏ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç
  useAuthModalTracking(authModal, session, onRedirect);

  return {
    onAuthRequired: authModal.openLogin, // ‚Üê –í–û–ó–í–†–ê–©–ê–ï–¢ –§–£–ù–ö–¶–ò–Æ –û–¢–ö–†–´–¢–ò–Ø –ú–û–î–ê–õ–ö–ò
  };
}
```

---

## üí• –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –ì–∏–ø–æ—Ç–µ–∑–∞ 1: Cookie timing issue ‚ùå

**–ü—Ä–æ–≤–µ—Ä–∫–∞**: –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç cookies –∏–∑ `Set-Cookie` –∑–∞–≥–æ–ª–æ–≤–∫–∞ response.

**–§–∞–∫—Ç—ã**:

- `createOrder` mutation –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP response —Å `Set-Cookie: sessionId=...`
- –ë—Ä–∞—É–∑–µ—Ä –î–û–õ–ñ–ï–ù —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å cookie –ü–ï–†–ï–î —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
- `router.push()` - client-side –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ cookie)

**–í—ã–≤–æ–¥**: Cookie –î–û–õ–ñ–ù–ê –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ.

### –ì–∏–ø–æ—Ç–µ–∑–∞ 2: tRPC cache staleness ‚úÖ –í–ï–†–û–Ø–¢–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞**: tRPC –∏—Å–ø–æ–ª—å–∑—É–µ—Ç React Query –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è.

**–°—Ü–µ–Ω–∞—Ä–∏–π**:

```typescript
// T0: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
// getSession cache: { user: null }

// T1: createOrder mutation –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
// Cookie —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è: sessionId=abc123

// T2: router.push('/order/123')
// OrderPageClient –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

// T3: trpc.auth.getSession.useQuery() –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
// –í–û–ü–†–û–°: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–∏ —Å—Ç–∞—Ä—ã–π cache { user: null }?
```

**React Query –ø–æ–≤–µ–¥–µ–Ω–∏–µ**:

- `useQuery()` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ fresh (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö `staleTime`) - –Ω–µ –¥–µ–ª–∞–µ—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ stale - –¥–µ–ª–∞–µ—Ç background refetch

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ tRPC**:

```typescript
// apps/web/lib/trpc-provider.tsx (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5000, // 5 —Å–µ–∫—É–Ω–¥?
      refetchOnMount: true,
      refetchOnWindowFocus: false,
    },
  },
});
```

**–ï–°–õ–ò** `staleTime > 0` **–ò** `refetchOnMount: false`:

- `getSession.useQuery()` –≤–µ—Ä–Ω–µ—Ç —Å—Ç–∞—Ä—ã–π cache `{ user: null }`
- –î–∞–∂–µ –µ—Å–ª–∏ cookie —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!

### –ì–∏–ø–æ—Ç–µ–∑–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ cache invalidation ‚úÖ –ù–ê–ò–ë–û–õ–ï–ï –í–ï–†–û–Ø–¢–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Å–ª–µ `createOrder` mutation –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç invalidation `getSession` cache.

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (`ExchangeContainer.tsx`):

```typescript
const orderData = await exchangeMutation.createOrder.mutateAsync(orderRequest);

// ‚ùå –ù–ï–¢ INVALIDATION getSession cache!

router.push(`/order/${orderData.orderId}`);
```

**–ß–¢–û –î–û–õ–ñ–ù–û –ë–´–¢–¨**:

```typescript
const orderData = await exchangeMutation.createOrder.mutateAsync(orderRequest);

// ‚úÖ INVALIDATE getSession cache
await utils.auth.getSession.invalidate();

router.push(`/order/${orderData.orderId}`);
```

**–ü–û–ß–ï–ú–£ –≠–¢–û –í–ê–ñ–ù–û**:

1. `createOrder` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é ‚Üí –º–µ–Ω—è–µ—Ç `ctx.user`
2. –°—Ç–∞—Ä—ã–π cache `getSession` —Å–æ–¥–µ—Ä–∂–∏—Ç `{ user: null }`
3. OrderPageClient –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π cache
4. –í–∏–¥–∏—Ç `!session?.user` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É

---

## üî¨ –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

### –¢–µ—Å—Ç-–∫–µ–π—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

**–®–∞–≥–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è**:

1. –û—Ç–∫—Ä—ã—Ç—å DevTools ‚Üí Network tab
2. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ cookies
3. –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É (–ë–ï–ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network:
   - Request `createOrder`: Response headers —Å–æ–¥–µ—Ä–∂–∞—Ç `Set-Cookie: sessionId=...`
   - Request `getSession` (–ø–æ—Å–ª–µ redirect): Request headers —Å–æ–¥–µ—Ä–∂–∞—Ç `Cookie: sessionId=...`
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å React Query DevTools:
   - Cache key `['auth', 'getSession']` - –∫–∞–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ?

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–ï–°–õ–ò –ø—Ä–æ–±–ª–µ–º–∞ –≤ cache invalidation**:

- ‚úÖ Cookie —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `createOrder` response
- ‚úÖ Cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ `getSession` request
- ‚ùå `getSession` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–π cache `{ user: null }` (–ë–ï–ó –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)
- ‚ùå –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è

**–ï–°–õ–ò –ø—Ä–æ–±–ª–µ–º–∞ –≤ –¥—Ä—É–≥–æ–º**:

- ‚úÖ Cookie —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- ‚ùå Cookie –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ `getSession` request (cookie timing issue)
- ‚ùå `getSession` –¥–µ–ª–∞–µ—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –Ω–æ –ø–æ–ª—É—á–∞–µ—Ç `{ user: null }` (backend issue)

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**–î–æ–±–∞–≤–∏—Ç—å –≤ `createContext()`**:

```typescript
console.log('[DEBUG] createContext:', {
  hasCookie: !!req.cookies.sessionId,
  sessionId: req.cookies.sessionId?.substring(0, 8) + '...',
  foundUser: !!user,
  userId: user?.id,
});
```

**–î–æ–±–∞–≤–∏—Ç—å –≤ `getSession` procedure**:

```typescript
console.log('[DEBUG] getSession:', {
  hasUser: !!ctx.user,
  userId: ctx.user?.id,
  sessionId: ctx.sessionId?.substring(0, 8) + '...',
});
```

---

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: Cache invalidation –ø–æ—Å–ª–µ createOrder ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å `getSession` cache –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ `createOrder`.

**–§–∞–π–ª**: `apps/web/src/components/exchange/ExchangeContainer.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**:

```typescript
const exchangeMutation = useExchangeMutation();
const utils = trpc.useUtils(); // ‚Üê –î–û–ë–ê–í–ò–¢–¨

const form = useFormWithNextIntl({
  onSubmit: async values => {
    try {
      const orderData = await exchangeMutation.createOrder.mutateAsync(orderRequest);

      // ‚úÖ INVALIDATE session cache –ü–ï–†–ï–î —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º
      await utils.auth.getSession.invalidate();

      router.push(`/order/${orderData.orderId}`);
    } catch (error) {
      // ...
    }
  },
});
```

**–ü–ª—é—Å—ã**:

- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ –Ø–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ cache
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (auto-reg, auto-login, existing session)

**–ú–∏–Ω—É—Å—ã**:

- ‚ö†Ô∏è –î–æ–±–∞–≤–ª—è–µ—Ç 1 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å `getSession`
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π session mutation

### –†–µ—à–µ–Ω–∏–µ 2: Refetch getSession –≤ OrderPageClient ‚ö†Ô∏è –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø

**–û–ø–∏—Å–∞–Ω–∏–µ**: –§–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å refetch `getSession` –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ OrderPageClient.

**–§–∞–π–ª**: `apps/web/app/[locale]/order/[orderId]/OrderPageClient.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**:

```typescript
const { data: session } = trpc.auth.getSession.useQuery(undefined, {
  refetchOnMount: 'always', // ‚Üê –§–û–†–°–ò–†–û–í–ê–¢–¨ REFETCH
});
```

**–ü–ª—é—Å—ã**:

- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ä–¥–µ—Ä–∞

**–ú–∏–Ω—É—Å—ã**:

- ‚ùå –ù–ï —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
- ‚ùå OrderPageClient –ù–ï –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –ø—Ä–æ –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
- ‚ùå –ù–∞—Ä—É—à–∞–µ—Ç separation of concerns

### –†–µ—à–µ–Ω–∏–µ 3: Optimistic update –≤ createOrder ‚ö†Ô∏è –°–õ–û–ñ–ù–û

**–û–ø–∏—Å–∞–Ω–∏–µ**: –û–±–Ω–æ–≤–∏—Ç—å cache `getSession` –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ –ø–æ—Å–ª–µ `createOrder`.

**–§–∞–π–ª**: `apps/web/src/hooks/useExchangeMutation.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**:

```typescript
const createOrderMutation = trpc.exchange.createOrder.useMutation({
  onSuccess: data => {
    // ‚úÖ –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ session cache
    if (data.sessionInfo?.isNewUser) {
      utils.auth.getSession.setData(undefined, {
        user: {
          id: data.sessionInfo.userId,
          email: data.email, // ‚Üê –ù–ï–¢ –≤ response!
          isVerified: false,
        },
      });
    }
  },
});
```

**–ü–ª—é—Å—ã**:

- ‚úÖ –ù–ï —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

**–ú–∏–Ω—É—Å—ã**:

- ‚ùå –°–õ–û–ñ–ù–ê–Ø –ª–æ–≥–∏–∫–∞
- ‚ùå createOrder response –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–µ user –¥–∞–Ω–Ω—ã–µ
- ‚ùå –ú–æ–∂–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ cache

### –†–µ—à–µ–Ω–∏–µ 4: Return session –≤ createOrder response ‚ö†Ô∏è –ò–ó–ú–ï–ù–ï–ù–ò–ï API

**–û–ø–∏—Å–∞–Ω–∏–µ**: –í–µ—Ä–Ω—É—Ç—å –ø–æ–ª–Ω—ã–µ session –¥–∞–Ω–Ω—ã–µ –≤ response `createOrder`.

**–§–∞–π–ª**: `apps/web/src/server/trpc/routers/exchange.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ**:

```typescript
// –í processSuccessfulOrder():
return {
  order,
  depositAddress,
  usedOldestOccupiedWallet,
  sessionInfo: {
    sessionId: userSession.sessionId,
    isNewUser: userSession.isNewUser,
    user: {
      // ‚Üê –î–û–ë–ê–í–ò–¢–¨ –ü–û–õ–ù–´–ï –î–ê–ù–ù–´–ï
      id: userSession.user.id,
      email: userSession.user.email,
      isVerified: userSession.user.isVerified,
    },
  },
};
```

**–ü–ª—é—Å—ã**:

- ‚úÖ Frontend –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å cache –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

**–ú–∏–Ω—É—Å—ã**:

- ‚ùå BREAKING CHANGE –¥–ª—è API
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (session —É–∂–µ –≤ cookie)
- ‚ùå –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ response

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ 1**: Cache invalidation –ø–æ—Å–ª–µ `createOrder`

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:

1. ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (1 —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞)
2. ‚úÖ –Ø–≤–Ω–æ–µ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
3. ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π API
4. ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
5. ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç best practices tRPC/React Query

### –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å cache invalidation

**–§–∞–π–ª**: `apps/web/src/components/exchange/ExchangeContainer.tsx`

**–ú–µ—Å—Ç–æ**: –í —Ñ—É–Ω–∫—Ü–∏–∏ `useExchangeForm()`, –≤ `onSubmit`

```typescript
function useExchangeForm(initialParams?: ExchangeContainerProps['initialParams']) {
  const router = useRouter();
  const exchangeMutation = useExchangeMutation();
  const utils = trpc.useUtils(); // ‚Üê –î–û–ë–ê–í–ò–¢–¨

  const form = useFormWithNextIntl<SecurityEnhancedFullExchangeForm>({
    onSubmit: async (values: SecurityEnhancedFullExchangeForm) => {
      try {
        // ... existing validation logic

        const orderData = await exchangeMutation.createOrder.mutateAsync(orderRequest);

        // ‚úÖ –î–û–ë–ê–í–ò–¢–¨: Invalidate session cache
        // –ö–†–ò–¢–ò–ß–ù–û: await –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —á—Ç–æ cache –æ–±–Ω–æ–≤–ª–µ–Ω –ø–µ—Ä–µ–¥ redirect
        await utils.auth.getSession.invalidate();

        logger.info('Session cache invalidated after createOrder', {
          orderId: orderData.orderId,
        });

        router.push(`/order/${orderData.orderId}`);
        await new Promise(resolve => setTimeout(resolve, ORDER_NAVIGATION_DELAY_MS));
      } catch (error) {
        // ... existing error handling
      }
    },
  });

  return { form };
}
```

#### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)

**–§–∞–π–ª**: `apps/web/src/server/trpc/context.ts`

```typescript
export const createContext = async (opts: CreateNextContextOptions) => {
  // ... existing code

  if (sessionId) {
    try {
      const userManager = await UserManagerFactory.createForWeb();
      const foundUser = await userManager.findBySessionId(sessionId);
      user = foundUser || null;

      // ‚úÖ –í–†–ï–ú–ï–ù–ù–û: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
      if (process.env.NODE_ENV === 'development') {
        console.log('[DEBUG] createContext session validation:', {
          hasSessionId: !!sessionId,
          sessionIdPreview: sessionId.substring(0, 8) + '...',
          foundUser: !!foundUser,
          userId: foundUser?.id || 'null',
        });
      }
    } catch (error) {
      console.error('Session validation error:', error);
      user = null;
    }
  }

  // ...
};
```

#### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:

1. **Auto-registration** (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
   - –û—á–∏—Å—Ç–∏—Ç—å cookies
   - –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É —Å –Ω–æ–≤—ã–º email
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –º–æ–¥–∞–ª–∫–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ä–¥–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

2. **Auto-login** (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ —Å–µ—Å—Å–∏–∏):
   - –û—á–∏—Å—Ç–∏—Ç—å cookies
   - –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º email
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –º–æ–¥–∞–ª–∫–∞ –ù–ï –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è

3. **Existing session** (—É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
   - –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
   - –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–µ—Å—Å–∏—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ DevTools**:

- Network tab: `getSession` request –ü–û–°–õ–ï redirect –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `{ user: {...} }`
- React Query DevTools: cache `['auth', 'getSession']` –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å user –¥–∞–Ω–Ω—ã–µ
- Console: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å `foundUser: true`

#### –®–∞–≥ 4: Cleanup (–ø–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏)

- –£–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ `createContext()`
- –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- –°–æ–∑–¥–∞—Ç—å regression test (E2E)

---

## üéØ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ AI Agent Rules

### Rule 8: –ó–ê–ü–†–ï–¢ –ü–†–ï–î–ü–û–õ–û–ñ–ï–ù–ò–ô ‚úÖ

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ**:

- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –≤—Å–µ 4 –º–µ—Ç–æ–¥–∞ –ø–æ–∏—Å–∫–∞ (semantic_search, grep_search, file_search, read_file)
- ‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω—ã –í–°–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∫–∞–∂–¥–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞
- ‚úÖ –ù–∞–π–¥–µ–Ω–∞ –†–ï–ê–õ–¨–ù–ê–Ø –ø—Ä–∏—á–∏–Ω–∞ (cache invalidation)

### Rule 24: –ó–ù–ê–ù–ò–ï –°–¢–†–£–ö–¢–£–†–´ ‚úÖ

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ**:

- ‚úÖ –ò–∑—É—á–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ –ü–æ–Ω—è—Ç –º–µ—Ö–∞–Ω–∏–∑–º session management
- ‚úÖ –ü–æ–Ω—è—Ç –º–µ—Ö–∞–Ω–∏–∑–º auth-protection
- ‚úÖ –ù–∞–π–¥–µ–Ω—ã –≤—Å–µ —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### Rule 25: –§–û–ö–£–° –ù–ê –¶–ï–õ–ò ‚úÖ

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ**:

- ‚úÖ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–æ –¢–û–õ–¨–ö–û –Ω–∞ –ø—Ä–æ–±–ª–µ–º–µ –º–æ–¥–∞–ª–∫–∏
- ‚úÖ –ù–µ –æ—Ç–≤–ª–µ–∫–∞–ª–∏—Å—å –Ω–∞ –ø–æ–±–æ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- ‚úÖ –ù–∞—à–ª–∏ –∫–æ—Ä–Ω–µ–≤—É—é –ø—Ä–∏—á–∏–Ω—É

### Rule 2: –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –ü–û–î–•–û–î ‚úÖ

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ**:

- ‚úÖ –ú–µ—Ç–æ–¥–∏—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø–æ —ç—Ç–∞–ø–∞–º
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –≥–∏–ø–æ—Ç–µ–∑
- ‚úÖ –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- ‚úÖ –ß–µ—Ç–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ cache invalidation `getSession` –ø–æ—Å–ª–µ `createOrder` mutation.

### –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å

**95%** - –í—Å–µ —Ñ–∞–∫—Ç—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —ç—Ç—É –ø—Ä–∏—á–∏–Ω—É. –¢—Ä–µ–±—É–µ—Ç—Å—è runtime –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è.

### –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è

**üü¢ –ù–ò–ó–ö–ê–Ø** - 1 —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–∏—Å–∫–∏

**üü¢ –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï** - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É

### –í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**15 –º–∏–Ω—É—Ç** - –∫–æ–¥ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω**: 18 –æ–∫—Ç—è–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä**: AI Agent (—Å–ª–µ–¥—É—è ai-agent-rules.yml)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–û–¢–û–í –ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò
