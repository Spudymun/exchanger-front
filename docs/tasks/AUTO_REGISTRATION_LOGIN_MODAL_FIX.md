# –†–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞: –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

**–î–∞—Ç–∞**: 18 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–∞–≤—Ç–æ–ª–æ–≥–∏–Ω–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –º–æ–¥–∞–ª–∫—É –ª–æ–≥–∏–Ω–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ä–¥–µ—Ä–∞, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ —á—Ç–æ —Å–µ—Å—Å–∏—è –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞.

---

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**tRPC/React Query cache staleness**: –ü–æ—Å–ª–µ `createOrder` mutation cache `getSession` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ `{ user: null }`, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É –Ω–æ–≤–æ–π session cookie.

**–§–ª–æ—É –ø—Ä–æ–±–ª–µ–º—ã**:

1. createOrder —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç cookie: `Set-Cookie: sessionId=abc123`
2. `router.push('/order/123')` - client-side –Ω–∞–≤–∏–≥–∞—Ü–∏—è
3. OrderPageClient –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
4. `trpc.auth.getSession.useQuery()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –°–¢–ê–†–´–ô cache `{ user: null }`
5. –£—Å–ª–æ–≤–∏–µ `!session?.user` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–æ–¥–∞–ª–∫–∞

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

**Invalidate `getSession` cache –ü–ï–†–ï–î —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º** –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ä–¥–µ—Ä–∞.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è

**–§–∞–π–ª**: `apps/web/src/components/exchange/ExchangeContainer.tsx`

**1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç**:

```typescript
import { trpc } from '../../../lib/trpc-provider'; // ‚úÖ –î–ª—è invalidation session cache
```

**2. –ü–æ–ª—É—á–∞–µ–º utils –≤ `useExchangeForm()`**:

```typescript
function useExchangeForm(initialParams?: ExchangeContainerProps['initialParams']) {
  const utils = trpc.useUtils(); // ‚úÖ –î–ª—è invalidation session cache
  // ...
}
```

**3. Invalidation –ü–ï–†–ï–î —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º**:

```typescript
const orderData = await exchangeMutation.createOrder.mutateAsync(orderRequest);

// ‚úÖ –§–ò–ö–°: Invalidate session cache –ü–ï–†–ï–î —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º
// –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–∞–≤—Ç–æ–ª–æ–≥–∏–Ω–∞ - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–∫–∞–∑ –º–æ–¥–∞–ª–∫–∏ –ª–æ–≥–∏–Ω–∞
await utils.auth.getSession.invalidate();

router.push(`/order/${orderData.orderId}`);
```

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–∞–≤—Ç–æ–ª–æ–≥–∏–Ω–∞ `getSession` cache –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- ‚úÖ OrderPageClient –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
- ‚úÖ –ú–æ–¥–∞–ª–∫–∞ –ª–æ–≥–∏–Ω–∞ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ä–¥–µ—Ä–∞

---

## üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–∏

1. **Auto-registration** (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
   - –û—á–∏—Å—Ç–∏—Ç—å cookies
   - –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É —Å –Ω–æ–≤—ã–º email
   - ‚úÖ –ú–æ–¥–∞–ª–∫–∞ –ù–ï –ø–æ—è–≤–ª—è–µ—Ç—Å—è
   - ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ä–¥–µ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

2. **Auto-login** (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):
   - –û—á–∏—Å—Ç–∏—Ç—å cookies
   - –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º email
   - ‚úÖ –ú–æ–¥–∞–ª–∫–∞ –ù–ï –ø–æ—è–≤–ª—è–µ—Ç—Å—è

3. **Existing session** (–∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–π):
   - –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
   - –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é

---

## üî¨ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

**DevTools –ø—Ä–æ–≤–µ—Ä–∫–∏**:

- Network tab: `getSession` –∑–∞–ø—Ä–æ—Å –ü–û–°–õ–ï redirect –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ user: {...} }`
- React Query DevTools: cache `['auth', 'getSession']` –æ–±–Ω–æ–≤–ª–µ–Ω
- Console: –ù–ï–¢ –æ—à–∏–±–æ–∫ UNAUTHORIZED

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω**: 18 –æ–∫—Ç—è–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä**: AI Agent (—Å–ª–µ–¥—É—è ai-agent-rules.yml)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
