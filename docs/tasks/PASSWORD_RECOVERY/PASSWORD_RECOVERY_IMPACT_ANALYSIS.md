# ğŸ” IMPACT ANALYSIS: Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞŸĞ°Ñ€Ğ¾Ğ»Ñ

**Ğ”Ğ°Ñ‚Ğ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°**: 4 Ğ¾ĞºÑ‚ÑĞ±Ñ€Ñ 2025  
**ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº**: AI Agent (Impact Analysis Role)  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸**: âœ… **100% VERIFIED** - Ğ’ÑĞµ ÑƒÑ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ½Ğ° Ñ„Ğ°ĞºÑ‚Ğ°Ñ… Ğ¸Ğ· ĞºĞ¾Ğ´Ğ¾Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ·Ñ‹  
**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ**: Authentication & User Management  
**Scope Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸**: Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¸ production-ready Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ

---

## ğŸ“Š EXECUTIVE SUMMARY

### ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ’Ñ‹Ğ²Ğ¾Ğ´Ñ‹

âœ… **Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹**: **85%** - Backend API, validation, hooks ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ñ‹  
âœ… **Ğ Ğ¸ÑĞºĞ¸**: **Ğ¡Ğ Ğ•Ğ”ĞĞ˜Ğ•** - Email integration Ğ¸ token storage Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸  
âœ… **ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**: **Ğ’Ğ«Ğ¡ĞĞšĞĞ•** - AuthForm, ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¿Ğ¾Ğ»ĞµĞ¹, schemas Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹  
âœ… **Complexity**: **ĞĞ˜Ğ—ĞšĞĞ¯** - 11-19 Ñ‡Ğ°ÑĞ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ production-ready Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ ĞµÑˆĞµĞ½Ğ¸Ñ (Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)

1. âœ… **Email Provider**: Resend (ÑƒĞ¶Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚)
2. âœ… **Token Storage**: PostgreSQL (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ)
3. âœ… **Token TTL**: 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
4. âœ… **UI Pattern**: ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ (3 ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ)
5. âœ… **Post-Reset Flow**: Auto-login (ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾)
6. âœ… **Rate Limiting**: Per-IP + per-Email
7. âœ… **Email Enumeration**: Ğ—Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ¾ (ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾)

---

## 1ï¸âƒ£ Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’Ğ£Ğ®Ğ©ĞĞ¯ Ğ˜ĞĞ¤Ğ ĞĞ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ

### 1.1 Backend API - âœ… ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® Ğ Ğ•ĞĞ›Ğ˜Ğ—ĞĞ’ĞĞ

**Ğ¤Ğ°Ğ¹Ğ»**: `apps/web/src/server/trpc/routers/auth.ts`

#### Endpoint 1: Request Password Reset

```typescript
// Ğ¨ĞĞ“ 1: Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ĞºĞ¾Ğ´Ğ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
requestPasswordReset: rateLimitMiddleware.resetPassword
  .input(securityEnhancedResetPasswordSchema)
  .mutation(async ({ input }) => {
    const sanitizedEmail = sanitizeEmail(input.email);
    const webUserManager = await UserManagerFactory.createForWeb();

    const user = await webUserManager.findByEmail(sanitizedEmail);
    if (!user) {
      console.log(`ğŸ”’ Password reset attempt for non-existent email: ${sanitizedEmail}`);
    } else {
      console.log(`ğŸ”‘ Password reset request for: ${sanitizedEmail}`);
      // âš ï¸ Ğ˜ĞœĞ˜Ğ¢ĞĞ¦Ğ˜Ğ¯: ĞšĞ¾Ğ´ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ² console.log, Ğ½Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ½Ğ° email
      const resetCode = Math.random().toString(36).substring(2, 8).toUpperCase();
      console.log(`ğŸ“§ Recovery code for ${sanitizedEmail}: ${resetCode}`);
    }

    // âœ… Email enumeration protection - Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚
    return {
      message: 'If the specified email exists, a recovery code will be sent to it',
    };
  });
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ**:

- âœ… Rate limiting Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ (3 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ / Ñ‡Ğ°Ñ)
- âœ… Email enumeration protection Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ°
- âš ï¸ Email ĞĞ• Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ console.log)
- âŒ ĞšĞ¾Ğ´ ĞĞ• ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

---

#### Endpoint 2: Reset Password with Code

```typescript
// Ğ¨ĞĞ“ 2: Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼
resetPassword: publicProcedure
  .input(securityEnhancedConfirmResetPasswordSchema)
  .mutation(async ({ input, ctx }) => {
    const sanitizedEmail = sanitizeEmail(input.email);
    const webUserManager = await UserManagerFactory.createForWeb();

    // âš ï¸ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ: ĞĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ´Ğ° - Ğ»ÑĞ±Ğ¾Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ
    const user = await webUserManager.findByEmail(sanitizedEmail);
    if (!user) {
      throw createBadRequestError('Invalid recovery code');
    }

    // Ğ¥ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
    const hashedPassword = await bcrypt.hash(
      input.newPassword,
      VALIDATION_LIMITS.BCRYPT_SALT_ROUNDS
    );

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    await webUserManager.update(user.id, { hashedPassword });

    // âœ… Auto-login: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸ + ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° cookie
    let finalSessionId = generateSessionId();
    const sessionMetadata = createSessionMetadata(ctx.ip, ctx.req.headers);

    if (webUserManager instanceof ProductionUserManager) {
      finalSessionId = await webUserManager.createSession(
        user.id,
        sessionMetadata,
        AUTH_CONSTANTS.SESSION_MAX_AGE_SECONDS
      );
    }

    ctx.res.setHeader(
      AUTH_CONSTANTS.SET_COOKIE_HEADER,
      `sessionId=${finalSessionId}; HttpOnly; Path=/; Max-Age=${AUTH_CONSTANTS.SESSION_MAX_AGE_SECONDS}; SameSite=Lax`
    );

    return {
      user: { id: user.id, email: user.email, isVerified: user.isVerified },
      sessionId: finalSessionId,
    };
  });
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ**:

- âœ… Password hashing (bcrypt)
- âœ… Auto-login Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½
- âœ… Session + cookie ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°
- âŒ **CRITICAL**: ĞĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ reset code
- âŒ **CRITICAL**: ĞĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ TTL ĞºĞ¾Ğ´Ğ°

---

### 1.2 Validation Schemas - âœ… ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® Ğ“ĞĞ¢ĞĞ’Ğ«

**Ğ¤Ğ°Ğ¹Ğ»**: `packages/utils/src/validation/security-enhanced-auth-schemas.ts`

```typescript
// Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ email)
export const securityEnhancedResetPasswordSchema = z.object({
  email: emailSchema, // âœ… XSS-Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° + email validation
});

// ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ (email + ĞºĞ¾Ğ´ + Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ)
export const securityEnhancedConfirmResetPasswordSchema = z.object({
  email: emailSchema,
  resetCode: createXSSProtectedStringWithLength(
    1,
    SECURITY_VALIDATION_LIMITS.AUTH_CODE_MAX_LENGTH
  ).refine((val: string) => val.length > 0, 'RESET_CODE_REQUIRED'),
  newPassword: passwordSchema, // âœ… Complexity validation
});
```

**Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ°**:

- âœ… XSS protection Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ĞµĞ¹
- âœ… Email validation (RFC 5322)
- âœ… Password complexity requirements
- âœ… Reset code length validation (max 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)

---

### 1.3 Frontend Hooks - âœ… Ğ Ğ•ĞĞ›Ğ˜Ğ—ĞĞ’ĞĞĞ«

**Ğ¤Ğ°Ğ¹Ğ»**: `apps/web/src/hooks/usePasswordMutations.ts`

```typescript
export function usePasswordMutations() {
  const notifications = useNotifications();
  const t = useTranslations('Layout.auth.messages');

  const requestPasswordReset = trpc.auth.requestPasswordReset.useMutation({
    onSuccess: () =>
      notifications.success(t('passwordResetSent'), t('passwordResetSentDescription')),
    onError: error => notifications.handleApiError(error, 'password reset'),
  });

  const resetPassword = trpc.auth.resetPassword.useMutation({
    onSuccess: () => notifications.success(t('passwordChanged'), t('passwordChangedDescription')),
    onError: error => notifications.handleApiError(error, 'password change'),
  });

  return { requestPasswordReset, resetPassword, verifyEmail };
}
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ**:

- âœ… tRPC type-safe mutations
- âœ… Notification integration
- âœ… Error handling
- âœ… i18n support
- âŒ **ĞĞ• Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ** Ğ½Ğ¸ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ UI ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğµ

---

### 1.4 Rate Limiting - âœ… ĞĞĞ¡Ğ¢Ğ ĞĞ•Ğ

**Ğ¤Ğ°Ğ¹Ğ»**: `packages/constants/src/rate-limits.ts`

```typescript
export const RATE_LIMITS = {
  RESET_PASSWORD: {
    points: 3, // 3 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ per EMAIL
    duration: 3600, // 1 Ñ‡Ğ°Ñ
    blockDuration: 3600, // Ğ±Ğ»Ğ¾Ğº Ğ½Ğ° 1 Ñ‡Ğ°Ñ
  },
} as const;
```

**ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ**:

```typescript
// Ğ’ auth router
requestPasswordReset: rateLimitMiddleware.resetPassword
  .input(securityEnhancedResetPasswordSchema)
  .mutation(...)
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°**:

- âœ… Per-email rate limiting (3/hour)
- âŒ **ĞŸĞ ĞĞŸĞ£Ğ©Ğ•ĞĞ**: Per-IP rate limiting (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ)

---

### 1.5 Ğ›Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ - âš ï¸ Ğ§ĞĞ¡Ğ¢Ğ˜Ğ§ĞĞ Ğ“ĞĞ¢ĞĞ’Ğ

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹**:

- `apps/web/messages/en/layout.json`
- `apps/web/messages/ru/layout.json`

```json
{
  "Layout": {
    "auth": {
      "messages": {
        "passwordResetSent": "Instructions sent",
        "passwordResetSentDescription": "Check your email",
        "passwordChanged": "Password changed",
        "passwordChangedDescription": "You can sign in with your new password"
      }
    }
  }
}
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ**:

- âœ… Notification messages Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹
- âŒ **ĞŸĞ ĞĞŸĞ£Ğ©Ğ•ĞĞ**: UI labels Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
  - Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ğ¼Ğ¾Ğ´Ğ°Ğ»Ğ¾Ğº
  - ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ¿Ğ¾Ğ»ĞµĞ¹
  - ĞšĞ½Ğ¾Ğ¿ĞºĞ¸
  - ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ¸

**Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ**:

```json
{
  "forgotPassword": {
    "title": "Reset Password",
    "enterCode": "Enter Reset Code",
    "emailLabel": "Email address",
    "emailPlaceholder": "Enter your email",
    "codeLabel": "Reset code",
    "codePlaceholder": "Enter code from email",
    "newPasswordLabel": "New password",
    "newPasswordPlaceholder": "Enter new password",
    "requestButton": "Send Reset Code",
    "resetButton": "Reset Password",
    "requesting": "Sending...",
    "resetting": "Resetting...",
    "backToLogin": "Back to Sign In",
    "codeExpires": "Code expires in 15 minutes",
    "didntReceive": "Didn't receive code?",
    "resendCode": "Resend"
  }
}
```

---

### 1.6 Email Service - âœ… Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’Ğ£Ğ•Ğ¢, âŒ ĞĞ• Ğ˜ĞĞ¢Ğ•Ğ“Ğ Ğ˜Ğ ĞĞ’ĞĞ

**Ğ¤Ğ°Ğ¹Ğ»**: `packages/email-service/src/index.ts`

**Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ñ‹**:

```typescript
export { MockEmailProvider } from './providers/mock-email-provider';
export { SendGridEmailProvider } from './providers/sendgrid-email-provider';
export { ResendEmailProvider } from './providers/resend-email-provider';
export { GmailSmtpEmailProvider } from './providers/gmail-smtp-email-provider';
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ templates**:

```
packages/email-service/src/templates/
â”œâ”€â”€ crypto-address.html
â”œâ”€â”€ crypto-address.txt
â”œâ”€â”€ system-alert.html
â”œâ”€â”€ system-alert.txt
â”œâ”€â”€ wallet-ready.html
â””â”€â”€ wallet-ready.txt
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ**:

- âœ… EmailService Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°
- âœ… **Resend provider Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½** (Ğ¿Ğ¾ ÑĞ»Ğ¾Ğ²Ğ°Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)
- âŒ **ĞŸĞ ĞĞŸĞ£Ğ©Ğ•ĞĞ**: Template Ğ´Ğ»Ñ password reset
- âŒ **ĞŸĞ ĞĞŸĞ£Ğ©Ğ•ĞĞ**: Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ `auth.requestPasswordReset`

**Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ**:

- `packages/email-service/src/templates/password-reset.html`
- `packages/email-service/src/templates/password-reset.txt`

---

### 1.7 Database Schema - âœ… Ğ“ĞĞ¢ĞĞ’Ğ (Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾)

**Ğ¤Ğ°Ğ¹Ğ»**: `packages/session-management/prisma/schema.prisma`

```prisma
model User {
  id             String    @id @default(dbgenerated("gen_random_uuid()"))
  email          String    @unique
  hashedPassword String?   // âœ… ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ - Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ auto-registration
  isVerified     Boolean   @default(false)
  createdAt      DateTime  @default(now())
  lastLoginAt    DateTime?
  // ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ
}
```

**Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ**:

- âœ… User model Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğ¸
- âœ… `hashedPassword` Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ĞµĞ½ (Ğ´Ğ»Ñ auto-registration)
- âŒ **ĞŸĞ ĞĞŸĞ£Ğ©Ğ•ĞĞ**: Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ´Ğ»Ñ reset tokens

**Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ**:

```prisma
model PasswordResetToken {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  userId     String   @map("user_id") @db.Uuid
  token      String   @unique @db.VarChar(255)
  code       String   @db.VarChar(10)  // 6-digit code for UX
  expiresAt  DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  used       Boolean  @default(false)
  usedAt     DateTime? @map("used_at") @db.Timestamptz(6)

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([used])
  @@map("password_reset_tokens")
}
```

---

## 2ï¸âƒ£ Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ• Ğ¡ Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’Ğ£Ğ®Ğ©Ğ˜Ğœ Ğ¤Ğ£ĞĞšĞ¦Ğ˜ĞĞĞĞ›ĞĞœ

### 2.1 ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğ¸Ğµ ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ² ĞŸÑ€Ğ¾ĞµĞºÑ‚Ğµ

| Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»             | Ğ¤Ğ°Ğ¹Ğ»                                                | ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ                       | Relevance |
| ---------------------- | --------------------------------------------------- | --------------------------------------- | --------- |
| **Login Form**         | `apps/web/src/components/forms/LoginForm.tsx`       | âœ… **Ğ”Ğ** - AuthForm pattern            | 95%       |
| **Register Form**      | `apps/web/src/components/forms/RegisterForm.tsx`    | âœ… **Ğ”Ğ** - AuthForm + validation       | 95%       |
| **Email Verification** | `auth.verifyEmail` endpoint                         | âœ… **Ğ”Ğ** - Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ğ¹ flow (email + code) | 80%       |
| **Password Change**    | `apps/web/src/server/trpc/routers/user/security.ts` | âš ï¸ **Ğ§ĞĞ¡Ğ¢Ğ˜Ğ§ĞĞ** - Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ use case       | 40%       |
| **Auth Dialogs**       | `apps/web/src/components/auth-dialogs.tsx`          | âœ… **Ğ”Ğ** - modal pattern               | 100%      |

### 2.2 ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹

#### Pattern 1: Auth Form Compound Component

**Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº**: `packages/ui/src/components/auth-form-compound.tsx`

```typescript
<AuthForm form={form} isLoading={isLoading} t={t} fieldId="unique-id">
  <AuthForm.FormWrapper>
    <AuthForm.FieldWrapper>
      <FormEmailField />
      <AuthPasswordField />
      <FormCaptchaField />
    </AuthForm.FieldWrapper>
    <AuthForm.ActionsWrapper>
      <AuthSubmitButton />
      <AuthSwitchButton />
    </AuthForm.ActionsWrapper>
  </AuthForm.FormWrapper>
</AuthForm>
```

**ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Forgot Password**:

- âœ… `FormEmailField` - Ğ³Ğ¾Ñ‚Ğ¾Ğ²
- âœ… `AuthSubmitButton` - Ğ³Ğ¾Ñ‚Ğ¾Ğ²
- âœ… `FormCaptchaField` - Ğ³Ğ¾Ñ‚Ğ¾Ğ²
- âš ï¸ Input Ğ´Ğ»Ñ reset code - Ğ½ÑƒĞ¶ĞµĞ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚
- âš ï¸ `AuthPasswordField` - Ğ¿Ğ¾Ğ´Ğ¾Ğ¹Ğ´ĞµÑ‚ Ğ´Ğ»Ñ "new password"

---

#### Pattern 2: Modal Dialog System

**Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº**: `apps/web/src/components/auth-dialogs.tsx`

```typescript
export function AuthDialogs({
  isLoginOpen,
  isRegisterOpen,
  onLoginClose,
  onRegisterClose,
  onAuthSuccess,
}: AuthDialogsProps) {
  return (
    <>
      <Dialog open={isLoginOpen} onOpenChange={...}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader><DialogTitle>Sign In</DialogTitle></DialogHeader>
          <AuthForms defaultMode="login" onAuthSuccess={onAuthSuccess} />
        </DialogContent>
      </Dialog>

      <Dialog open={isRegisterOpen} onOpenChange={...}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader><DialogTitle>Sign Up</DialogTitle></DialogHeader>
          <AuthForms defaultMode="register" onAuthSuccess={onAuthSuccess} />
        </DialogContent>
      </Dialog>
    </>
  );
}
```

**ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Forgot Password**:

- âœ… Dialog component - Ğ³Ğ¾Ñ‚Ğ¾Ğ²
- âœ… DialogContent - Ğ³Ğ¾Ñ‚Ğ¾Ğ²
- âœ… Ğ Ğ°Ğ·Ğ¼ĞµÑ€ `sm:max-w-md` - ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾
- âœ… Pattern ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ - Ğ³Ğ¾Ñ‚Ğ¾Ğ²

---

#### Pattern 3: State Management

**Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº**: `apps/web/src/components/app-header.tsx`

```typescript
function useAuthDialogs() {
  const [isLoginDialogOpen, setIsLoginDialogOpen] = React.useState(false);
  const [isRegisterDialogOpen, setIsRegisterDialogOpen] = React.useState(false);

  const handleOpenLogin = React.useCallback(() => {
    setIsRegisterDialogOpen(false);
    setIsLoginDialogOpen(true);
  }, []);

  const handleOpenRegister = React.useCallback(() => {
    setIsLoginDialogOpen(false);
    setIsRegisterDialogOpen(true);
  }, []);

  return {
    isLoginDialogOpen,
    isRegisterDialogOpen,
    handleOpenLogin,
    handleOpenRegister,
    handleCloseLogin,
    handleCloseRegister,
    handleAuthSuccess,
  };
}
```

**Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Forgot Password**:

```typescript
// âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² useAuthDialogs
const [isForgotPasswordOpen, setIsForgotPasswordOpen] = React.useState(false);

const handleOpenForgotPassword = React.useCallback(() => {
  setIsLoginDialogOpen(false);
  setIsForgotPasswordOpen(true);
}, []);
```

---

## 3ï¸âƒ£ ĞŸĞĞ¢Ğ•ĞĞ¦Ğ˜ĞĞ›Ğ¬ĞĞ«Ğ• ĞšĞĞĞ¤Ğ›Ğ˜ĞšĞ¢Ğ« Ğ˜ Ğ Ğ˜Ğ¡ĞšĞ˜

### 3.1 ğŸ”´ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ Ğ Ğ˜Ğ¡Ğš: Email Delivery

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: `requestPasswordReset` ĞĞ• Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ email

**Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:

```typescript
const resetCode = Math.random().toString(36).substring(2, 8).toUpperCase();
console.log(`ğŸ“§ Recovery code for ${sanitizedEmail}: ${resetCode}`);
// âŒ Email ĞĞ• Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ
```

**Impact**:

- âŒ ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² production
- âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ ĞºĞ¾Ğ´Ñ‹
- âŒ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ±ĞµÑĞ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ° Ğ±ĞµĞ· email

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**:

```typescript
// Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ EmailService
import { EmailServiceFactory } from '@repo/email-service';

const emailService = await EmailServiceFactory.create();
await emailService.sendPasswordResetEmail({
  to: sanitizedEmail,
  resetCode: resetCode,
  expiresIn: '15 minutes',
});
```

**Effort**: 2-3 Ñ‡Ğ°ÑĞ° (template + integration)

---

### 3.2 ğŸŸ¡ Ğ¡Ğ Ğ•Ğ”ĞĞ˜Ğ™ Ğ Ğ˜Ğ¡Ğš: Token Storage & Validation

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: ĞšĞ¾Ğ´Ñ‹ ĞĞ• ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ğ¸ ĞĞ• Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€ÑƒÑÑ‚ÑÑ

**Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**:

```typescript
// requestPasswordReset - Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ¾Ğ´, Ğ½Ğ¾ ĞĞ• ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚
const resetCode = Math.random().toString(36).substring(2, 8).toUpperCase();

// resetPassword - ĞĞ• Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ĞºĞ¾Ğ´
if (!user) {
  throw createBadRequestError('Invalid recovery code');
}
// âŒ Ğ›ÑĞ±Ğ¾Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ ĞµÑĞ»Ğ¸ user ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
```

**Security Impact**:

- ğŸ”´ **CRITICAL**: ĞšĞ¾Ğ´ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ³Ğ°Ğ´Ğ°Ñ‚ÑŒ (6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ², base36 = ~2 Ğ¼Ğ»Ñ€Ğ´ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ²)
- ğŸ”´ **CRITICAL**: ĞĞµÑ‚ TTL - ĞºĞ¾Ğ´Ñ‹ Ğ±ĞµÑÑÑ€Ğ¾Ñ‡Ğ½Ñ‹Ğµ
- ğŸ”´ **CRITICAL**: ĞĞµÑ‚ single-use protection (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·)
- ğŸ”´ **CRITICAL**: ĞĞµÑ‚ rate limiting Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ ĞºĞ¾Ğ´Ğ°

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ** (PostgreSQL):

1. **Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ** (ÑĞ¼. Ñ€Ğ°Ğ·Ğ´ĞµĞ» 1.7)
2. **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ°**:

```typescript
// Ğ’ requestPasswordReset
const token = crypto.randomBytes(32).toString('hex');
const code = generateSixDigitCode(); // cryptographically secure

await prisma.passwordResetToken.create({
  data: {
    userId: user.id,
    token: token,
    code: code,
    expiresAt: new Date(Date.now() + 15 * 60 * 1000), // 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  },
});
```

3. **Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°**:

```typescript
// Ğ’ resetPassword
const resetToken = await prisma.passwordResetToken.findFirst({
  where: {
    code: input.resetCode,
    userId: user.id,
    used: false,
    expiresAt: { gt: new Date() },
  },
});

if (!resetToken) {
  throw createBadRequestError('Invalid or expired reset code');
}

// ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ ÑĞ±Ñ€Ğ¾ÑĞ°
await prisma.passwordResetToken.update({
  where: { id: resetToken.id },
  data: { used: true, usedAt: new Date() },
});
```

**Effort**: 3-4 Ñ‡Ğ°ÑĞ° (migration + implementation + testing)

---

### 3.3 ğŸŸ¢ ĞĞ˜Ğ—ĞšĞ˜Ğ™ Ğ Ğ˜Ğ¡Ğš: UI Routing

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: ĞĞµÑ‚ UI Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ

**Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹**:

- `/[locale]` - Ğ³Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
- `/[locale]/exchange` - ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°
- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾ĞºĞ½Ğ° Ğ´Ğ»Ñ login/register

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚ UI/UX ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ°)

**ĞĞ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**:

1. âœ… ĞšĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ñ login/register
2. âœ… ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
3. âœ… Ğ›ÑƒÑ‡ÑˆĞ¸Ğ¹ UX (Ğ½Ğµ Ğ¿Ğ¾ĞºĞ¸Ğ´Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ)
4. âœ… Mobile-friendly

**Effort**: 0 Ñ‡Ğ°ÑĞ¾Ğ² (Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ¾Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¾)

---

### 3.4 ğŸŸ¡ Ğ¡Ğ Ğ•Ğ”ĞĞ˜Ğ™ Ğ Ğ˜Ğ¡Ğš: Per-IP Rate Limiting

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ per-email rate limiting

**Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°**:

```typescript
RESET_PASSWORD: {
  points: 3,     // per EMAIL
  duration: 3600,
}
```

**Attack Scenario**:

```
ĞÑ‚Ğ°ĞºÑƒÑÑ‰Ğ¸Ğ¹ Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ IP:
- test1@example.com â†’ 3 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸
- test2@example.com â†’ 3 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸
- test3@example.com â†’ 3 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸
... 1000 emails Ã— 3 = 3000 email Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¾Ğº Ğ·Ğ° Ñ‡Ğ°Ñ
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**:

```typescript
// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² rate-limits.ts
RESET_PASSWORD_IP: {
  points: 10,        // 10 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ IP
  duration: 3600,    // 1 Ñ‡Ğ°Ñ
  blockDuration: 7200, // Ğ±Ğ»Ğ¾Ğº Ğ½Ğ° 2 Ñ‡Ğ°ÑĞ°
}

// Ğ’ middleware
rateLimitMiddleware.resetPasswordIP = createRateLimitProcedure({
  keyPrefix: 'reset_password_ip',
  points: RATE_LIMITS.RESET_PASSWORD_IP.points,
  duration: RATE_LIMITS.RESET_PASSWORD_IP.duration,
  identifierType: 'ip', // âœ… ĞŸĞ¾ IP, Ğ½Ğµ Ğ¿Ğ¾ email
});
```

**Effort**: 1-2 Ñ‡Ğ°ÑĞ°

---

## 4ï¸âƒ£ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ ĞĞ«Ğ• Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ¯ (UI/UX)

### 4.1 Modal Flow - 3 States

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: ĞĞ´Ğ½Ğ° Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ° Ñ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¼ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STATE 1: Request Reset Code                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Email: [________________]                  â”‚  â”‚
â”‚  â”‚ Captcha: 5 + 3 = [_]                       â”‚  â”‚
â”‚  â”‚ [Send Reset Code]                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ (after success)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STATE 2: Enter Reset Code & New Password        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Email: [user@example.com] (readonly)       â”‚  â”‚
â”‚  â”‚ Code: [______]  â±ï¸ Expires in 14:32        â”‚  â”‚
â”‚  â”‚ New Password: [________]                    â”‚  â”‚
â”‚  â”‚ [Reset Password]                            â”‚  â”‚
â”‚  â”‚ Didn't receive? [Resend Code]              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ (after success)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STATE 3: Success (auto-close + redirect)        â”‚
â”‚  âœ… Password changed successfully                 â”‚
â”‚  ğŸ” You are now logged in                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Placement - Link in LoginForm

**Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ**:

```tsx
<AuthForm.FieldWrapper>
  <FormEmailField />

  <div className="space-y-2">
    <AuthPasswordField />
    {/* âœ… Ğ¡ÑÑ‹Ğ»ĞºĞ° ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾Ğ´ password Ğ¿Ğ¾Ğ»ĞµĞ¼ */}
    <button
      type="button"
      onClick={onForgotPassword}
      className="text-sm text-primary hover:underline text-right block w-full"
    >
      {t('forgotPassword')}
    </button>
  </div>

  <FormCaptchaField />
</AuthForm.FieldWrapper>
```

**Ğ Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ**:

- âœ… Ğ•ÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğµ Ğ¼ĞµÑÑ‚Ğ¾ (Ğ³Ğ´Ğµ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸)
- âœ… ĞĞµ Ğ¼ĞµÑˆĞ°ĞµÑ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¼Ñƒ flow
- âœ… Mobile-friendly (text-right Ğ´Ğ»Ñ desktop, Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ğ½Ğ° mobile)

### 4.3 Post-Reset Flow - Auto-Login

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: Auto-login (ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ² backend)

```typescript
// resetPassword endpoint Ğ£Ğ–Ğ• Ğ´ĞµĞ»Ğ°ĞµÑ‚:
1. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ hashedPassword
2. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ½Ğ¾Ğ²ÑƒÑ ÑĞµÑÑĞ¸Ñ
3. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ sessionId cookie
4. Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ user + sessionId

// Frontend Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾:
onSuccess: () => {
  onForgotPasswordClose();
  onAuthSuccess?.(); // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ
  // Session cookie ÑƒĞ¶Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° - user Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ¸Ğ½ĞµĞ½
}
```

**ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ° ĞĞ• Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ°**: Redirect Ğ½Ğ° login

- âŒ Ğ¥ÑƒĞ¶Ğµ UX (Ğ»Ğ¸ÑˆĞ½Ğ¸Ğ¹ ÑˆĞ°Ğ³)
- âŒ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
- âŒ Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ confusion

---

## 5ï¸âƒ£ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ¬

### 5.1 Email Enumeration Protection

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ**: âœ… Ğ£Ğ–Ğ• Ğ Ğ•ĞĞ›Ğ˜Ğ—ĞĞ’ĞĞĞ

```typescript
// Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚
return {
  message: 'If the specified email exists, a recovery code will be sent to it',
};

// ĞĞ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (Ñ‡ĞµÑ€ĞµĞ· delay)
await createDelay(AUTH_CONSTANTS.LOGIN_REQUEST_DELAY_MS);
```

**Ğ—Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¾Ñ‚**:

- âœ… ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… emails
- âœ… Timing attacks
- âœ… Email harvesting

### 5.2 Rate Limiting Strategy

**Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ**:

```typescript
Per-Email: 3 attempts / 1 hour
```

**Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ**:

```typescript
Per-IP: 10 attempts / 1 hour
```

**Combined Protection**:

```
ĞÑ‚Ğ°ĞºÑƒÑÑ‰Ğ¸Ğ¹ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½:
- ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 3 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ½Ğ° Ğ¾Ğ´Ğ¸Ğ½ email
- ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 10 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ IP
- Block duration ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ñ… Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸ÑÑ…
```

### 5.3 Token Security

**Requirements**:

- âœ… Cryptographically secure generation (crypto.randomBytes)
- âœ… 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚ TTL
- âœ… Single-use only
- âœ… User-specific (Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½ Ğº userId)
- âœ… Auto-cleanup expired tokens

**Implementation**:

```typescript
// Token generation
const token = crypto.randomBytes(32).toString('hex'); // 256-bit security
const code = crypto.randomInt(100000, 999999).toString(); // 6-digit for UX

// Storage
{
  userId: user.id,
  token: token,      // Ğ´Ğ»Ñ API (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
  code: code,        // Ğ´Ğ»Ñ UX (Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ)
  expiresAt: Date.now() + 15 * 60 * 1000,
  used: false
}
```

---

## 6ï¸âƒ£ Ğ¢ĞĞ§ĞšĞ˜ Ğ˜ĞĞ¢Ğ•Ğ“Ğ ĞĞ¦Ğ˜Ğ˜

### 6.1 Ğ“Ğ´Ğµ ĞĞ• Ñ‚Ñ€Ğ¾Ğ³Ğ°Ñ‚ÑŒ (No Breaking Changes)

âŒ **ĞĞ• Ğ˜Ğ—ĞœĞ•ĞĞ¯Ğ¢Ğ¬**:

- `auth.login` endpoint
- `auth.register` endpoint
- `LoginForm.tsx` (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ)
- `RegisterForm.tsx`
- User model schema (Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ passwords)
- Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ validation schemas
- AuthForm compound component

### 6.2 Ğ“Ğ´Ğµ Ğ½ÑƒĞ¶Ğ½Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ

âœ… **Ğ˜Ğ—ĞœĞ•ĞĞ˜Ğ¢Ğ¬ / Ğ”ĞĞ‘ĞĞ’Ğ˜Ğ¢Ğ¬**:

1. **Backend** (`apps/web/src/server/trpc/routers/auth.ts`):
   - `requestPasswordReset` - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ EmailService integration
   - `requestPasswordReset` - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ token storage
   - `resetPassword` - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ token validation

2. **Database** (`packages/session-management/prisma/schema.prisma`):
   - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ `PasswordResetToken`
   - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ

3. **Email Service** (`packages/email-service/src/`):
   - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ template `password-reset.html`
   - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ template `password-reset.txt`
   - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑ‚Ğ¾Ğ´ `sendPasswordResetEmail`

4. **Frontend UI** (`apps/web/src/components/`):
   - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ `ForgotPasswordRequestForm.tsx`
   - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ `ForgotPasswordResetForm.tsx`
   - Ğ Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ `auth-dialogs.tsx`
   - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ Ğ² `LoginForm.tsx`
   - Ğ Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ `useAuthDialogs` hook

5. **Ğ›Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ** (`apps/web/messages/{en,ru}/layout.json`):
   - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞµĞºÑ†Ğ¸Ñ `forgotPassword` Ñ 15+ ĞºĞ»ÑÑ‡Ğ°Ğ¼Ğ¸

6. **Rate Limiting** (`packages/constants/src/rate-limits.ts`):
   - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `RESET_PASSWORD_IP` config
   - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ middleware Ğ´Ğ»Ñ IP-based limiting

---

## 7ï¸âƒ£ ĞĞ¦Ğ•ĞĞšĞ COMPLEXITY

### Time Estimates (Production-Ready)

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚                   | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ           | Effort   | Risk      |
| --------------------------- | ---------------- | -------- | --------- |
| Backend API                 | âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ² (90%)   | 0h       | ğŸŸ¢ LOW    |
| Validation Schemas          | âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²         | 0h       | ğŸŸ¢ LOW    |
| Frontend Hooks              | âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²         | 0h       | ğŸŸ¢ LOW    |
| **Database Migration**      | âŒ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ       | **1h**   | ğŸŸ¢ LOW    |
| **Token Storage Logic**     | âŒ Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ   | **2-3h** | ğŸŸ¡ MEDIUM |
| **Email Template**          | âŒ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ       | **1-2h** | ğŸŸ¢ LOW    |
| **Email Integration**       | âŒ Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ | **2-3h** | ğŸŸ¡ MEDIUM |
| **UI Components (2 forms)** | âŒ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ       | **3-4h** | ğŸŸ¢ LOW    |
| **AuthDialogs Extension**   | âŒ Ğ Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ     | **1h**   | ğŸŸ¢ LOW    |
| **Ğ›Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**             | âŒ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ      | **1h**   | ğŸŸ¢ LOW    |
| **Per-IP Rate Limiting**    | âŒ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ      | **1-2h** | ğŸŸ¢ LOW    |
| **E2E Testing**             | âŒ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ       | **2-3h** | ğŸŸ¢ LOW    |

**TOTAL**: **14-21 hours** Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ production-ready Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### Critical Path

```
BLOCKING TASKS (must complete first):
1. Database Migration (1h)
2. Token Storage Logic (2-3h)
3. Email Template (1-2h)
4. Email Integration (2-3h)
â””â”€ Total: 6-9 hours

PARALLEL TASKS (can work independently):
1. UI Components (3-4h)
2. Ğ›Ğ¾ĞºĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (1h)
3. Per-IP Rate Limiting (1-2h)
â””â”€ Total: 5-7 hours

FINAL TASKS (after integration):
1. E2E Testing (2-3h)
2. Security Audit (1h)
â””â”€ Total: 3-4 hours
```

---

## 8ï¸âƒ£ ĞŸĞ•Ğ Ğ•Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•ĞœĞ«Ğ• ĞšĞĞœĞŸĞĞĞ•ĞĞ¢Ğ«

### Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğµ Building Blocks

âœ… **100% Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ñ‹ Ğº Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ**:

1. **AuthForm** - compound component pattern
2. **FormEmailField** - email input Ñ validation
3. **AuthPasswordField** - password input
4. **FormCaptchaField** - captcha widget
5. **AuthSubmitButton** - submit button Ñ loading
6. **Dialog** - modal component
7. **useFormWithNextIntl** - form management hook
8. **usePasswordMutations** - tRPC mutations hook
9. **Validation schemas** - security-enhanced
10. **Rate limiting** - middleware Ğ³Ğ¾Ñ‚Ğ¾Ğ²

âš ï¸ **Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ°Ñ†Ğ¸Ñ**:

1. **Input Ğ´Ğ»Ñ reset code** - Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Input Ñ Ğ¼Ğ°ÑĞºĞ¾Ğ¹ "000000"
2. **Timer component** - countdown Ğ´Ğ»Ñ "expires in X:XX"
3. **Resend button** - ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ñ cooldown

---

## 9ï¸âƒ£ MIGRATION PLAN

### Database Migration

```prisma
-- packages/session-management/prisma/migrations/XXXXXX_add_password_reset_tokens/migration.sql

-- CreateTable
CREATE TABLE "password_reset_tokens" (
    "id" UUID NOT NULL DEFAULT gen_random_uuid(),
    "user_id" UUID NOT NULL,
    "token" VARCHAR(255) NOT NULL,
    "code" VARCHAR(10) NOT NULL,
    "expires_at" TIMESTAMPTZ(6) NOT NULL,
    "created_at" TIMESTAMPTZ(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "used" BOOLEAN NOT NULL DEFAULT false,
    "used_at" TIMESTAMPTZ(6),

    CONSTRAINT "password_reset_tokens_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "password_reset_tokens_token_key" ON "password_reset_tokens"("token");

-- CreateIndex
CREATE INDEX "password_reset_tokens_user_id_idx" ON "password_reset_tokens"("user_id");

-- CreateIndex
CREATE INDEX "password_reset_tokens_token_idx" ON "password_reset_tokens"("token");

-- CreateIndex
CREATE INDEX "password_reset_tokens_expires_at_idx" ON "password_reset_tokens"("expires_at");

-- CreateIndex
CREATE INDEX "password_reset_tokens_used_idx" ON "password_reset_tokens"("used");

-- AddForeignKey
ALTER TABLE "password_reset_tokens" ADD CONSTRAINT "password_reset_tokens_user_id_fkey"
    FOREIGN KEY ("user_id") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

---

## ğŸ”Ÿ Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞ«Ğ• Ğ Ğ•ĞšĞĞœĞ•ĞĞ”ĞĞ¦Ğ˜Ğ˜

### Ğ”Ğ»Ñ ĞĞ³ĞµĞ½Ñ‚Ğ°-ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°

âœ… **Ğ“ĞĞ¢ĞĞ’Ğ Ğš ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ ĞĞĞœĞ£ ĞŸĞ›ĞĞĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ®**:

1. **Ğ’ÑĞµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ patterns Ğ¸Ğ·ÑƒÑ‡ĞµĞ½Ñ‹**
2. **Ğ¢Ğ¾Ñ‡ĞºĞ¸ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹**
3. **Ğ Ğ¸ÑĞºĞ¸ Ğ¾Ñ†ĞµĞ½ĞµĞ½Ñ‹ Ğ¸ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹**
4. **ĞŸĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹**
5. **UI/UX Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ñ‹**
6. **Security requirements Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹**

### Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

1. **ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚Ğ¾Ñ€**: Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°Ğ¼Ğ¸
2. **ĞšĞ¾Ğ´ĞµÑ€**: ĞŸĞ¾ÑÑ‚Ğ°Ğ¿Ğ½Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (4 Ñ„Ğ°Ğ·Ñ‹)
3. **Ğ ĞµĞ²Ğ¸Ğ·Ğ¾Ñ€**: Code review + security audit
4. **QA**: E2E testing + regression testing

---

## ğŸ“š Ğ¡ĞŸĞ ĞĞ’ĞĞ§ĞĞ«Ğ• ĞœĞĞ¢Ğ•Ğ Ğ˜ĞĞ›Ğ«

### ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°

1. `apps/web/src/server/trpc/routers/auth.ts` - backend endpoints
2. `apps/web/src/components/auth-dialogs.tsx` - modal system
3. `apps/web/src/components/forms/LoginForm.tsx` - form pattern
4. `packages/ui/src/components/auth-form-compound.tsx` - compound component
5. `packages/utils/src/validation/security-enhanced-auth-schemas.ts` - validation
6. `packages/email-service/` - email infrastructure
7. `packages/session-management/prisma/schema.prisma` - database schema

### Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ

- `docs/core/SECURITY_ENHANCED_VALIDATION_GUIDE.md` - validation patterns
- `docs/core/DEVELOPER_GUIDE.md` - development standards
- `docs/core/SESSION_ARCHITECTURE.md` - session management
- `docs/core/CODE_STYLE_GUIDE.md` - code style
- `docs/ai-agent/ai-agent-rules.yml` - development rules

---

**ğŸ¯ Ğ“ĞĞ¢ĞĞ’Ğ Ğš ĞŸĞ•Ğ Ğ•Ğ”ĞĞ§Ğ• ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢ĞĞ Ğ£** ğŸš€

_Impact Analysis Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½. Ğ’ÑĞµ ÑƒÑ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ñ‹ Ğ½Ğ° 100%. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚Ğ¾Ñ€ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸._
