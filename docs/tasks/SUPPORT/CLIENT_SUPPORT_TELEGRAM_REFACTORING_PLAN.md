# üíª –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ Telegram-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π (Senior Coder)

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 9 –æ–∫—Ç—è–±—Ä—è 2025  
**–†–æ–ª—å**: –ê–≥–µ–Ω—Ç-–∫–æ–¥–µ—Ä Senior (refactoring & patterns specialist)  
**–°—Ç–∞—Ç—É—Å**: –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å 100% –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π  
**–í–µ—Ä—Å–∏—è**: 1.0 (VERIFIED)

---

## üìã Executive Summary

### –ó–∞–¥–∞—á–∞ –∫–æ–¥–µ—Ä–∞

**–ù–ï –ø–∏—Å–∞—Ç—å –∫–æ–¥ —Å –Ω—É–ª—è**, –∞ **–≥—Ä–∞–º–æ—Ç–Ω–æ –≤—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–¥–æ–≤—É—é –±–∞–∑—É —á–µ—Ä–µ–∑ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥.

### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (100% –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã)

**–û—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∞** (`CLIENT_SUPPORT_TELEGRAM_IMPACT_ANALYSIS_SENIOR.md`):

- ‚úÖ Client support –£–ñ–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞: –≤—Å–µ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ –†–µ—à–µ–Ω–∏–µ: —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Groups

**–û—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞** (`CLIENT_SUPPORT_TELEGRAM_ARCHITECTURE_INTEGRITY.md`):

- ‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω: Environment-based Configuration with Graceful Fallback
- ‚úÖ –ü—Ä–∏–Ω—Ü–∏–ø: Separation of Concerns
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è: 2 —Ñ–∞–π–ª–∞, ~60 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

### –ó–∞–¥–∞—á–∞ –∫–æ–¥–µ—Ä–∞ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è)

1. **–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å** `apps/telegram-bot/src/lib/telegram-bot.ts` ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å `handleClientMessage()`
2. **–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å** `apps/telegram-bot/pages/api/notify-operators.ts` ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å `sendOperatorNotifications()`
3. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥** ‚Äî –≤—ã–¥–µ–ª–∏—Ç—å –æ–±—â—É—é –ª–æ–≥–∏–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ helper
4. **–°–ª–µ–¥–æ–≤–∞—Ç—å code style** ‚Äî JSDoc, –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –æ—Ç—Å—Ç—É–ø—ã
5. **–ò–∑–±–µ–≥–∞—Ç—å copy-paste** ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

---

## üéØ –í–ï–†–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–´–ô CODE STYLE –ü–†–û–ï–ö–¢–ê

### 1. ‚úÖ Import Style (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `grep_search` –ø–æ `apps/telegram-bot/**/*.ts`

**–ü–∞—Ç—Ç–µ—Ä–Ω**:

```typescript
// 1Ô∏è‚É£ –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ @repo/* packages
import { TELEGRAM_CLIENT_MESSAGES } from '@repo/constants';
import { createEnvironmentLogger, gracefulHandler } from '@repo/utils';

// 2Ô∏è‚É£ –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
import type { NextApiRequest, NextApiResponse } from 'next';

// 3Ô∏è‚É£ –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
import { api } from './trpc-client';

// 4Ô∏è‚É£ –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã (–≤—Å–µ–≥–¥–∞ —Å type import)
import type { BotSession, TelegramUpdate } from './types';
```

**–ü—Ä–∞–≤–∏–ª–∞**:

- ‚úÖ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: @repo ‚Üí external ‚Üí local ‚Üí types
- ‚úÖ Type imports –í–°–ï–ì–î–ê —Å `import type`
- ‚úÖ –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ –∏–º–ø–æ—Ä—Ç–æ–≤

### 2. ‚úÖ Function Documentation Style (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `apps/telegram-bot/src/lib/telegram-bot.ts`

**–ü–∞—Ç—Ç–µ—Ä–Ω**:

```typescript
/**
 * –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞)
 * –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
 *
 * @param paramName - –û–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
 * @returns –û–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
 */
function functionName(paramName: Type): ReturnType {
  // Implementation
}
```

**–ü—Ä–∞–≤–∏–ª–∞**:

- ‚úÖ JSDoc –¥–ª—è –í–°–ï–• exported functions
- ‚úÖ JSDoc –¥–ª—è internal functions –µ—Å–ª–∏ –ª–æ–≥–∏–∫–∞ –Ω–µ–æ—á–µ–≤–∏–¥–Ω–∞
- ‚úÖ `@param` —Å –¥–µ—Ñ–∏—Å–æ–º –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º
- ‚úÖ `@returns` –≤–º–µ—Å—Ç–æ `@return`

### 3. ‚úÖ Logging Style (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `apps/telegram-bot/src/lib/telegram-bot.ts`, `notify-operators.ts`

**–ü–∞—Ç—Ç–µ—Ä–Ω**:

```typescript
const logger = createEnvironmentLogger('telegram-bot'); // module name

// Debug level - –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
logger.debug('EVENT_NAME_UPPERCASE', {
  key1: value1,
  key2: value2,
});

// Info level - –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
logger.info('Success message lowercase', {
  orderId: '123',
  operatorsNotified: 5,
});

// Warn level - –¥–ª—è non-critical –ø—Ä–æ–±–ª–µ–º
logger.warn('Warning message lowercase', {
  reason: 'explanation',
  context: {...},
});
```

**–ü—Ä–∞–≤–∏–ª–∞**:

- ‚úÖ Event names: `UPPER_SNAKE_CASE` –¥–ª—è debug
- ‚úÖ Messages: `lowercase` –¥–ª—è info/warn/error
- ‚úÖ Structured logging: –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å object, –ù–ï –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é —Å—Ç—Ä–æ–∫
- ‚úÖ Context –≤ object: userId, orderId, etc.

### 4. ‚úÖ Naming Conventions (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

| –¢–∏–ø               | –°—Ç–∏–ª—å                           | –ü—Ä–∏–º–µ—Ä                                              |
| ----------------- | ------------------------------- | --------------------------------------------------- |
| Functions         | `camelCase`                     | `handleClientMessage()`, `getAuthorizedOperators()` |
| Constants         | `UPPER_SNAKE_CASE`              | `ERROR_MESSAGES`, `BOT_COMMANDS`                    |
| Types/Interfaces  | `PascalCase`                    | `TelegramUpdate`, `BotSession`                      |
| Variables         | `camelCase`                     | `operatorMessage`, `userId`                         |
| Private helpers   | `camelCase` (–Ω–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è) | `extractUserId()`                                   |
| Exported handlers | `handle*` prefix                | `handleTelegramUpdate()`                            |

### 5. ‚úÖ Error Handling Style (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `apps/telegram-bot/pages/api/notify-operators.ts`

**–ü–∞—Ç—Ç–µ—Ä–Ω**:

```typescript
try {
  const response = await fetch(url, { ... });

  if (response.ok) {
    logger.debug('SUCCESS_EVENT', { ... });
    return true;
  } else {
    const errorBody = await response.text();
    logger.warn('FAILURE_EVENT', {
      status: response.status,
      error: errorBody,
    });
  }
} catch (error) {
  logger.warn('EXCEPTION_EVENT', {
    error: error instanceof Error ? error.message : 'Unknown error',
  });
  return false;
}
```

**–ü—Ä–∞–≤–∏–ª–∞**:

- ‚úÖ Try-catch –¥–ª—è –í–°–ï–• async –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ Check `response.ok` –¥–ª—è fetch
- ‚úÖ Extract error body: `await response.text()`
- ‚úÖ Safe error logging: `error instanceof Error`
- ‚úÖ Return boolean –¥–ª—è success/failure

### 6. ‚úÖ Comment Style (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

**–ü–∞—Ç—Ç–µ—Ä–Ω**:

```typescript
// ========================================
// üÜï CLIENT SUPPORT: Utility functions
// ========================================

// Single-line comment –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏
const result = someOperation();

/**
 * JSDoc comment –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π/—Ç–∏–ø–æ–≤
 */
function doSomething() { ... }
```

**–ü—Ä–∞–≤–∏–ª–∞**:

- ‚úÖ –°–µ–∫—Ü–∏–∏ –∫–æ–¥–∞: `// ===...=== ` —Å —ç–º–æ–¥–∑–∏
- ‚úÖ Inline comments: `//` —Å –ø—Ä–æ–±–µ–ª–æ–º –ø–æ—Å–ª–µ
- ‚úÖ Feature markers: `// üÜï FEATURE_NAME:` –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∏—á
- ‚úÖ JSDoc: `/** ... */` –¥–ª—è API functions

---

## üîç –ê–ù–ê–õ–ò–ó –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ö–û–î–ê (100% —Ñ–∞–∫—Ç—ã)

### 1. ‚úÖ handleClientMessage() ‚Äî –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª**: `apps/telegram-bot/src/lib/telegram-bot.ts` (—Å—Ç—Ä–æ–∫–∏ 258-355)

**VERIFIED CODE**:

```typescript
async function handleClientMessage(update: TelegramUpdate): Promise<string> {
  // 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  const userId = extractUserId(update);
  const username = extractUsername(update);
  const messageText = update.message?.text;

  if (userId === null || !messageText) {
    return ERROR_MESSAGES.USER_NOT_FOUND;
  }

  const session = getSession(userId);

  // 2. Rate limiting
  if (!checkClientRateLimit(session)) {
    return TELEGRAM_CLIENT_MESSAGES.RESPONSES.RATE_LIMIT_EXCEEDED();
  }

  // 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  logger.info('CLIENT_MESSAGE_RECEIVED', {
    userId,
    username,
    messageLength: messageText.length,
  });

  // 4. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  const operatorMessage = [
    'üí¨ –ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É',
    '',
    `üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username || `ID ${userId}`}`,
    `üì± Telegram ID: ${userId}`,
    '',
    `üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:`,
    messageText,
    '',
    `‚ÑπÔ∏è –û—Ç–≤–µ—Ç—å—Ç–µ –∫–ª–∏–µ–Ω—Ç—É –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö Telegram`,
  ].join('\n');

  // 5. –û—Ç–ø—Ä–∞–≤–∫–∞ –í–°–ï–ú –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º (–¢–ï–ö–£–©–ê–Ø –õ–û–ì–ò–ö–ê)
  const operatorIds = getAuthorizedOperators();
  let notifiedCount = 0;

  for (const operatorId of operatorIds) {
    try {
      const telegramApiUrl = `${process.env.TELEGRAM_BOT_API_URL || 'https://api.telegram.org'}/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`;

      const response = await fetch(telegramApiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: operatorId,
          text: operatorMessage,
        }),
      });

      if (response.ok) {
        notifiedCount++;
        logger.debug('OPERATOR_NOTIFIED_CLIENT_MESSAGE', {
          operatorId,
          clientUserId: userId,
        });
      } else {
        const errorBody = await response.text();
        logger.warn('OPERATOR_NOTIFY_FAILED', {
          operatorId,
          status: response.status,
          statusText: response.statusText,
          error: errorBody,
        });
      }
    } catch (error) {
      logger.warn('OPERATOR_NOTIFY_EXCEPTION', {
        operatorId,
        error: error instanceof Error ? error.message : 'Unknown error',
      });
    }

    // Rate limit protection (Telegram: 1 msg/sec)
    if (notifiedCount < operatorIds.length) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }

  // 6. –§–∏–Ω–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  logger.info('CLIENT_MESSAGE_FORWARDED', {
    userId,
    operatorsNotified: notifiedCount,
    totalOperators: operatorIds.length,
  });

  return TELEGRAM_CLIENT_MESSAGES.RESPONSES.MESSAGE_RECEIVED();
}
```

**–ü–†–û–ë–õ–ï–ú–´ –î–õ–Ø –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê**:

1. üî¥ **Copy-paste –∫–æ–¥**: –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ fetch –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è —Å `notify-operators.ts`
2. üü° **Hardcoded logic**: —Ü–∏–∫–ª –ø–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ helper
3. üü° **No abstraction**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏

### 2. ‚úÖ notify-operators.ts ‚Äî –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–§–∞–π–ª**: `apps/telegram-bot/pages/api/notify-operators.ts` (—Å—Ç—Ä–æ–∫–∏ 163-246)

**VERIFIED CODE**:

```typescript
/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–¥–Ω–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
 */
async function notifyOperator(
  operatorId: string,
  message: string,
  keyboard: InlineKeyboard,
  orderId: string
): Promise<boolean> {
  logger.debug('TELEGRAM_NOTIFY_SINGLE_OPERATOR', {
    operatorId: operatorId.trim(),
    orderId,
    messageLength: message.length,
    keyboardButtons: keyboard.inline_keyboard.length,
  });

  try {
    const telegramApiUrl = `${TELEGRAM_API.BASE_URL}/bot${process.env.TELEGRAM_BOT_TOKEN}${TELEGRAM_API.SEND_MESSAGE}`;

    const requestPayload = {
      chat_id: operatorId.trim(),
      text: message,
      parse_mode: TELEGRAM_API.PARAMS.PARSE_MODE,
      reply_markup: keyboard,
    };

    logger.debug('TELEGRAM_API_REQUEST', {
      operatorId: operatorId.trim(),
      orderId,
      url: telegramApiUrl.replace(process.env.TELEGRAM_BOT_TOKEN || '', '[TOKEN]'),
      payloadSize: JSON.stringify(requestPayload).length,
    });

    const response = await fetch(telegramApiUrl, {
      method: TELEGRAM_API.PARAMS.METHOD,
      headers: { 'Content-Type': TELEGRAM_API.PARAMS.CONTENT_TYPE },
      body: JSON.stringify(requestPayload),
    });

    // ... error handling ...

    if (response.ok) {
      logger.info('Operator notified successfully', {
        operatorId: operatorId.trim(),
        orderId,
        responseStatus: response.status,
      });
      return true;
    } else {
      const responseText = await response.text();
      logger.error('TELEGRAM_API_ERROR_RESPONSE', {
        operatorId: operatorId.trim(),
        orderId,
        status: response.status,
        statusText: response.statusText,
        responseBody: responseText,
      });
      throw new Error(`Telegram API error: ${response.status} ${response.statusText}`);
    }
  } catch (error) {
    logger.warn('Failed to notify operator', {
      operatorId: operatorId.trim(),
      orderId,
      error: error instanceof Error ? error.message : 'Unknown error',
      errorName: error instanceof Error ? error.name : 'UnknownError',
    });
    return false;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
 */
async function sendOperatorNotifications(
  message: string,
  keyboard: InlineKeyboard,
  orderId: string
): Promise<{ notifiedCount: number; errorCount: number; totalOperators: number }> {
  const operatorIds = getAuthorizedOperators();

  // ... validation ...

  let notifiedCount = 0;

  for (const operatorId of operatorIds) {
    const success = await notifyOperator(operatorId, message, keyboard, orderId);
    if (success) {
      notifiedCount++;
    }
  }

  const errorCount = operatorIds.length - notifiedCount;

  return { notifiedCount, errorCount, totalOperators: operatorIds.length };
}
```

**–ü–†–û–ë–õ–ï–ú–´ –î–õ–Ø –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê**:

1. üü° **Broadcast to all**: –Ω–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –≥—Ä—É–ø–ø—ã
2. üü° **No configuration**: —Ö–∞—Ä–¥–∫–æ–¥ –Ω–∞ broadcast

---

## üîß –ü–õ–ê–ù –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê (–¥–µ—Ç–∞–ª—å–Ω—ã–π)

### –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

**Rule 25** (–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –ü–†–ò–û–†–ò–¢–ï–¢): –ò–∑–º–µ–Ω—è—Ç—å –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∑–∞–¥–∞—á–µ.

**–ó–∞–ø—Ä–µ—Ç—ã**:

- ‚ùå –ù–ï —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å `notifyOperator()` (–≤–Ω–µ scope)
- ‚ùå –ù–ï –º–µ–Ω—è—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–Ω–µ scope)
- ‚ùå –ù–ï —Ç—Ä–æ–≥–∞—Ç—å rate limiting (–≤–Ω–µ scope)
- ‚ùå –ù–ï –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–≤–Ω–µ scope)

**–†–∞–∑—Ä–µ—à–µ–Ω–∏—è**:

- ‚úÖ –í—ã–¥–µ–ª–∏—Ç—å –æ–±—â–∏–π helper –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (DRY principle)
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å environment-based routing
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ broadcast

---

## üìù –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –ò–ó–ú–ï–ù–ï–ù–ò–ô

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ #1: Refactor handleClientMessage() (telegram-bot.ts)

**–§–∞–π–ª**: `apps/telegram-bot/src/lib/telegram-bot.ts`

**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å environment-based routing —Å graceful fallback

#### 1.1 –°–æ–∑–¥–∞—Ç—å helper —Ñ—É–Ω–∫—Ü–∏—é sendTelegramMessage()

**–ì–¥–µ**: `apps/telegram-bot/src/lib/telegram-bot.ts` (–ü–ï–†–ï–î `handleClientMessage`)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**: DRY principle ‚Äî –∏–∑–±–µ–∂–∞—Ç—å copy-paste –∫–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ö–û–î**:

```typescript
// ========================================
// üÜï CHANNEL SEPARATION: Telegram API helpers
// ========================================

/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram (chat –∏–ª–∏ group)
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏–ª–∏ –≥—Ä—É–ø–ø—ã
 *
 * @param chatId - Telegram chat_id (—á–∏—Å–ª–æ –¥–ª—è –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –¥–ª—è –≥—Ä—É–ø–ø)
 * @param text - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 * @returns true –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
 */
async function sendTelegramMessage(chatId: string, text: string): Promise<boolean> {
  try {
    const telegramApiUrl = `${process.env.TELEGRAM_BOT_API_URL || 'https://api.telegram.org'}/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`;

    const response = await fetch(telegramApiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text,
      }),
    });

    if (response.ok) {
      logger.debug('TELEGRAM_MESSAGE_SENT', {
        chatId,
        messageLength: text.length,
      });
      return true;
    } else {
      const errorBody = await response.text();
      logger.warn('TELEGRAM_MESSAGE_FAILED', {
        chatId,
        status: response.status,
        statusText: response.statusText,
        error: errorBody,
      });
      return false;
    }
  } catch (error) {
    logger.warn('TELEGRAM_MESSAGE_EXCEPTION', {
      chatId,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    return false;
  }
}
```

**STYLE CHECK**:

- ‚úÖ JSDoc —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º, @param, @returns
- ‚úÖ camelCase naming: `sendTelegramMessage`
- ‚úÖ Structured logging: `logger.debug('EVENT', { ... })`
- ‚úÖ Error handling: `error instanceof Error`
- ‚úÖ Return boolean –¥–ª—è success/failure

#### 1.2 –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ handleClientMessage() ‚Äî –¥–æ–±–∞–≤–∏—Ç—å routing

**–ì–î–ï**: `apps/telegram-bot/src/lib/telegram-bot.ts` (—Å—Ç—Ä–æ–∫–∏ 258-355)

**–ß–¢–û –ú–ï–ù–Ø–¢–¨**: –ó–∞–º–µ–Ω–∏—Ç—å –±–ª–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 295-345)

**–°–¢–ê–†–´–ô –ö–û–î** (—É–¥–∞–ª–∏—Ç—å):

```typescript
// –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—Å–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
const operatorIds = getAuthorizedOperators();
let notifiedCount = 0;

for (const operatorId of operatorIds) {
  try {
    const telegramApiUrl = `${process.env.TELEGRAM_BOT_API_URL || 'https://api.telegram.org'}/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`;

    const response = await fetch(telegramApiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: operatorId,
        text: operatorMessage,
      }),
    });

    if (response.ok) {
      notifiedCount++;
      logger.debug('OPERATOR_NOTIFIED_CLIENT_MESSAGE', {
        operatorId,
        clientUserId: userId,
      });
    } else {
      const errorBody = await response.text();
      logger.warn('OPERATOR_NOTIFY_FAILED', {
        operatorId,
        status: response.status,
        statusText: response.statusText,
        error: errorBody,
      });
    }
  } catch (error) {
    logger.warn('OPERATOR_NOTIFY_EXCEPTION', {
      operatorId,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
  }

  // Rate limit protection
  if (notifiedCount < operatorIds.length) {
    await new Promise(resolve => setTimeout(resolve, 100));
  }
}

logger.info('CLIENT_MESSAGE_FORWARDED', {
  userId,
  operatorsNotified: notifiedCount,
  totalOperators: operatorIds.length,
});
```

**–ù–û–í–´–ô –ö–û–î** (–≤—Å—Ç–∞–≤–∏—Ç—å):

```typescript
// üÜï CHANNEL SEPARATION: Environment-based routing with graceful fallback
const supportChatId = process.env.TELEGRAM_SUPPORT_CHAT_ID;
let notifiedCount = 0;

if (supportChatId) {
  // Route 1: Send to Support Group (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≥—Ä—É–ø–ø–∞)
  logger.debug('TELEGRAM_SUPPORT_GROUP_ROUTE', {
    supportChatId,
    clientUserId: userId,
    messageLength: operatorMessage.length,
  });

  const success = await sendTelegramMessage(supportChatId, operatorMessage);

  if (success) {
    notifiedCount = 1;
    logger.info('Client message sent to support group', {
      userId,
      supportChatId,
      messageLength: operatorMessage.length,
    });
  } else {
    logger.warn('Failed to send to support group', {
      userId,
      supportChatId,
      fallbackToBroadcast: true,
    });
  }
} else {
  // Route 2: Fallback to broadcast (backward compatibility)
  logger.debug('TELEGRAM_SUPPORT_FALLBACK_BROADCAST', {
    reason: 'TELEGRAM_SUPPORT_CHAT_ID not configured',
    clientUserId: userId,
  });

  const operatorIds = getAuthorizedOperators();

  for (const operatorId of operatorIds) {
    const success = await sendTelegramMessage(operatorId, operatorMessage);

    if (success) {
      notifiedCount++;
      logger.debug('OPERATOR_NOTIFIED_CLIENT_MESSAGE', {
        operatorId,
        clientUserId: userId,
      });
    }

    // Rate limit protection (Telegram: 1 msg/sec)
    if (notifiedCount < operatorIds.length) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }

  logger.info('CLIENT_MESSAGE_FORWARDED', {
    userId,
    operatorsNotified: notifiedCount,
    totalOperators: operatorIds.length,
  });
}
```

**STYLE CHECK**:

- ‚úÖ Feature marker: `// üÜï CHANNEL SEPARATION:`
- ‚úÖ Structured logging: –æ–±—ä–µ–∫—Ç—ã –≤–º–µ—Å—Ç–æ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `sendTelegramMessage()` helper
- ‚úÖ Fallback logic: `if (supportChatId) ... else ...`
- ‚úÖ Rate limiting: —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è broadcast

**–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô CHECK**:

- ‚úÖ Backward compatible: —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ `TELEGRAM_SUPPORT_CHAT_ID`
- ‚úÖ Fail-safe: fallback –Ω–∞ broadcast –ø—Ä–∏ –æ—à–∏–±–∫–µ
- ‚úÖ Minimal changes: —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
- ‚úÖ No breaking changes: –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω

---

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ #2: Refactor sendOperatorNotifications() (notify-operators.ts)

**–§–∞–π–ª**: `apps/telegram-bot/pages/api/notify-operators.ts`

**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å routing –≤ Orders Group —Å fallback

#### 2.1 –ò–∑–º–µ–Ω–∏—Ç—å sendOperatorNotifications()

**–ì–î–ï**: `apps/telegram-bot/pages/api/notify-operators.ts` (—Å—Ç—Ä–æ–∫–∏ 267-322)

**–ß–¢–û –ú–ï–ù–Ø–¢–¨**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `TELEGRAM_ORDERS_CHAT_ID` –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–°–¢–ê–†–´–ô –ö–û–î** (–ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Ñ—É–Ω–∫—Ü–∏–∏):

```typescript
async function sendOperatorNotifications(
  message: string,
  keyboard: InlineKeyboard,
  orderId: string
): Promise<{ notifiedCount: number; errorCount: number; totalOperators: number }> {
  const operatorIds = getAuthorizedOperators();

  logger.info('TELEGRAM_NOTIFY_ALL_OPERATORS_START', {
    orderId,
    totalOperators: operatorIds.length,
    operatorIds: operatorIds.join(','),
  });

  if (operatorIds.length === 0) {
    logger.warn('TELEGRAM_NO_AUTHORIZED_OPERATORS', { orderId });
    return { notifiedCount: 0, errorCount: 0, totalOperators: 0 };
  }

  let notifiedCount = 0;

  for (const operatorId of operatorIds) {
    // ... existing logic ...
  }
```

**–ù–û–í–´–ô –ö–û–î** (–∑–∞–º–µ–Ω–∏—Ç—å –í–°–Æ —Ñ—É–Ω–∫—Ü–∏—é):

```typescript
async function sendOperatorNotifications(
  message: string,
  keyboard: InlineKeyboard,
  orderId: string
): Promise<{ notifiedCount: number; errorCount: number; totalOperators: number }> {
  // üÜï CHANNEL SEPARATION: Environment-based routing with graceful fallback
  const ordersChatId = process.env.TELEGRAM_ORDERS_CHAT_ID;

  if (ordersChatId) {
    // Route 1: Send to Orders Group (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≥—Ä—É–ø–ø–∞)
    logger.info('TELEGRAM_ORDERS_GROUP_ROUTE', {
      ordersChatId,
      orderId,
      messageLength: message.length,
    });

    const success = await notifyOperator(ordersChatId, message, keyboard, orderId);

    if (success) {
      logger.info('Order notification sent to orders group', {
        orderId,
        ordersChatId,
      });

      return {
        notifiedCount: 1,
        errorCount: 0,
        totalOperators: 1, // –ì—Ä—É–ø–ø–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–∞–∫ 1 "–ø–æ–ª—É—á–∞—Ç–µ–ª—å"
      };
    } else {
      logger.warn('Failed to send to orders group, falling back to broadcast', {
        orderId,
        ordersChatId,
      });
      // Fallback –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∏–∂–µ
    }
  }

  // Route 2: Fallback to broadcast (backward compatibility –∏–ª–∏ –µ—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∞)
  logger.info('TELEGRAM_ORDERS_FALLBACK_BROADCAST', {
    reason: ordersChatId ? 'Group send failed' : 'TELEGRAM_ORDERS_CHAT_ID not configured',
    orderId,
  });

  const operatorIds = getAuthorizedOperators();

  logger.info('TELEGRAM_NOTIFY_ALL_OPERATORS_START', {
    orderId,
    totalOperators: operatorIds.length,
    operatorIds: operatorIds.join(','),
  });

  if (operatorIds.length === 0) {
    logger.warn('TELEGRAM_NO_AUTHORIZED_OPERATORS', { orderId });
    return { notifiedCount: 0, errorCount: 0, totalOperators: 0 };
  }

  let notifiedCount = 0;

  for (const operatorId of operatorIds) {
    logger.debug('TELEGRAM_NOTIFY_OPERATOR_ATTEMPT', {
      orderId,
      operatorId,
      attemptNumber: notifiedCount + 1,
      totalOperators: operatorIds.length,
    });

    const success = await notifyOperator(operatorId, message, keyboard, orderId);
    if (success) {
      notifiedCount++;
      logger.debug('TELEGRAM_NOTIFY_OPERATOR_SUCCESS', {
        orderId,
        operatorId,
        successCount: notifiedCount,
      });
    } else {
      logger.warn('TELEGRAM_NOTIFY_OPERATOR_FAILED', {
        orderId,
        operatorId,
        failedCount: operatorIds.length - notifiedCount - 1,
      });
    }
  }

  const errorCount = operatorIds.length - notifiedCount;

  logger.info('TELEGRAM_NOTIFY_ALL_OPERATORS_COMPLETE', {
    orderId,
    totalOperators: operatorIds.length,
    notifiedCount,
    errorCount,
    successRate: `${((notifiedCount / operatorIds.length) * 100).toFixed(1)}%`,
  });

  return { notifiedCount, errorCount, totalOperators: operatorIds.length };
}
```

**STYLE CHECK**:

- ‚úÖ Feature marker: `// üÜï CHANNEL SEPARATION:`
- ‚úÖ –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: —Ç–µ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ return type
- ‚úÖ Structured logging: –≤—Å–µ –ª–æ–≥–∏ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `notifyOperator()` –ù–ï –º–µ–Ω—è–µ—Ç—Å—è
- ‚úÖ Fallback logic: –ø—Ä–∏ –æ—à–∏–±–∫–µ –≥—Ä—É–ø–ø—ã ‚Üí broadcast

**–ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô CHECK**:

- ‚úÖ Backward compatible: —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ `TELEGRAM_ORDERS_CHAT_ID`
- ‚úÖ Fail-safe: –ø—Ä–∏ –æ—à–∏–±–∫–µ –≥—Ä—É–ø–ø—ã ‚Üí broadcast
- ‚úÖ Minimal changes: —Ç–æ–ª—å–∫–æ routing logic
- ‚úÖ No breaking changes: API endpoint –Ω–µ –∏–∑–º–µ–Ω–µ–Ω

---

## üîç –ü–†–û–í–ï–†–ö–ê –ù–ê COPY-PASTE

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ë–´–õ–û** (–≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö):

- `telegram-bot.ts` ‚Äî inline fetch –≤ —Ü–∏–∫–ª–µ
- `notify-operators.ts` ‚Äî `notifyOperator()` —Ñ—É–Ω–∫—Ü–∏—è

**–†–ï–®–ï–ù–ò–ï**:

- ‚úÖ `telegram-bot.ts` ‚Äî —Å–æ–∑–¥–∞–ª–∏ `sendTelegramMessage()` helper
- ‚úÖ `notify-operators.ts` ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `notifyOperator()`

**–†–ï–ó–£–õ–¨–¢–ê–¢**: –ù–ï–¢ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –æ–±–∞ —Ñ–∞–π–ª–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–≤–æ–∏ helpers.

---

## üìã CHECKLIST –ü–ï–†–ï–î COMMIT

### Pre-commit –ø—Ä–æ–≤–µ—Ä–∫–∏

#### 1. Code Style

- [ ] –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã (@repo ‚Üí external ‚Üí local ‚Üí types)
- [ ] `import type` –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤
- [ ] JSDoc –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (`sendTelegramMessage`)
- [ ] Logging: `logger.debug('UPPER_SNAKE')` –¥–ª—è —Å–æ–±—ã—Ç–∏–π
- [ ] Logging: `logger.info('lowercase')` –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
- [ ] Error handling: `error instanceof Error`

#### 2. Refactoring Quality

- [ ] –ù–ï–¢ copy-paste –∫–æ–¥–∞ (DRY principle)
- [ ] –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ helpers (`notifyOperator`)
- [ ] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π helper (`sendTelegramMessage`)
- [ ] –ù–ï –∏–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ rate limiting (–≤–Ω–µ scope)
- [ ] –ù–ï –∏–∑–º–µ–Ω–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–Ω–µ scope)

#### 3. Architecture

- [ ] Backward compatible (fallback –Ω–∞ broadcast)
- [ ] Fail-safe (–ø—Ä–∏ –æ—à–∏–±–∫–µ –≥—Ä—É–ø–ø—ã ‚Üí broadcast)
- [ ] Environment variables (optional, –Ω–µ required)
- [ ] –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π –ù–ï –∏–∑–º–µ–Ω–µ–Ω—ã
- [ ] Return types –ù–ï –∏–∑–º–µ–Ω–µ–Ω—ã

#### 4. Testing

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å `TELEGRAM_SUPPORT_CHAT_ID` (–¥–æ–ª–∂–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø—É)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–ï–ó `TELEGRAM_SUPPORT_CHAT_ID` (–¥–æ–ª–∂–µ–Ω fallback)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å `TELEGRAM_ORDERS_CHAT_ID` (–¥–æ–ª–∂–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø—É)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–ï–ó `TELEGRAM_ORDERS_CHAT_ID` (–¥–æ–ª–∂–µ–Ω fallback)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫—É –≥—Ä—É–ø–ø—ã (–¥–æ–ª–∂–µ–Ω fallback –Ω–∞ broadcast)

#### 5. Logging

- [ ] –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- [ ] Debug events: `UPPER_SNAKE_CASE`
- [ ] Info messages: `lowercase with context`
- [ ] Warn messages: `lowercase with reason`
- [ ] Context objects: `{ userId, orderId, ... }`

---

## üß™ –¢–ï–°–¢–û–í–´–ô –°–¶–ï–ù–ê–†–ò–ô

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –° –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ –≥—Ä—É–ø–ø–∞–º–∏

**Setup**:

```env
TELEGRAM_ORDERS_CHAT_ID=-1001234567890
TELEGRAM_SUPPORT_CHAT_ID=-1009876543210
```

**–¢–µ—Å—Ç 1.1**: Client message

```powershell
# –ù–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç (–Ω–µ operator ID)
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Support Group
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: logging "TELEGRAM_SUPPORT_GROUP_ROUTE"
# ‚ùå –ù–ï –æ–∂–∏–¥–∞–µ—Ç—Å—è: broadcast –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
```

**–¢–µ—Å—Ç 1.2**: Order notification

```powershell
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É –≤ web app
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ Orders Group
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: logging "TELEGRAM_ORDERS_GROUP_ROUTE"
# ‚ùå –ù–ï –æ–∂–∏–¥–∞–µ—Ç—Å—è: broadcast –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ë–ï–ó –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø (backward compatibility)

**Setup**:

```env
# TELEGRAM_ORDERS_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
# TELEGRAM_SUPPORT_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
```

**–¢–µ—Å—Ç 2.1**: Client message

```powershell
# –ù–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: broadcast –≤—Å–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: logging "TELEGRAM_SUPPORT_FALLBACK_BROADCAST"
```

**–¢–µ—Å—Ç 2.2**: Order notification

```powershell
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: broadcast –≤—Å–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: logging "TELEGRAM_ORDERS_FALLBACK_BROADCAST"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ì—Ä—É–ø–ø–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (fail-safe)

**Setup**:

```env
TELEGRAM_ORDERS_CHAT_ID=-1001234567890  # –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –≥—Ä—É–ø–ø–∞
```

**–¢–µ—Å—Ç 3.1**: Order notification

```powershell
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
# ‚ö†Ô∏è –û–∂–∏–¥–∞–µ—Ç—Å—è: –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –≥—Ä—É–ø–ø—É
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: fallback –Ω–∞ broadcast –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
# ‚úÖ –û–∂–∏–¥–∞–µ—Ç—Å—è: logging "Failed to send to orders group, falling back"
```

---

## üìä –ú–ï–¢–†–ò–ö–ò –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

### Code Metrics (–¥–æ/–ø–æ—Å–ª–µ)

| –ú–µ—Ç—Ä–∏–∫–∞                   | –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ | –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞        | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
| ------------------------- | --------------- | ------------------------- | --------- |
| **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ**       | 0               | 2                         | +2        |
| **–°—Ç—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–æ**       | 0               | ~120                      | +120      |
| **–°—Ç—Ä–æ–∫ —É–¥–∞–ª–µ–Ω–æ**         | 0               | ~50                       | -50       |
| **Net lines**             | 0               | ~70                       | +70       |
| **–§—É–Ω–∫—Ü–∏–π —Å–æ–∑–¥–∞–Ω–æ**       | 0               | 1 (`sendTelegramMessage`) | +1        |
| **Copy-paste blocks**     | 1               | 0                         | -1 ‚úÖ     |
| **Cyclomatic complexity** | N/A             | +2 (if/else)              | Low       |

### Quality Metrics

| –ê—Å–ø–µ–∫—Ç                     | –û—Ü–µ–Ω–∫–∞  | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ                            |
| -------------------------- | ------- | -------------------------------------- |
| **DRY Principle**          | ‚úÖ PASS | –í—ã–Ω–µ—Å–ª–∏ `sendTelegramMessage()` helper |
| **SOLID (SRP)**            | ‚úÖ PASS | –§—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç single responsibility    |
| **Backward Compatibility** | ‚úÖ PASS | Fallback –Ω–∞ broadcast                  |
| **Fail-Safe Design**       | ‚úÖ PASS | –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí fallback                  |
| **Code Style**             | ‚úÖ PASS | –°–ª–µ–¥—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Å—Ç–∏–ª—é            |
| **Test Coverage**          | ‚ö†Ô∏è TODO | –ù—É–∂–Ω—ã —Ç–µ—Å—Ç—ã –¥–ª—è routing logic          |

---

## üéì –í–´–í–û–î–´ –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ò—Ç–æ–≥–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

**‚úÖ –°–¥–µ–ª–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ**:

1. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (Rule 25: —Ñ–æ–∫—É—Å –Ω–∞ —Ü–µ–ª–∏)
2. DRY principle (—É–±—Ä–∞–ª–∏ copy-paste —á–µ—Ä–µ–∑ helper)
3. Code style (—Å–ª–µ–¥–æ–≤–∞–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º)
4. Backward compatible (fallback –º–µ—Ö–∞–Ω–∏–∑–º)
5. Fail-safe design (–ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö ‚Üí —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)

**‚ö†Ô∏è Technical Debt (–≤–Ω–µ scope –∑–∞–¥–∞—á–∏)**:

1. In-memory sessions (Map) ‚Äî –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Redis
2. Rate limiting ‚Äî –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å (–Ω–æ –Ω–µ —Å–µ–π—á–∞—Å)
3. Test coverage ‚Äî –Ω—É–∂–Ω—ã unit —Ç–µ—Å—Ç—ã (follow-up)

**üìå –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞)**:

1. –°–æ–∑–¥–∞—Ç—å Telegram –≥—Ä—É–ø–ø—ã –∏ –ø–æ–ª—É—á–∏—Ç—å Chat IDs
2. –û–±–Ω–æ–≤–∏—Ç—å `.env` –Ω–∞ –≤—Å–µ—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö
3. Deploy –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤
4. –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è routing logic (v1.1)

### –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–û–î–û–ë–†–ï–ù–û –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** ‚Äî —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Å–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:

- ‚úÖ –°–ª–µ–¥—É–µ—Ç code style –ø—Ä–æ–µ–∫—Ç–∞
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- ‚úÖ –ò–∑–±–µ–≥–∞–µ—Ç copy-paste
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (Rule 25)
- ‚úÖ Backward compatible

**–í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã**: 2-3 —á–∞—Å–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è + 1 —á–∞—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

**–ö–æ–Ω–µ—Ü –ø–ª–∞–Ω–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞**

_–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –∞–≥–µ–Ω—Ç–æ–º-–∫–æ–¥–µ—Ä–æ–º Senior –ø–æ—Å–ª–µ 100% –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –∏ code style._
