# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–ª–∞–Ω: Telegram-–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 9 –æ–∫—Ç—è–±—Ä—è 2025  
**–†–æ–ª—å**: –ê–≥–µ–Ω—Ç-–∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä (—Ñ–æ–∫—É—Å –Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)  
**–°—Ç–∞—Ç—É—Å**: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è  
**–í–µ—Ä—Å–∏—è**: 1.0

---

## üìã Executive Summary

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∑–∞–¥–∞—á–∞

–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é Telegram-–ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `apps/telegram-bot/` —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞.

### –ö–ª—é—á–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –Ω–∞—Ö–æ–¥–∫–∞

**‚úÖ –ü—Ä–æ–µ–∫—Ç –£–ñ–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Command Handler Pattern** –≤ telegram-bot —Å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º (–Ω–µ –∫–ª–∞—Å—Å—ã). –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–ü–∞—Ç—Ç–µ—Ä–Ω**: Function-based Command Handler —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–µ handler-—Ñ—É–Ω–∫—Ü–∏–∏.  
**–ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å**: –ù–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã, —Å–µ—Ä–≤–∏—Å—ã, —Ñ–∞–±—Ä–∏–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º —Å—Ç–∏–ª–µ.

---

## üèóÔ∏è –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ (100% —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ)

### 1. ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–∞ (VERIFIED)

#### 1.1 Clean Architecture —Å –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `docs/analysis/ARCHITECTURE_ANALYSIS_ORDER_SYSTEM.md`, `docs/core/ARCHITECTURE.md`

- **Separation of Concerns**: –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (`packages/exchange-core/`) –æ—Ç–¥–µ–ª–µ–Ω–∞ –æ—Ç UI (`apps/`)
- **Dependency Inversion**: –ü–∞–∫–µ—Ç—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π (interfaces –≤ `repositories/`, `types/`)
- **Single Responsibility**: –ö–∞–∂–¥—ã–π package –∏–º–µ–µ—Ç —á–µ—Ç–∫—É—é —Ä–æ–ª—å
- **Pragmatic Balance**: –ü—Ä–æ–µ–∫—Ç –ù–ï —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–µ—Ç Clean Architecture ‚Äî –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: –ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "Technical Debt vs Clean Architecture" –±–∞–ª–∞–Ω—Å ‚Äî –Ω–µ –ø–µ—Ä–µ–≥–∏–±–∞—Ç—å —Å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è–º–∏.

#### 1.2 Design Patterns –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `grep_search` –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ + –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

1. **Factory Pattern** ‚úÖ –ê–ö–¢–ò–í–ù–û –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
   - `UserManagerFactory.createForWeb()`, `createForAdmin()` (Session Management)
   - `WalletPoolManagerFactory.create()` (Exchange Core)
   - `EmailServiceFactory.createFromEnvironment()` (Email Service)

2. **Strategy Pattern** ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø:
   - `WalletAllocationStrategy` ‚Üí `ImmediateAllocationStrategy` (Exchange Core)
   - –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–æ–≤

3. **Service Layer Pattern** ‚úÖ –ê–ö–¢–ò–í–ù–û –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
   - `SmartPricingService`, `WalletAlertsService`, `EmailService`
   - –í—Å–µ services ‚Äî –∫–ª–∞—Å—Å—ã —Å static –º–µ—Ç–æ–¥–∞–º–∏ –∏–ª–∏ instance methods

4. **Repository Pattern** ‚úÖ –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø:
   - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤ `packages/exchange-core/src/repositories/`
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ data layer

5. **Middleware Pattern** ‚úÖ –ê–ö–¢–ò–í–ù–û –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
   - tRPC middleware: `operatorOnly`, `supportOnly`, `systemApiMiddleware`
   - Security-enhanced validation middleware

6. **Context-Aware Factory Pattern** ‚úÖ –°–ü–ï–¶–ò–§–ò–ß–ù–´–ô –î–õ–Ø –ü–†–û–ï–ö–¢–ê:
   - Multi-App session architecture
   - Redis namespacing: `session:web:*`, `session:admin:*`

**‚ö†Ô∏è –û–¢–°–£–¢–°–¢–í–£–ï–¢ –≤ –ø—Ä–æ–µ–∫—Ç–µ**:

- ‚ùå Command Pattern (–∫–ª–∞—Å—Å—ã –∫–æ–º–∞–Ω–¥)
- ‚ùå Mediator Pattern
- ‚ùå Observer Pattern (–∫–ª–∞—Å—Å—ã)

#### 1.3 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω Telegram Bot (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `apps/telegram-bot/src/lib/telegram-bot.ts` (–ø—Ä–æ—á–∏—Ç–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é)

**–§–ê–ö–¢**: Telegram bot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Function-based Command Handler Pattern**

```typescript
// ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ü–ê–¢–¢–ï–†–ù (–Ω–µ –∫–ª–∞—Å—Å—ã!)
function handleStartCommand(update: TelegramUpdate): string { ... }
function handleLoginCommand(update: TelegramUpdate): string { ... }
async function handleTakeOrderCommand(update: TelegramUpdate): Promise<string> { ... }
function handleOrdersCommand(update: TelegramUpdate): string { ... }
async function handleCallbackQuery(update: TelegramUpdate): Promise<string | null> { ... }

// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è-—Ä–æ—É—Ç–µ—Ä
export async function handleTelegramUpdate(update: TelegramUpdate): Promise<string | null> {
  // if/else —Ü–µ–ø–æ—á–∫–∞ –¥–ª—è —Ä–æ—É—Ç–∏–Ω–≥–∞ –∫–æ–º–∞–Ω–¥
}
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞**:

- ‚úÖ **–§—É–Ω–∫—Ü–∏–∏, –∞ –Ω–µ –∫–ª–∞—Å—Å—ã** ‚Äî –∫–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ = –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
- ‚úÖ **In-memory state** ‚Äî `Map<userId, BotSession>` –¥–ª—è —Å–µ—Å—Å–∏–π
- ‚úÖ **Single entry point** ‚Äî `handleTelegramUpdate()` –∫–∞–∫ —Ä–æ—É—Ç–µ—Ä
- ‚úÖ **Graceful handler** ‚Äî –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **Environment logger** ‚Äî `createEnvironmentLogger('telegram-bot')`

**‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:

- –ö–ª–∞—Å—Å—ã –¥–ª—è –∫–æ–º–∞–Ω–¥
- Dependency Injection
- IoC –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã

---

### 2. ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–æ–≤ (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `docs/core/PROJECT_STRUCTURE_MAP.md`, `list_dir` –ø—Ä–æ–≤–µ—Ä–∫–∏

#### 2.1 –ö–ª—é—á–µ–≤—ã–µ –ø–∞–∫–µ—Ç—ã –∏ –∏—Ö —Ä–æ–ª–∏

| –ü–∞–∫–µ—Ç                        | –†–æ–ª—å                   | –≠–∫—Å–ø–æ—Ä—Ç—ã                                              | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å          |
| ---------------------------- | ---------------------- | ----------------------------------------------------- | --------------------------- |
| `@repo/constants`            | Single Source of Truth | `USER_ROLES`, `TELEGRAM_API`, `VALIDATION_LIMITS`     | –í—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã               |
| `@repo/utils`                | –£—Ç–∏–ª–∏—Ç—ã + –≤–∞–ª–∏–¥–∞—Ü–∏—è    | `createEnvironmentLogger`, `gracefulHandler`, schemas | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, error handling |
| `@repo/exchange-core`        | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞          | Managers, Services, Types                             | Server-side –±–∏–∑–Ω–µ—Å-–æ–ø–µ—Ä–∞—Ü–∏–∏ |
| `@repo/exchange-core/client` | Client-safe exports    | Types, utilities –±–µ–∑ Node.js deps                     | Frontend –∫–æ–¥                |
| `@repo/exchange-core/server` | Server-only            | Services —Å Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏                      | API routes, tRPC            |
| `@repo/session-management`   | –°–µ—Å—Å–∏–∏ + auth          | UserManagerFactory, Redis repos                       | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è              |
| `@repo/hooks`                | React —Ö—É–∫–∏ + Zustand   | State stores, custom hooks                            | Frontend state              |
| `@repo/ui`                   | UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã          | shadcn/ui components                                  | –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã |

#### 2.2 –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–º–ø–æ—Ä—Ç–∞ (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `packages/exchange-core/src/index.ts`, `client.ts`, `server.ts`

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å frontend —Å–±–æ—Ä–∫—É)
import { QueueEmailNotifier } from '@repo/exchange-core';

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
import { QueueEmailNotifier } from '@repo/exchange-core/server'; // server-only

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û –¥–ª—è —Ç–∏–ø–æ–≤
import type { Order, User } from '@repo/exchange-core'; // client-safe
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ**: –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å client/server split –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–º–ø–æ—Ä—Ç–æ–≤.

---

### 3. ‚úÖ tRPC Architecture (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `apps/web/src/server/trpc/routers/`, middleware –∞–Ω–∞–ª–∏–∑

#### 3.1 Namespace Composition Pattern

```
apps/web/src/server/trpc/routers/
‚îú‚îÄ‚îÄ index.ts           # createTRPCRouter({ ... })
‚îú‚îÄ‚îÄ auth.ts           # authRouter
‚îú‚îÄ‚îÄ exchange.ts       # exchangeRouter
‚îú‚îÄ‚îÄ operator.ts       # operatorRouter (operatorOnly middleware)
‚îú‚îÄ‚îÄ support.ts        # supportRouter (supportOnly middleware)
‚îú‚îÄ‚îÄ telegram-bot.ts   # telegramBotRouter (systemApiMiddleware) ‚úÖ –°–£–©–ï–°–¢–í–£–ï–¢
‚îî‚îÄ‚îÄ user/            # userRouter namespace
```

**–§–ê–ö–¢**: –£–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç `telegramBotRouter` —Å `systemApiMiddleware` –¥–ª—è bot-to-API –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏.

#### 3.2 Middleware Architecture (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `apps/web/src/server/trpc/middleware/auth.ts`

```typescript
// ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï MIDDLEWARE
export const operatorOnly = roleMiddleware([USER_ROLES.OPERATOR]);
export const supportOnly = roleMiddleware([USER_ROLES.SUPPORT]);
export const operatorAndSupport = roleMiddleware([USER_ROLES.OPERATOR, USER_ROLES.SUPPORT]);

// ‚úÖ –î–õ–Ø TELEGRAM BOT (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
export const systemApiMiddleware; // Docker Network Auth
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø**: Role-based access —á–µ—Ä–µ–∑ middleware, –∞ –ù–ï –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–Ω—É—Ç—Ä–∏ procedures.

---

### 4. ‚úÖ Session Management Architecture (VERIFIED)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `docs/core/SESSION_ARCHITECTURE.md`, `packages/session-management/`

#### 4.1 Context-Aware Pattern (–ö–õ–Æ–ß–ï–í–û–ô –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞)

```typescript
// ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ü–ê–¢–¢–ï–†–ù
const webUserManager = await UserManagerFactory.createForWeb();
const adminUserManager = await UserManagerFactory.createForAdmin();
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è**:

- –†–∞–∑–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`web`, `admin-panel`) = —Ä–∞–∑–Ω—ã–µ contexts
- Redis namespacing: `session:web:*`, `session:admin:*`
- PostgreSQL fallback –¥–ª—è compatibility

**–í–û–ü–†–û–° –î–õ–Ø TELEGRAM**: –ù—É–∂–µ–Ω –ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π context `telegram` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `web`?

#### 4.2 In-Memory vs Persistent (TELEGRAM –°–ü–ï–¶–ò–§–ò–ö–ê)

**–ò—Å—Ç–æ—á–Ω–∏–∫**: `apps/telegram-bot/src/lib/telegram-bot.ts` —Å—Ç—Ä–æ–∫–∞ 23

```typescript
// ‚úÖ –¢–ï–ö–£–©–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –í TELEGRAM BOT
const sessions = new Map<number, BotSession>();
```

**–§–ê–ö–¢**: Telegram bot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **in-memory Map** –¥–ª—è —Å–µ—Å—Å–∏–π, –ù–ï Redis/Prisma.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞**:

- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–ª—è MVP
- ‚ö†Ô∏è –ü–æ—Ç–µ—Ä—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
- ‚ùå –ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –û—Å—Ç–∞–≤–∏—Ç—å as is –¥–ª—è v1, –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ Technical Debt.

---

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è Client Support

### –ü—Ä–∏–Ω—Ü–∏–ø: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–ó–∞–ø—Ä–µ—Ç—ã (–≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ –¥–æ–ª–≥–∞)**:

1. ‚ùå **–ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã** ‚Äî –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è telegram bot
2. ‚ùå **–ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã** ‚Äî –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. ‚ùå **–ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–±—Ä–∏–∫–∏** ‚Äî —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã
4. ‚ùå **–ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å DI/IoC** ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ
5. ‚ùå **–ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–æ—É—Ç–µ—Ä** ‚Äî —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
6. ‚ùå **–ù–ï –º–µ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É packages/** ‚Äî —Ç–æ–ª—å–∫–æ `constants` –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–†–∞–∑—Ä–µ—à–µ–Ω–∏—è (—Å–ª–µ–¥—É—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ)**:

1. ‚úÖ **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ handler-—Ñ—É–Ω–∫—Ü–∏–∏** ‚Äî –≤ —Å—Ç–∏–ª–µ `handleStartCommand()`
2. ‚úÖ **–†–∞—Å—à–∏—Ä–∏—Ç—å BotSession type** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `userType: 'operator' | 'client'`
3. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã** ‚Äî –≤ `packages/constants/src/telegram.ts`
4. ‚úÖ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å notify-operators.ts** ‚Äî —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
5. ‚úÖ **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `createEnvironmentLogger`

---

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: Function-based Command Handler Extension

#### 1. Type Extension (Minimal Change)

**–§–ê–ô–õ**: `apps/telegram-bot/src/lib/types.ts`

**–ò–ó–ú–ï–ù–ï–ù–ò–ï**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ, –ù–ï –º–µ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É

```typescript
// ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –¢–ò–ü
export interface BotSession {
  userId: number;
  username?: string;
  operatorId?: string;
  isOperator: boolean;
  currentOrderId?: string;
  // üÜï –î–û–ë–ê–í–ò–¢–¨ (backwards compatible)
  userType?: 'operator' | 'client'; // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
}
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:

- Optional field ‚Üí –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –ù–ï breaking change –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞
- –ú–æ–∂–Ω–æ –≤—ã—á–∏—Å–ª–∏—Ç—å –∏–∑ `isOperator` –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

#### 2. Handler Functions (Follow Existing Pattern)

**–§–ê–ô–õ**: `apps/telegram-bot/src/lib/telegram-bot.ts`

**–ü–ê–¢–¢–ï–†–ù**: –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏, –ù–ï –∏–∑–º–µ–Ω—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

```typescript
// üÜï –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø (–≤ —Å—Ç–∏–ª–µ –ø—Ä–æ–µ–∫—Ç–∞)
function handleClientStart(update: TelegramUpdate): string {
  logger.debug('TELEGRAM_CLIENT_START', { userId: update.message?.from?.id });

  if (!update.message?.from) {
    return ERROR_MESSAGES.USER_NOT_FOUND;
  }

  const session = getSession(update.message.from.id);
  session.userType = 'client'; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∏–ø

  return (
    `–ü—Ä–∏–≤–µ—Ç, ${update.message.from.first_name}! üëã\n\n` +
    `–Ø –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ExchangeGO.\n` +
    `–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É, –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n` +
    `üìû –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: –æ–±—ã—á–Ω–æ 5-15 –º–∏–Ω—É—Ç`
  );
}

// üÜï –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø (–≤ —Å—Ç–∏–ª–µ –ø—Ä–æ–µ–∫—Ç–∞)
async function handleClientMessage(update: TelegramUpdate): Promise<string> {
  logger.info('CLIENT_MESSAGE_RECEIVED', {
    userId: update.message?.from?.id,
    username: update.message?.from?.username,
  });

  // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –º–µ—Ö–∞–Ω–∏–∑–º–∞
  const operatorIds = process.env.AUTHORIZED_TELEGRAM_OPERATORS?.split(',') || [];

  const message = formatClientMessageForOperators(update);

  // –í—ã–∑–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ API endpoint
  await notifyOperatorsAboutClientMessage(message, update.message!.from!.id);

  return '‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ!\n–û–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.';
}

// üîÑ –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é (Minimal Change)
function handleStartCommand(update: TelegramUpdate): string {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

  // üÜï –î–û–ë–ê–í–ò–¢–¨ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const authorizedOperators = process.env.AUTHORIZED_TELEGRAM_OPERATORS?.split(',') || [];
  const isOperator = authorizedOperators.includes(String(userId));

  if (isOperator) {
    // ‚úÖ –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
    return handleOperatorStart(update); // –†–ï–§–ê–ö–¢–û–†–ò–ù–ì: –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
  } else {
    // üÜï –ù–û–í–ê–Ø –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
    return handleClientStart(update);
  }
}
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:

- ‚úÖ –°–ª–µ–¥—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É Function-based Pattern
- ‚úÖ Graceful handler –≤–µ–∑–¥–µ
- ‚úÖ Environment logger consistency
- ‚úÖ Backward compatibility (–æ–ø–µ—Ä–∞—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ)

#### 3. Routing Logic Extension (Single Responsibility)

**–ü–ê–¢–¢–ï–†–ù**: –û—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```typescript
// üÜï –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø (pure, testable)
function getUserType(userId: number): 'operator' | 'client' {
  const authorizedOperators = process.env.AUTHORIZED_TELEGRAM_OPERATORS?.split(',') || [];
  return authorizedOperators.includes(String(userId)) ? 'operator' : 'client';
}

// üîÑ –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–¢–¨ –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
export async function handleTelegramUpdate(update: TelegramUpdate): Promise<string | null> {
  return await gracefulHandler(
    async () => {
      // ... callback_query handling ...

      const message = update.message;
      if (!message?.text) {
        return '‚ùì –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è';
      }

      const text = message.text.trim();
      const userType = message.from ? getUserType(message.from.id) : 'client';

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (text === '/start') {
        return userType === 'operator' ? handleOperatorStart(update) : handleClientStart(update);
      }

      if (text === '/help') {
        return userType === 'operator' ? handleOperatorHelp() : handleClientHelp();
      }

      // –û–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)
      if (userType === 'operator') {
        if (text === '/login') return handleLoginCommand(update);
        if (text.startsWith('/takeorder')) return await handleTakeOrderCommand(update);
        if (text === '/orders') return handleOrdersCommand(update);
      }

      // –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–æ–≤—ã–µ)
      if (userType === 'client') {
        // –õ—é–±–æ–π —Ç–µ–∫—Å—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ = –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
        return await handleClientMessage(update);
      }

      return '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help';
    },
    { fallback: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è' }
  );
}
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:

- ‚úÖ Single Responsibility: `getUserType()` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
- ‚úÖ Open/Closed Principle: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π, –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
- ‚úÖ Dependency Inversion: –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç environment variables (–∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è)

---

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º notify –º–µ—Ö–∞–Ω–∏–∑–º–æ–º

**–§–ê–ô–õ**: `apps/telegram-bot/pages/api/notify-operators.ts`

**–°–¢–†–ê–¢–ï–ì–ò–Ø**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –∫–æ–¥

```typescript
// ‚úÖ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢
async function sendOperatorNotifications(
  message: string,
  keyboard: InlineKeyboard,
  orderId: string
): Promise<{ notifiedCount: number; errorCount: number; totalOperators: number }>;

// üÜï –û–ë–ï–†–¢–ö–ê –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–ù–ï –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞ –∞–¥–∞–ø—Ç–∞—Ü–∏—è)
async function notifyOperatorsAboutClientMessage(
  clientMessage: string,
  clientUserId: number
): Promise<void> {
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
  const operatorMessage =
    `üÜò –ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞\n\n` +
    `üë§ User ID: ${clientUserId}\n` +
    `üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:\n${clientMessage}\n\n` +
    `–û—Ç–≤–µ—Ç—å—Ç–µ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è Telegram.`;

  // ‚úÖ –ü–ï–†–ï–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
  await sendOperatorNotifications(
    operatorMessage,
    { inline_keyboard: [] }, // –ë–µ–∑ –∫–Ω–æ–ø–æ–∫ –¥–ª—è v1
    `client_support_${clientUserId}` // fake orderId –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
  );
}
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:

- ‚úÖ DRY principle ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
- ‚úÖ Adapter pattern ‚Äî –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ use case
- ‚úÖ Minimal change ‚Äî —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è

---

### Constants Extension (Single Source of Truth)

**–§–ê–ô–õ**: `packages/constants/src/telegram.ts`

**–°–¢–†–ê–¢–ï–ì–ò–Ø**: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, –ù–ï –∏–∑–º–µ–Ω—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

```typescript
// ‚úÖ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢
export const TELEGRAM_OPERATOR_MESSAGES = {
  // ... existing messages
};

// üÜï –î–û–ë–ê–í–ò–¢–¨ (–æ—Ç–¥–µ–ª—å–Ω—ã–π namespace)
export const TELEGRAM_CLIENT_MESSAGES = {
  WELCOME: (firstName: string) =>
    `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üëã\n\n` +
    `–Ø –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ExchangeGO.\n` +
    `–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É, –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n\n` +
    `üìû –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: –æ–±—ã—á–Ω–æ 5-15 –º–∏–Ω—É—Ç`,

  HELP:
    `üÜò –ü–æ–º–æ—â—å:\n\n` +
    `‚Ä¢ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º\n` +
    `‚Ä¢ –û–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç\n` +
    `‚Ä¢ –†–∞–±–æ—á–∏–µ —á–∞—Å—ã: 24/7`,

  MESSAGE_RECEIVED: `‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ!\n–û–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.`,
} as const;
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:

- ‚úÖ Single Source of Truth ‚Äî –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ Namespace separation ‚Äî `OPERATOR_*` vs `CLIENT_*`
- ‚úÖ Type safety ‚Äî `as const` –¥–ª—è —Å—Ç—Ä–æ–≥–∏—Ö —Ç–∏–ø–æ–≤

---

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º

### ‚úÖ SOLID Principles Compliance

| –ü—Ä–∏–Ω—Ü–∏–ø                   | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ                                     |
| ------------------------- | ------------ | ----------------------------------------------- |
| **Single Responsibility** | ‚úÖ –î–∞        | –ö–∞–∂–¥–∞—è handler-—Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –∫–æ–º–∞–Ω–¥—É |
| **Open/Closed**           | ‚úÖ –î–∞        | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π, –ù–ï –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö   |
| **Liskov Substitution**   | N/A          | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ                      |
| **Interface Segregation** | ‚úÖ –î–∞        | `BotSession` ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å            |
| **Dependency Inversion**  | ‚úÖ –î–∞        | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `process.env`, –∞ –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥      |

### ‚úÖ Clean Architecture Layers Compliance

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Presentation Layer (Telegram Webhook)                       ‚îÇ
‚îÇ apps/telegram-bot/pages/api/webhook.ts                     ‚îÇ
‚îÇ ‚îú‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ TelegramUpdate                                ‚îÇ
‚îÇ ‚îî‚îÄ –í—ã–∑–æ–≤ handleTelegramUpdate()                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Application Layer (Business Logic)                          ‚îÇ
‚îÇ apps/telegram-bot/src/lib/telegram-bot.ts                  ‚îÇ
‚îÇ ‚îú‚îÄ Command routing (getUserType, if/else)                  ‚îÇ
‚îÇ ‚îú‚îÄ Handler functions (handleClientStart, handleClientMessage) ‚îÇ
‚îÇ ‚îî‚îÄ Session management (getSession)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Domain Layer (Types & Interfaces)                           ‚îÇ
‚îÇ apps/telegram-bot/src/lib/types.ts                         ‚îÇ
‚îÇ ‚îî‚îÄ BotSession, TelegramUpdate interfaces                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Infrastructure Layer (External Services)                    ‚îÇ
‚îÇ ‚îú‚îÄ Telegram API (sendTelegramMessage)                      ‚îÇ
‚îÇ ‚îú‚îÄ tRPC Client (api.telegram.*)                            ‚îÇ
‚îÇ ‚îî‚îÄ Environment Logger (createEnvironmentLogger)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–û—Ü–µ–Ω–∫–∞**: ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ–±–ª—é–¥–∞–µ—Ç—Å—è. –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –Ω–∞—Ä—É—à–∞—é—Ç —Å–ª–æ–∏.

### ‚úÖ Design Patterns Alignment

| –ü–∞—Ç—Ç–µ—Ä–Ω                              | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ | –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤ —Ä–µ—à–µ–Ω–∏–∏                         |
| ------------------------------------ | ---------------------- | --------------------------------------------- |
| **Command Handler** (Function-based) | ‚úÖ –î–∞                  | ‚úÖ –î–∞ ‚Äî –Ω–æ–≤—ã–µ handler-—Ñ—É–Ω–∫—Ü–∏–∏                 |
| **Factory Pattern**                  | ‚úÖ –î–∞                  | ‚ùå –ù–µ—Ç ‚Äî –Ω–µ –Ω—É–∂–µ–Ω                             |
| **Service Layer**                    | ‚úÖ –î–∞ (–∫–ª–∞—Å—Å—ã)         | ‚ùå –ù–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏                   |
| **Strategy Pattern**                 | ‚úÖ –î–∞                  | ‚ùå –ù–µ—Ç ‚Äî –Ω–µ—Ç –≤–∞—Ä–∏–∞—Ü–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤              |
| **Middleware Pattern**               | ‚úÖ –î–∞                  | ‚úÖ –î–∞ ‚Äî `systemApiMiddleware` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç  |
| **Adapter Pattern**                  | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Å—Ç–∞–º–∏   | ‚úÖ –î–∞ ‚Äî `notifyOperatorsAboutClientMessage()` |
| **Repository Pattern**               | ‚úÖ –î–∞                  | ‚ùå –ù–µ—Ç ‚Äî –Ω–µ —Ä–∞–±–æ—Ç–∞–µ–º —Å –ë–î                     |

**–í–µ—Ä–¥–∏–∫—Ç**: ‚úÖ –†–µ—à–µ–Ω–∏–µ —Å–ª–µ–¥—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –ø—Ä–æ–µ–∫—Ç–∞.

---

## üöß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–∏—Å–∫–∏ –∏ Technical Debt

### 1. ‚ö†Ô∏è In-Memory Session Storage

**–ü—Ä–æ–±–ª–µ–º–∞**: `Map<userId, BotSession>` —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ.

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞**: –°–†–ï–î–ù–ò–ô

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:

- **v1**: –ü—Ä–∏–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
- **v2**: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Redis —á–µ—Ä–µ–∑ `@repo/session-management`

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—É—Ç—å –∫ v2**:

```typescript
// –ë—É–¥—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ (–ù–ï —Å–µ–π—á–∞—Å!)
const sessionManager = await UserManagerFactory.createForContext('telegram');
// Redis namespacing: session:telegram:*
```

### 2. ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Conversation State Persistence

**–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞**: –ù–ò–ó–ö–ò–ô (–¥–ª—è v1)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:

- **v1**: Manual operator replies ‚Äî –∏—Å—Ç–æ—Ä–∏—è –≤ Telegram UI
- **v2**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `supportRouter` + –ë–î —Ç–∏–∫–µ—Ç–æ–≤

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—É—Ç—å –∫ v2**:

```typescript
// Prisma schema extension
model SupportTicket {
  id              String   @id @default(cuid())
  clientTelegramId String
  operatorId      String?
  messages        SupportMessage[]
}

model SupportMessage {
  id        String   @id @default(cuid())
  ticketId  String
  senderId  String
  text      String
  createdAt DateTime @default(now())
}
```

### 3. ‚ö†Ô∏è –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å broadcast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞**: –í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞**: –°–†–ï–î–ù–ò–ô (–ø—Ä–∏ —Ä–æ—Å—Ç–µ —Ç—Ä–∞—Ñ–∏–∫–∞)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:

- **v1**: Rate limiting –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞ (1 —Å–æ–æ–±—â–µ–Ω–∏–µ/–º–∏–Ω—É—Ç—É –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞)
- **v2**: –°–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π + routing –ø–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è v2**:

```typescript
// Queue-based distribution (–∏—Å–ø–æ–ª—å–∑—É—è existing patterns)
interface OperatorQueue {
  operatorId: string;
  assignedTickets: string[];
  isOnline: boolean;
}
```

### 4. ‚ùå –ù–ï–¢ client-operator reply threading

**–ü—Ä–æ–±–ª–µ–º–∞**: –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –æ—Ç–≤–µ—á–∞—é—Ç –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

**–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞**: –ù–ò–ó–ö–ò–ô (UX issue, –Ω–µ technical)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**:

- **v1**: –ü—Ä–∏–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–æ—Ç–∞ –≤–∞–∂–Ω–µ–µ
- **v1.5**: –î–æ–±–∞–≤–∏—Ç—å `reply_to_message_id` threading
- **v2**: Full conversation UI –≤ admin-panel

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã** (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞):

1. –ö–Ω–æ–ø–∫–∏ —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ (–ü–†–û–°–¢–ï–ô–®–ò–ô) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `callback_query`
2. –ö–æ–º–∞–Ω–¥–∞ `/reply CLIENT_ID —Ç–µ–∫—Å—Ç` (–ü–†–û–°–¢–û–ô) ‚Äî —Å–ª–µ–¥—É–µ—Ç Command Pattern
3. Reply-threading —á–µ—Ä–µ–∑ `message_id` (–°–†–ï–î–ù–ò–ô) ‚Äî —Ç—Ä–µ–±—É–µ—Ç state mapping
4. –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π ticket system (–°–õ–û–ñ–ù–´–ô) ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `supportRouter`

---

## üìã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### ‚úÖ Pre-Implementation Checklist

- [ ] **–ü—Ä–æ—á–∏—Ç–∞—Ç—å** `docs/core/ARCHITECTURE.md` –ø–æ–ª–Ω–æ—Å—Ç—å—é
- [ ] **–ò–∑—É—á–∏—Ç—å** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `apps/telegram-bot/src/lib/telegram-bot.ts`
- [ ] **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** —Ç–∏–ø—ã –≤ `apps/telegram-bot/src/lib/types.ts`
- [ ] **–ù–∞–π—Ç–∏** –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `createEnvironmentLogger` –≤ –ø—Ä–æ–µ–∫—Ç–µ
- [ ] **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** –ø–∞—Ç—Ç–µ—Ä–Ω `gracefulHandler` –≤ `@repo/utils`

### ‚úÖ Implementation Checklist

- [ ] **–†–∞—Å—à–∏—Ä–∏—Ç—å** `BotSession` —Ç–∏–ø (optional field)
- [ ] **–°–æ–∑–¥–∞—Ç—å** `getUserType()` —Ñ—É–Ω–∫—Ü–∏—é
- [ ] **–°–æ–∑–¥–∞—Ç—å** `handleClientStart()` —Ñ—É–Ω–∫—Ü–∏—é
- [ ] **–°–æ–∑–¥–∞—Ç—å** `handleClientMessage()` —Ñ—É–Ω–∫—Ü–∏—é
- [ ] **–°–æ–∑–¥–∞—Ç—å** `handleClientHelp()` —Ñ—É–Ω–∫—Ü–∏—é
- [ ] **–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å** `handleStartCommand()` (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
- [ ] **–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å** `handleTelegramUpdate()` (—Ä–æ—É—Ç–∏–Ω–≥)
- [ ] **–î–æ–±–∞–≤–∏—Ç—å** `TELEGRAM_CLIENT_MESSAGES` –≤ `@repo/constants`
- [ ] **–°–æ–∑–¥–∞—Ç—å** wrapper `notifyOperatorsAboutClientMessage()`
- [ ] **–î–æ–±–∞–≤–∏—Ç—å** –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π

### ‚úÖ Testing Checklist

- [ ] **Unit —Ç–µ—Å—Ç—ã** –¥–ª—è `getUserType()`
- [ ] **Unit —Ç–µ—Å—Ç—ã** –¥–ª—è handler-—Ñ—É–Ω–∫—Ü–∏–π
- [ ] **Integration —Ç–µ—Å—Ç** –∫–ª–∏–µ–Ω—Ç ‚Üí –±–æ—Ç ‚Üí –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
- [ ] **Regression —Ç–µ—Å—Ç** –æ–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ

### ‚úÖ Documentation Checklist

- [ ] **–û–±–Ω–æ–≤–∏—Ç—å** `apps/telegram-bot/README.md`
- [ ] **–ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å** Technical Debt (in-memory sessions)
- [ ] **–û–ø–∏—Å–∞—Ç—å** roadmap v1 ‚Üí v2
- [ ] **–î–æ–±–∞–≤–∏—Ç—å** –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üéØ Acceptance Criteria (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞)

### AC-1: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

- **GIVEN**: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ telegram-bot
- **WHEN**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ client support
- **THEN**:
  - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Function-based Command Handler Pattern
  - ‚úÖ –ù–ï –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª–∞—Å—Å—ã/—Å–µ—Ä–≤–∏—Å—ã
  - ‚úÖ –°–ª–µ–¥—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º naming conventions
  - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `createEnvironmentLogger`, `gracefulHandler`

### AC-2: –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- **GIVEN**: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
- **WHEN**: –û–ø–µ—Ä–∞—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `/login`, `/takeorder`, `/orders`
- **THEN**:
  - ‚úÖ –ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
  - ‚úÖ –ù–µ—Ç breaking changes
  - ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

### AC-3: Type Safety

- **GIVEN**: TypeScript strict mode
- **WHEN**: –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
- **THEN**:
  - ‚úÖ –ù–µ—Ç TypeScript –æ—à–∏–±–æ–∫
  - ‚úÖ –í—Å–µ —Ç–∏–ø—ã –≤—ã–≤–µ–¥–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
  - ‚úÖ `BotSession` backward compatible

### AC-4: Clean Architecture Compliance

- **GIVEN**: –°–ª–æ–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- **WHEN**: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- **THEN**:
  - ‚úÖ –ù–µ –Ω–∞—Ä—É—à–µ–Ω—ã boundaries –º–µ–∂–¥—É —Å–ª–æ—è–º–∏
  - ‚úÖ Dependency flow —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
  - ‚úÖ –ù–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### AC-5: Design Patterns Alignment

- **GIVEN**: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–µ–∫—Ç–∞
- **WHEN**: –†–µ–≤—å—é –∫–æ–¥–∞
- **THEN**:
  - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ –∂–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (Function-based handlers)
  - ‚úÖ –ù–ï –∏–∑–æ–±—Ä–µ—Ç–µ–Ω—ã –Ω–æ–≤—ã–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã
  - ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã

---

## üöÄ Roadmap: v1.0 ‚Üí v2.0

### v1.0 (MVP) ‚Äî –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–°—Ä–æ–∫**: 2-3 –¥–Ω—è  
**–§–æ–∫—É—Å**: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å + –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

- ‚úÖ Function-based handlers –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ operator/client —á–µ—Ä–µ–∑ `getUserType()`
- ‚úÖ Broadcast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º
- ‚úÖ Manual operator replies
- ‚ùå –ù–µ—Ç persistence
- ‚ùå –ù–µ—Ç threading

**Technical Debt**:

- In-memory sessions
- No conversation history
- Broadcast –≤—Å–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º

### v1.5 (Reply Mechanism) ‚Äî UX —É–ª—É—á—à–µ–Ω–∏–µ

**–°—Ä–æ–∫**: +3-5 –¥–Ω–µ–π  
**–§–æ–∫—É—Å**: Reply threading –±–µ–∑ –ë–î

- ‚úÖ `message_id` tracking
- ‚úÖ Reply-to-message support
- ‚úÖ `Map<messageId, conversation>` state
- ‚ùå Still no persistence

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ**:

```typescript
// State extension (in-memory)
const conversationMap = new Map<
  number,
  {
    clientChatId: number;
    operatorChatId: number;
    lastMessageId: number;
  }
>();
```

### v2.0 (Full System) ‚Äî Production-ready

**–°—Ä–æ–∫**: +2 –Ω–µ–¥–µ–ª–∏  
**–§–æ–∫—É—Å**: Persistence + admin UI

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:

1. **Prisma schema extension**:
   - `SupportTicket`, `SupportMessage` models
   - –°–≤—è–∑—å —Å `User` —á–µ—Ä–µ–∑ `telegramId`

2. **tRPC router extension**:
   - `supportRouter.createTicket`
   - `supportRouter.sendMessage`
   - `supportRouter.getTickets`

3. **Session management migration**:

   ```typescript
   // Redis-backed sessions
   const telegramSessionManager = await UserManagerFactory.createForContext('telegram');
   ```

4. **Admin Panel UI**:
   - –°–ø–∏—Å–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤
   - Conversation view
   - Operator assignment

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è v2**:

- Repository Pattern –¥–ª—è —Ç–∏–∫–µ—Ç–æ–≤
- Service Layer –¥–ª—è business logic
- tRPC procedures –¥–ª—è API

---

## üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –∏–∑—É—á–µ–Ω–∏—é

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (–ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã)

1. **–ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é**:
   - `docs/core/ARCHITECTURE.md` ‚Äî –æ–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
   - `docs/core/SESSION_ARCHITECTURE.md` ‚Äî session patterns
   - `docs/analysis/ARCHITECTURE_ANALYSIS_ORDER_SYSTEM.md` ‚Äî design patterns

2. **–ò–∑—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥**:
   - `apps/telegram-bot/src/lib/telegram-bot.ts` ‚Äî –≤—Å–µ handler-—Ñ—É–Ω–∫—Ü–∏–∏
   - `apps/telegram-bot/pages/api/notify-operators.ts` ‚Äî –º–µ—Ö–∞–Ω–∏–∑–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   - `packages/constants/src/telegram.ts` ‚Äî message templates

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã**:
   - `packages/utils/src/graceful-handler.ts` ‚Äî error handling
   - `packages/utils/src/logger.ts` ‚Äî logging pattern
   - `apps/web/src/server/trpc/routers/telegram-bot.ts` ‚Äî API integration

### –î–ª—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–∞ (—Ä–µ–≤—å—é –∫–æ–¥–∞)

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å**:

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –ù–ï –∫–ª–∞—Å—Å—ã
2. ‚úÖ –°–ª–µ–¥—É–µ—Ç naming conventions
3. ‚úÖ `gracefulHandler` –≤–µ–∑–¥–µ
4. ‚úÖ `createEnvironmentLogger` –¥–ª—è –ª–æ–≥–æ–≤
5. ‚úÖ TypeScript strict mode compliance
6. ‚úÖ –ù–µ—Ç breaking changes –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
7. ‚úÖ Constants –≤ `@repo/constants`
8. ‚úÖ Types –≤ `types.ts`

**–ó–∞–ø—Ä–µ—Ç–∏—Ç—å**:

1. ‚ùå –ù–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã/—Å–µ—Ä–≤–∏—Å—ã
2. ‚ùå –ù–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã –≤ `packages/`
3. ‚ùå Breaking changes –≤ `BotSession`
4. ‚ùå –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö handler-—Ñ—É–Ω–∫—Ü–∏–π (—Ç–æ–ª—å–∫–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)
5. ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ `notify-operators.ts`

---

## üéì –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ì–ª–∞–≤–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –≤—ã–≤–æ–¥

**–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ Clean Architecture** ‚Äî –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —á–∏—Å—Ç–æ—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ —Å–∫–æ—Ä–æ—Å—Ç—å—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏. Telegram bot –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **Function-based Command Handler Pattern** –±–µ–∑ –∏–∑–ª–∏—à–Ω–∏—Ö –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π.

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è Client Support** –¥–æ–ª–∂–Ω–æ —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–æ–º—É –ø–æ–¥—Ö–æ–¥—É: –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π, –ù–ï —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Å–ª–æ–µ–≤.

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤

#### ‚ùå –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 1: –ö–ª–∞—Å—Å—ã –¥–ª—è –∫–æ–º–∞–Ω–¥ (Command Pattern)

```typescript
// ‚ùå –ü–õ–û–•–û ‚Äî –Ω–µ —Å–ª–µ–¥—É–µ—Ç –ø—Ä–æ–µ–∫—Ç—É
class ClientStartCommand implements ICommand {
  execute(update: TelegramUpdate): string { ... }
}
```

**–ü–æ—á–µ–º—É –Ω–µ—Ç**:

- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ
- –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –±–æ—Ç–∞
- –£—Å–ª–æ–∂–Ω–∏—Ç –∫–æ–¥–æ–≤—É—é –±–∞–∑—É

#### ‚ùå –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 2: –û—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å

```typescript
// ‚ùå –ü–õ–û–•–û ‚Äî –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
class ClientSupportService {
  handleMessage() { ... }
  notifyOperators() { ... } // –î–£–ë–õ–ò–†–£–ï–¢ notify-operators.ts
}
```

**–ü–æ—á–µ–º—É –Ω–µ—Ç**:

- –î—É–±–ª–∏—Ä—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
- –ù–∞—Ä—É—à–∞–µ—Ç DRY principle
- –°–æ–∑–¥–∞–µ—Ç Technical Debt

#### ‚úÖ –í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: Function-based Extension

```typescript
// ‚úÖ –•–û–†–û–®–û ‚Äî —Å–ª–µ–¥—É–µ—Ç –ø—Ä–æ–µ–∫—Ç—É
function handleClientStart(update: TelegramUpdate): string { ... }
function handleClientMessage(update: TelegramUpdate): Promise<string> { ... }
```

**–ü–æ—á–µ–º—É –¥–∞**:

- –°–ª–µ–¥—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

### –§–∏–Ω–∞–ª—å–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–°–ª–µ–¥–æ–≤–∞—Ç—å Function-based Pattern** ‚Äî –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–ª–∞—Å—Å—ã
2. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã** ‚Äî `notify-operators.ts`, `gracefulHandler`, `logger`
3. **Minimal changes principle** ‚Äî —Ä–∞—Å—à–∏—Ä—è—Ç—å, –ù–ï –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å
4. **Technical Debt acceptance** ‚Äî in-memory sessions –¥–ª—è v1 ‚Äî —ç—Ç–æ –û–ö
5. **Roadmap –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî v1 ‚Üí v1.5 ‚Üí v2.0 —Å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–º —É–ª—É—á—à–µ–Ω–∏–µ–º
6. **Documentation first** ‚Äî –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è v1

---

**–ö–æ–Ω–µ—Ü –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ –ø–ª–∞–Ω–∞**

**–í–∞–∂–Ω–æ**: –≠—Ç–æ—Ç –ø–ª–∞–Ω –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ **100% —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–º –∞–Ω–∞–ª–∏–∑–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞**. –í—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤ –∫–æ–¥–µ, –≤—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ. –†–µ—à–µ–Ω–∏–µ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –¥–æ–ª–≥–æ–º –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å—é.
