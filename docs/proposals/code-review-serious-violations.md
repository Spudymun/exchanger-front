# Code Review: –°–µ—Ä—å–µ–∑–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 16 –æ–∫—Ç—è–±—Ä—è 2025  
**Reviewer:** AI Senior Code Reviewer  
**Scope:** –í—Å–µ –∫–æ–¥–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–∑ git status

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–∞:**

1. –ó–∞–ø—É—Ç–∞–Ω–Ω–æ—Å—Ç—å –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–¥–∞
2. –ù–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
3. –°–µ—Ä—å–µ–∑–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤
4. –ù–∞—Ä—É—à–µ–Ω–∏–µ SOLID, DRY, KISS
5. –ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é

---

## üìã –°—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞

- [x] –ù–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏–∑–∞
- [x] –§–∞–π–ª—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã: 23 —Ñ–∞–π–ª–∞
- [ ] –û—Ç—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω

---

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ó–∞–ø—É—Ç–∞–Ω–Ω–æ—Å—Ç—å –∏ –∏–∑–ª–∏—à–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å

#### 1. `apps/web/src/server/trpc/routers/exchange.ts` - –ß—Ä–µ–∑–º–µ—Ä–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ —Ä–∞–∑–¥—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç 1051 —Å—Ç—Ä–æ–∫—É —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º helper —Ñ—É–Ω–∫—Ü–∏–π, –∑–∞–ø—É—Ç–∞–Ω–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π –∏ –ø–ª–æ—Ö–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

**–î–µ—Ç–∞–ª–∏:**

- –§—É–Ω–∫—Ü–∏—è `createOrderInSystem` –∏–º–µ–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Ü–µ–ø–æ—á–∫—É –≤—ã–∑–æ–≤–æ–≤
- –°–º–µ—à–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ —Å HTTP –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ try-catch –±–ª–æ–∫–∏
- Helper —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å–∫–∏–¥–∞–Ω—ã –ø–æ —Ñ–∞–π–ª—É –±–µ–∑ —á–µ—Ç–∫–æ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –í—ã–¥–µ–ª–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π service —Å–ª–æ–π (`OrderCreationService`)
- –†–∞–∑–±–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–æ—É—Ç–µ—Ä–æ–≤ –ø–æ –¥–æ–º–µ–Ω–∞–º: `order-creation.ts`, `order-query.ts`, `rates.ts`
- –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å helper —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `utils/order-helpers.ts`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Command Pattern –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í–´–°–û–ö–ò–ô

---

#### 2. `apps/telegram-bot/pages/api/notify-operators.ts` - –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** 655 —Å—Ç—Ä–æ–∫ —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

**–î–µ—Ç–∞–ª–∏:**

- –§—É–Ω–∫—Ü–∏—è `validatePayload` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–∂–Ω—ã–µ —É—Å–ª–æ–≤–Ω—ã–µ –≤–µ—Ç–≤–ª–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 44-126)
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö `notificationType` –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç –¥–ª—è —Ç–∏–ø–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –°–º–µ—à–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Strategy Pattern –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
- –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ validator –∫–ª–∞—Å—Å—ã: `NewOrderValidator`, `ManualRateValidator`, `CancelledOrderValidator`
- –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ `@repo/utils/validation/telegram-payload-validators.ts`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô

---

#### 3. `packages/exchange-core/src/services/smart-pricing-service.ts` - –°–ª–æ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ fallback'–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** 600+ —Å—Ç—Ä–æ–∫ —Å –∑–∞–ø—É—Ç–∞–Ω–Ω–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–µ–π –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ fallback –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏.

**–î–µ—Ç–∞–ª–∏:**

- –ú–µ—Ç–æ–¥ `getSafeExchangeRate` –∏–º–µ–µ—Ç 4 —É—Ä–æ–≤–Ω—è fallback (API ‚Üí Cache ‚Üí Manual DB ‚Üí Static)
- –°–º–µ—à–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è, API –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ fallback'–æ–≤
- static –∫–µ—à –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–ª–∞—Å—Å–∞ —Å–æ–∑–¥–∞–µ—Ç —Å–∫—Ä—ã—Ç—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–æ –ø–æ –≤—Å–µ–º –º–µ—Ç–æ–¥–∞–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –ü—Ä–∏–º–µ–Ω–∏—Ç—å Chain of Responsibility Pattern –¥–ª—è fallback –∏–µ—Ä–∞—Ä—Ö–∏–∏
- –í—ã–Ω–µ—Å—Ç–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π `RateCacheManager`
- –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ provider –∫–ª–∞—Å—Å—ã: `BinanceProvider`, `ManualDbProvider`, `StaticFallbackProvider`
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ interceptor

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –í–´–°–û–ö–ò–ô

---

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ù–∞—Ä—É—à–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤

#### 4. `apps/web/src/components/exchange/ExchangeContainer.tsx` - –ù–∞—Ä—É—à–µ–Ω–∏–µ Single Responsibility

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–æ–≤–º–µ—â–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–µ–π.

**–î–µ—Ç–∞–ª–∏:**

- –°–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 176-198)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Ñ–æ—Ä–º—ã
- HTTP –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ tRPC
- –ù–∞–≤–∏–≥–∞—Ü–∏—é –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- –í–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –í—ã–Ω–µ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç—ã –≤ `useExchangeCalculations` hook
- –õ–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ `useOrderCreation` hook
- –ù–∞–≤–∏–≥–∞—Ü–∏—é –≤ `useOrderNavigation` hook
- –û—Å—Ç–∞–≤–∏—Ç—å –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ —Ç–æ–ª—å–∫–æ UI –∫–æ–º–ø–æ–∑–∏—Ü–∏—é

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô

---

#### 5. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–Ω–∫–∞–º–∏

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**

- `apps/web/src/components/exchange/ExchangeLayout.tsx` (—Å—Ç—Ä–æ–∫–∏ 115-120)
- `apps/web/src/components/hero-exchange/SendingCard.tsx` (—Å—Ç—Ä–æ–∫–∏ 20-30)
- `apps/web/src/hooks/useDefaultBank.ts` (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ `useBanksForCurrency` –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ `@repo/hooks/src/business/useBankSelection.ts`
- –°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π hook `useBankSelector` —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º default bank selection

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–ò–ó–ö–ò–ô (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

---

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ü—Ä–æ–±–ª–µ–º—ã —Å —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π

#### 6. Type Casting Hell –≤ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**

- `apps/web/src/components/exchange/ExchangeLayout.tsx` (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ `as unknown as UseFormReturn<Record<string, unknown>>`)
- `apps/web/src/components/hero-exchange/SendingCard.tsx` (—Ç–µ –∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ —á–µ—Ä–µ–∑ `unknown` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π —Ç–∏–ø–æ–≤.

**–î–µ—Ç–∞–ª–∏:**

```typescript
form={form as unknown as UseFormReturn<Record<string, unknown>>}
```

–¢–∞–∫–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è 10+ —Ä–∞–∑ –≤ –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –°–æ–∑–¥–∞—Ç—å generic —Ç–∏–ø—ã –¥–ª—è form props: `FormWithValues<T>`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å utility types –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –∏–∑ form
- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –±–µ–∑ casting

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô

---

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ù–∞—Ä—É—à–µ–Ω–∏–µ DRY –ø—Ä–∏–Ω—Ü–∏–ø–∞

#### 7. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**

- `apps/web/src/components/hero-exchange/useHeroExchangeForm.ts` (—Å—Ç—Ä–æ–∫–∏ 30-50)
- `apps/web/src/components/exchange/ExchangeContainer.tsx` (—Å—Ç—Ä–æ–∫–∏ 176-198)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ `calculatedAmount` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `useExchangeRates`.

**–û–±–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞:**

```typescript
const { data: ratesData } = useExchangeRates();
const currentRate = ratesData?.rates?.find(r => r.currency === fromCurrency);
const grossAmount = amount * currentRate.uahRate;
const netAmount = calculateNetAmount(grossAmount, currentRate.commission);
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π hook `useAmountCalculation(fromAmount, fromCurrency)`
- –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ `@repo/hooks/src/business/useAmountCalculation.ts`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô

---

#### 8. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ `handleCurrencyChange`

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**

- `apps/web/src/components/exchange/ExchangeLayout.tsx` (—Å—Ç—Ä–æ–∫–∏ 72-79)
- `apps/web/src/components/hero-exchange/SendingCard.tsx` (—Å—Ç—Ä–æ–∫–∏ 38-44)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É–º–º—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∞–ª—é—Ç—ã.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –í—ã–Ω–µ—Å—Ç–∏ –≤ `@repo/ui/src/components/exchange/shared-handlers.ts`
- –ò–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `CryptoCurrencySelector` –∫–∞–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ª–æ–≥–∏–∫—É

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –ù–ò–ó–ö–ò–ô

---

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è: Performance issues

#### 9. `packages/exchange-core/src/services/smart-pricing-service.ts` - –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫–µ—à

**–ü—Ä–æ–±–ª–µ–º–∞:** static –∫–µ—à —Å —Ä—É—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º TTL –≤–º–µ—Å—Ç–æ –≥–æ—Ç–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π.

**–î–µ—Ç–∞–ª–∏:**

- –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `isCacheFresh`, `isCacheStale` (—Å—Ç—Ä–æ–∫–∏ 132-148)
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤–∞–ª—é—Ç
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ LRU eviction policy

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `lru-cache` –∏–ª–∏ `node-cache`
- –ò–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å Redis –µ—Å–ª–∏ –æ–Ω —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ cache hit/miss rate

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô

---

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è: Security concerns

#### 10. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è Telegram Webhook Signature + Production Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** üîê

**–§–∞–π–ª**: `apps/telegram-bot/pages/api/webhook.ts` (—Å—Ç—Ä–æ–∫–∏ 625-671)

**–ü—Ä–æ–±–ª–µ–º–∞ 1:** Endpoint `/api/webhook` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ `X-Telegram-Bot-Api-Secret-Token` header.

**–ü—Ä–æ–±–ª–µ–º–∞ 2:** –í production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ telegram-bot –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –≤–Ω—É—Ç—Ä–∏ Docker network –±–µ–∑ exposed –ø–æ—Ä—Ç–æ–≤, –ø–æ—ç—Ç–æ–º—É Telegram API –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å webhook –Ω–∞–ø—Ä—è–º—É—é.

**–î–µ—Ç–∞–ª–∏:**

```typescript
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    res.status(HTTP_STATUS.METHOD_NOT_ALLOWED).json({ error: 'Method not allowed' });
    return;
  }

  // ‚ùå –ù–ï–¢ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ secret_token –∏–∑ Telegram webhook
  const update = req.body as TelegramUpdate;
  const responseMessage = await handleTelegramUpdate(update);
  // ...
}
```

**Docker Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

```yaml
# docker-compose.production.yml
telegram-bot:
  # –ë–ï–ó –ø–æ—Ä—Ç–æ–≤ - –ø–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è ‚ùå
  # Telegram API –ù–ï –ú–û–ñ–ï–¢ –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è!
  networks:
    - exchanger-network
```

**–†–∏—Å–∫:**

- –õ—é–±–æ–π –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–µ–π–∫–æ–≤—ã–µ webhook —Å –ø–æ–¥–¥–µ–ª—å–Ω—ã–º–∏ `callback_query` –∏–ª–∏ `message`
- –í–æ–∑–º–æ–∂–Ω—ã –∞—Ç–∞–∫–∏ —Ç–∏–ø–∞ Replay Attack (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö callback'–æ–≤)
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ—Ç–º–µ–Ω—ã –∑–∞—è–≤–æ–∫ –æ—Ç –∏–º–µ–Ω–∏ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
- DoS –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑ –º–∞—Å—Å–æ–≤—ã–µ —Ñ–µ–π–∫–æ–≤—ã–µ webhook'–∏
- **Production webhook –≤–æ–æ–±—â–µ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å** (Telegram API –Ω–µ –¥–æ—Å—Ç—É—á–∏—Ç—Å—è)

**–ö–æ–Ω—Ç–µ–∫—Å—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**

- ‚úÖ `notify-operators.ts` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π endpoint (Docker network), –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞
- ‚ùå `webhook.ts` - **–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ** –¥–ª—è Telegram API, –Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –≤ production

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

–°–æ–∑–¥–∞—Ç—å Reverse Proxy —á–µ—Ä–µ–∑ web service (—Å–º. `docs/PRODUCTION_WEBHOOK_ARCHITECTURE.md`):

```typescript
// ‚úÖ –ù–û–í–´–ô –§–ê–ô–õ: apps/web/pages/api/telegram/webhook.ts
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è secret_token –æ—Ç Telegram
  const secretToken = req.headers['x-telegram-bot-api-secret-token'];

  if (secretToken !== process.env.TELEGRAM_WEBHOOK_SECRET) {
    logger.warn('Invalid webhook secret token');
    return res.status(HTTP_STATUS.UNAUTHORIZED).json({ error: 'Unauthorized' });
  }

  // –ü—Ä–æ–∫—Å–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ telegram-bot (internal)
  const response = await fetch(`${process.env.TELEGRAM_BOT_URL}/api/webhook`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(req.body),
  });

  return res.status(response.status).json(await response.json());
}
```

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

```
Telegram API ‚Üí web:3000/api/telegram/webhook ‚Üí telegram-bot:3003/api/webhook
             (exposed, with auth)          (internal, no ports)
```

**Setup webhook —Å secret_token:**

```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
node scripts/telegram-bot/setup-webhook.mjs --env=prod
```

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**

- https://core.telegram.org/bots/api#setwebhook
- `docs/PRODUCTION_WEBHOOK_ARCHITECTURE.md` (–ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô (–±–ª–æ–∫–∏—Ä—É–µ—Ç production deployment)

---

### –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

#### 11. `apps/web/src/server/trpc/context.ts` - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ await –≤ context

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–∑–¥–∞–Ω–∏–µ context –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö async –æ–ø–µ—Ä–∞—Ü–∏—è—Ö.

**–î–µ—Ç–∞–ª–∏:**

```typescript
// –°—Ç—Ä–æ–∫–∏ 61-69
if (sessionId) {
  try {
    const userManager = await UserManagerFactory.createForWeb();
    const foundUser = await userManager.findBySessionId(sessionId);
    user = foundUser || null;
  } catch (error) {
    console.error('Session validation error:', error);
  }
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- –í—ã–Ω–µ—Å—Ç–∏ session –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ middleware
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LazyPromise –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ user
- –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å `UserManagerFactory` instance

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

- üî¥ **–í–´–°–û–ö–ò–ô**: 3 –ø—Ä–æ–±–ª–µ–º—ã
- üü° **–°–†–ï–î–ù–ò–ô**: 6 –ø—Ä–æ–±–ª–µ–º
- üü¢ **–ù–ò–ó–ö–ò–ô**: 2 –ø—Ä–æ–±–ª–µ–º—ã

**–ò—Ç–æ–≥–æ:** 11 —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏

1. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):**
   - #10 - Security: –≤–∫–ª—é—á–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ Telegram API
   - #1 - –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ exchange router (–±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ)
   - #3 - –£–ø—Ä–æ—â–µ–Ω–∏–µ SmartPricingService (–∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É)

2. **–í–∞–∂–Ω—ã–µ (—Å–ª–µ–¥—É—é—â–∏–π —Å–ø—Ä–∏–Ω—Ç):**
   - #6 - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ (technical debt)
   - #7 - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–æ–≤
   - #9 - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–µ—à–∞ –∫—É—Ä—Å–æ–≤

3. **–ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ (backlog):**
   - #5, #8 - –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
   - #2, #4, #11 - –£–ª—É—á—à–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

---
