# üîç –û–¢–ß–ï–¢ –û–ë –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ò: –õ–æ–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏ –∑–∞—è–≤–∫–∏ —á–µ—Ä–µ–∑ Telegram

**–î–∞—Ç–∞**: 8 –æ–∫—Ç—è–±—Ä—è 2025  
**–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å**: AI Agent  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê –ò –ó–ê–î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–ù–ê

---

## üìã EXECUTIVE SUMMARY

### –ü—Ä–æ–±–ª–µ–º–∞
–û–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç –≤ Telegram **—É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** –æ –≤–∑—è—Ç–∏–∏ –∑–∞—è–≤–∫–∏ –≤ —Ä–∞–±–æ—Ç—É, —Ö–æ—Ç—è –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–∞—è–≤–∫–∞ **–ù–ï –±—ã–ª–∞ –≤–∑—è—Ç–∞** –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

### –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å
üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø** - –û–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ª–æ–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:
- –ü–æ—Ç–µ—Ä–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- –ù–µ–≤–µ—Ä–Ω–æ–º—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –∑–∞—è–≤–æ–∫
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∑–∞—è–≤–æ–∫

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ tRPC —Ä–æ—É—Ç–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π **–≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `success: true`** –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

---

## üî¨ –î–ï–¢–ê–õ–¨–ù–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï

### 1. –•–†–û–ù–û–õ–û–ì–ò–Ø –°–û–ë–´–¢–ò–ô (–∏–∑ –ª–æ–≥–æ–≤)

#### Web Application (apps/web) - –ë–î —É—Ä–æ–≤–µ–Ω—å:
```
2025-10-08T15:18:26.231Z DEBUG ORDER_FOUND_FOR_TELEGRAM
{
  "orderId": "fe1d2eb5-b80b-426d-9435-4b6695106e59",
  "currentStatus": "paid"  // ‚úÖ –ó–∞—è–≤–∫–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ PAID
}

2025-10-08T15:18:26.232Z INFO Assigning order to operator with concurrent protection

prisma:query UPDATE "public"."orders" SET ... WHERE (... AND "status" = 'PENDING' ...)
prisma:query ROLLBACK

prisma:error Invalid `prisma.order.update()` invocation:
An operation failed because it depends on one or more records that were required but not found.

2025-10-08T15:18:26.249Z WARN Concurrent assignment attempt detected
{
  "reason": "Order already assigned or not in PENDING/PAID status"
}

2025-10-08T15:18:26.249Z INFO ORDER_ASSIGNED_VIA_TELEGRAM  // ‚ùå –õ–û–ñ–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ!
{
  "orderId": "fe1d2eb5-b80b-426d-9435-4b6695106e59",
  "telegramOperatorId": "621882329",
  "success": true  // ‚ùå –õ–û–ñ–ù–´–ô success
}
```

#### Telegram Bot (apps/telegram-bot):
```
2025-10-08T15:18:26.255Z DEBUG TELEGRAM_TAKE_ORDER_API_RESULT
{
  "orderId": "fe1d2eb5-b80b-426d-9435-4b6695106e59",
  "success": false,  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª –æ—à–∏–±–∫—É
  "hasOrder": false
}

2025-10-08T15:18:26.256Z WARN TELEGRAM_TAKE_ORDER_FAILED
{
  "result": "{\"success\":true}"  // ‚ùå –ù–û –ø–æ–ª—É—á–∏–ª success: true –æ—Ç API!
}

2025-10-08T15:18:26.256Z DEBUG TELEGRAM_TAKE_ORDER_ERROR_RESPONSE
{
  "messageLength": 162  // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
}

2025-10-08T15:18:26.570Z INFO Order message updated  // ‚ùå –ù–û –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞!
{
  "orderId": "fe1d2eb5-b80b-426d-9435-4b6695106e59",
  "chatId": 621882329
}
```

### 2. –ê–ù–ê–õ–ò–ó –ö–û–î–û–í–û–ô –ë–ê–ó–´

#### üî¥ –ü–†–û–ë–õ–ï–ú–ê #1: telegram-bot-router.ts (apps/web)

**–§–∞–π–ª**: `apps/web/src/server/trpc/routers/telegram-bot.ts`  
**–°—Ç—Ä–æ–∫–∞**: 100

```typescript
// ‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç success: true
const updatedOrder = await orderManager.assignToOperator(input.orderId, operator.id);

logger.info('ORDER_ASSIGNED_VIA_TELEGRAM', {
  orderId: input.orderId,
  telegramOperatorId: input.telegramOperatorId,
  operatorId: operator.id,
  newStatus: updatedOrder?.status,  // –º–æ–∂–µ—Ç –±—ã—Ç—å undefined!
  assignedAt: updatedOrder?.assignedAt?.toISOString(),
});

return { success: true, order: updatedOrder };  // ‚ùå –í–°–ï–ì–î–ê success: true
```

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- `orderManager.assignToOperator` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Order | undefined`
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `undefined`
- –ù–û —Ä–æ—É—Ç–µ—Ä **–í–°–ï–ì–î–ê** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `success: true`, –¥–∞–∂–µ –∫–æ–≥–¥–∞ `updatedOrder === undefined`

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∏–∑ –∫–æ–¥–∞**:
```typescript
// packages/exchange-core/src/data/manager.ts, —Å—Ç—Ä–æ–∫–∞ 191
assignToOperator: async (orderId: string, operatorId: string): Promise<Order | undefined> => {
  const repo = await getOrderRepository();
  if (!repo) throw new Error(REPO_ERROR_MESSAGE);
  const order = await repo.assignToOperator(orderId, operatorId);
  return order || undefined;  // ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç undefined –ø—Ä–∏ –æ—à–∏–±–∫–µ
},
```

```typescript
// packages/session-management/src/adapters/postgres-order-adapter.ts, —Å—Ç—Ä–æ–∫–∞ 232
private handleAssignmentError(error: unknown, orderId: string, operatorId: string): Order | null {
  if (error instanceof Error && 'code' in error && error.code === 'P2025') {
    this.logger.warn('Concurrent assignment attempt detected', {
      orderId,
      operatorId,
      reason: 'Order already assigned or not in PENDING/PAID status',
    });
    return null;  // ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç null –ø—Ä–∏ –æ—à–∏–±–∫–µ
  }
  // ...
  return null;
}
```

#### üî¥ –ü–†–û–ë–õ–ï–ú–ê #2: webhook.ts (apps/telegram-bot)

**–§–∞–π–ª**: `apps/telegram-bot/pages/api/webhook.ts`  
**–°—Ç—Ä–æ–∫–∞**: 67-92

```typescript
// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –í–°–ï–ì–î–ê, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É—Å–ø–µ—Ö–∞
async function handleCallbackQueryResponse(
  callbackQuery: NonNullable<TelegramUpdate['callback_query']>,
  responseMessage: string | null
): Promise<void> {
  try {
    // –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ callback query
    await fetch(/* answerCallbackQuery */);

    // ‚ùå –ï—Å–ª–∏ —ç—Ç–æ –≤–∑—è—Ç–∏–µ –∑–∞—è–≤–∫–∏ - –æ–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if (callbackQuery.data?.startsWith('take_order_') && callbackQuery.message) {
      const orderId = callbackQuery.data.replace('take_order_', '');
      const originalText = callbackQuery.message.text || '';
      const updatedText = `${originalText}\n\n‚úÖ **–ó–∞—è–≤–∫–∞ –≤–∑—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É...**`;

      // ‚ùå –ö–ù–û–ü–ö–ò –£–î–ê–õ–Ø–Æ–¢–°–Ø –í–°–ï–ì–î–ê, –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ!
      await fetch(/* editMessageText */, {
        body: JSON.stringify({
          // ...
          reply_markup: { inline_keyboard: [] }, // ‚ùå –£–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫–∏
        }),
      });

      logger.info('Order message updated', { orderId, chatId: callbackQuery.message.chat.id });
    }
  }
  // ...
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–ù–ï–ó–ê–í–ò–°–ò–ú–û** –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ `responseMessage` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏
- –°–æ–∑–¥–∞—ë—Ç—Å—è –∏–ª–ª—é–∑–∏—è —É—Å–ø–µ—Ö–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê: telegram-bot.ts

**–§–∞–π–ª**: `apps/telegram-bot/src/lib/telegram-bot.ts`  
**–°—Ç—Ä–æ–∫–∞**: 266-299

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ result?.order
logger.debug('TELEGRAM_TAKE_ORDER_API_RESULT', {
  orderId,
  success: !!result?.order,  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  hasOrder: !!result?.order,
});

if (result?.order) {  // ‚úÖ –£—Å–ª–æ–≤–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –Ω–∞–ª–∏—á–∏–∏ order
  // ... –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
  return successMessage;
} else {
  logger.warn('TELEGRAM_TAKE_ORDER_FAILED', { /* ... */ });
  
  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  const errorMessage = (
    `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å –∑–∞—è–≤–∫—É\n\n` +
    `–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n` +
    `‚Ä¢ –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\n` +
    `‚Ä¢ –ó–∞—è–≤–∫–∞ —É–∂–µ –≤–∑—è—Ç–∞ –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º\n` +
    `‚Ä¢ –°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞`
  );
  
  return errorMessage;  // ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
}
```

**–ù–û**: –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, `webhook.ts` –≤—Å—ë —Ä–∞–≤–Ω–æ —É–¥–∞–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏!

---

## üéØ –ö–û–†–ù–ï–í–´–ï –ü–†–ò–ß–ò–ù–´

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ tRPC —Ä–æ—É—Ç–µ—Ä–µ
**–§–∞–π–ª**: `apps/web/src/server/trpc/routers/telegram-bot.ts`

```typescript
// ‚ùå –ë–´–õ–û:
return { success: true, order: updatedOrder };

// ‚úÖ –î–û–õ–ñ–ù–û –ë–´–¢–¨:
return { 
  success: !!updatedOrder, 
  order: updatedOrder 
};
```

### 2. –ë–µ–∑—É—Å–ª–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ webhook handler
**–§–∞–π–ª**: `apps/telegram-bot/pages/api/webhook.ts`

```typescript
// ‚ùå –ë–´–õ–û:
if (callbackQuery.data?.startsWith('take_order_')) {
  // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
}

// ‚úÖ –î–û–õ–ñ–ù–û –ë–´–¢–¨:
if (callbackQuery.data?.startsWith('take_order_') && wasSuccessful) {
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
}
```

### 3. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `ORDER_ASSIGNED_VIA_TELEGRAM` –¥–∞–∂–µ –∫–æ–≥–¥–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å.

---

## üìä –í–õ–ò–Ø–ù–ò–ï –ù–ê –°–ò–°–¢–ï–ú–£

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
1. ‚úÖ `apps/web/src/server/trpc/routers/telegram-bot.ts` - tRPC —Ä–æ—É—Ç–µ—Ä
2. ‚úÖ `apps/telegram-bot/pages/api/webhook.ts` - Webhook handler
3. ‚úÖ `apps/telegram-bot/src/lib/telegram-bot.ts` - Bot logic (—á–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
4. ‚úÖ `packages/session-management/src/adapters/postgres-order-adapter.ts` - –ë–î –∞–¥–∞–ø—Ç–µ—Ä (—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è:
- ‚úÖ –ó–∞—è–≤–∫–∞ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å—Ç–∞—Ç—É—Å–µ (–Ω–µ PENDING/PAID)
- ‚úÖ –ó–∞—è–≤–∫–∞ —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥—Ä—É–≥–æ–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
- ‚úÖ –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
- ‚úÖ –û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- ‚úÖ –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –º–µ–∂–¥—É telegram-bot –∏ web

---

## üí° –°–ï–ù–¨–û–†–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´

#### 1. **Explicit Error Handling Pattern**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω —è–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –Ω–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ:

```typescript
// –£—Ä–æ–≤–µ–Ω—å –ë–î –∞–¥–∞–ø—Ç–µ—Ä–∞
async assignToOperator(orderId: string, operatorId: string): Promise<Result<Order, AssignmentError>> {
  try {
    const order = await this.prisma.order.update(/* ... */);
    return { success: true, data: order };
  } catch (error) {
    return { 
      success: false, 
      error: {
        code: 'ASSIGNMENT_FAILED',
        reason: this.parseErrorReason(error),
        recoverable: true
      }
    };
  }
}

// –£—Ä–æ–≤–µ–Ω—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
async assignToOperator(orderId: string, operatorId: string): Promise<Result<Order, AssignmentError>> {
  const result = await repo.assignToOperator(orderId, operatorId);
  
  if (!result.success) {
    logger.warn('Assignment failed', result.error);
  }
  
  return result;
}

// –£—Ä–æ–≤–µ–Ω—å API
.mutation(async ({ input }) => {
  const result = await orderManager.assignToOperator(input.orderId, operator.id);
  
  return {
    success: result.success,
    order: result.success ? result.data : null,
    error: !result.success ? result.error : null
  };
});
```

#### 2. **Type-Safe Error Codes**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã –æ—à–∏–±–æ–∫:

```typescript
// packages/constants/src/errors.ts
export const ORDER_ASSIGNMENT_ERRORS = {
  ORDER_NOT_FOUND: 'ORDER_NOT_FOUND',
  INVALID_STATUS: 'INVALID_STATUS',
  ALREADY_ASSIGNED: 'ALREADY_ASSIGNED',
  OPERATOR_NOT_AUTHORIZED: 'OPERATOR_NOT_AUTHORIZED',
  DATABASE_ERROR: 'DATABASE_ERROR',
} as const;

export type OrderAssignmentError = keyof typeof ORDER_ASSIGNMENT_ERRORS;

export const ORDER_ASSIGNMENT_ERROR_MESSAGES: Record<OrderAssignmentError, string> = {
  ORDER_NOT_FOUND: '‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞',
  INVALID_STATUS: '‚ùå –ó–∞—è–≤–∫–∞ –≤ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–µ–º —Å—Ç–∞—Ç—É—Å–µ –¥–ª—è –≤–∑—è—Ç–∏—è –≤ —Ä–∞–±–æ—Ç—É',
  ALREADY_ASSIGNED: '‚ùå –ó–∞—è–≤–∫–∞ —É–∂–µ –≤–∑—è—Ç–∞ –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º',
  OPERATOR_NOT_AUTHORIZED: '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤–∑—è—Ç–∏—è –∑–∞—è–≤–æ–∫',
  DATABASE_ERROR: '‚ùå –°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
};
```

#### 3. **Conditional UI Updates**
–û–±–Ω–æ–≤–ª—è—Ç—å UI —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º —É—Å–ø–µ—Ö–µ:

```typescript
// apps/telegram-bot/pages/api/webhook.ts
async function handleCallbackQueryResponse(
  callbackQuery: NonNullable<TelegramUpdate['callback_query']>,
  responseMessage: string | null,
  operationSuccess: boolean  // ‚úÖ –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
): Promise<void> {
  await answerCallbackQuery(/* ... */);

  // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
  if (callbackQuery.data?.startsWith('take_order_') && operationSuccess) {
    await updateMessageWithSuccess(/* ... */);
  } else if (callbackQuery.data?.startsWith('take_order_') && !operationSuccess) {
    // –ö–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è, –æ–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
    await answerCallbackQuery({
      text: responseMessage || '–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞',
      show_alert: true  // ‚úÖ –ü–æ–∫–∞–∑–∞—Ç—å alert –≤–º–µ—Å—Ç–æ toast
    });
  }
}
```

#### 4. **Structured Logging**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —á–µ—Ç–∫–∏–º–∏ —É—Ä–æ–≤–Ω—è–º–∏:

```typescript
// ‚ùå –ë–´–õ–û:
logger.info('ORDER_ASSIGNED_VIA_TELEGRAM', { orderId, success: true });

// ‚úÖ –î–û–õ–ñ–ù–û –ë–´–¢–¨:
if (result.success) {
  logger.info('ORDER_ASSIGNED_VIA_TELEGRAM', {
    orderId,
    operatorId,
    status: result.data.status,
    assignedAt: result.data.assignedAt,
  });
} else {
  logger.error('ORDER_ASSIGNMENT_FAILED_VIA_TELEGRAM', {
    orderId,
    operatorId,
    errorCode: result.error.code,
    reason: result.error.reason,
    recoverable: result.error.recoverable,
  });
}
```

#### 5. **Operator Notification Strategy**

##### –ü—Ä–∏–Ω—Ü–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å** - –æ–ø–µ—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–†–ê–ó–£
2. **–Ø—Å–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç—É—Å–∞** - —á–µ—Ç–∫–æ–µ —Ä–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É success/error/warning
3. **Actionable –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** - —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ
4. **Persistent state** - –∫–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞

##### –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

```typescript
// 1. SUCCESS - –û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
{
  "message": "‚úÖ –ó–∞—è–≤–∫–∞ #12345 –≤–∑—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É",
  "messageUpdate": {
    "text": "Original text + ‚úÖ –í–∑—è—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º",
    "buttons": []  // –£–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫–∏
  },
  "alert": false
}

// 2. ERROR - –û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, recoverable
{
  "message": "‚ùå –ó–∞—è–≤–∫–∞ —É–∂–µ –≤–∑—è—Ç–∞ –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º",
  "messageUpdate": null,  // –ù–ï –æ–±–Ω–æ–≤–ª—è—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  "buttons": ["üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫"],  // –ö–Ω–æ–ø–∫–∏ –¥–ª—è recovery
  "alert": true  // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–∫ alert
}

// 3. WARNING - –ß–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö
{
  "message": "‚ö†Ô∏è –ó–∞—è–≤–∫–∞ –≤–∑—è—Ç–∞, –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",
  "messageUpdate": {
    "text": "Original text + ‚ö†Ô∏è –í–∑—è—Ç–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º",
    "buttons": ["üîî –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"]
  },
  "alert": false
}

// 4. INFO - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
{
  "message": "‚ÑπÔ∏è –ó–∞—è–≤–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º",
  "messageUpdate": null,
  "buttons": [],
  "alert": false
}
```

---

## üõ†Ô∏è –ö–û–ù–ö–†–ï–¢–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1: telegram-bot-router.ts

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

```typescript
// apps/web/src/server/trpc/routers/telegram-bot.ts

export const telegramBotRouter = createTRPCRouter({
  takeOrderByTelegram: systemApiMiddleware
    .input(
      z.object({
        orderId: z.string(),
        telegramOperatorId: z.string(),
      })
    )
    .mutation(async ({ input }) => {
      logger.info('TELEGRAM_TAKE_ORDER_REQUEST', {
        orderId: input.orderId,
        telegramOperatorId: input.telegramOperatorId,
      });

      try {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è telegram –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        const operator = await validateTelegramOperator(input.telegramOperatorId);

        // –ò–º–ø–æ—Ä—Ç order manager
        const { orderManager } = await import('@repo/exchange-core');

        // –ù–∞–π—Ç–∏ –∑–∞—è–≤–∫—É
        const order = await orderManager.findById(input.orderId);

        if (!order) {
          logger.warn('ORDER_NOT_FOUND_FOR_TELEGRAM', { orderId: input.orderId });
          return { 
            success: false, 
            order: null,
            error: {
              code: 'ORDER_NOT_FOUND',
              message: '–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
            }
          };
        }

        logger.debug('ORDER_FOUND_FOR_TELEGRAM', {
          orderId: input.orderId,
          currentStatus: order.status,
        });

        // –ù–∞–∑–Ω–∞—á–∏—Ç—å –∑–∞—è–≤–∫—É
        const updatedOrder = await orderManager.assignToOperator(input.orderId, operator.id);

        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if (!updatedOrder) {
          logger.error('ORDER_ASSIGNMENT_FAILED_VIA_TELEGRAM', {
            orderId: input.orderId,
            telegramOperatorId: input.telegramOperatorId,
            operatorId: operator.id,
            currentStatus: order.status,
            assignedOperator: order.assignedOperatorId,
          });

          // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –æ—à–∏–±–∫–∏
          let errorCode = 'ASSIGNMENT_FAILED';
          let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å –∑–∞—è–≤–∫—É –≤ —Ä–∞–±–æ—Ç—É';

          if (order.assignedOperatorId) {
            errorCode = 'ALREADY_ASSIGNED';
            errorMessage = '–ó–∞—è–≤–∫–∞ —É–∂–µ –≤–∑—è—Ç–∞ –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º';
          } else if (!['pending', 'paid'].includes(order.status)) {
            errorCode = 'INVALID_STATUS';
            errorMessage = `–ó–∞—è–≤–∫–∞ –≤ —Å—Ç–∞—Ç—É—Å–µ "${order.status}" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∑—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É`;
          }

          return { 
            success: false, 
            order: null,
            error: {
              code: errorCode,
              message: errorMessage
            }
          };
        }

        logger.info('ORDER_ASSIGNED_VIA_TELEGRAM', {
          orderId: input.orderId,
          telegramOperatorId: input.telegramOperatorId,
          operatorId: operator.id,
          newStatus: updatedOrder.status,
          assignedAt: updatedOrder.assignedAt?.toISOString(),
        });

        return { 
          success: true, 
          order: updatedOrder,
          error: null
        };
      } catch (error) {
        logger.error('TELEGRAM_TAKE_ORDER_EXCEPTION', {
          orderId: input.orderId,
          telegramOperatorId: input.telegramOperatorId,
          error: error instanceof Error ? error.message : String(error),
        });

        return {
          success: false,
          order: null,
          error: {
            code: 'SYSTEM_ERROR',
            message: '–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞'
          }
        };
      }
    }),
});
```

### –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #2: webhook.ts

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

```typescript
// apps/telegram-bot/pages/api/webhook.ts

/**
 * –û–±—Ä–∞–±–æ—Ç–∫–∞ callback query –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
 */
async function handleCallbackQueryResponse(
  callbackQuery: NonNullable<TelegramUpdate['callback_query']>,
  responseMessage: string | null,
  operationSuccess: boolean  // ‚úÖ –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
): Promise<void> {
  try {
    // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const shouldShowAlert = !operationSuccess;
    
    // –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ callback query
    await fetch(
      `${TELEGRAM_API.BASE_URL}/bot${process.env.TELEGRAM_BOT_TOKEN}${TELEGRAM_API.ANSWER_CALLBACK_QUERY}`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          callback_query_id: callbackQuery.id,
          text: responseMessage || (operationSuccess ? '–ì–æ—Ç–æ–≤–æ!' : '–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞'),
          show_alert: shouldShowAlert,  // ‚úÖ Alert –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }),
      }
    );

    // ‚úÖ –û–±–Ω–æ–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
    if (callbackQuery.data?.startsWith('take_order_') && callbackQuery.message && operationSuccess) {
      const orderId = callbackQuery.data.replace('take_order_', '');
      const originalText = callbackQuery.message.text || '';
      const updatedText = `${originalText}\n\n‚úÖ **–ó–∞—è–≤–∫–∞ –≤–∑—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º ${callbackQuery.from.first_name || callbackQuery.from.id}**`;

      await fetch(
        `${TELEGRAM_API.BASE_URL}/bot${process.env.TELEGRAM_BOT_TOKEN}${TELEGRAM_API.EDIT_MESSAGE}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chat_id: callbackQuery.message.chat.id,
            message_id: callbackQuery.message.message_id,
            text: updatedText,
            parse_mode: 'Markdown',
            reply_markup: { inline_keyboard: [] }, // –£–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
          }),
        }
      );

      logger.info('Order message updated after successful assignment', { 
        orderId, 
        chatId: callbackQuery.message.chat.id 
      });
    } else if (callbackQuery.data?.startsWith('take_order_') && !operationSuccess) {
      // ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ - –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–Ω–æ–ø–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è
      logger.info('Order assignment failed, message NOT updated, buttons remain', {
        orderId: callbackQuery.data.replace('take_order_', ''),
        chatId: callbackQuery.message?.chat.id,
      });
    }
  } catch (error) {
    logger.error('Failed to handle callback query', {
      callbackQueryId: callbackQuery.id,
      error: String(error),
    });
  }
}

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    res.status(HTTP_STATUS.METHOD_NOT_ALLOWED).json({ error: 'Method not allowed' });
    return;
  }

  const result = await gracefulHandler(
    async () => {
      if (!req.body || typeof req.body !== 'object') {
        logger.warn('Invalid webhook payload received', { body: req.body });
        res.status(HTTP_STATUS.BAD_REQUEST).json({ error: 'Invalid payload' });
        return;
      }

      const update = req.body as TelegramUpdate;

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ update —á–µ—Ä–µ–∑ telegram-bot –ª–æ–≥–∏–∫—É
      const responseMessage = await handleTelegramUpdate(update);

      logger.info('Webhook processed successfully', {
        updateId: update.update_id,
        hasMessage: !!update.message,
        hasCallbackQuery: !!update.callback_query,
        responseGenerated: !!responseMessage,
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ Telegram API
      if (responseMessage && update.message?.from?.id) {
        await sendTelegramMessage(update.message.from.id, responseMessage);
      }

      // ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ callback queries —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —É—Å–ø–µ—Ö–∞
      if (update.callback_query) {
        // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å success –∏–∑ responseMessage (—Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ "‚úÖ")
        const operationSuccess = responseMessage?.includes('‚úÖ') ?? false;
        
        await handleCallbackQueryResponse(
          update.callback_query, 
          responseMessage,
          operationSuccess  // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º —Ñ–ª–∞–≥ —É—Å–ø–µ—Ö–∞
        );
      }

      res.status(HTTP_STATUS.OK).json({
        status: 'ok',
        processed: true,
        responseGenerated: !!responseMessage,
      });
    },
    { fallback: null }
  );

  if (result === null) {
    logger.error('Webhook processing failed');
    res.status(HTTP_STATUS.INTERNAL_SERVER_ERROR).json({
      error: 'Internal server error',
    });
  }
}
```

### –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #3: telegram-bot.ts

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° –°–†–ï–î–ù–ò–ô (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)

```typescript
// apps/telegram-bot/src/lib/telegram-bot.ts

async function handleTakeOrderCommand(update: TelegramUpdate): Promise<string> {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

  const result = await gracefulHandler(
    async () => {
      logger.debug('CALLING_TELEGRAM_TAKE_ORDER_API', { orderId, telegramOperatorId });
      return await api.telegram.takeOrder({
        orderId,
        telegramOperatorId,
      });
    },
    { fallback: null }
  );

  // ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å result.success –≤–º–µ—Å—Ç–æ !!result?.order
  logger.debug('TELEGRAM_TAKE_ORDER_API_RESULT', {
    orderId,
    success: result?.success ?? false,  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–≤–Ω—ã–π —Ñ–ª–∞–≥
    hasOrder: !!result?.order,
    errorCode: result?.error?.code,
    errorMessage: result?.error?.message,
  });

  if (result?.success && result?.order) {  // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–æ–∏—Ö —É—Å–ª–æ–≤–∏–π
    session.currentOrderId = result.order.id;

    logger.info('Order taken by operator', {
      operatorId: session.operatorId,
      orderId: result.order.id,
      telegramOperatorId,
      orderStatus: result.order.status,
    });

    const successMessage = (
      `‚úÖ –ó–∞—è–≤–∫–∞ –≤–∑—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É!\n\n` +
      `üìã –ó–∞—è–≤–∫–∞ #${result.order.publicId}\n` +
      `üí∞ –°—É–º–º–∞: ${result.order.cryptoAmount} ${result.order.currency}\n` +
      `üîÑ –°—Ç–∞—Ç—É—Å: ${result.order.status}\n\n` +
      `–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /orders –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π.`
    );
    
    return successMessage;
  } else {
    logger.warn('TELEGRAM_TAKE_ORDER_FAILED', {
      orderId,
      telegramOperatorId,
      operatorId: session.operatorId,
      errorCode: result?.error?.code,
      errorMessage: result?.error?.message,
    });

    // ‚úÖ –£–õ–£–ß–®–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å errorMessage –∏–∑ API
    const errorMessage = result?.error?.message 
      ? `‚ùå ${result.error.message}`
      : (
        `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å –∑–∞—è–≤–∫—É\n\n` +
        `–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n` +
        `‚Ä¢ –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\n` +
        `‚Ä¢ –ó–∞—è–≤–∫–∞ —É–∂–µ –≤–∑—è—Ç–∞ –¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º\n` +
        `‚Ä¢ –ó–∞—è–≤–∫–∞ –≤ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–µ–º —Å—Ç–∞—Ç—É—Å–µ\n` +
        `‚Ä¢ –°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞\n\n` +
        `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫.`
      );
    
    return errorMessage;
  }
}
```

---

## üìà –ú–ï–¢–†–ò–ö–ò –î–õ–Ø –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:

### 1. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
{
  "metric": "telegram.order.assignment",
  "success": true/false,
  "duration_ms": 123,
  "error_code": "ALREADY_ASSIGNED" | null,
  "operator_id": "...",
  "order_status": "paid"
}
```

### 2. –ë–∏–∑–Ω–µ—Å –º–µ—Ç—Ä–∏–∫–∏:
- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤–∑—è—Ç–∏—è –∑–∞—è–≤–∫–∏
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø–æ –∫–æ–¥–∞–º

### 3. UX –º–µ—Ç—Ä–∏–∫–∏:
- –í—Ä–µ–º—è –æ—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ alert —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π vs toast
- –ü—Ä–æ—Ü–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö –∫–Ω–æ–ø–∫–∏ vs –∫–æ–º–∞–Ω–¥—ã

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –í–ù–ï–î–†–ï–ù–ò–Ø

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å telegram-bot-router.ts (success –ø—Ä–æ–≤–µ—Ä–∫–∞)
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å webhook.ts (—É—Å–ª–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ –≤ constants
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏

### –§–∞–∑–∞ 2: –£–ª—É—á—à–µ–Ω–∏—è
- [ ] –£–ª—É—á—à–∏—Ç—å telegram-bot.ts (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ error codes)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –í–Ω–µ–¥—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫

### –§–∞–∑–∞ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å dashboard –º–µ—Ç—Ä–∏–∫
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –û–±—É—á–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–æ–≤–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é

---

## üîê SECURITY CONSIDERATIONS

### 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è - –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `AUTHORIZED_TELEGRAM_OPERATORS` –∏ –ë–î.

### 2. Rate Limiting
–î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –≤–∑—è—Ç–∏—è –∑–∞—è–≤–∫–∏:
```typescript
const MAX_TAKE_ORDER_ATTEMPTS = 5;
const RATE_LIMIT_WINDOW = 60000; // 1 –º–∏–Ω—É—Ç–∞
```

### 3. –ê—É–¥–∏—Ç –ª–æ–≥–∏
–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å.

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–ê–¢–ï–†–ò–ê–õ–´

### –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:
- `docs/TELEGRAM_WEBHOOK_SETUP.md` - —Ç–µ–∫—É—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `docs/troubleshooting/` - —Ä–∞–∑–¥–µ–ª –¥–ª—è troubleshooting
- `packages/constants/src/errors.ts` - —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ (—Å–æ–∑–¥–∞—Ç—å)

### –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è:
- Result type pattern (Rust-style)
- Railway-oriented programming
- Error boundaries –≤ React/Next.js

---

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–Ω—è—Ç–Ω–∞ –Ω–∞ 100%
‚úÖ –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `result.success` –≤ tRPC —Ä–æ—É—Ç–µ—Ä–µ  
‚úÖ –£—Å—É–≥—É–±–ª–µ–Ω–∏–µ: –±–µ–∑—É—Å–ª–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ webhook handler  
‚úÖ –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ: –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç success –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–µ  

### –†–µ—à–µ–Ω–∏–µ —á—ë—Ç–∫–æ–µ
‚úÖ 3 —Ñ–∞–π–ª–∞ —Ç—Ä–µ–±—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π  
‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  
‚úÖ –í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ~2-4 —á–∞—Å–∞  
‚úÖ –†–∏—Å–∫ —Ä–µ–≥—Ä–µ—Å—Å–∏–π: –ù–ò–ó–ö–ò–ô (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫)  

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–ª—É—á—à–∏—Ç—Å—è
‚úÖ –Ø–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö  
‚úÖ –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã –æ—à–∏–±–æ–∫  
‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º  
‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ –¥–ª—è retry  

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ**: AI Agent  
**–î–∞—Ç–∞**: 8 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–û–¢–û–í–û –ö –í–ù–ï–î–†–ï–ù–ò–Æ
