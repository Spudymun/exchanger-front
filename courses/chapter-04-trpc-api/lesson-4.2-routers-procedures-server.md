# –£—Ä–æ–∫ 4.2: Router'—ã –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

> **üéØ –¶–µ–ª—å —É—Ä–æ–∫–∞**: –ù–∞—É—á–∏—Ç—å—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ tRPC —Ä–æ—É—Ç–µ—Ä—ã –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

## üìñ –í–≤–µ–¥–µ–Ω–∏–µ

### –ß—Ç–æ —Ç–∞–∫–æ–µ tRPC –∏ –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω?

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –æ–±—ã—á–Ω—ã–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–º —Å —Ü–∏—Ñ—Ä–æ–≤—ã–º –º–µ–Ω—é:

**–û–±—ã—á–Ω—ã–π REST API** - —ç—Ç–æ –∫–∞–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –≥–¥–µ:

- –ö–ª–∏–µ–Ω—Ç –∫—Ä–∏—á–∏—Ç –Ω–∞ –∫—É—Ö–Ω—é: "–î–∞–π—Ç–µ –º–Ω–µ —á—Ç–æ-—Ç–æ –≤–∫—É—Å–Ω–æ–µ!"
- –ü–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—á–µ—Ç –∫–ª–∏–µ–Ω—Ç
- –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞–Ω–∏—è
- –ù—É–∂–Ω–æ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –æ–±—ä—è—Å–Ω—è—Ç—å, —á—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –º–µ–Ω—é

**tRPC** - —ç—Ç–æ –∫–∞–∫ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å —É–º–Ω—ã–º –º–µ–Ω—é, –≥–¥–µ:

- –£ –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å —Ç–æ—á–Ω–æ–µ –º–µ–Ω—é —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ –±–ª—é–¥–∞
- –ü–æ–≤–∞—Ä —Ç–æ—á–Ω–æ –∑–Ω–∞–µ—Ç, —á—Ç–æ –∑–∞–∫–∞–∑–∞–ª –∫–ª–∏–µ–Ω—Ç
- –ï—Å–ª–∏ –±–ª—é–¥–∞ –Ω–µ—Ç –≤ –º–µ–Ω—é, –∫–ª–∏–µ–Ω—Ç —Å—Ä–∞–∑—É –æ–± —ç—Ç–æ–º —É–∑–Ω–∞–µ—Ç
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–µ–Ω—é –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —É –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ tRPC

‚úÖ **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - TypeScript —Ç–∏–ø—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–æ–º –∏ –∫–ª–∏–µ–Ω—Ç–æ–º
‚úÖ **–ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ** - IDE –∑–Ω–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏ –∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ã  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥** - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª–∏ –º–µ—Ç–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑ –∫–æ—Ä–æ–±–∫–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚úÖ **–û—Ç–ª–∏—á–Ω–∞—è DX** - —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–∏—è—Ç–Ω–µ–µ

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è

**–†–æ—É—Ç–µ—Ä (Router)** - —ç—Ç–æ "–æ—Ç–¥–µ–ª —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞" (–≥—Ä—É–ø–ø–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö API –º–µ—Ç–æ–¥–æ–≤)
**–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ (Procedure)** - —ç—Ç–æ "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –±–ª—é–¥–æ" (–æ—Ç–¥–µ–ª—å–Ω—ã–π API –º–µ—Ç–æ–¥)
**–ö–æ–Ω—Ç–µ–∫—Å—Ç (Context)** - —ç—Ç–æ "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ" (–¥–∞–Ω–Ω—ã–µ, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö)
**Middleware** - —ç—Ç–æ "–æ—Ö—Ä–∞–Ω–Ω–∏–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞" (–ø—Ä–æ–≤–µ—Ä–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–µ—Ä–µ–¥ –ø—Ä–æ—Ü–µ–¥—É—Ä–æ–π)

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –∏–∑—É—á–∏–º –∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ tRPC –≤ –ø—Ä–æ–µ–∫—Ç–µ ExchangeGO.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–æ—É—Ç–µ—Ä–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ tRPC —Ä–æ—É—Ç–µ—Ä–æ–≤

```
apps/web/src/server/trpc/
‚îú‚îÄ‚îÄ init.ts                    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è tRPC
‚îú‚îÄ‚îÄ context.ts                 # –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä
‚îú‚îÄ‚îÄ middleware/                # Middleware –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts               # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ä–æ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ rateLimit.ts          # Rate limiting
‚îî‚îÄ‚îÄ routers/                   # –ú–æ–¥—É–ª—å–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã
    ‚îú‚îÄ‚îÄ index.ts              # –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä (App Router)
    ‚îú‚îÄ‚îÄ auth.ts               # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    ‚îú‚îÄ‚îÄ exchange.ts           # –û–±–º–µ–Ω –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
    ‚îú‚îÄ‚îÄ fiat.ts               # –§–∏–∞—Ç–Ω—ã–µ –≤–∞–ª—é—Ç—ã
    ‚îú‚îÄ‚îÄ operator.ts           # –†–æ—É—Ç–µ—Ä—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
    ‚îú‚îÄ‚îÄ support.ts            # –†–æ—É—Ç–µ—Ä—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    ‚îú‚îÄ‚îÄ shared.ts             # –û–±—â–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
    ‚îî‚îÄ‚îÄ user/                 # Namespace –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        ‚îú‚îÄ‚îÄ index.ts          # User —Ä–æ—É—Ç–µ—Ä
        ‚îú‚îÄ‚îÄ orders.ts         # –ó–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ‚îú‚îÄ‚îÄ profile.ts        # –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ‚îî‚îÄ‚îÄ security.ts       # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```

## üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è tRPC

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏?

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è tRPC - —ç—Ç–æ –∫–∞–∫ **–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–∏–ª —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞**:

- –ö–∞–∫ –±—É–¥–µ–º "–ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å" —Å–ª–æ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –∫—É—Ö–Ω–µ–π –∏ –∑–∞–ª–æ–º?
- –ö–∞–∫ –±—É–¥–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞–º?
- –ö–∞–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ –Ω–∞–º –Ω—É–∂–Ω–∞?

### –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```typescript
// apps/web/src/server/trpc/init.ts
import { initTRPC } from '@trpc/server';
import superjson from 'superjson';
import { ZodError } from 'zod';
import { type Context } from './context';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è tRPC —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
const t = initTRPC.context<Context>().create({
  // üîÑ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö (Date, Map, Set)
  // –ó–∞—á–µ–º –Ω—É–∂–µ–Ω: JSON –Ω–µ —É–º–µ–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å Date –æ–±—ä–µ–∫—Ç—ã, superjson —Ä–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É
  transformer: superjson,

  // üö® –ö–∞—Å—Ç–æ–º–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
  // –ó–∞—á–µ–º –Ω—É–∂–Ω–æ: –¥–µ–ª–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
  errorFormatter({ shape, error }) {
    return {
      ...shape,
      data: {
        ...shape.data,
        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Zod - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
        // –ü—Ä–∏–º–µ—Ä: "email –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º", "amount –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º"
        zodError: error.cause instanceof ZodError ? error.cause.flatten() : null,
      },
    };
  },
});

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏
export const createTRPCRouter = t.router;
export const publicProcedure = t.procedure;
export const createCallerFactory = t.createCallerFactory;

// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
const loggingMiddleware = t.middleware(async ({ path, type, next }) => {
  const start = Date.now();
  const result = await next();
  const durationMs = Date.now() - start;

  console.log(`üîó tRPC ${type} ${path} - ${durationMs}ms`);
  return result;
});

// –ü—É–±–ª–∏—á–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
export const loggedProcedure = publicProcedure.use(loggingMiddleware);
```

### –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ—Ü–µ–¥—É—Ä

**–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç?**
–ö–æ–Ω—Ç–µ–∫—Å—Ç - —ç—Ç–æ "–ø–∞—Å–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–∞" –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ. –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –Ω—É–∂–Ω–∞ –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è:

- –ö—Ç–æ —ç—Ç–æ—Ç –∫–ª–∏–µ–Ω—Ç? (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
- –û—Ç–∫—É–¥–∞ –æ–Ω –ø—Ä–∏—à–µ–ª? (IP –¥–ª—è rate limiting)
- –ù–∞ –∫–∞–∫–æ–º —è–∑—ã–∫–µ –≥–æ–≤–æ—Ä–∏—Ç? (–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è)
- –ö–∞–∫–∏–µ —É –Ω–µ–≥–æ –ø—Ä–∞–≤–∞? (—Ä–æ–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?**
–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –≤ –∫–∞–∂–¥–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–µ –∑–∞–Ω–æ–≤–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –º—ã –¥–µ–ª–∞–µ–º —ç—Ç–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.

```typescript
// apps/web/src/server/trpc/context.ts
import { type CreateNextContextOptions } from '@trpc/server/adapters/next';
import { type User, userManager } from '@repo/exchange-core';
import { SUPPORTED_LOCALES, I18N_CONFIG } from '@repo/constants';

export const createContext = async (opts: CreateNextContextOptions) => {
  const { req, res } = opts;

  // IP –¥–ª—è rate limiting
  const forwarded = req.headers['x-forwarded-for'];
  const ip =
    typeof forwarded === 'string' ? forwarded.split(',')[0] : req.socket.remoteAddress || 'unknown';

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ –∏–∑ Accept-Language header
  const acceptLanguage = req.headers['accept-language'] || '';
  const locale = getLocaleFromAcceptLanguage(acceptLanguage);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
  let user: User | null = null;
  const sessionId = req.cookies.sessionId || req.headers.authorization?.replace('Bearer ', '');

  if (sessionId) {
    user = await userManager.findBySessionId(sessionId);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
  const getErrorMessage = createErrorMessageFunction(locale);

  return {
    req,
    res,
    ip,
    user,
    locale,
    getErrorMessage,
  };
};

export type Context = inferAsyncReturnType<typeof createContext>;
```

## üìã –¢–∏–ø—ã –ø—Ä–æ—Ü–µ–¥—É—Ä

### –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –ø—Ä–æ—Ü–µ–¥—É—Ä

–í tRPC –µ—Å—Ç—å —Ç—Ä–∏ —Ç–∏–ø–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä, –∫–∞–∂–¥—ã–π –¥–ª—è —Å–≤–æ–µ–π –∑–∞–¥–∞—á–∏:

**üîç Query** - "–ü–æ–∫–∞–∂–∏ –º–Ω–µ —á—Ç–æ-—Ç–æ" (–ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ù–µ –∏–∑–º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
- –ú–æ–∂–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å—Å—è
- –ü—Ä–∏–º–µ—Ä—ã: –ø–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å –≤–∞–ª—é—Ç—ã, —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤, –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**‚úèÔ∏è Mutation** - "–°–¥–µ–ª–∞–π —á—Ç–æ-—Ç–æ" (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ò–∑–º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
- –ù–µ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è
- –ü—Ä–∏–º–µ—Ä—ã: —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑, –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å, —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª

**üì° Subscription** - "–£–≤–µ–¥–æ–º–∏ –º–µ–Ω—è, –∫–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è" (—Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –ü—Ä–∏–º–µ—Ä—ã: –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á–∞—Ç

### 1. Query - –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å, –Ω–µ –∏–∑–º–µ–Ω—è—è –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

```typescript
// –ü—Ä–∏–º–µ—Ä –∏–∑ apps/web/src/server/trpc/routers/exchange.ts

// Query –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
getCurrencyRate: publicProcedure
  .input(securityEnhancedGetCurrencyRateSchema) // üìù –ß—Ç–æ –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç
  .query(async ({ input, ctx }) => {            // üîç –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    const { from, to } = input;

    // üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤–∞–ª—é—Ç (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞)
    await assertValidCurrency(from, ctx);
    await assertValidCurrency(to, ctx);

    // üí± –ü–æ–ª—É—á–∞–µ–º –∫—É—Ä—Å –æ–±–º–µ–Ω–∞ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API
    const rate = await getExchangeRate(from as CryptoCurrency, to);

    // üì§ –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
    return {
      from,
      to,
      rate: rate.toFixed(8),        // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 8 –∑–Ω–∞–∫–æ–≤
      timestamp: new Date(),        // –í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞
    };
  }),

// üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:
// const { data } = trpc.exchange.getCurrencyRate.useQuery({
//   from: 'BTC',
//   to: 'UAH'
// });
// console.log(data.rate); // "50000.12345678"
```

### 2. Mutation - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—Å–æ–∑–¥–∞—Ç—å, –æ–±–Ω–æ–≤–∏—Ç—å, —É–¥–∞–ª–∏—Ç—å).

```typescript
// Mutation –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω–∞ –æ–±–º–µ–Ω
createOrder: publicProcedure
  .input(securityEnhancedCreateExchangeOrderSchema)     // üìù –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  .use(rateLimitMiddleware({ limit: 5, window: '1m' })) // üö¶ –ù–µ –±–æ–ª—å—à–µ 5 –∑–∞–∫–∞–∑–æ–≤ –≤ –º–∏–Ω—É—Ç—É
  .mutation(async ({ input, ctx }) => {                 // ‚úèÔ∏è –õ–æ–≥–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    const { email, fromCurrency, toCurrency, amount } = input;

    // üõ°Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
    await assertValidCurrency(fromCurrency, ctx);
    await assertValidCurrency(toCurrency, ctx);

    // üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è/–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞)
    const limits = getCurrencyLimits(fromCurrency as CryptoCurrency);
    if (!isAmountWithinLimits(amount, limits)) {
      throw createOrderError(
        await ctx.getErrorMessage('server.errors.business.amountOutOfLimits')
      );
    }

    // üíæ –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    const order = await orderManager.create({
      email: sanitizeEmail(email),                                    // –û—á–∏—â–∞–µ–º email
      fromCurrency: fromCurrency as CryptoCurrency,
      toCurrency,
      amount,
      status: ORDER_STATUSES.PENDING,                                // –°—Ç–∞—Ç—É—Å "–û–∂–∏–¥–∞–µ—Ç"
      depositAddress: generateDepositAddress(fromCurrency as CryptoCurrency), // –ê–¥—Ä–µ—Å –¥–ª—è –¥–µ–ø–æ–∑–∏—Ç–∞
    });

    // üì§ –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∫–ª–∏–µ–Ω—Ç—É
    return {
      id: order.id,
      depositAddress: order.depositAddress,  // –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É
      expiresAt: order.expiresAt,           // –ö–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç –∑–∞–∫–∞–∑
    };
  }),

// üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:
// const createOrderMutation = trpc.exchange.createOrder.useMutation();
// const result = await createOrderMutation.mutateAsync({
//   email: 'user@example.com',
//   fromCurrency: 'BTC',
//   toCurrency: 'UAH',
//   amount: 0.1
// });
// console.log(result.depositAddress); // "1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"
```

### 3. Subscription - –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–∫—É—Ä—Å—ã –≤–∞–ª—é—Ç, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á–∞—Ç).

```typescript
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤ (–¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤)
watchCurrencyRate: publicProcedure
  .input(z.object({
    from: z.string(),
    to: z.string(),
  }))
  .subscription(async function* ({ input }) {    // üì° –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    // üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    while (true) {
      const rate = await getExchangeRate(
        input.from as CryptoCurrency,
        input.to
      );

      // üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—É
      yield {
        rate: rate.toFixed(8),
        timestamp: new Date(),
      };

      // ‚è∞ –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      await new Promise(resolve => setTimeout(resolve, 10000));
    }
  }),

// üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:
// trpc.exchange.watchCurrencyRate.useSubscription(
//   { from: 'BTC', to: 'UAH' },
//   {
//     onData: (data) => {
//       console.log('–ù–æ–≤—ã–π –∫—É—Ä—Å:', data.rate);
//       updateUI(data.rate);
//     }
//   }
// );
```

## üîó –ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤

### –ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤?

–ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤ - —ç—Ç–æ –∫–∞–∫ **–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–¥–µ–ª–æ–≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞** –≤ –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω:

- –£ –≤–∞—Å –µ—Å—Ç—å –æ—Ç–¥–µ–ª –ø–∏—Ü—Ü—ã, –æ—Ç–¥–µ–ª —Å–∞–ª–∞—Ç–æ–≤, –æ—Ç–¥–µ–ª –¥–µ—Å–µ—Ä—Ç–æ–≤
- –ö–∞–∂–¥—ã–π –æ—Ç–¥–µ–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –ù–æ –∫–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç –µ–¥–∏–Ω–æ–µ –º–µ–Ω—é –≤—Å–µ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
- –ó–∞–∫–∞–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –Ω—É–∂–Ω—ã–π –æ—Ç–¥–µ–ª

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?**

- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π —Ä–æ—É—Ç–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –æ–±–ª–∞—Å—Ç—å
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - —Ä–æ—É—Ç–µ—Ä—ã –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
- **–ö–æ–º–∞–Ω–¥—ã** - —Ä–∞–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ —Ä–∞–∑–Ω—ã–º–∏ —Ä–æ—É—Ç–µ—Ä–∞–º–∏
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–∞–∂–¥—ã–π —Ä–æ—É—Ç–µ—Ä –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ

### –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä

```typescript
// apps/web/src/server/trpc/routers/index.ts
import { createTRPCRouter } from '../init';

import { authRouter } from './auth';
import { exchangeRouter } from './exchange';
import { userRouter } from './user';
import { operatorRouter } from './operator';
import { supportRouter } from './support';

// –ö–æ–º–ø–æ–∑–∏—Ü–∏—è –≤—Å–µ—Ö —Ä–æ—É—Ç–µ—Ä–æ–≤ –≤ –≥–ª–∞–≤–Ω—ã–π App Router
export const appRouter = createTRPCRouter({
  auth: authRouter, // üîê /api/trpc/auth.* - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  exchange: exchangeRouter, // üí± /api/trpc/exchange.* - –æ–±–º–µ–Ω –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
  user: userRouter, // üë§ /api/trpc/user.* - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  operator: operatorRouter, // üë®‚Äçüíº /api/trpc/operator.* - —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
  support: supportRouter, // üéß /api/trpc/support.* - —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞
});

// üéØ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ - —ç—Ç–æ –ö–õ–Æ–ß–ï–í–ê–Ø –º–∞–≥–∏—è tRPC!
// –≠—Ç–æ—Ç —Ç–∏–ø –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –¥–ª—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
export type AppRouter = typeof appRouter;

// üí° –¢–µ–ø–µ—Ä—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ:
// trpc.auth.login.useMutation()
// trpc.exchange.getCurrencyRate.useQuery()
// trpc.user.getProfile.useQuery()
// –ò TypeScript –±—É–¥–µ—Ç –∑–Ω–∞—Ç—å –≤—Å–µ —Ç–∏–ø—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
```

### –ú–æ–¥—É–ª—å–Ω—ã–π —Ä–æ—É—Ç–µ—Ä

```typescript
// apps/web/src/server/trpc/routers/exchange.ts
import { createTRPCRouter, publicProcedure } from '../init';
import { rateLimitMiddleware } from '../middleware/rateLimit';

export const exchangeRouter = createTRPCRouter({
  // –ü—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
  getCurrencyRate: publicProcedure.input(getCurrencyRateSchema).query(async ({ input, ctx }) => {
    // –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞
  }),

  calculateAmount: publicProcedure.input(calculateAmountSchema).query(async ({ input, ctx }) => {
    // –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—É–º–º—ã
  }),

  // –ü—Ä–æ—Ü–µ–¥—É—Ä—ã —Å rate limiting
  createOrder: publicProcedure
    .input(createOrderSchema)
    .use(rateLimitMiddleware({ limit: 5, window: '1m' }))
    .mutation(async ({ input, ctx }) => {
      // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
    }),

  // –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  getMyOrders: authMiddleware.input(paginationSchema).query(async ({ input, ctx }) => {
    // ctx.user –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const orders = await orderManager.findByUserId(ctx.user.id);
    return paginateOrders(orders, input);
  }),
});
```

## üõ°Ô∏è Middleware –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ß—Ç–æ —Ç–∞–∫–æ–µ Middleware?

Middleware - —ç—Ç–æ **"–æ—Ö—Ä–∞–Ω–Ω–∏–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞"**, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –∏—Ö –æ–±—Å–ª—É–∂–∏—Ç—å:

**–ü—Ä–∏–º–µ—Ä—ã middleware:**

- üîê **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - "–í—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É?"
- üëÆ **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - "–£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ?"
- üö¶ **Rate Limiting** - "–í—ã –Ω–µ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –¥–µ–ª–∞–µ—Ç–µ –∑–∞–ø—Ä–æ—Å—ã?"
- üìù **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - "–ó–∞–ø–∏—Å–∞—Ç—å, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –∑–∞–∫–∞–∑–∞–ª"
- üõ°Ô∏è **–í–∞–ª–∏–¥–∞—Ü–∏—è** - "–î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã?"

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

1. –ö–ª–∏–µ–Ω—Ç –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ
2. Middleware –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–¥–æ** –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
3. –ï—Å–ª–∏ middleware –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞
4. –ï—Å–ª–∏ middleware –±–ª–æ–∫–∏—Ä—É–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞

### Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```typescript
// apps/web/src/server/trpc/middleware/auth.ts
import { publicProcedure } from '../init';
import { createUnauthorizedError } from '@repo/utils';

// üîê –ë–∞–∑–æ–≤—ã–π middleware –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
export const authMiddleware = publicProcedure.use(async ({ ctx, next }) => {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  if (!isAuthenticatedUser(ctx.user)) {
    throw createUnauthorizedError(await ctx.getErrorMessage('server.errors.auth.required'));
  }

  // ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–ª—å—à–µ
  return next({
    ctx: {
      ...ctx,
      user: ctx.user, // üéØ TypeScript —Ç–µ–ø–µ—Ä—å –∑–Ω–∞–µ—Ç —á—Ç–æ user: User (–Ω–µ null)
    },
  });
});

// üë®‚Äçüíº Middleware –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π (–Ω–∞—Å–ª–µ–¥—É–µ—Ç –æ—Ç authMiddleware)
export const operatorMiddleware = authMiddleware.use(async ({ ctx, next }) => {
  // –ó–¥–µ—Å—å ctx.user —É–∂–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è authMiddleware
  if (ctx.user.role !== USER_ROLES.OPERATOR) {
    throw createForbiddenError(await ctx.getErrorMessage('server.errors.auth.operatorRequired'));
  }
  return next();
});

// üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
// getMyOrders: authMiddleware        // –¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
//   .query(async ({ ctx }) => {
//     // ctx.user —Ç–æ—á–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç —Ç–∏–ø User
//     return await getOrdersForUser(ctx.user.id);
//   })
//
// getSystemStats: operatorMiddleware  // –¢–æ–ª—å–∫–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
//   .query(async ({ ctx }) => {
//     // ctx.user —Ç–æ—á–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —è–≤–ª—è–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
//     return await getSystemStatistics();
//   })
```

### Rate Limiting Middleware

**–ß—Ç–æ —Ç–∞–∫–æ–µ Rate Limiting?**
–≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è:

- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∏ DDoS –∞—Ç–∞–∫
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π API
- –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

**–ü—Ä–∏–º–µ—Ä—ã –ª–∏–º–∏—Ç–æ–≤:**

- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤: 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- –û—Ç–ø—Ä–∞–≤–∫–∞ email: 3 –∑–∞–ø—Ä–æ—Å–∞ –≤ —á–∞—Å
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É

```typescript
// apps/web/src/server/trpc/middleware/rateLimit.ts
import { TRPCError } from '@trpc/server';

// üìä –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis)
const rateLimitStore = new Map<string, { count: number; resetTime: number }>();

export const rateLimitMiddleware = (config: {
  limit: number; // –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤
  window: string; // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ: '1m', '1h', '1d'
}) => {
  return publicProcedure.use(async ({ ctx, next }) => {
    // üîë –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫–∞–∂–¥–æ–≥–æ IP + –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
    const key = `${ctx.ip}:${ctx.procedure}`;
    const windowMs = parseTimeWindow(config.window); // '1m' ‚Üí 60000ms
    const now = Date.now();

    const current = rateLimitStore.get(key);

    if (!current || now > current.resetTime) {
      // üÜï –ù–æ–≤–æ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
      rateLimitStore.set(key, { count: 1, resetTime: now + windowMs });
    } else if (current.count >= config.limit) {
      // üö´ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç - –±–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
      throw new TRPCError({
        code: 'TOO_MANY_REQUESTS',
        message: `Rate limit exceeded. Max ${config.limit} requests per ${config.window}`,
      });
    } else {
      // ‚ûï –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
      current.count++;
    }

    return next();
  });
};

// üí° –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
// createOrder: publicProcedure
//   .use(rateLimitMiddleware({ limit: 5, window: '1m' }))  // –ù–µ –±–æ–ª—å—à–µ 5 –∑–∞–∫–∞–∑–æ–≤ –≤ –º–∏–Ω—É—Ç—É
//   .input(createOrderSchema)
//   .mutation(async ({ input }) => {
//     // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
//   })
```

## üîç –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–æ—É—Ç–µ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

### –†–∞–∑–±–æ—Ä Exchange Router –ø–æ —à–∞–≥–∞–º

–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –æ–±–º–µ–Ω–∞ –≤–∞–ª—é—Ç –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ ExchangeGO –∏ –ø–æ–π–º–µ–º, –∫–∞–∫ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.

### Exchange Router

```typescript
// –†–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ ExchangeGO
export const exchangeRouter = createTRPCRouter({
  // üîç Query: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç—ã
  getCurrencyRate: publicProcedure
    .input(securityEnhancedGetCurrencyRateSchema) // –í–∞–ª–∏–¥–∞—Ü–∏—è: from, to –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞–º–∏
    .query(async ({ input, ctx }) => {
      // üêå –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –≤–Ω–µ—à–Ω–µ–≥–æ API (—Ç–æ–ª—å–∫–æ –≤ dev —Ä–µ–∂–∏–º–µ)
      await new Promise(resolve => setTimeout(resolve, API_DELAY_MS.EXCHANGE_RATE));

      // üí± –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API (CoinGecko, Binance, etc.)
      const rate = await getExchangeRate(input.from, input.to);

      // ÔøΩ –í:–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—É—Ä—Å —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
      return { rate: rate.toFixed(8) };
    }),

  // üí∞ Query: –†–∞—Å—á–µ—Ç —Å—É–º–º—ã –æ–±–º–µ–Ω–∞
  calculateAmount: publicProcedure
    .input(securityEnhancedCalculateAmountSchema) // –í–∞–ª–∏–¥–∞—Ü–∏—è: currency, amount, direction
    .query(async ({ input, ctx }) => {
      const { fromCurrency, amount, direction } = input;

      let result;
      if (direction === 'crypto-to-uah') {
        // üí∏ –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ ‚Üí –ì—Ä–∏–≤–Ω—ã: BTC 0.1 ‚Üí 50000 UAH
        result = await calculateUahAmount(fromCurrency, amount);
      } else {
        // üí∞ –ì—Ä–∏–≤–Ω—ã ‚Üí –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞: 50000 UAH ‚Üí BTC 0.1
        result = await calculateCryptoAmount(fromCurrency, amount);
      }

      return {
        amount: result.toFixed(8), // –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
        rate: result.rate, // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å
      };
    }),

  // üìù Mutation: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –Ω–∞ –æ–±–º–µ–Ω
  createOrder: publicProcedure
    .input(securityEnhancedCreateExchangeOrderSchema) // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –∑–∞–∫–∞–∑–∞
    .use(rateLimitMiddleware({ limit: 5, window: '1m' })) // üö¶ –ú–∞–∫—Å–∏–º—É–º 5 –∑–∞–∫–∞–∑–æ–≤ –≤ –º–∏–Ω—É—Ç—É
    .mutation(async ({ input, ctx }) => {
      // üõ°Ô∏è –ü–æ–ª–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:
      // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –≤–∞–ª—é—Ç
      // 2. –í–∞–ª–∏–¥–∞—Ü–∏—è email
      // 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ –¥–ª—è –¥–µ–ø–æ–∑–∏—Ç–∞
      // 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      // 5. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      // –ü–æ–¥—Ä–æ–±–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ –≤—ã—à–µ ‚¨ÜÔ∏è
    }),
});

// üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π API
// trpc.exchange.getCurrencyRate.useQuery({ from: 'BTC', to: 'UAH' })
// trpc.exchange.calculateAmount.useQuery({ fromCurrency: 'BTC', amount: 0.1, direction: 'crypto-to-uah' })
// trpc.exchange.createOrder.useMutation()
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä

### Unit —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ—Ü–µ–¥—É—Ä

```typescript
// tests/trpc/exchange.test.ts
import { createCallerFactory } from '../src/server/trpc/init';
import { exchangeRouter } from '../src/server/trpc/routers/exchange';

describe('Exchange Router', () => {
  const createCaller = createCallerFactory(exchangeRouter);

  it('should get currency rate', async () => {
    const caller = createCaller({
      // Mock –∫–æ–Ω—Ç–µ–∫—Å—Ç
      ip: '127.0.0.1',
      user: null,
      locale: 'en',
      getErrorMessage: key => key,
    });

    const result = await caller.getCurrencyRate({
      from: 'BTC',
      to: 'UAH',
    });

    expect(result.rate).toBeDefined();
    expect(typeof result.rate).toBe('string');
  });

  it('should handle invalid currency', async () => {
    const caller = createCaller(mockContext);

    await expect(
      caller.getCurrencyRate({
        from: 'INVALID',
        to: 'UAH',
      })
    ).rejects.toThrow('Unsupported currency');
  });
});
```

## üíª –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ

### –ü–æ—à–∞–≥–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–∞

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –º—ã –ø–æ–Ω–∏–º–∞–µ–º —Ç–µ–æ—Ä–∏—é, –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —Ä–æ—É—Ç–µ—Ä —Å –Ω—É–ª—è! –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∑–∞–∫—Ä–µ–ø–∏—Ç—å –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.

### –ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å —Ä–æ—É—Ç–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ß—Ç–æ –º—ã –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞–¥–∏–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. –î–æ–±–∞–≤–∏–º –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è, –æ—Ç–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
3. –ò—Å–ø–æ–ª—å–∑—É–µ–º middleware –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
4. –î–æ–±–∞–≤–∏–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–ª—è —Å–ø–∏—Å–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–ë–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–≤–æ–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
- –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º

–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ä–æ—É—Ç–µ—Ä `notifications.ts` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º–∏:

```typescript
// apps/web/src/server/trpc/routers/notifications.ts
import { z } from 'zod';
import { createTRPCRouter, publicProcedure } from '../init';
import { authMiddleware } from '../middleware/auth';

export const notificationsRouter = createTRPCRouter({
  // –ü–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  getMyNotifications: authMiddleware
    .input(
      z.object({
        page: z.number().default(1),
        limit: z.number().max(50).default(10),
      })
    )
    .query(async ({ input, ctx }) => {
      // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      return {
        notifications: [],
        total: 0,
        page: input.page,
      };
    }),

  // –û—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
  markAsRead: authMiddleware
    .input(
      z.object({
        notificationId: z.string(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
      return { success: true };
    }),

  // –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
  markAllAsRead: authMiddleware.mutation(async ({ ctx }) => {
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç–º–µ—Ç–∫–∏ –≤—Å–µ—Ö –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
    return { success: true };
  }),
});
```

### –®–∞–≥ 2: –î–æ–±–∞–≤—å—Ç–µ —Ä–æ—É—Ç–µ—Ä –≤ –≥–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä

```typescript
// apps/web/src/server/trpc/routers/index.ts
import { notificationsRouter } from './notifications';

export const appRouter = createTRPCRouter({
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–æ—É—Ç–µ—Ä—ã
  notifications: notificationsRouter, // üîî –î–æ–±–∞–≤–ª—è–µ–º —Ä–æ—É—Ç–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
});

// üéØ –¢–µ–ø–µ—Ä—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ:
// trpc.notifications.getMyNotifications.useQuery()
// trpc.notifications.markAsRead.useMutation()
// trpc.notifications.markAllAsRead.useMutation()
```

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–∞

```typescript
// tests/trpc/notifications.test.ts
import { createCallerFactory } from '../src/server/trpc/init';
import { notificationsRouter } from '../src/server/trpc/routers/notifications';

describe('Notifications Router', () => {
  const createCaller = createCallerFactory(notificationsRouter);

  it('should require authentication', async () => {
    const caller = createCaller({
      ip: '127.0.0.1',
      user: null, // –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      locale: 'en',
      getErrorMessage: key => key,
    });

    // –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    await expect(caller.getMyNotifications({ page: 1 })).rejects.toThrow('Authentication required');
  });

  it('should get notifications for authenticated user', async () => {
    const caller = createCaller({
      ip: '127.0.0.1',
      user: { id: '123', email: 'test@example.com' }, // –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      locale: 'en',
      getErrorMessage: key => key,
    });

    const result = await caller.getMyNotifications({ page: 1 });

    expect(result).toHaveProperty('notifications');
    expect(result).toHaveProperty('total');
    expect(result).toHaveProperty('page');
  });
});
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π

### –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è:

**ü§î –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è - –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∞ –ø–æ—Ç–æ–º –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:**

1. **–í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É Query –∏ Mutation?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>
   - **Query** - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (—á—Ç–µ–Ω–∏–µ), –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞, –º–æ–∂–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å—Å—è
   - **Mutation** - –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ), –∏–∑–º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞, –Ω–µ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è
   </details>

2. **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç middleware –≤ tRPC?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>

   Middleware –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–¥–æ** –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ –º–æ–∂–µ—Ç:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
   - –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–¥–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–≤—ã–±—Ä–æ—Å–∏—Ç—å –æ—à–∏–±–∫—É)
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
   </details>

3. **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω transformer (superjson)?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>

   JSON –Ω–µ —É–º–µ–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö:
   - `Date` –æ–±—ä–µ–∫—Ç—ã –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫–∏
   - `Map`, `Set`, `undefined` —Ç–µ—Ä—è—é—Ç—Å—è
   - `superjson` —Ä–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É, —Å–æ—Ö—Ä–∞–Ω—è—è —Ç–∏–ø—ã
   </details>

4. **–ö–∞–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–æ–º –∏ –∫–ª–∏–µ–Ω—Ç–æ–º?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>
   - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º `export type AppRouter = typeof appRouter` —Å —Å–µ—Ä–≤–µ—Ä–∞
   - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —ç—Ç–æ—Ç —Ç–∏–ø –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
   - TypeScript –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏ –∏—Ö —Ç–∏–ø—ã
   </details>

5. **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Zod?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>

   tRPC –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É Zod
   - –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –µ—ë —á–µ—Ä–µ–∑ `errorFormatter`
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
   - –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, –∫–∞–∫–∏–µ –ø–æ–ª—è –Ω–µ–≤–µ—Ä–Ω—ã
   </details>

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è:

**üéØ –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ —Å–≤–æ–µ–º—É —É—Ä–æ–≤–Ω—é:**

#### –£—Ä–æ–≤–µ–Ω—å 1: –ù–∞—á–∏–Ω–∞—é—â–∏–π

1. **–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å–æ–∑–¥–∞–π—Ç–µ middleware, –∫–æ—Ç–æ—Ä—ã–π –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
2. **–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É** - –¥–æ–±–∞–≤—å—Ç–µ –≤ notifications —Ä–æ—É—Ç–µ—Ä –ø—Ä–æ—Ü–µ–¥—É—Ä—É –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### –£—Ä–æ–≤–µ–Ω—å 2: –°—Ä–µ–¥–Ω–∏–π

3. **–°–æ–∑–¥–∞–π—Ç–µ middleware –¥–ª—è IP whitelist** - —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤
4. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** - —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤, –æ–±—â–∞—è —Å—É–º–º–∞)

#### –£—Ä–æ–≤–µ–Ω—å 3: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π

5. **–î–æ–±–∞–≤—å—Ç–µ rate limiting –¥–ª—è –≤—Å–µ—Ö mutations** - –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –≤—Å–µ –∏–∑–º–µ–Ω—è—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
6. **–°–æ–∑–¥–∞–π—Ç–µ subscription** - —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

**üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:**

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞
- –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ —Ç–∏–ø–∏–∑–∞—Ü–∏—é TypeScript
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

### üìñ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

- [tRPC Procedures](https://trpc.io/docs/server/procedures) - –ø–æ–¥—Ä–æ–±–Ω–æ –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö
- [tRPC Routers](https://trpc.io/docs/server/routers) - –∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤
- [tRPC Middleware](https://trpc.io/docs/server/middlewares) - —Å–æ–∑–¥–∞–Ω–∏–µ middleware
- [Error Handling](https://trpc.io/docs/server/error-handling) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

- üìÅ –ì—Ä—É–ø–ø–∏—Ä—É–π—Ç–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã
- üèóÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–æ—É—Ç–µ—Ä–æ–≤
- üîÑ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ middleware –º–µ–∂–¥—É —Ä–æ—É—Ç–µ—Ä–∞–º–∏

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- üõ°Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ security-enhanced —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- üö¶ –î–æ–±–∞–≤–ª—è–π—Ç–µ rate limiting –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö endpoint'–æ–≤
- üîê –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:**

- ‚úÖ –í—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø–æ—Å–ª–µ —Å—Ö–µ–º—ã Zod
- üß™ –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã —Å –º–æ–∫–∞–º–∏
- üìù –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
- üè∑Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–Ω—è—Ç–Ω—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è –ø—Ä–æ—Ü–µ–¥—É—Ä

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

- ‚ö° –ö–µ—à–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã query –ø—Ä–æ—Ü–µ–¥—É—Ä –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- üîÑ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
- üìä –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä

### üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?

–í —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–∫–µ –º—ã –∏–∑—É—á–∏–º:

- –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ —Ä–æ—É—Ç–µ—Ä—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å React Query
- –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ö—É–∫–∏ –¥–ª—è React
- –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

---

[‚Üê –£—Ä–æ–∫ 4.1](./lesson-4.1-rest-problems-trpc-solution.md) | [–£—Ä–æ–∫ 4.3 ‚Üí](./lesson-4.3-client-integration-react-query.md)
