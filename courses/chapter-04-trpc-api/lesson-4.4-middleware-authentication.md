# –£—Ä–æ–∫ 4.4: Middleware –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ tRPC

> **üéØ –¶–µ–ª—å —É—Ä–æ–∫–∞**: –û—Å–≤–æ–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üìñ –í–≤–µ–¥–µ–Ω–∏–µ

### –°–≤—è–∑—å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —É—Ä–æ–∫–∞–º–∏

–í –ø—Ä–æ—à–ª—ã—Ö —É—Ä–æ–∫–∞—Ö –º—ã —Å–æ–∑–¥–∞–ª–∏:

- **–£—Ä–æ–∫ 4.2**: –°–µ—Ä–≤–µ—Ä–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
- **–£—Ä–æ–∫ 4.3**: –ö–ª–∏–µ–Ω—Ç—Å–∫—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å React Query

**–ù–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞!** üö® –í—Å–µ –Ω–∞—à–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º:

```typescript
// –õ—é–±–æ–π –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑, –¥–∞–∂–µ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!
createOrder: publicProcedure.mutation(...)

// –õ—é–±–æ–π –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!
getAllUsers: publicProcedure.query(...)
```

**–ù—É–∂–Ω–∞ –∑–∞—â–∏—Ç–∞!** üõ°Ô∏è Middleware —Ä–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É.

### –ß—Ç–æ —Ç–∞–∫–æ–µ Middleware?

**Middleware** - —ç—Ç–æ **"–æ—Ö—Ä–∞–Ω–Ω–∏–∫ –Ω–∞ –≤—Ö–æ–¥–µ"** –≤ –≤–∞—à–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.

**–ê–Ω–∞–ª–æ–≥–∏—è —Å –Ω–æ—á–Ω—ã–º –∫–ª—É–±–æ–º:**

- **–ë–µ–∑ middleware** - –ª—é–±–æ–π –∑–∞—Ö–æ–¥–∏—Ç –∫—É–¥–∞ —Ö–æ—á–µ—Ç
- **–° middleware** - –æ—Ö—Ä–∞–Ω–Ω–∏–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã, –≤–æ–∑—Ä–∞—Å—Ç, –¥—Ä–µ—Å—Å-–∫–æ–¥

**Middleware –≤ tRPC:**

```typescript
// Middleware –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –î–û –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
const protectedProcedure = publicProcedure
  .use(checkAuth) // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  .use(checkPermissions) // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
  .use(logAction); // 3. –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ

// –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞
protectedProcedure.mutation(async ({ ctx }) => {
  // –ó–¥–µ—Å—å –º—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞
});
```

### –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ –∫—Ä–∏–ø—Ç–æ–±–∏—Ä–∂–µ?

**–†–µ–∞–ª—å–Ω—ã–µ —É–≥—Ä–æ–∑—ã:**

- üè¥‚Äç‚ò†Ô∏è **–•–∞–∫–µ—Ä—ã** –ø—ã—Ç–∞—é—Ç—Å—è —É–∫—Ä–∞—Å—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É
- ü§ñ **–ë–æ—Ç—ã** —Å–æ–∑–¥–∞—é—Ç —Ç—ã—Å—è—á–∏ —Ñ–µ–π–∫–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
- üë§ **–ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∏** –ø—ã—Ç–∞—é—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —á—É–∂–∏–º –∞–∫–∫–∞—É–Ω—Ç–∞–º
- üí∏ **–ú–æ—à–µ–Ω–Ω–∏–∫–∏** –æ–±—Ö–æ–¥—è—Ç –ª–∏–º–∏—Ç—ã –Ω–∞ –æ–±–º–µ–Ω

**–ß—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç middleware:**

- ‚úÖ –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã
- ‚úÖ –ê–¥–º–∏–Ω—ã –Ω–µ –º–æ–≥—É—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —á—É–∂–∏–º –¥–∞–Ω–Ω—ã–º –±–µ–∑ –ø—Ä–∞–≤
- ‚úÖ –õ–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç DDoS
- ‚úÖ –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π

### –ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å middleware

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ö–ª–∏–µ–Ω—Ç        ‚îÇ    ‚îÇ   Middleware     ‚îÇ    ‚îÇ   –ü—Ä–æ—Ü–µ–¥—É—Ä–∞     ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç      ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ –í—ã–ø–æ–ª–Ω—è–µ—Ç       ‚îÇ
‚îÇ –∑–∞–ø—Ä–æ—Å          ‚îÇ    ‚îÇ    —Ç–æ–∫–µ–Ω         ‚îÇ    ‚îÇ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ 2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç     ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ    –ø—Ä–∞–≤–∞         ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ 3. –õ–æ–≥–∏—Ä—É–µ—Ç      ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ                 ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÇ ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ—Ç     ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ –ü–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É ‚îÇ    ‚îÇ    –ø—Ä–∏ –æ—à–∏–±–∫–µ    ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –∏–∑—É—á–∏–º –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å middleware –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ API –≤ –ø—Ä–æ–µ–∫—Ç–µ ExchangeGO.

## üîê –û—Å–Ω–æ–≤—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –ü–æ–Ω–∏–º–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π

–ü—Ä–µ–∂–¥–µ —á–µ–º –ø–∏—Å–∞—Ç—å –∫–æ–¥, —Ä–∞–∑–±–µ—Ä–µ–º—Å—è —Å —Ç–µ—Ä–º–∏–Ω–∞–º–∏:

**üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (Authentication)** - "–ö—Ç–æ —Ç—ã?"

- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ—Ç, –∑–∞ –∫–æ–≥–æ —Å–µ–±—è –≤—ã–¥–∞–µ—Ç
- –ü—Ä–∏–º–µ—Ä: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞ –∏ –ø–∞—Ä–æ–ª—è

**üõ°Ô∏è –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (Authorization)** - "–ß—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –¥–µ–ª–∞—Ç—å?"

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º
- –ü—Ä–∏–º–µ—Ä: —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**üé≠ –†–æ–ª–∏ (Roles)** - "–ö–∞–∫–∞—è —É —Ç–µ–±—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å?"

- –ì—Ä—É–ø–ø—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –ü—Ä–∏–º–µ—Ä: USER, ADMIN, MODERATOR

**üîê –†–∞–∑—Ä–µ—à–µ–Ω–∏—è (Permissions)** - "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞"

- –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è
- –ü—Ä–∏–º–µ—Ä: "orders:create", "users:delete"

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω?

**JWT (JSON Web Token)** - —ç—Ç–æ "—Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–∞—Å–ø–æ—Ä—Ç" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```
–ó–∞–≥–æ–ª–æ–≤–æ–∫.–ü–æ–ª–µ–∑–Ω–∞—è_–Ω–∞–≥—Ä—É–∑–∫–∞.–ü–æ–¥–ø–∏—Å—å
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiIxMjMiLCJyb2xlIjoiVVNFUiJ9.signature
```

**–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ —Ç–æ–∫–µ–Ω–∞:**

```json
{
  "userId": "123",
  "email": "user@example.com",
  "role": "USER",
  "permissions": ["orders:create", "profile:update"],
  "exp": 1640995200 // –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è
}
```

**–ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–∫–µ–Ω–æ–º:**

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è ‚Üí —Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞–µ—Ç JWT
2. –ö–ª–∏–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç JWT –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
3. Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ ExchangeGO

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –£—Ä–æ–≤–Ω–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üåê Network Level    ‚îÇ Rate Limiting, IP –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üîë Authentication   ‚îÇ JWT —Ç–æ–∫–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üõ°Ô∏è Authorization    ‚îÇ –†–æ–ª–∏, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è, –≤–ª–∞–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìä Business Logic   ‚îÇ –õ–∏–º–∏—Ç—ã –æ–±–º–µ–Ω–∞, KYC –ø—Ä–æ–≤–µ—Ä–∫–∏          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üìù Audit & Logging  ‚îÇ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ middleware

### –ü—Ä–æ—Å—Ç–µ–π—à–∏–π middleware - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ù–∞—á–Ω–µ–º —Å —Å–∞–º–æ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ middleware, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:

```typescript
// src/server/trpc/middleware/logging.ts
import { t } from '../init';

// üìù –ü—Ä–æ—Å—Ç–µ–π—à–∏–π middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
export const loggingMiddleware = t.middleware(async ({ path, type, next }) => {
  console.log(`üîó tRPC ${type} ${path} - started`);

  const start = Date.now();

  try {
    // ‚è≠Ô∏è –í—ã–ø–æ–ª–Ω—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π middleware –∏–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É
    const result = await next();

    const duration = Date.now() - start;
    console.log(`‚úÖ tRPC ${type} ${path} - completed in ${duration}ms`);

    return result;
  } catch (error) {
    const duration = Date.now() - start;
    console.log(`‚ùå tRPC ${type} ${path} - failed in ${duration}ms:`, error.message);

    // üö® –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ
    throw error;
  }
});

// üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
const loggedProcedure = publicProcedure.use(loggingMiddleware);
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. Middleware –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ (`path`, `type`)
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. –í—ã–∑—ã–≤–∞–µ—Ç `next()` - –ø–µ—Ä–µ–¥–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–ª—å—à–µ
4. –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—É—Å–ø–µ—Ö –∏–ª–∏ –æ—à–∏–±–∫—É)

### –¢–∏–ø—ã –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

````typescript
// src/server/trpc/middleware/auth.ts
import { TRPCError } from '@trpc/server';
import { verify } from 'jsonwebtoken';
import type { Context } from '../context';

// üé≠ –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ
export enum UserRole {
  USER = 'user', // –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  ADMIN = 'admin', // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
  MODERATOR = 'moderator', // –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä
}

// üë§ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export interface AuthUser {
  id: string; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
  email: string; // Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  role: UserRole; // –†–æ–ª—å –≤ —Å–∏—Å—Ç–µ–º–µ
  isEmailVerified: boolean; // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ª–∏ email
  permissions: string[]; // –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
}

### Middleware –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–æ–∫–µ–Ω–∞

**–ó–∞–¥–∞—á–∞:** –ò–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å).

```typescript
// üîë Middleware –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT —Ç–æ–∫–µ–Ω–∞
export const parseAuthToken = t.middleware(async ({ ctx, next }) => {
  // üìã –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization
  const authHeader = ctx.req.headers.authorization;

  // üö´ –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  if (!authHeader?.startsWith('Bearer ')) {
    return next({
      ctx: {
        ...ctx,
        user: null, // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      },
    });
  }

  // üîç –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ "Bearer TOKEN"
  const token = authHeader.substring(7);

  try {
    // üîê –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω
    const payload = verify(token, process.env.JWT_SECRET!) as {
      userId: string;
      email: string;
      role: UserRole;
      permissions: string[];
    };

    // üìä –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    // –ó–∞—á–µ–º: —Ç–æ–∫–µ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–∞—Ä—ã–º, –∞ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
    const user = await ctx.db.user.findUnique({
      where: { id: payload.userId },
      include: {
        profile: true,
        permissions: true,
      },
    });

    // üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î
    if (!user) {
      throw new TRPCError({
        code: 'UNAUTHORIZED',
        message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
      });
    }

    // üîí –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
    if (!user.isActive) {
      throw new TRPCError({
        code: 'FORBIDDEN',
        message: '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
      });
    }

    // ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã - –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    return next({
      ctx: {
        ...ctx,
        user: {
          id: user.id,
          email: user.email,
          role: user.role as UserRole,
          isEmailVerified: user.isEmailVerified,
          permissions: user.permissions.map(p => p.name),
        } as AuthUser,
      },
    });
  } catch (error) {
    // üö® –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ tRPC –æ—à–∏–±–∫–∞ - –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
    if (error instanceof TRPCError) {
      throw error;
    }

    // üîê –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ = –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: '–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω',
    });
  }
});

// üí° –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã middleware:
// - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π ‚Üí ctx.user —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç ‚Üí ctx.user = null
// - –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π ‚Üí –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ UNAUTHORIZED

### Middleware –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ó–∞–¥–∞—á–∞:** –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∏–Ω–∞—á–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø.

```typescript
// üõ°Ô∏è Middleware —Ç—Ä–µ–±—É—é—â–∏–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
export const requireAuth = t.middleware(async ({ ctx, next }) => {
  // üö´ –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –±–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø
  if (!ctx.user) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
    });
  }

  // ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
  return next({
    ctx: {
      ...ctx,
      user: ctx.user, // üéØ TypeScript —Ç–µ–ø–µ—Ä—å –∑–Ω–∞–µ—Ç —á—Ç–æ user —Ç–æ—á–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    },
  });
});

// üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
const protectedProcedure = publicProcedure
  .use(parseAuthToken)  // 1. –ü–∞—Ä—Å–∏–º —Ç–æ–∫–µ–Ω (–º–æ–∂–µ—Ç –±—ã—Ç—å null)
  .use(requireAuth);    // 2. –¢—Ä–µ–±—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–±–ª–æ–∫–∏—Ä—É–µ–º –µ—Å–ª–∏ null)

// –¢–µ–ø–µ—Ä—å –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ ctx.user –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
protectedProcedure.query(({ ctx }) => {
  console.log(ctx.user.id); // ‚úÖ TypeScript –Ω–µ —Ä—É–≥–∞–µ—Ç—Å—è
});
```

### Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π

**–ó–∞–¥–∞—á–∞:** –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ —Ä–æ–ª—è–º–∏.

```typescript
// üé≠ Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export const requireRole = (roles: UserRole[]) =>
  t.middleware(async ({ ctx, next }) => {
    // üö´ –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!ctx.user) {
      throw new TRPCError({
        code: 'UNAUTHORIZED',
        message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
      });
    }

    // üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (!roles.includes(ctx.user.role)) {
      throw new TRPCError({
        code: 'FORBIDDEN',
        message: `–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å: ${roles.join(' –∏–ª–∏ ')}`,
      });
    }

    // ‚úÖ –†–æ–ª—å –ø–æ–¥—Ö–æ–¥–∏—Ç - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
    return next({
      ctx: {
        ...ctx,
        user: ctx.user,
      },
    });
  });

// üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

// –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
const adminProcedure = publicProcedure
  .use(parseAuthToken)
  .use(requireAuth)
  .use(requireRole([UserRole.ADMIN]));

// –î–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤
const moderatorProcedure = publicProcedure
  .use(parseAuthToken)
  .use(requireAuth)
  .use(requireRole([UserRole.ADMIN, UserRole.MODERATOR]));

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–æ—É—Ç–µ—Ä–µ
export const adminRouter = t.router({
  deleteUser: adminProcedure
    .input(z.object({ userId: z.string() }))
    .mutation(({ input, ctx }) => {
      // –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      return ctx.db.user.delete({ where: { id: input.userId } });
    }),
});
```

### Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π

**–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ.

**–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Ä–æ–ª—è–º–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏:**
- **–†–æ–ª–∏** - —ç—Ç–æ "–¥–æ–ª–∂–Ω–æ—Å—Ç–∏" (ADMIN, USER)
- **–†–∞–∑—Ä–µ—à–µ–Ω–∏—è** - —ç—Ç–æ "–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞" ("orders:delete", "users:create")

```typescript
// üîê Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
export const requirePermission = (permission: string) =>
  t.middleware(async ({ ctx, next }) => {
    // üö´ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!ctx.user) {
      throw new TRPCError({
        code: 'UNAUTHORIZED',
        message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
      });
    }

    // üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
    if (!ctx.user.permissions.includes(permission)) {
      throw new TRPCError({
        code: 'FORBIDDEN',
        message: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤: —Ç—Ä–µ–±—É–µ—Ç—Å—è ${permission}`,
      });
    }

    // ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –µ—Å—Ç—å - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
    return next({
      ctx: {
        ...ctx,
        user: ctx.user,
      },
    });
  });

// üí° –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –≤ –∫—Ä–∏–ø—Ç–æ–±–∏—Ä–∂–µ:
const PERMISSIONS = {
  // –ó–∞–∫–∞–∑—ã
  ORDERS_CREATE: 'orders:create',
  ORDERS_CANCEL: 'orders:cancel',
  ORDERS_REFUND: 'orders:refund',

  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
  USERS_VIEW: 'users:view',
  USERS_EDIT: 'users:edit',
  USERS_DELETE: 'users:delete',

  // –§–∏–Ω–∞–Ω—Å—ã
  FINANCE_WITHDRAW: 'finance:withdraw',
  FINANCE_DEPOSIT: 'finance:deposit',
} as const;

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–æ—É—Ç–µ—Ä–µ
export const exchangeRouter = t.router({
  // –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ - —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
  refundOrder: publicProcedure
    .use(parseAuthToken)
    .use(requireAuth)
    .use(requirePermission(PERMISSIONS.ORDERS_REFUND))
    .input(z.object({ orderId: z.string(), reason: z.string() }))
    .mutation(({ input, ctx }) => {
      // –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø—Ä–∞–≤–æ–º "orders:refund" –º–æ–≥—É—Ç –¥–µ–ª–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç—ã
      return ctx.exchangeService.processRefund(input);
    }),
});
```

### Middleware –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

**–ó–∞–¥–∞—á–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π email, KYC –∏ —Ç.–¥.).

```typescript
// üìß Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–≥–æ email
export const requireEmailVerification = t.middleware(async ({ ctx, next }) => {
  // üö´ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  if (!ctx.user) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
    });
  }

  // üìß –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
  if (!ctx.user.isEmailVerified) {
    throw new TRPCError({
      code: 'FORBIDDEN',
      message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email',
    });
  }

  // ‚úÖ Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
  return next({
    ctx: {
      ...ctx,
      user: ctx.user,
    },
  });
});

// üÜî Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ KYC –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
export const requireKYCVerification = t.middleware(async ({ ctx, next }) => {
  if (!ctx.user) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
    });
  }

  // üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º KYC —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
  const kycStatus = await ctx.db.userKyc.findUnique({
    where: { userId: ctx.user.id },
  });

  if (!kycStatus?.isVerified) {
    throw new TRPCError({
      code: 'FORBIDDEN',
      message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–∏—á–Ω–æ—Å—Ç–∏ (KYC)',
    });
  }

  return next({
    ctx: {
      ...ctx,
      user: ctx.user,
      kycVerified: true, // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    },
  });
});

// üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

// –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ - —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
const basicProcedure = publicProcedure
  .use(parseAuthToken)
  .use(requireAuth);

// –û–ø–µ—Ä–∞—Ü–∏–∏ —Å email - —Ç—Ä–µ–±—É—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π email
const emailVerifiedProcedure = basicProcedure
  .use(requireEmailVerification);

// –ö—Ä—É–ø–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ - —Ç—Ä–µ–±—É—é—Ç KYC
const kycVerifiedProcedure = emailVerifiedProcedure
  .use(requireKYCVerification);

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
export const exchangeRouter = t.router({
  // –ü—Ä–æ—Å–º–æ—Ç—Ä –∫—É—Ä—Å–æ–≤ - –¥–ª—è –≤—Å–µ—Ö
  getCurrencyRate: publicProcedure.query(...),

  // –ú–µ–ª–∫–∏–µ –∑–∞–∫–∞–∑—ã - —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
  createSmallOrder: basicProcedure.mutation(...),

  // –°—Ä–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π email
  createMediumOrder: emailVerifiedProcedure.mutation(...),

  // –ö—Ä—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã - –ø–æ–ª–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
  createLargeOrder: kycVerifiedProcedure.mutation(...),
});
````

## üìä Rate Limiting - –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

### –ß—Ç–æ —Ç–∞–∫–æ–µ Rate Limiting?

**Rate Limiting** - —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.

**–ó–∞—á–µ–º –Ω—É–∂–Ω–æ:**

- üõ°Ô∏è **–ó–∞—â–∏—Ç–∞ –æ—Ç DDoS** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É —Å–µ—Ä–≤–µ—Ä–∞
- ü§ñ **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–æ—Ç–æ–≤** - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏
- ‚öñÔ∏è **–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - –Ω–µ –¥–∞–µ—Ç –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞–±—Ä–∞—Ç—å –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã
- üí∞ **–ó–∞—â–∏—Ç–∞ –±–∏–∑–Ω–µ—Å–∞** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –≤ –∫—Ä–∏–ø—Ç–æ–±–∏—Ä–∂–µ

**–ü—Ä–∏–º–µ—Ä—ã –∞—Ç–∞–∫ –±–µ–∑ Rate Limiting:**

- –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç 1000 –∑–∞–∫–∞–∑–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É ‚Üí —Å–µ—Ä–≤–µ—Ä –ø–∞–¥–∞–µ—Ç
- –•–∞–∫–µ—Ä –ø—ã—Ç–∞–µ—Ç—Å—è 10000 –ø–∞—Ä–æ–ª–µ–π –≤ –º–∏–Ω—É—Ç—É ‚Üí –≤–∑–ª–∞–º—ã–≤–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç—ã
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç —Å–ø–∞–º–∏—Ç API ‚Üí –≤–∞—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

### –ü—Ä–æ—Å—Ç–æ–π Rate Limiting middleware

```typescript
// src/server/trpc/middleware/rateLimit.ts
import { TRPCError } from '@trpc/server';

// üìä –ü—Ä–æ—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å—á–µ—Ç—á–∏–∫–æ–≤ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis)
const requestCounts = new Map<string, { count: number; resetTime: number }>();

interface RateLimitConfig {
  maxRequests: number; // –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤
  windowMs: number; // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
}

export const rateLimit = (config: RateLimitConfig) =>
  t.middleware(async ({ ctx, next }) => {
    // üîë –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const key = ctx.user?.id || ctx.req.ip || 'anonymous';
    const now = Date.now();

    // üìä –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—á–µ—Ç—á–∏–∫
    const current = requestCounts.get(key);

    // üîÑ –ï—Å–ª–∏ –æ–∫–Ω–æ –∏—Å—Ç–µ–∫–ª–æ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
    if (!current || now > current.resetTime) {
      requestCounts.set(key, {
        count: 1,
        resetTime: now + config.windowMs,
      });
      return next();
    }

    // üö´ –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç - –±–ª–æ–∫–∏—Ä—É–µ–º
    if (current.count >= config.maxRequests) {
      throw new TRPCError({
        code: 'TOO_MANY_REQUESTS',
        message: `–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç: –º–∞–∫—Å–∏–º—É–º ${config.maxRequests} –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ ${config.windowMs}–º—Å`,
      });
    }

    // ‚ûï –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
    current.count++;
    return next();
  });

// üí° –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
export const standardRateLimit = rateLimit({
  maxRequests: 100, // 100 –∑–∞–ø—Ä–æ—Å–æ–≤
  windowMs: 15 * 60 * 1000, // –∑–∞ 15 –º–∏–Ω—É—Ç
});

// –°—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
export const strictRateLimit = rateLimit({
  maxRequests: 10, // 10 –∑–∞–ø—Ä–æ—Å–æ–≤
  windowMs: 60 * 1000, // –∑–∞ 1 –º–∏–Ω—É—Ç—É
});

// –õ–∏–º–∏—Ç –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞)
export const authRateLimit = rateLimit({
  maxRequests: 5, // 5 –ø–æ–ø—ã—Ç–æ–∫
  windowMs: 15 * 60 * 1000, // –∑–∞ 15 –º–∏–Ω—É—Ç
});
```

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏—Ç

### –ó–∞—á–µ–º –Ω—É–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ?

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —ç—Ç–æ "—á–µ—Ä–Ω—ã–π —è—â–∏–∫" –≤–∞—à–µ–≥–æ API, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:**

- üîç **–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤** - –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ —á—Ç–æ –¥–µ–ª–∞–ª
- üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - –∫–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ
- üö® **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞—Ç–∞–∫** - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- üìã **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º** - –º–Ω–æ–≥–∏–µ —Ä–µ–≥—É–ª—è—Ç–æ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –ª–æ–≥–∏

### Middleware –¥–ª—è –∞—É–¥–∏—Ç–∞

```typescript
// src/server/trpc/middleware/audit.ts
import { TRPCError } from '@trpc/server';
import type { Context } from '../context';

// üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–∞ –¥–ª—è –∞—É–¥–∏—Ç–∞
interface AuditLog {
  id: string;
  userId?: string; // –ö—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª –¥–µ–π—Å—Ç–≤–∏–µ
  action: string; // –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ
  resource: string; // –° –∫–∞–∫–∏–º —Ä–µ—Å—É—Ä—Å–æ–º
  details: Record<string, any>; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  ip: string; // IP –∞–¥—Ä–µ—Å
  userAgent: string; // –ë—Ä–∞—É–∑–µ—Ä/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  timestamp: Date; // –ö–æ–≥–¥–∞ –ø—Ä–æ–∏–∑–æ—à–ª–æ
  success: boolean; // –£—Å–ø–µ—à–Ω–æ –∏–ª–∏ –Ω–µ—Ç
  error?: string; // –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ –±—ã–ª–∞)
}

export const auditMiddleware = t.middleware(async ({ ctx, next, path, type, input }) => {
  const startTime = Date.now();

  // üåê –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—Ä–æ—Å–µ
  const ip = ctx.req.ip || ctx.req.socket.remoteAddress || 'unknown';
  const userAgent = ctx.req.headers['user-agent'] || 'unknown';

  // üìù –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –ª–æ–≥
  const auditLog: Partial<AuditLog> = {
    userId: ctx.user?.id,
    action: `${type}:${path}`, // –ü—Ä–∏–º–µ—Ä: "mutation:exchange.createOrder"
    resource: path, // –ü—Ä–∏–º–µ—Ä: "exchange.createOrder"
    details: {
      input: sanitizeInput(input), // üîí –£–±–∏—Ä–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      method: type,
    },
    ip,
    userAgent,
    timestamp: new Date(),
  };

  try {
    // ‚è≠Ô∏è –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä—É
    const result = await next();
    const duration = Date.now() - startTime;

    // ‚úÖ –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    console.log(`‚úÖ ${auditLog.action} - success in ${duration}ms`, {
      userId: auditLog.userId,
      ip: auditLog.ip,
    });

    // üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –ë–î
    if (shouldAuditToDB(path)) {
      await ctx.db.auditLog.create({
        data: {
          ...auditLog,
          success: true,
          details: {
            ...auditLog.details,
            duration,
          },
        } as AuditLog,
      });
    }

    return result;
  } catch (error) {
    const duration = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : 'Unknown error';

    // üö® –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
    console.error(`‚ùå ${auditLog.action} - failed in ${duration}ms:`, {
      error: errorMessage,
      userId: auditLog.userId,
      ip: auditLog.ip,
    });

    // üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—à–∏–±–∫–∏ –≤ –ë–î (–æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
    if (shouldAuditToDB(path)) {
      await ctx.db.auditLog.create({
        data: {
          ...auditLog,
          success: false,
          error: errorMessage,
          details: {
            ...auditLog.details,
            duration,
          },
        } as AuditLog,
      });
    }

    // üö® –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ
    throw error;
  }
});

// üîí –£–±–∏—Ä–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–æ–≤
function sanitizeInput(input: any): any {
  if (!input) return input;

  // üö´ –°–ø–∏—Å–æ–∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
  const sensitive = ['password', 'token', 'secret', 'key', 'pin', 'ssn', 'passport'];
  const sanitized = { ...input };

  for (const key of Object.keys(sanitized)) {
    if (sensitive.some(s => key.toLowerCase().includes(s))) {
      sanitized[key] = '[REDACTED]'; // –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    }
  }

  return sanitized;
}

// üéØ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ –ë–î
function shouldAuditToDB(path: string): boolean {
  const criticalPaths = [
    'auth.', // –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    'admin.', // –í—Å–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    'exchange.createOrder', // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
    'exchange.updateOrderStatus', // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–æ–≤
    'user.updateProfile', // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    'user.changePassword', // –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
    'finance.', // –í—Å–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  ];

  return criticalPaths.some(p => path.startsWith(p));
}

// üí° –ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:
// ‚úÖ mutation:exchange.createOrder - success in 245ms { userId: "123", ip: "192.168.1.1" }
// ‚ùå mutation:auth.login - failed in 12ms: Invalid credentials { userId: undefined, ip: "192.168.1.1" }
```

## üõ°Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä

### –ö–æ–º–ø–æ–∑–∏—Ü–∏—è middleware

**–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è?**
–ö–æ–º–ø–æ–∑–∏—Ü–∏—è - —ç—Ç–æ **–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö middleware** –≤ –æ–¥–Ω—É –∑–∞—â–∏—â–µ–Ω–Ω—É—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É.

**–ê–Ω–∞–ª–æ–≥–∏—è —Å –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π –æ—Ö—Ä–∞–Ω–æ–π:**

```
–í—Ö–æ–¥ –≤ –±–∞–Ω–∫ ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Üí –ú–µ—Ç–∞–ª–ª–æ–¥–µ—Ç–µ–∫—Ç–æ—Ä ‚Üí –°–∫–∞–Ω–µ—Ä –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤ ‚Üí –°–µ–π—Ñ
     ‚Üì              ‚Üì                ‚Üì               ‚Üì              ‚Üì
publicProcedure ‚Üí parseToken ‚Üí requireAuth ‚Üí requireRole ‚Üí yourProcedure
```

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**

1. –ö–∞–∂–¥—ã–π middleware –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É
2. –ï—Å–ª–∏ –ª—é–±–æ–π middleware –±–ª–æ–∫–∏—Ä—É–µ—Ç - –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
3. –ï—Å–ª–∏ –≤—Å–µ middleware –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞

### –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã —Å middleware

```typescript
// src/server/trpc/init.ts
import { parseAuthToken, requireAuth, requireRole, requirePermission } from './middleware/auth';
import { auditMiddleware } from './middleware/audit';
import { standardRateLimit, strictRateLimit, authRateLimit } from './middleware/rateLimit';

// üåê –ü—É–±–ª–∏—á–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ (–¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º)
export const publicProcedure = t.procedure
  .use(parseAuthToken) // üîç –ü–∞—Ä—Å–∏–º —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å, –Ω–æ –Ω–µ —Ç—Ä–µ–±—É–µ–º
  .use(auditMiddleware); // üìù –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

// üîê –ó–∞—â–∏—â–µ–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)
export const protectedProcedure = t.procedure
  .use(parseAuthToken) // üîç –ü–∞—Ä—Å–∏–º —Ç–æ–∫–µ–Ω
  .use(requireAuth) // üõ°Ô∏è –¢—Ä–µ–±—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  .use(auditMiddleware) // üìù –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏—è
  .use(standardRateLimit); // üö¶ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤

// üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)
export const adminProcedure = t.procedure
  .use(parseAuthToken)
  .use(requireAuth)
  .use(requireRole([UserRole.ADMIN])) // üé≠ –¢–æ–ª—å–∫–æ —Ä–æ–ª—å ADMIN
  .use(auditMiddleware)
  .use(strictRateLimit); // üö¶ –°—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

// üëÆ –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—Å–∫–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ (–∞–¥–º–∏–Ω—ã + –º–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã)
export const moderatorProcedure = t.procedure
  .use(parseAuthToken)
  .use(requireAuth)
  .use(requireRole([UserRole.ADMIN, UserRole.MODERATOR])) // üé≠ –î–≤–µ —Ä–æ–ª–∏
  .use(auditMiddleware);

// üîë –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
export const permissionProcedure = (permission: string) =>
  t.procedure
    .use(parseAuthToken)
    .use(requireAuth)
    .use(requirePermission(permission)) // üîê –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    .use(auditMiddleware);

// üîí –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞)
export const authProcedure = t.procedure.use(auditMiddleware).use(authRateLimit); // üö¶ –°—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç –¥–ª—è –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞

// üí° –ü–æ—Ä—è–¥–æ–∫ middleware –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ!
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: parseToken ‚Üí requireAuth ‚Üí requireRole
// ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: requireAuth ‚Üí parseToken (requireAuth –Ω–µ –Ω–∞–π–¥–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

// üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç: —É –Ω–∞—Å –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–µ "—à–∞–±–ª–æ–Ω—ã" –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
// –ü—Ä–æ—Å—Ç–æ –≤—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–æ—É—Ç–µ—Ä–∞—Ö

**–¢–µ–ø–µ—Ä—å –ø—Ä–∏–º–µ–Ω–∏–º –Ω–∞—à–∏ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Ä–æ—É—Ç–µ—Ä–µ –∫—Ä–∏–ø—Ç–æ–±–∏—Ä–∂–∏:**

```typescript
// src/server/trpc/routers/exchange.ts
import { z } from 'zod';
import { TRPCError } from '@trpc/server';
import { publicProcedure, protectedProcedure, adminProcedure, permissionProcedure } from '../init';

export const exchangeRouter = t.router({
  // üåê –ü—É–±–ª–∏—á–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ - –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç (–¥–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–º)
  getCurrencyRate: publicProcedure
    .input(
      z.object({
        from: z.enum(['BTC', 'ETH', 'USDT']),
        to: z.enum(['UAH', 'USD', 'EUR']),
      })
    )
    .query(async ({ input, ctx }) => {
      // ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–º, –≤–∫–ª—é—á–∞—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      // ctx.user –º–æ–∂–µ—Ç –±—ã—Ç—å null - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
      const rate = await ctx.exchangeService.getCurrentRate(input.from, input.to);
      return { rate };
    }),

  // üîê –ó–∞—â–∏—â–µ–Ω–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (—Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ)
  createOrder: protectedProcedure
    .input(
      z.object({
        fromCurrency: z.enum(['BTC', 'ETH', 'USDT']),
        toCurrency: z.enum(['UAH', 'USD']),
        amount: z.number().positive(),
        email: z.string().email(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      // ‚úÖ ctx.user –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è requireAuth
      const order = await ctx.exchangeService.createOrder({
        ...input,
        userId: ctx.user.id, // üéØ –ë–µ—Ä–µ–º ID –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
      });

      return {
        id: order.id,
        status: order.status,
        depositAddress: order.depositAddress,
      };
    }),

  // üìß –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π email
  createLargeOrder: protectedProcedure
    .use(requireEmailVerification) // üìß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    .input(
      z.object({
        fromCurrency: z.enum(['BTC', 'ETH']),
        toCurrency: z.string(),
        amount: z.number().min(1000), // –ú–∏–Ω–∏–º—É–º $1000
      })
    )
    .mutation(async ({ input, ctx }) => {
      // üí∞ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Å—É–º–º
      if (input.amount > 10000) {
        const userKyc = await ctx.db.userKyc.findUnique({
          where: { userId: ctx.user.id },
        });

        if (!userKyc?.isVerified) {
          throw new TRPCError({
            code: 'FORBIDDEN',
            message: '–î–ª—è –∑–∞–∫–∞–∑–æ–≤ —Å–≤—ã—à–µ $10,000 —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è KYC',
          });
        }
      }

      return ctx.exchangeService.createOrder({
        ...input,
        userId: ctx.user.id,
      });
    }),

  // üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)
  updateOrderStatus: adminProcedure
    .input(
      z.object({
        orderId: z.string(),
        status: z.enum(['pending', 'processing', 'completed', 'cancelled']),
        reason: z.string().optional(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      // üé≠ –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ä–æ–ª—å—é ADMIN –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å
      const order = await ctx.exchangeService.updateOrderStatus({
        ...input,
        updatedBy: ctx.user.id, // üìù –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫—Ç–æ –∏–∑–º–µ–Ω–∏–ª —Å—Ç–∞—Ç—É—Å
      });

      return order;
    }),

  // üîë –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
  refundOrder: permissionProcedure('orders:refund')
    .input(
      z.object({
        orderId: z.string(),
        amount: z.number().positive(),
        reason: z.string(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      // üîê –¢—Ä–µ–±—É–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ 'orders:refund'
      // –ù–µ –≤—Å–µ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –¥–µ–ª–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç—ã!
      const refund = await ctx.exchangeService.processRefund({
        ...input,
        processedBy: ctx.user.id,
      });

      return refund;
    }),

  // üìä –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞)
  getMyOrdersStats: protectedProcedure.query(async ({ ctx }) => {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    return ctx.exchangeService.getUserStats(ctx.user.id);
  }),

  getAllOrdersStats: adminProcedure.query(async ({ ctx }) => {
    // –ê–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    return ctx.exchangeService.getGlobalStats();
  }),
});

// üí° –†–µ–∑—É–ª—å—Ç–∞—Ç: —É –Ω–∞—Å –µ—Å—Ç—å API —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ –¥–æ—Å—Ç—É–ø–∞:
// üåê –ü—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç
// üîê –õ–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤, –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö
// üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
// üîë –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è - –≤–æ–∑–≤—Ä–∞—Ç—ã, –æ—Å–æ–±—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
```

## üîí –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–±–ª–µ–º–∞ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –∑–∞–∫–∞–∑ –ø–æ ID.

**–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è:**

```typescript
// ‚ùå –ü–ª–æ—Ö–æ: –ª—é–±–æ–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª—é–±–æ–π –∑–∞–∫–∞–∑
getOrder: protectedProcedure.input(z.object({ orderId: z.string() })).query(({ input, ctx }) => {
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è B!
  return ctx.db.order.findUnique({ where: { id: input.orderId } });
});
```

**–†–µ—à–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–ª–∞–¥–µ–Ω–∏—è:**

```typescript
// ‚úÖ –•–æ—Ä–æ—à–æ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–∫–∞–∑—ã
getMyOrder: protectedProcedure
  .input(z.object({ orderId: z.string() }))
  .query(async ({ input, ctx }) => {
    const order = await ctx.db.order.findUnique({
      where: { id: input.orderId },
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    if (!order || order.userId !== ctx.user.id) {
      throw new TRPCError({
        code: 'NOT_FOUND',
        message: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω',
      });
    }

    return order;
  });
```

### Middleware –¥–ª—è –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏

```typescript
// src/server/trpc/middleware/ownership.ts

// üè† –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏
export const requireResourceOwnership = <T extends { userId?: string }>(
  resourceGetter: (input: any, ctx: Context) => Promise<T | null>
) =>
  t.middleware(async ({ ctx, input, next }) => {
    // üö´ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    if (!ctx.user) {
      throw new TRPCError({
        code: 'UNAUTHORIZED',
        message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
      });
    }

    // üîç –ü–æ–ª—É—á–∞–µ–º —Ä–µ—Å—É—Ä—Å –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    const resource = await resourceGetter(input, ctx);

    // üö´ –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
    if (!resource) {
      throw new TRPCError({
        code: 'NOT_FOUND',
        message: '–†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω',
      });
    }

    // üë®‚Äçüíº –ê–¥–º–∏–Ω—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–µ—Å—É—Ä—Å–∞–º
    if (ctx.user.role === UserRole.ADMIN) {
      return next({
        ctx: {
          ...ctx,
          resource, // üì¶ –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        },
      });
    }

    // üîí –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–∏–º —Ä–µ—Å—É—Ä—Å–∞–º
    if (resource.userId !== ctx.user.id) {
      throw new TRPCError({
        code: 'FORBIDDEN',
        message: '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–µ—Å—É—Ä—Å—É',
      });
    }

    // ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
    return next({
      ctx: {
        ...ctx,
        resource, // üì¶ –ü–µ—Ä–µ–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
      },
    });
  });

// üí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ä–æ—É—Ç–µ—Ä–µ
export const userRouter = t.router({
  // üìã –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ –∑–∞–∫–∞–∑–∞
  getMyOrder: protectedProcedure
    .input(z.object({ orderId: z.string() }))
    .use(
      requireResourceOwnership(async (input, ctx) => {
        // üîç –ò—â–µ–º –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        return ctx.db.order.findUnique({
          where: { id: input.orderId },
          include: {
            transactions: true, // –í–∫–ª—é—á–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            statusHistory: true, // –ò –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤
          },
        });
      })
    )
    .query(async ({ ctx }) => {
      // ‚úÖ ctx.resource —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑
      // –ú—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ –æ–Ω –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      return ctx.resource;
    }),

  // ‚úèÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫ –∫ –∑–∞–∫–∞–∑—É
  updateMyOrderNotes: protectedProcedure
    .input(
      z.object({
        orderId: z.string(),
        notes: z.string().max(500),
      })
    )
    .use(
      requireResourceOwnership(async (input, ctx) => {
        return ctx.db.order.findUnique({
          where: { id: input.orderId },
        });
      })
    )
    .mutation(async ({ input, ctx }) => {
      // üìù –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–∞)
      return ctx.db.order.update({
        where: { id: input.orderId },
        data: {
          notes: input.notes,
          updatedAt: new Date(),
        },
      });
    }),

  // üóëÔ∏è –û—Ç–º–µ–Ω–∞ —Å–≤–æ–µ–≥–æ –∑–∞–∫–∞–∑–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –ø–æ–∑–≤–æ–ª—è–µ—Ç)
  cancelMyOrder: protectedProcedure
    .input(z.object({ orderId: z.string() }))
    .use(
      requireResourceOwnership(async (input, ctx) => {
        return ctx.db.order.findUnique({
          where: { id: input.orderId },
        });
      })
    )
    .mutation(async ({ input, ctx }) => {
      // üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
      if (!['pending', 'processing'].includes(ctx.resource.status)) {
        throw new TRPCError({
          code: 'BAD_REQUEST',
          message: '–ó–∞–∫–∞–∑ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –≤ —Ç–µ–∫—É—â–µ–º —Å—Ç–∞—Ç—É—Å–µ',
        });
      }

      // ‚ùå –û—Ç–º–µ–Ω—è–µ–º –∑–∞–∫–∞–∑
      return ctx.exchangeService.cancelOrder(input.orderId, ctx.user.id);
    }),
});

// üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:
// ‚úÖ –ö–æ–¥ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ middleware
// ‚úÖ –ê–¥–º–∏–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–µ—Å—É—Ä—Å–∞–º
// ‚úÖ –†–µ—Å—É—Ä—Å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä—É
// ‚úÖ TypeScript –∑–Ω–∞–µ—Ç —á—Ç–æ resource —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ
```

## üíª –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ

### –ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è –∫—Ä–∏–ø—Ç–æ–±–∏—Ä–∂–∏

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:**
–°–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Ö —É—Ä–æ–≤–Ω—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.

**–ë–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

- **–ù–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: –º–∞–∫—Å–∏–º—É–º $100 –≤ –¥–µ–Ω—å
- **Email –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ**: –º–∞–∫—Å–∏–º—É–º $1,000 –≤ –¥–µ–Ω—å
- **KYC –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ**: –º–∞–∫—Å–∏–º—É–º $10,000 –≤ –¥–µ–Ω—å
- **VIP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ:**
–°–æ–∑–¥–∞–π—Ç–µ middleware –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–Ω–µ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞.

### –®–∞–±–ª–æ–Ω –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

```typescript
// src/server/trpc/middleware/exchangeLimits.ts
import { TRPCError } from '@trpc/server';

// üí∞ –õ–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
export const DAILY_LIMITS = {
  UNVERIFIED: 100, // $100 - —Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  EMAIL_VERIFIED: 1000, // $1,000 - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω email
  KYC_VERIFIED: 10000, // $10,000 - –ø—Ä–æ–π–¥–µ–Ω KYC
  VIP: Infinity, // –ë–µ–∑ –ª–∏–º–∏—Ç–æ–≤ - VIP —Å—Ç–∞—Ç—É—Å
} as const;

export const checkExchangeLimits = t.middleware(async ({ ctx, input, next }) => {
  if (!ctx.user) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
    });
  }

  // üéØ TODO: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  // –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ ctx.user.isEmailVerified –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ KYC —Å—Ç–∞—Ç—É—Å

  // üìä TODO: –ü–æ–ª—É—á–∏—Ç—å —Å—É–º–º—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è
  // –ü–æ–¥—Å–∫–∞–∑–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ctx.db.order.aggregate —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –¥–∞—Ç–µ

  // üí∞ TODO: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç –ª–∏–º–∏—Ç
  // –ü–æ–¥—Å–∫–∞–∑–∫–∞: —Å—Ä–∞–≤–Ω–∏—Ç–µ (—Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è_—Å—É–º–º–∞ + input.amount) —Å –ª–∏–º–∏—Ç–æ–º

  // ‚úÖ TODO: –ï—Å–ª–∏ –≤—Å–µ –æ–∫ - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
  return next();
});

// üí° –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ —Ä–æ—É—Ç–µ—Ä–µ
export const exchangeRouter = t.router({
  createOrder: protectedProcedure
    .use(checkExchangeLimits) // üö¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç—ã –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
    .input(
      z.object({
        fromCurrency: z.string(),
        toCurrency: z.string(),
        amount: z.number().positive(),
      })
    )
    .mutation(async ({ input, ctx }) => {
      // üéØ –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
      // –ó–¥–µ—Å—å –º—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ –ª–∏–º–∏—Ç—ã –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω—ã
      return ctx.exchangeService.createOrder({
        ...input,
        userId: ctx.user.id,
      });
    }),
});

// üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è:
// 1. –î–æ–±–∞–≤—å—Ç–µ middleware –¥–ª—è –º–µ—Å—è—á–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤
// 2. –°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–≤—ã—à–µ–Ω–∏–π –ª–∏–º–∏—Ç–æ–≤
// 3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ –ª–∏–º–∏—Ç—É
// 4. –î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –ª–∏–º–∏—Ç–æ–≤
```

### –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

```typescript
// üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function getUserLevel(user: AuthUser, ctx: Context) {
  if (user.isVip) return 'VIP';

  const kyc = await ctx.db.userKyc.findUnique({
    where: { userId: user.id },
  });

  if (kyc?.isVerified) return 'KYC_VERIFIED';
  if (user.isEmailVerified) return 'EMAIL_VERIFIED';
  return 'UNVERIFIED';
}

// üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É–º–º—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è
async function getTodayAmount(userId: string, ctx: Context) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const result = await ctx.db.order.aggregate({
    where: {
      userId,
      createdAt: { gte: today },
      status: { in: ['completed', 'processing'] },
    },
    _sum: { amount: true },
  });

  return result._sum.amount || 0;
}
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–Ω–∞–Ω–∏–π

### –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è:

**ü§î –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è - –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∞ –ø–æ—Ç–æ–º –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:**

1. **–ß—Ç–æ —Ç–∞–∫–æ–µ middleware –≤ tRPC –∏ –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>

   Middleware - —ç—Ç–æ "–æ—Ö—Ä–∞–Ω–Ω–∏–∫" –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –î–û –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ –º–æ–∂–µ—Ç:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
   - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
   - –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç (–¥–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –∏ –∏–∑–º–µ—Ä—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   </details>

2. **–í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `parseAuthToken` –∏ `requireAuth`?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>
   - **parseAuthToken** - –ø–∞—Ä—Å–∏—Ç —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å, –Ω–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –µ–≥–æ (–¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä)
   - **requireAuth** - —Ç—Ä–µ–±—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –±–ª–æ–∫–∏—Ä—É–µ—Ç –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç
   - –û–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–º–µ—Å—Ç–µ: —Å–Ω–∞—á–∞–ª–∞ parseAuthToken, –ø–æ—Ç–æ–º requireAuth
   </details>

3. **–ö–∞–∫ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ middleware –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä—É?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>

   –ß–µ—Ä–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ `next({ ctx })`:

   ```typescript
   return next({
     ctx: {
       ...ctx,
       user: userData, // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       resource: order, // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å
     },
   });
   ```

   </details>

4. **–ß—Ç–æ —Ç–∞–∫–æ–µ Rate Limiting –∏ –∑–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>

   Rate Limiting - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –≤—Ä–µ–º—è:
   - **–ó–∞—â–∏—Ç–∞ –æ—Ç DDoS** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É —Å–µ—Ä–≤–µ—Ä–∞
   - **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–æ—Ç–æ–≤** - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏
   - **–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - –Ω–µ –¥–∞–µ—Ç –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∑–∞–±—Ä–∞—Ç—å –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã
   </details>

5. **–ó–∞—á–µ–º –Ω—É–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏—Ç –≤ API?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>
   - **–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤** - –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ —á—Ç–æ –¥–µ–ª–∞–ª
   - **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - –∫–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ
   - **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞—Ç–∞–∫** - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
   - **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º** - —Ä–µ–≥—É–ª—è—Ç–æ—Ä—ã —á–∞—Å—Ç–æ —Ç—Ä–µ–±—É—é—Ç –ª–æ–≥–∏
   </details>

6. **–ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>

   –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–∏–º —Ä–µ—Å—É—Ä—Å–∞–º:
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –Ω–µ –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è B
   - –ê–¥–º–∏–Ω—ã –æ–±—ã—á–Ω–æ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–µ—Å—É—Ä—Å–∞–º
   - –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ middleware –∏–ª–∏ –≤ —Å–∞–º–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä–µ
   </details>

7. **–ü–æ—á–µ–º—É –≤–∞–∂–µ–Ω –ø–æ—Ä—è–¥–æ–∫ middleware?**
   <details>
   <summary>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</summary>

   Middleware –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É, –∫–∞–∂–¥—ã–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ:
   - ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: `parseToken ‚Üí requireAuth ‚Üí requireRole`
   - ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: `requireAuth ‚Üí parseToken` (requireAuth –Ω–µ –Ω–∞–π–¥–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   </details>

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è:

**üéØ –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ —Å–≤–æ–µ–º—É —É—Ä–æ–≤–Ω—é:**

#### –£—Ä–æ–≤–µ–Ω—å 1: –ù–∞—á–∏–Ω–∞—é—â–∏–π

1. **–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Å—Ç–æ–π middleware** –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä
2. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –±–∞–∑–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É** email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
3. **–î–æ–±–∞–≤—å—Ç–µ middleware** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ maintenance —Ä–µ–∂–∏–º–∞

#### –£—Ä–æ–≤–µ–Ω—å 2: –°—Ä–µ–¥–Ω–∏–π

4. **–°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–æ–ª–µ–π** —Å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ USER/ADMIN/MODERATOR
5. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ Rate Limiting** —Å —Ä–∞–∑–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π
6. **–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏** –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### –£—Ä–æ–≤–µ–Ω—å 3: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π

7. **–°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π** —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ (orders:create, users:delete)
8. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** (–æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã)
9. **–î–æ–±–∞–≤—å—Ç–µ –≥–µ–æ–±–ª–æ–∫–∏—Ä–æ–≤–∫—É** –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω –ø–æ IP

#### –£—Ä–æ–≤–µ–Ω—å 4: –≠–∫—Å–ø–µ—Ä—Ç

10. **–°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –ª–∏–º–∏—Ç–æ–≤** –∫–∞–∫ –≤ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º –∑–∞–¥–∞–Ω–∏–∏
11. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ audit trail** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
12. **–î–æ–±–∞–≤—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ middleware

**üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:**

- –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –ø—Ä–æ—Å—Ç—ã—Ö middleware –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É—Å–ª–æ–∂–Ω—è–π—Ç–µ
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—ã–π middleware –æ—Ç–¥–µ–ª—å–Ω–æ
- –û–±—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

### üìñ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

- [tRPC Middleware](https://trpc.io/docs/server/middlewares) - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ middleware
- [tRPC Error Handling](https://trpc.io/docs/server/error-handling) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [JWT Best Practices](https://auth0.com/blog/a-look-at-the-latest-draft-for-jwt-bcp/) - –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å JWT
- [OWASP API Security](https://owasp.org/www-project-api-security/) - —Ç–æ–ø —É–≥—Ä–æ–∑ API

### üõ°Ô∏è –ü—Ä–∏–Ω—Ü–∏–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**

- üîê –í—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ JWT —Ç–æ–∫–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- üé≠ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–Ω—Ü–∏–ø –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π (least privilege)
- üìß –¢—Ä–µ–±—É–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- üÜî –†–µ–∞–ª–∏–∑—É–π—Ç–µ KYC –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫:**

- üö¶ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Rate Limiting –¥–ª—è –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö endpoint'–æ–≤
- üìù –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏)
- üîí –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ª–æ–≥–∏—Ä—É–π—Ç–µ –ø–∞—Ä–æ–ª–∏, —Ç–æ–∫–µ–Ω—ã –∏ –¥—Ä—É–≥–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- üåê –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ IP –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞—É–¥–∏—Ç:**

- üìä –°–æ–±–∏—Ä–∞–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ—à–∏–±–æ–∫
- üö® –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
- üìã –í–µ–¥–∏—Ç–µ audit trail –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- üîç –†–µ–≥—É–ª—è—Ä–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∞–Ω–æ–º–∞–ª–∏–π

### üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è –∫—Ä–∏–ø—Ç–æ–±–∏—Ä–∂:

**–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞:**

- –ë–∞–∑–æ–≤–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Üí KYC ‚Üí –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- –†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

- –õ–∏–º–∏—Ç—ã –Ω–∞ —Å—É–º–º—ã –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Å—É–º–º
- –ó–∞–º–æ—Ä–æ–∑–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

### üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?

–í —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–∫–µ –º—ã –∏–∑—É—á–∏–º:

- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ API endpoint'–∞ —Å –Ω—É–ª—è
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤—Å–µ—Ö –∏–∑—É—á–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫—É tRPC API
- –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã:

- [tRPC Examples](https://github.com/trpc/trpc/tree/main/examples) - –ø—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- [JWT.io](https://jwt.io/) - –æ—Ç–ª–∞–¥–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–æ–≤
- [OWASP Cheat Sheets](https://cheatsheetseries.owasp.org/) - —à–ø–∞—Ä–≥–∞–ª–∫–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

[‚Üê –£—Ä–æ–∫ 4.3](./lesson-4.3-client-integration-react-query.md) | [–£—Ä–æ–∫ 4.5 ‚Üí](./lesson-4.5-practice-full-api-endpoint.md)
