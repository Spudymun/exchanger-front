/**
 * Content Generation Service
 * Ð¡ÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ Markdown Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸
 */

import type {
  ProjectScanResult,
  PageScanResult,
  LayoutScanResult,
  ComponentNode,
} from '../types/scanner.js';
import { ComponentAnalysisService } from './component-analysis.service.js';
import { MarkdownFormattingService } from './markdown-formatting.service.js';

/**
 * Ð¡ÐµÑ€Ð²Ð¸Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° Markdown
 */
export class ContentGenerationService {
  private readonly analysisService: ComponentAnalysisService;
  private readonly formattingService: MarkdownFormattingService;

  constructor(verbose: boolean) {
    this.analysisService = new ComponentAnalysisService(verbose);
    this.formattingService = new MarkdownFormattingService(verbose);
  }

  /**
   * Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Markdown ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð° (ÑÐµÐºÑ†Ð¸Ð¸ Ð¸Ð»Ð¸ Ñ‚Ð¾Ð¿-Ð»ÐµÐ²ÐµÐ»)
   */
  createComponentMarkdown(component: ComponentNode, pagePath: string): string {
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð’Ð¡Ð• Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ ÑÑ‚Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°
    const allNestedComponents = this.analysisService.flattenComponents([component]);
    const nestedOnly = allNestedComponents.filter(comp => comp !== component);

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… ÐºÐ»Ð°ÑÑÐ¾Ð² Ð²Ð¾ Ð’Ð¡Ð•Ð¥ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°Ñ…
    const hasDynamicClasses = allNestedComponents.some(
      comp => comp.styles.dynamicClasses && comp.styles.dynamicClasses.length > 0
    );

    return `# ${component.name}

**File**: \`${component.filePath}\`  
**Page**: \`${pagePath}\`  
**Generated**: ${new Date().toISOString()}

---

## ðŸ“‹ Component Summary

* **Direct Children**: ${component.children.length}
* **Total Nested Components**: ${nestedOnly.length}
* **Max Nesting Depth**: ${this.analysisService.getMaxDepth(allNestedComponents)} levels
* **Dynamic Classes Detected**: ${hasDynamicClasses ? 'âœ…' : 'âŒ'}
* **Named Imports**: ${component.imports.map(imp => imp.name).join(', ') || 'None'}
* **Named Exports**: ${component.exports.map(exp => exp.name).join(', ') || 'None'}

---

## ðŸ§© Component Tree

\`\`\`
${this.formattingService.renderComponentTreeText(allNestedComponents)}
\`\`\`

---

## ðŸŽ¨ Styles Per Component

${this.formattingService.renderDetailedComponentStyles(allNestedComponents)}

---

## ðŸ” Complete Tailwind Summary

${this.formattingService.renderTailwindSummaryByComponent(allNestedComponents)}

---

*Generated by @repo/style-scanner*
`;
  }

  /**
   * Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐ²Ð¾Ð´Ð½Ð¾Ð³Ð¾ Markdown Ñ„Ð°Ð¹Ð»Ð°
   */
  createSummaryMarkdown(projectResult: ProjectScanResult): string {
    const { summary, pages } = projectResult;
    return `# Style Scanner - Project Summary

Generated: ${new Date().toISOString()}

## ðŸ“Š Overview

- **Total Pages Scanned**: ${summary.totalPages}
- **Total Components Found**: ${summary.totalComponents}
- **Total Errors**: ${summary.totalErrors}
- **Scan Duration**: ${summary.scanDuration}ms

## ðŸ“„ Pages Analysis

${pages
  .map(page => {
    const { projectName, pageName } = this.extractProjectAndPageNames(page.pagePath);
    return `
### ${this.formattingService.formatPagePath(page.pagePath)}

- **Components**: ${page.components.length}
- **Errors**: ${page.errors.length}
- **Project**: [\`${projectName}\`](./${projectName}/${pageName}/overview.md)
- **Sections**: ${
      page.components
        .filter(c => c.depth === 0)
        .map(
          comp =>
            `[\`${comp.name}\`](./${projectName}/${pageName}/${this.formattingService.sanitizeFileName(comp.name)}.md)`
        )
        .join(', ') || '_No sections_'
    }
`;
  })
  .join('\n')}

---

*Generated by @repo/style-scanner*
`;
  }

  /**
   * Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ overview Markdown Ð´Ð»Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
   */
  createPageOverviewMarkdown(
    pageResult: PageScanResult,
    projectName: string,
    pageName: string
  ): string {
    const { pagePath, components, errors } = pageResult;
    return `# ${projectName} - ${pageName}

**File**: \`${pagePath}\`  
**Generated**: ${new Date().toISOString()}

## ðŸ“Š Overview

- **Total Components**: ${components.length}
- **Top-level Components**: ${components.filter(c => c.depth === 0).length}
- **Errors**: ${errors.length}

## ðŸ§© Top-level Components

${components
  .filter(c => c.depth === 0)
  .map(comp => {
    const styleCount =
      comp.styles.tailwind.length + comp.styles.cssModules.length + comp.styles.cssInJs.length;
    return `- **[${comp.name}](./${this.formattingService.sanitizeFileName(comp.name)}.md)** (${styleCount} styles) - \`${comp.filePath}\``;
  })
  .join('\n')}

---

*Generated by @repo/style-scanner*
`;
  }

  /**
   * Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ overview Markdown Ð´Ð»Ñ layout
   */
  createLayoutOverviewMarkdown(
    layoutResult: LayoutScanResult,
    projectName: string,
    layoutName: string
  ): string {
    const { layoutPath, layoutType, components, errors } = layoutResult;
    return `# ${projectName} - ${layoutName} Layout

**File**: \`${layoutPath}\`  
**Type**: \`${layoutType}\`  
**Generated**: ${new Date().toISOString()}

## ðŸ“Š Overview

- **Total Components**: ${components.length}
- **Layout Type**: ${layoutType}
- **Errors**: ${errors.length}

## ðŸ§© Layout Components

${
  components.length > 0
    ? components
        .map(comp => {
          const styleCount =
            comp.styles.tailwind.length +
            comp.styles.cssModules.length +
            comp.styles.cssInJs.length;
          return `- **[${comp.name}](./${this.formattingService.sanitizeFileName(comp.name)}.md)** (${styleCount} styles) - \`${comp.filePath}\``;
        })
        .join('\n')
    : '_No components found_'
}

---

*Generated by @repo/style-scanner*
`;
  }

  /**
   * Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð¸Ð· Ð¿ÑƒÑ‚Ð¸ (Ð´ÑƒÐ±Ð»Ð¸Ñ€ÑƒÐµÑ‚ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
   */
  private extractProjectAndPageNames(pagePath: string): { projectName: string; pageName: string } {
    const normalizedPath = pagePath.replace(/\\/g, '/');
    const pathParts = normalizedPath.split('/');
    let projectName = 'unknown';
    let pageName = 'page';

    const appsIndex = pathParts.findIndex(part => part === 'apps');
    if (appsIndex !== -1 && pathParts[appsIndex + 1]) {
      projectName = pathParts[appsIndex + 1] || 'unknown';
    }

    const appIndex = pathParts.findIndex(part => part === 'app');
    if (appIndex !== -1) {
      const pageStructure = pathParts.slice(appIndex + 1, -1);
      if (pageStructure.length === 0) {
        pageName = 'home-page';
      } else if (pageStructure.includes('[locale]')) {
        const filteredParts = pageStructure.filter(part => !part.startsWith('['));
        pageName = filteredParts.length > 0 ? filteredParts.join('-') + '-page' : 'home-page';
      } else {
        pageName = pageStructure.join('-') + '-page';
      }
    }

    return { projectName, pageName };
  }
}
